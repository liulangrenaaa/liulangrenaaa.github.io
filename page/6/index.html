<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-12T11:00:00.000Z" title="4/12/2021, 7:00:00 PM">2021-04-12</time>发表</span><span class="level-item"><time dateTime="2021-04-21T08:09:37.140Z" title="4/21/2021, 4:09:37 PM">2021-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux-kernel/">linux kernel</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/">linux schedule</a></span><span class="level-item">6 分钟读完 (大约886个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/12/schedule/sched_domain%20and%20root_domain/">sched_domain and root_domain</a></h1><div class="content"><h2 id="root-domain"><a href="#root-domain" class="headerlink" title="root_domain"></a>root_domain</h2><p><code>root_domain</code> 相对于 <code>sched_domain</code> 来说简单很多， 这是描述一个cpu集合的 数据结构。<br>每个 <code>cpuset</code> 都会拥有一个 <code>root_domain</code>，无论何时何地 <code>cpuset</code>被创建，同时会创建 并 attach 一个 root_domain结构。<br>一个  <code>root_domain</code> 可能包含多个cpu，且这些cpu的能效不一定是一致的，所以内嵌了<code>perf_domain</code> 结构来描述这种差异。</p>
<p><code>perf_domain</code> 的<code>next</code> 指针 就这样将这个<code>root_domain</code> 中的<code>perf_domain</code> 连接起来了。<br>具有同一能效模型的俩cpu(在同一cluster上)，共享一个 <code>em_perf_domain</code> 能效模型结构，但是 <code>perf_domain</code>可能是分开的，因为这俩cpu可能是属于不同<code>root_domain</code>的。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/scheduler/sched-energy.html">kernel 文档</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">The lists are attached to the root domains in order to cope with exclusive cpuset configurations. Since the boundaries of exclusive cpusets do not necessarily match those of performance domains, the lists of different root domains can contain duplicate elements.</span><br><span class="line"></span><br><span class="line">Example 1.</span><br><span class="line">Let us consider a platform with 12 CPUs, split in 3 performance domains (pd0, pd4 and pd8), organized as follows:</span><br><span class="line"></span><br><span class="line">CPUs:   0 1 2 3 4 5 6 7 8 9 10 11</span><br><span class="line">PDs:   |--pd0--|--pd4--|---pd8---|</span><br><span class="line">RDs:   |----rd1----|-----rd2-----|</span><br><span class="line">Now, consider that userspace decided to split the system with two exclusive cpusets, hence creating two independent root domains, each containing 6 CPUs. The two root domains are denoted rd1 and rd2 in the above figure. Since pd4 intersects with both rd1 and rd2, it will be present in the linked list ‘-&gt;pd’ attached to each of them:</span><br><span class="line">rd1-&gt;pd: pd0 -&gt; pd4</span><br><span class="line">rd2-&gt;pd: pd4 -&gt; pd8</span><br><span class="line"></span><br><span class="line">Please note that the scheduler will create two duplicate list nodes for pd4 (one for each list). However, both just hold a pointer to the same shared data structure of the EM framework.</span><br><span class="line"></span><br><span class="line">Since the access to these lists can happen concurrently with hotplug and other things, they are protected by RCU, like the rest of topology structures manipulated by the scheduler.</span><br><span class="line"></span><br><span class="line">EAS also maintains a static key (sched_energy_present) which is enabled when at least one root domain meets all conditions for EAS to start. Those conditions are summarized in Section 6.</span><br></pre></td></tr></table></figure>

<p>这是 <code>root_domain</code> 实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">struct perf_domain &#123;</span><br><span class="line">	struct em_perf_domain *em_pd;</span><br><span class="line">	struct perf_domain *next;</span><br><span class="line">	struct rcu_head rcu;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * We add the notion of a root-domain which will be used to define per-domain</span><br><span class="line"> * variables. Each exclusive cpuset essentially defines an island domain by</span><br><span class="line"> * fully partitioning the member CPUs from any other cpuset. Whenever a new</span><br><span class="line"> * exclusive cpuset is created, we also create and attach a new root-domain</span><br><span class="line"> * object.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct root_domain &#123;</span><br><span class="line">	atomic_t		refcount;</span><br><span class="line">	atomic_t		rto_count;</span><br><span class="line">	struct rcu_head		rcu;</span><br><span class="line">	cpumask_var_t		span;</span><br><span class="line">	cpumask_var_t		online;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Indicate pullable load on at least one CPU, e.g:</span><br><span class="line">	 * - More than one runnable task</span><br><span class="line">	 * - Running task is misfit</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	int			overload;</span><br><span class="line"></span><br><span class="line">	&#x2F;* Indicate one or more cpus over-utilized (tipping point) *&#x2F;</span><br><span class="line">	int			overutilized;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * The bit corresponding to a CPU gets set here if such CPU has more</span><br><span class="line">	 * than one runnable -deadline task (as it is below for RT tasks).</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	cpumask_var_t		dlo_mask;</span><br><span class="line">	atomic_t		dlo_count;</span><br><span class="line">	struct dl_bw		dl_bw;</span><br><span class="line">	struct cpudl		cpudl;</span><br><span class="line"></span><br><span class="line">#ifdef HAVE_RT_PUSH_IPI</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * For IPI pull requests, loop across the rto_mask.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	struct irq_work		rto_push_work;</span><br><span class="line">	raw_spinlock_t		rto_lock;</span><br><span class="line">	&#x2F;* These are only updated and read within rto_lock *&#x2F;</span><br><span class="line">	int			rto_loop;</span><br><span class="line">	int			rto_cpu;</span><br><span class="line">	&#x2F;* These atomics are updated outside of a lock *&#x2F;</span><br><span class="line">	atomic_t		rto_loop_next;</span><br><span class="line">	atomic_t		rto_loop_start;</span><br><span class="line">#endif</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * The &quot;RT overload&quot; flag: it gets set if a CPU has more than</span><br><span class="line">	 * one runnable RT task.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	cpumask_var_t		rto_mask;</span><br><span class="line">	struct cpupri		cpupri;</span><br><span class="line"></span><br><span class="line">	unsigned long		max_cpu_capacity;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * NULL-terminated list of performance domains intersecting with the</span><br><span class="line">	 * CPUs of the rd. Protected by RCU.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	struct perf_domain __rcu *pd;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="sched-domain-WHAT"><a href="#sched-domain-WHAT" class="headerlink" title="sched domain: WHAT?"></a>sched domain: WHAT?</h2><h2 id="sched-domain-如何标识？"><a href="#sched-domain-如何标识？" class="headerlink" title="sched domain: 如何标识？"></a>sched domain: 如何标识？</h2><p><code>include/linux/sched/sd_flags.h</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define SDF_SHARED_CHILD       0x1</span><br><span class="line">#define SDF_SHARED_PARENT      0x2</span><br><span class="line">#define SDF_NEEDS_GROUPS       0x4</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SD_FLAG(SD_BALANCE_NEWIDLE, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_BALANCE_EXEC, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_BALANCE_FORK, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_BALANCE_WAKE, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_WAKE_AFFINE, SDF_SHARED_CHILD)</span><br><span class="line">SD_FLAG(SD_ASYM_CPUCAPACITY, SDF_SHARED_PARENT | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_SHARE_CPUCAPACITY, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_SHARE_PKG_RESOURCES, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_SERIALIZE, SDF_SHARED_PARENT | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_ASYM_PACKING, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_PREFER_SIBLING, SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_OVERLAP, SDF_SHARED_PARENT | SDF_NEEDS_GROUPS)</span><br><span class="line">SD_FLAG(SD_NUMA, SDF_SHARED_PARENT | SDF_NEEDS_GROUPS)</span><br></pre></td></tr></table></figure>


</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-09T11:00:00.000Z" title="4/9/2021, 7:00:00 PM">2021-04-09</time>发表</span><span class="level-item"><time dateTime="2021-09-02T01:51:27.712Z" title="9/2/2021, 9:51:27 AM">2021-09-02</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/qemu/">qemu</a></span><span class="level-item">5 分钟读完 (大约713个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/09/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/qemu%E5%90%AF%E5%8A%A8%E7%9A%84ubuntu%20img%E5%88%B6%E4%BD%9C/">qemu启动的ubuntu img制作</a></h1><div class="content"><h2 id="基础img是从哪里来？"><a href="#基础img是从哪里来？" class="headerlink" title="基础img是从哪里来？"></a>基础img是从哪里来？</h2><p>直接 wget <a target="_blank" rel="noopener" href="https://cloud-images.ubuntu.com/focal/20210407/">链接</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;cloud-images.ubuntu.com&#x2F;focal&#x2F;20210407&#x2F;focal-server-cloudimg-arm64.img</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://spyff.github.io/linux/2018/07/20/qemu-vm/">博客</a></p>
<h2 id="不替换kernel，如何启动这个kernel"><a href="#不替换kernel，如何启动这个kernel" class="headerlink" title="不替换kernel，如何启动这个kernel ???"></a>不替换kernel，如何启动这个kernel ???</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-aarch64 \</span><br><span class="line">	-hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;aarch64&#x2F;arm64_ubuntu.img \</span><br><span class="line">	-m 2048M \</span><br><span class="line">	-smp 4  \</span><br><span class="line">	-M virt \</span><br><span class="line">	-cpu cortex-a72 \</span><br><span class="line">	-net nic \</span><br><span class="line">	-net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></figure>


<h2 id="如何使用这个-img"><a href="#如何使用这个-img" class="headerlink" title="如何使用这个 img"></a>如何使用这个 img</h2><p>这个img是直接可以启动的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-aarch64 \</span><br><span class="line">	-hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;aarch64&#x2F;arm64_ubuntu.img \</span><br><span class="line">	-kernel &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;linux-stable&#x2F;out&#x2F;arch&#x2F;arm64&#x2F;boot&#x2F;Image \</span><br><span class="line">	-append &quot;console&#x3D;ttyAMA0 root&#x3D;&#x2F;dev&#x2F;vda1&quot; \</span><br><span class="line">	-m 2048M \</span><br><span class="line">	-smp 4  \</span><br><span class="line">	-M virt \</span><br><span class="line">	-cpu cortex-a72 \</span><br><span class="line">	-net nic \</span><br><span class="line">	-net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></figure>

<p>但是由于是 <code>cloud img</code>，所以一开始无法使用账号密码登陆，也没法通过ssh登陆。<br>但是可以通过 <code>mount</code> 整个 img，将主机的 ssh的 id_rsa.pub 添加到 <code>cloud img</code>的 <code>authorized_keys</code>中，然后就可以通过 <code>ssh</code> 登陆了。</p>
<h2 id="How-to-mount-a-qcow2-disk-image-方法一"><a href="#How-to-mount-a-qcow2-disk-image-方法一" class="headerlink" title="How to mount a qcow2 disk image- 方法一"></a>How to mount a qcow2 disk image- 方法一</h2><p>This is a quick guide to mounting a qcow2 disk images on your host server. This is useful to reset passwords, edit files, or recover something without the virtual machine running.</p>
<h3 id="Step-1-Enable-NBD-on-the-Host"><a href="#Step-1-Enable-NBD-on-the-Host" class="headerlink" title="Step 1 - Enable NBD on the Host"></a>Step 1 - Enable NBD on the Host</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe nbd max_part&#x3D;8</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Connect-the-QCOW2-as-network-block-device"><a href="#Step-2-Connect-the-QCOW2-as-network-block-device" class="headerlink" title="Step 2 - Connect the QCOW2 as network block device"></a>Step 2 - Connect the QCOW2 as network block device</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-nbd --connect&#x3D;&#x2F;dev&#x2F;nbd0 &#x2F;var&#x2F;lib&#x2F;vz&#x2F;images&#x2F;100&#x2F;vm-100-disk-1.qcow2</span><br></pre></td></tr></table></figure>

<h3 id="Step-3-Find-The-Virtual-Machine-Partitions"><a href="#Step-3-Find-The-Virtual-Machine-Partitions" class="headerlink" title="Step 3 - Find The Virtual Machine Partitions"></a>Step 3 - Find The Virtual Machine Partitions</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fdisk &#x2F;dev&#x2F;nbd0 -l</span><br></pre></td></tr></table></figure>

<h3 id="Step-4-Mount-the-partition-from-the-VM"><a href="#Step-4-Mount-the-partition-from-the-VM" class="headerlink" title="Step 4 - Mount the partition from the VM"></a>Step 4 - Mount the partition from the VM</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount &#x2F;dev&#x2F;nbd0p1 &#x2F;mnt&#x2F;somepoint&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="Step-5-After-you-done-unmount-and-disconnect"><a href="#Step-5-After-you-done-unmount-and-disconnect" class="headerlink" title="Step 5 - After you done, unmount and disconnect"></a>Step 5 - After you done, unmount and disconnect</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">umount &#x2F;mnt&#x2F;somepoint&#x2F;</span><br><span class="line">qemu-nbd --disconnect &#x2F;dev&#x2F;nbd0</span><br><span class="line">rmmod nbd</span><br></pre></td></tr></table></figure>

<h2 id="How-to-mount-a-qcow2-disk-image-方法二"><a href="#How-to-mount-a-qcow2-disk-image-方法二" class="headerlink" title="How to mount a qcow2 disk image- 方法二"></a>How to mount a qcow2 disk image- 方法二</h2><h3 id="安装-libguestfs-tools"><a href="#安装-libguestfs-tools" class="headerlink" title="安装 libguestfs-tools"></a>安装 libguestfs-tools</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libguestfs-tools</span><br></pre></td></tr></table></figure>

<h3 id="help-libguestfs-tools"><a href="#help-libguestfs-tools" class="headerlink" title="help libguestfs-tools"></a>help libguestfs-tools</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;share&#x2F;simpleapp_hw_breakpoints $ guestmount --help</span><br><span class="line">guestmount: FUSE module for libguestfs</span><br><span class="line">guestmount lets you mount a virtual machine filesystem</span><br><span class="line">Copyright (C) 2009-2020 Red Hat Inc.</span><br><span class="line">Usage:</span><br><span class="line">  guestmount [--options] mountpoint</span><br><span class="line">Options:</span><br><span class="line">  -a|--add image       Add image</span><br><span class="line">  --blocksize[&#x3D;512|4096]</span><br><span class="line">                       Set sector size of the disk for -a option</span><br><span class="line">  -c|--connect uri     Specify libvirt URI for -d option</span><br><span class="line">  --dir-cache-timeout  Set readdir cache timeout (default 5 sec)</span><br><span class="line">  -d|--domain guest    Add disks from libvirt guest</span><br><span class="line">  --echo-keys          Don&#39;t turn off echo for passphrases</span><br><span class="line">  --fd&#x3D;FD              Write to pipe FD when mountpoint is ready</span><br><span class="line">  --format[&#x3D;raw|..]    Force disk format for -a option</span><br><span class="line">  --fuse-help          Display extra FUSE options</span><br><span class="line">  -i|--inspector       Automatically mount filesystems</span><br><span class="line">  --help               Display help message and exit</span><br><span class="line">  --key selector       Specify a LUKS key</span><br></pre></td></tr></table></figure>

<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo guestmount  -a userdata-qemu.img.qcow2 -m &#x2F;dev&#x2F;sda qcow2_mount_point</span><br></pre></td></tr></table></figure>

<h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo guestunmount qcow2_mount_point</span><br></pre></td></tr></table></figure>


<h2 id="如何连接-到-img"><a href="#如何连接-到-img" class="headerlink" title="如何连接 到 img"></a>如何连接 到 img</h2><ol>
<li><p>ssh<br>添加key之后，可以直接使用 ssh连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -v ubuntu@127.0.0.1 -p 2222</span><br></pre></td></tr></table></figure>
<p>连接之后，可以添加账号密码，修改默认账号密码</p>
</li>
<li><p>账号密码</p>
</li>
</ol>
<h2 id="如何加大-img-size"><a href="#如何加大-img-size" class="headerlink" title="如何加大 img size"></a>如何加大 img size</h2><p>在长时间运行 安装软件 编译软件之后， img的size会越来越大，这时候最好可以扩展 img的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img resize ubuntu.img +10G</span><br></pre></td></tr></table></figure>

<h2 id="如何开启-numa-架构支持"><a href="#如何开启-numa-架构支持" class="headerlink" title="如何开启 numa 架构支持"></a>如何开启 numa 架构支持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 -kernel &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;linux&#x2F;out&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage -hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;stable_ubuntu.img -append &#39;root&#x3D;&#x2F;dev&#x2F;sda5 console&#x3D;ttyS0 crashkernel&#x3D;256M systemd.unified_cgroup_hierarchy&#x3D;1&#39; -smp cores&#x3D;4,threads&#x3D;1,sockets&#x3D;2 -m 4G -object memory-backend-ram,id&#x3D;mem0,size&#x3D;2G -object memory-backend-ram,id&#x3D;mem1,size&#x3D;2G -numa node,memdev&#x3D;mem0,cpus&#x3D;0-3,nodeid&#x3D;0 -numa node,memdev&#x3D;mem1,cpus&#x3D;4-7,nodeid&#x3D;1 --enable-kvm -net nic -net user,hostfwd&#x3D;tcp::2222-:22 --nographic -fsdev local,id&#x3D;fs1,path&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share,security_model&#x3D;none -device virtio-9p-pci,fsdev&#x3D;fs1,mount_tag&#x3D;host_share</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-18T11:00:00.000Z" title="3/18/2021, 7:00:00 PM">2021-03-18</time>发表</span><span class="level-item"><time dateTime="2021-03-19T05:13:34.287Z" title="3/19/2021, 1:13:34 PM">2021-03-19</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span><span class="level-item">3 分钟读完 (大约478个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/18/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/arm64%20kernel%20%E7%BC%96%E8%AF%91%20+%20vscode%E8%A7%A3%E6%9E%90/">arm64 kernel 编译 + vscode解析</a></h1><div class="content"><p>最近要换坑位了，下一家公司是做arm64手机芯片的，所以先熟悉一下arm64 kernel 开发环境的配置。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li><p>安装 aarch64 架构的gcc编译器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@100ubuntu: ~&#x2F;workspace&#x2F;linux-stable# sudo apt install gcc-aarch64-linux-gnu</span><br><span class="line">正在读取软件包列表... 完成</span><br><span class="line">正在分析软件包的依赖关系树</span><br><span class="line">正在读取状态信息... 完成</span><br><span class="line">下列软件包是自动安装的并且现在不需要了：</span><br><span class="line">  gir1.2-keybinder-3.0 libfprint-2-tod1 libkeybinder-3.0-0 python3-configobj python3-psutil</span><br><span class="line">使用&#39;sudo apt autoremove&#39;来卸载它(它们)。</span><br><span class="line">将会同时安装下列软件：</span><br><span class="line">  cpp-aarch64-linux-gnu</span><br><span class="line">建议安装：</span><br><span class="line">  cpp-doc gdb-aarch64-linux-gnu gcc-doc</span><br><span class="line">下列【新】软件包将被安装：</span><br><span class="line">  cpp-aarch64-linux-gnu gcc-aarch64-linux-gnu</span><br><span class="line">升级了 0 个软件包，新安装了 2 个软件包，要卸载 0 个软件包，有 80 个软件包未被升级。</span><br><span class="line">需要下载 4,852 B 的归档。</span><br><span class="line">解压缩后会消耗 56.3 kB 的额外空间。</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备 defconfig</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@130ubuntu: ~&#x2F;workspace&#x2F;linux-stable# cp arch&#x2F;arm64&#x2F;configs&#x2F;defconfig .config</span><br><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace&#x2F;linux-stable#</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ol>
<li>配置 config</li>
</ol>
<p><code>make ARCH=arm64 CROSS_COMPILE=/usr/bin/aarch64-linux-gnu- menuconfig</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace&#x2F;linux-stable# make ARCH&#x3D;arm64 CROSS_COMPILE&#x3D;&#x2F;usr&#x2F;bin&#x2F;aarch64-linux-gnu- menuconfig</span><br><span class="line">.config:745:warning: symbol value &#39;m&#39; invalid for KVM</span><br><span class="line">configuration written to .config</span><br><span class="line"></span><br><span class="line">*** End of the configuration.</span><br><span class="line">*** Execute &#39;make&#39; to start the build or try &#39;make help&#39;.</span><br><span class="line"></span><br><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace&#x2F;linux-stable#</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编译<br><code>make ARCH=arm64 CROSS_COMPILE=/usr/bin/aarch64-linux-gnu- all -j4</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace&#x2F;linux-stable# make ARCH&#x3D;arm64 CROSS_COMPILE&#x3D;&#x2F;usr&#x2F;bin&#x2F;aarch64-linux-gnu- all -j4 O&#x3D;.&#x2F;out</span><br><span class="line"></span><br><span class="line">  SYNC    include&#x2F;config&#x2F;auto.conf.cmd</span><br><span class="line">  HOSTCC  scripts&#x2F;kconfig&#x2F;conf.o</span><br><span class="line">  HOSTLD  scripts&#x2F;kconfig&#x2F;conf</span><br><span class="line">  WRAP    arch&#x2F;arm64&#x2F;include&#x2F;generated&#x2F;uapi&#x2F;asm&#x2F;kvm_para.h</span><br><span class="line">  WRAP    arch&#x2F;arm64&#x2F;include&#x2F;generated&#x2F;uapi&#x2F;asm&#x2F;errno.h</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>生成compile_commands.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 4.19 - 5.8 之前可以用</span><br><span class="line">.&#x2F;scripts&#x2F;gen_compile_commands.py -d .&#x2F;out&#x2F;</span><br><span class="line"># 5.9 之后可以用</span><br><span class="line">.&#x2F;scripts&#x2F;clang-tools&#x2F;gen_compile_commands.py -d .&#x2F;out&#x2F;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 .vscode/c_cpp_properties.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"># 4.19 - 5.8 之前可以用</span><br><span class="line">    .....</span><br><span class="line">    &quot;compileCommands&quot;: &quot;$&#123;WorkspaceFolder&#125;&#x2F;out&#x2F;compile_commands.json&quot;</span><br><span class="line">    .....</span><br><span class="line"># 5.9 之后可以用</span><br><span class="line">    .....</span><br><span class="line">    &quot;compileCommands&quot;: &quot;$&#123;WorkspaceFolder&#125;&#x2F;compile_commands.json&quot;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，基本上在浏览内核代码上不会有困难了</p>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-18T11:00:00.000Z" title="3/18/2021, 7:00:00 PM">2021-03-18</time>发表</span><span class="level-item"><time dateTime="2022-05-16T10:46:11.827Z" title="5/16/2022, 6:46:11 PM">2022-05-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span><span class="level-item">2 分钟读完 (大约247个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/18/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/pyqt5%20%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91/">pyqt5 界面开发</a></h1><div class="content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>最近需要做一个界面，本来想用 C plus plus 和 Qt做的，但是C++ 不太熟悉，去知乎了解了一下，大家都说自己写的工具还是用PyQt5来做比较快，比较不是商用软件，开发快最重要。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>环境轻量是很重要的，我一开始都装好了vs2022 和 QtCreater了，但是实在太大占用C盘资源太多，加上对 C plus plus不太熟悉，最后还是放弃了 Qt，转而使用PyQt5。</p>
<p>我使用的是 <code>Anaconda3 + vscode + python 插件 + PyQt 插件</code><br><code>Anaconda3</code> 中保存了 绝大部分需要的库，但是 pyQt5 需要卸载重装（看情况，如果不报错就不需要）。<br>还需要单独安装 pyqt5_tools 与 webengines (看报错情况而定)</p>
<h2 id="designer-exe"><a href="#designer-exe" class="headerlink" title="designer.exe"></a>designer.exe</h2><p>是包含在 pyqt5_tools 安装内容中的。可以构思制作界面UI图。</p>
<h2 id="有意思的控件"><a href="#有意思的控件" class="headerlink" title="有意思的控件"></a>有意思的控件</h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-18T11:00:00.000Z" title="3/18/2021, 7:00:00 PM">2021-03-18</time>发表</span><span class="level-item"><time dateTime="2022-05-22T05:59:34.363Z" title="5/22/2022, 1:59:34 PM">2022-05-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span><span class="level-item">几秒读完 (大约0个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/18/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/%E5%9F%BA%E4%BA%8Epython%E7%9A%84%20http%20client&amp;server/">pyqt5 界面开发</a></h1><div class="content"></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-04T11:00:40.000Z" title="3/4/2021, 7:00:40 PM">2021-03-04</time>发表</span><span class="level-item"><time dateTime="2021-03-08T08:11:46.200Z" title="3/8/2021, 4:11:46 PM">2021-03-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约1013个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/04/interrupt/hrtimer/">hrtimer</a></h1><div class="content"><p>hrtimer没有使用时间轮对定时器进行管理，而是选用了更加通用、性能稳定的红黑树。红黑树查找，插入和删除平均时间复杂度是O(logN)。虽然查找的时间复杂度达不到O(1)，但是避免了时间轮的迁移。</p>
<p>因此在平均性能上红黑树和时间轮会较为接近。 hrtimer红黑树是在红黑树的基础上做了简单的封装，hrtimer红黑树节点使用数据结构struct timerqueue_node，比rb_node多了一个expires字段，用于记录超时时刻。<br>hrtimer的数据结构与动态定时器的数据结构类似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">struct timerqueue_node &#123;</span><br><span class="line">	struct rb_node node;</span><br><span class="line">	ktime_t expires;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; include&#x2F;linux&#x2F;hrtimer.h</span><br><span class="line">&#x2F;**</span><br><span class="line"> * struct hrtimer - the basic hrtimer structure</span><br><span class="line"> * @node:	timerqueue node, which also manages node.expires,</span><br><span class="line"> *		the absolute expiry time in the hrtimers internal</span><br><span class="line"> *		representation. The time is related to the clock on</span><br><span class="line"> *		which the timer is based. Is setup by adding</span><br><span class="line"> *		slack to the _softexpires value. For non range timers</span><br><span class="line"> *		identical to _softexpires.</span><br><span class="line"> * @_softexpires: the absolute earliest expiry time of the hrtimer.</span><br><span class="line"> *		The time which was given as expiry time when the timer</span><br><span class="line"> *		was armed.</span><br><span class="line"> * @function:	timer expiry callback function</span><br><span class="line"> * @base:	pointer to the timer base (per cpu and per clock)</span><br><span class="line"> * @state:	state information (See bit values above)</span><br><span class="line"> * @is_rel:	Set if the timer was armed relative</span><br><span class="line"> * @is_soft:	Set if hrtimer will be expired in soft interrupt context.</span><br><span class="line"> * @is_hard:	Set if hrtimer will be expired in hard interrupt context</span><br><span class="line"> *		even on RT.</span><br><span class="line"> *</span><br><span class="line"> * The hrtimer structure must be initialized by hrtimer_init()</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct hrtimer &#123;</span><br><span class="line">	struct timerqueue_node		node;</span><br><span class="line">	ktime_t				_softexpires;</span><br><span class="line">	enum hrtimer_restart		(*function)(struct hrtimer *);</span><br><span class="line">	struct hrtimer_clock_base	*base;</span><br><span class="line">	u8				state;</span><br><span class="line">	u8				is_rel;</span><br><span class="line">	u8				is_soft;</span><br><span class="line">	u8				is_hard;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * struct hrtimer_sleeper - simple sleeper structure</span><br><span class="line"> * @timer:	embedded timer structure</span><br><span class="line"> * @task:	task to wake up</span><br><span class="line"> *</span><br><span class="line"> * task is set to NULL, when the timer expires.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct hrtimer_sleeper &#123;</span><br><span class="line">	struct hrtimer timer;</span><br><span class="line">	struct task_struct *task;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>hrtimer和动态定时器一样拥有超时计数字段_softexpires和超时后的回调函数。 通过比较当前时间是否大于_softexpires来决定定时器超时，执行回调函数。 在红黑树的node中同样保存了一份expires，node.expires大于等于_softexpires。 这样做的目的是在高精度模式下，在_softexpires到node.expires期间设定定时器被触发的时间。</p>
<p>hrtimer管理器结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">struct hrtimer_cpu_base &#123;</span><br><span class="line">	raw_spinlock_t			lock;</span><br><span class="line">	unsigned int			cpu;</span><br><span class="line">	unsigned int			active_bases;</span><br><span class="line">	unsigned int			clock_was_set_seq;</span><br><span class="line">	unsigned int			hres_active		: 1,</span><br><span class="line">					in_hrtirq		: 1,</span><br><span class="line">					hang_detected		: 1,</span><br><span class="line">					softirq_activated       : 1;</span><br><span class="line">#ifdef CONFIG_HIGH_RES_TIMERS</span><br><span class="line">	unsigned int			nr_events;</span><br><span class="line">	unsigned short			nr_retries;</span><br><span class="line">	unsigned short			nr_hangs;</span><br><span class="line">	unsigned int			max_hang_time;</span><br><span class="line">#endif</span><br><span class="line">	ktime_t				expires_next;</span><br><span class="line">	struct hrtimer			*next_timer;</span><br><span class="line">	ktime_t				softirq_expires_next;</span><br><span class="line">	struct hrtimer			*softirq_next_timer;</span><br><span class="line">	struct hrtimer_clock_base	clock_base[HRTIMER_MAX_CLOCK_BASES];</span><br><span class="line">&#125; ____cacheline_aligned;</span><br></pre></td></tr></table></figure>

<p><code>running</code> 字段指向正在执行的 <code>hrtimer</code>。 next_timer字段指向第一个超时的hrtimer。 clock_base字段是当前CPU维护的定时器树。 目前每个CPU都维护了若干组定时器树，其中包括单条递增时间HRTIMER_BASE_MONOTONIC,上墙时间HRTIMER_BASE_REALTIME等。<br>。</p>
<p>hrtimer有两种精度模式，高精度模式和低精度模式。那么同样的数据设计，如何实现两种精度呢？ 这里的关键就是调用检查hrtimer函数的地方。我们来看看两种精度的调用栈。</p>
<p>低精度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timer_interrupt() -&gt; update_process_times() -&gt; run_local_timers() -&gt; hrtimer_run_queues() -&gt; __hrtimer_run_queues()</span><br></pre></td></tr></table></figure>

<p>高精度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hrtimer_interrupt() -&gt; __hrtimer_run_queues()</span><br></pre></td></tr></table></figure>

<p>当hrtimer处于低精度模式时，每次irq0上的时间中断，即每次tick事件，调用一次检查hrtimer函数。 tick的频率是1000hz，此时，hrtimer处于低精度模式。 在第一篇文章中，我们提到TSC、HPET都是可以提供纳秒级的时间设备。 当hrtimer处于高精度模式时，Linux把hrtimer_interrupt()绑定到高精度的时间设备，这时就可以提供纳秒级的定时器服务了。 但是频繁的调用检查hrtimer函数会非常消耗机器性能。 为了避免这个缺陷，hrtimer_interrupt()的调用采用了one-shot的模式。每一次调用都会设定下一次调用的时间。</p>
<p>参考<a target="_blank" rel="noopener" href="http://rangechow.com/2016/04/19/%E9%AB%98%E7%B2%BE%E5%BA%A6%E5%AE%9A%E6%97%B6%E5%99%A8Hrtimer.html">高精度定时器Hrtimer</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-04T11:00:40.000Z" title="3/4/2021, 7:00:40 PM">2021-03-04</time>发表</span><span class="level-item"><time dateTime="2021-07-22T09:21:52.820Z" title="7/22/2021, 5:21:52 PM">2021-07-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">2 分钟读完 (大约262个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/04/interrupt/%E5%92%8C%E4%B8%AD%E6%96%AD%E6%8A%A2%E5%8D%A0%E7%9B%B8%E5%85%B3api/">和中断抢占相关api</a></h1><div class="content"><h2 id="开关关中断api"><a href="#开关关中断api" class="headerlink" title="开关关中断api"></a>开关关中断api</h2><p>api1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define local_irq_enable()	do &#123; raw_local_irq_enable(); &#125; while (0)</span><br><span class="line">#define local_irq_disable()	do &#123; raw_local_irq_disable(); &#125; while (0)</span><br></pre></td></tr></table></figure>

<p>api2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define local_irq_save(flags)	do &#123; raw_local_irq_save(flags); &#125; while (0)</span><br><span class="line">#define local_irq_restore(flags) do &#123; raw_local_irq_restore(flags); &#125; while (0)</span><br></pre></td></tr></table></figure>



<h2 id="this-cpu-read-amp-amp-this-cpu-read"><a href="#this-cpu-read-amp-amp-this-cpu-read" class="headerlink" title="__this_cpu_read &amp;&amp; this_cpu_read"></a>__this_cpu_read &amp;&amp; this_cpu_read</h2><h3 id="中断上下文"><a href="#中断上下文" class="headerlink" title="中断上下文"></a>中断上下文</h3><p>可以在中断上下文中使用，无需考虑被中断或者进程强占</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Operations for contexts that are safe from preemption&#x2F;interrupts.  These</span><br><span class="line"> * operations verify that preemption is disabled.</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define __this_cpu_read(pcp)						\</span><br><span class="line">(&#123;									\</span><br><span class="line">	__this_cpu_preempt_check(&quot;read&quot;);				\</span><br><span class="line">	raw_cpu_read(pcp);						\</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">#define __this_cpu_write(pcp, val)					\</span><br><span class="line">(&#123;									\</span><br><span class="line">	__this_cpu_preempt_check(&quot;write&quot;);				\</span><br><span class="line">	raw_cpu_write(pcp, val);					\</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="进程上下文"><a href="#进程上下文" class="headerlink" title="进程上下文"></a>进程上下文</h3><p>可以在进程上下文中使用，实现了 强占、中断保护</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Operations with implied preemption&#x2F;interrupt protection.  These</span><br><span class="line"> * operations can be used without worrying about preemption or interrupt.</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define this_cpu_read(pcp)		__pcpu_size_call_return(this_cpu_read_, pcp)</span><br><span class="line">#define this_cpu_write(pcp, val)	__pcpu_size_call(this_cpu_write_, pcp, val)</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/commit/?id=8afecaa68df1e94a9d634f1f961533a925f239fc">patch1</a><br>参考<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/commit/?id=17c891ab349138e8d8a59ca2700f42ce8af96f4e">patch2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-01T11:00:40.000Z" title="3/1/2021, 7:00:40 PM">2021-03-01</time>发表</span><span class="level-item"><time dateTime="2021-03-01T07:06:10.303Z" title="3/1/2021, 3:06:10 PM">2021-03-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">2 分钟读完 (大约254个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/01/interrupt/interrupt%20storm/">interrupt storm</a></h1><div class="content"><p>记录一下<code>hrtimer</code>使用问题导致的 <code>interrupt storm</code> （中断风暴）。</p>
<h2 id="hrtimer使用"><a href="#hrtimer使用" class="headerlink" title="hrtimer使用"></a>hrtimer使用</h2><ol>
<li><p>只想使用一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init -&gt; start -&gt; [return HRTIMER_NORESTART;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>想使用多次，timer 一直存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init -&gt; start -&gt; [hrtimer_forward_now; return HRTIMER_NORESTART;]</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/misc/hrtimer/hrtimer.c">代码</a></p>
<p>init:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hrtimer_init( &amp;hr_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);</span><br><span class="line">hr_timer.function &#x3D; &amp;my_hrtimer_callback;</span><br></pre></td></tr></table></figure>

<p>start:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hrtimer_start(&amp;hr_timer, ms_to_ktime(500), HRTIMER_MODE_REL);</span><br></pre></td></tr></table></figure>

<p>callback: (产生中断风暴)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int once_timer &#x3D; 1;</span><br><span class="line">int interrupt_storm &#x3D; 0;</span><br><span class="line"></span><br><span class="line">enum hrtimer_restart my_hrtimer_callback( struct hrtimer *hr_timer)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;my_hrtimer_callback called (%ld).\n&quot;, jiffies );</span><br><span class="line"></span><br><span class="line">	if (interrupt_storm) &#123;</span><br><span class="line">		if (once_timer) &#123;</span><br><span class="line">			return HRTIMER_NORESTART;</span><br><span class="line">		&#125;</span><br><span class="line">		hrtimer_forward_now(hr_timer, ms_to_ktime(500));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return HRTIMER_RESTART;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="中断风暴"><a href="#中断风暴" class="headerlink" title="中断风暴"></a>中断风暴</h2><p>安装这个模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;misc&#x2F;hrtimer# sudo insmod hrtimer.ko</span><br></pre></td></tr></table></figure>

<p>产生如下警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ 1130.893739] rcu: INFO: rcu_sched detected stalls on CPUs&#x2F;tasks:</span><br><span class="line">[ 1130.893750] rcu: 	3-...0: (5 GPs behind) idle&#x3D;b3e&#x2F;0&#x2F;0x1 softirq&#x3D;17149&#x2F;17149 fqs&#x3D;6500</span><br><span class="line">[ 1208.887926] rcu: INFO: rcu_sched detected stalls on CPUs&#x2F;tasks:</span><br><span class="line">[ 1208.888716] rcu: 	3-...0: (5 GPs behind) idle&#x3D;b3e&#x2F;0&#x2F;0x1 softirq&#x3D;17149&#x2F;17149 fqs&#x3D;24703</span><br><span class="line"></span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996 login:</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996 login: [ 1286.883226] rcu: INFO: rcu_sched detected stalls on CPUs&#x2F;tasks:</span><br><span class="line">[ 1286.884781] rcu: 	3-...0: (5 GPs behind) idle&#x3D;b3e&#x2F;0&#x2F;0x1 softirq&#x3D;17149&#x2F;17149 fqs&#x3D;42700</span><br></pre></td></tr></table></figure>


<p>然后<code>crash</code>,看现场信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>






























</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-26T11:00:40.000Z" title="2/26/2021, 7:00:40 PM">2021-02-26</time>发表</span><span class="level-item"><time dateTime="2021-03-01T05:20:02.847Z" title="3/1/2021, 1:20:02 PM">2021-03-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">4 分钟读完 (大约565个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/26/rcu/rcu%E7%AE%80%E4%BB%8B/">rcu简介</a></h1><div class="content"><p>RCU顾名思义–Read Copy Update，我的理解是：<br>读者直接读，没有任何开销，写者需要先Copy，然后等待合适的时机(宽限期)，去更新 Update。</p>
<p>记得之前有一道笔试题叫 无锁编程？<br>现在想想应该是有以下几类吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 原子操作</span><br><span class="line">2. CAS操作</span><br><span class="line">3. 使用rcu编程</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="WHY-RCU"><a href="#WHY-RCU" class="headerlink" title="WHY RCU?"></a>WHY RCU?</h2><p>在RCU的实现过程中，我们主要解决以下问题：</p>
<ol>
<li>在读取过程中，另外一个线程删除了一个节点。删除线程可以把这个节点从链表中移除，但它不能直接销毁这个节点，必须等到所有的读取线程读取完成以后，才进行销毁操作。RCU中把这个过程称为宽限期（Grace period）。</li>
<li>在读取过程中，另外一个线程插入了一个新节点，而读线程读到了这个节点，那么需要保证读到的这个节点是完整的。这里涉及到了发布-订阅机制（Publish-Subscribe Mechanism）。</li>
<li>保证读取链表的完整性。新增或者删除一个节点，不至于导致遍历一个链表从中间断开。但是RCU并不保证一定能读到新增的节点或者不读到要被删除的节点。</li>
</ol>
<p>关于 RCU 和 其他锁的性能对比:</p>
<ol>
<li>RCU 的性能优势（scalblity）往往体现在多核上</li>
<li>相对于 rwlock等锁来说，RCU的效率可以高到10 - 100倍</li>
</ol>
<h2 id="rcu-的编程API"><a href="#rcu-的编程API" class="headerlink" title="rcu 的编程API"></a>rcu 的编程API</h2><p>For reader:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rcu_read_lock(void);</span><br><span class="line">rcu_read_unlock(void);</span><br><span class="line">rcu_read_lock_bh(void);</span><br><span class="line">rcu_read_unlock_bh(void);</span><br></pre></td></tr></table></figure>

<p>For writer:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void call_rcu(struct rcu_head *head, rcu_callback_t func);</span><br><span class="line">void synchronize_rcu(void);</span><br><span class="line"></span><br><span class="line">#define rcu_assign_pointer(p, v)</span><br><span class="line">#define rcu_replace_pointer(rcu_ptr, ptr, c)</span><br><span class="line">rcu_dereferencercu_read_unlock(void);</span><br></pre></td></tr></table></figure>

<p>和调度器相关的 API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static void __sched notrace __schedule(bool preempt)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">	rcu_note_context_switch(preempt);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RCU类型"><a href="#RCU类型" class="headerlink" title="RCU类型"></a>RCU类型</h2><p><code>TINY RCU</code> 一般只有arm32 UP系统使用了，使用场景很少。<br><code>TREE RCU</code> 从4核 到 1024 核心都可以很好的支持。</p>
<p>arm64平台 和 x86平台 defconfig 都是使用的是 <code>TREE RCU</code>。<br>所以重点还是放在 <code>TREE RCU</code>，同时需要关注 <code>SRCU</code>。</p>
<h2 id="CONFIG-PREEMPT-RCU"><a href="#CONFIG-PREEMPT-RCU" class="headerlink" title="CONFIG_PREEMPT_RCU"></a>CONFIG_PREEMPT_RCU</h2><p>抢占式 RCU含义是？</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-25T11:00:40.000Z" title="2/25/2021, 7:00:40 PM">2021-02-25</time>发表</span><span class="level-item"><time dateTime="2021-04-19T01:49:45.960Z" title="4/19/2021, 9:49:45 AM">2021-04-19</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">5 分钟读完 (大约679个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/25/mycase/softlockup%20+%20rcu%20+%20oom/">softlockup + rcu + oom</a></h1><div class="content"><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>产生oom，业务A被干掉了</p>
<h2 id="case"><a href="#case" class="headerlink" title="case"></a>case</h2><ol>
<li>根据oom现场 dump的信息查看 各个进程都没有占用太多内存，排除<code>用户空间进程内存泄漏</code></li>
<li>查看 <code>slab</code> 信息，发现确实有某些<code>slab</code> 变得很大，发现是图传驱动创建的一个slab。</li>
<li>严重 怀疑是 <code>slab 内存泄漏</code>，最后导致的内存泄漏，排查相关<code>create alloc free</code> 代码之后，没什么收获。</li>
<li>使用 bpftrace 跟踪 申请释放的kprobe点，跟踪几分钟，十几分钟，看 输出几乎是成对出现的，应该不存在 <code>slab内存泄漏</code></li>
<li>查看驱动自己封装的接口，发现<code>释放slab</code> 是直接使用 call_rcu()的一个接口，怀疑可能是跟 call_rcu接口有关系。</li>
<li>rcu 涉及到 宽限期的问题，怀疑可能是某个 cpu 发生了 softlockup 或者不调度，部署panic_on_oom 抓取现场。</li>
<li>看到确实有 一个驱动线程 一直占用cpu,看这个线程的 backtrace发现是在一个驱动的重新初始化上 一直 while，且之前获取过 spin_lock()，这样就基本构成了发生 softlockup的必要条件，之所以没有看到softlockup的原因就是时间还没到。</li>
<li>到这一步，大概基本80～90%怀疑是 驱动代码 + 外设导致的 softlockup，最后导致rcu的宽限期不能通过，导致slab不能延迟释放，最后导致的 oom。</li>
<li>然后尝试手动触发一个 <code>softlockup</code>，来尝试复现这个问题，但是一直只能的到 softlockup的警告，并不能复现 oom的情况？</li>
<li>最后发现slab积累 释放的速率 和 业务场景有很大关系，研发机器经常烧录，在烧录之后参数区丢失，导致图传模式一直是默认模式，slab申请释放速率较低，但是QA都是OTA升级，一般使用 高画质，slab 申请释放 会比默认模式快很多，这也是为什么我本地不能复现这个 oom bug的原因。</li>
</ol>
<p>大概流程是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------+</span><br><span class="line">|    驱动先spin_lock之后，while等待  |</span><br><span class="line">|    一个初始化信号，由于外设异常，导致 |</span><br><span class="line">|    一直在while中,无法退出          |</span><br><span class="line">+-----------+---------------------+</span><br><span class="line">            |</span><br><span class="line">            |</span><br><span class="line">            |</span><br><span class="line">            |</span><br><span class="line">            v</span><br><span class="line">+-----------+----------------------------+</span><br><span class="line">|                                         |</span><br><span class="line">|  具备产生 softlockup 的条件,              |</span><br><span class="line">|  但是时间还是比较短，所以还未发生            |</span><br><span class="line">|  softlockup                             |</span><br><span class="line">+----------+-----------------------------+</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">+----------v-----------------------------+</span><br><span class="line">|                                        |</span><br><span class="line">|    系统中rcu的宽限期过不了，               |</span><br><span class="line">|    导致业务驱动使用频繁的slab积累          |</span><br><span class="line">|    太多看起来和slab内存泄漏一样            |</span><br><span class="line">|                                        |</span><br><span class="line">+---------+------------------------------+</span><br><span class="line">          |</span><br><span class="line">          |</span><br><span class="line">          |</span><br><span class="line">          |</span><br><span class="line">+---------v-------------------+</span><br><span class="line">|                             |</span><br><span class="line">|  系统内存不足，导致oom         |</span><br><span class="line">|                             |</span><br><span class="line">+-----------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/5/">上一页</a></div><div class="pagination-next"><a href="/page/7/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/5/">5</a></li><li><a class="pagination-link is-current" href="/page/6/">6</a></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/13/">13</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">130</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">28</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">164</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/explore" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BRK/"><span class="tag">BRK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HW/"><span class="tag">HW</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QCOM/"><span class="tag">QCOM</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aarch64/"><span class="tag">aarch64</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/acl/"><span class="tag">acl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android-framework/"><span class="tag">android framework</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android12-gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/"><span class="tag">android12 gdb64调试进程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/asid/"><span class="tag">asid</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/benchmark/"><span class="tag">benchmark</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v1/"><span class="tag">cgroup v1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v2/"><span class="tag">cgroup v2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/config/"><span class="tag">config</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/coroutinue/"><span class="tag">coroutinue</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu%E8%B0%83%E9%A2%91/"><span class="tag">cpu调频</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dd/"><span class="tag">dd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debugfs/"><span class="tag">debugfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/double-free/"><span class="tag">double free</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drop-caches/"><span class="tag">drop_caches</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dumpe2fs/"><span class="tag">dumpe2fs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eas/"><span class="tag">eas</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/epoll/"><span class="tag">epoll</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ext2/"><span class="tag">ext2</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-attr/"><span class="tag">file attr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-hole/"><span class="tag">file hole</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filesystem/"><span class="tag">filesystem</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fsck/"><span class="tag">fsck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace-%E7%94%A8%E6%B3%95/"><span class="tag">ftrace 用法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/futex/"><span class="tag">futex</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hrtimer/"><span class="tag">hrtimer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hugepage/"><span class="tag">hugepage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/initramfs/"><span class="tag">initramfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interrupt/"><span class="tag">interrupt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt/"><span class="tag">intrrrupt</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt-storm/"><span class="tag">intrrrupt storm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kallsyms/"><span class="tag">kallsyms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kfence/"><span class="tag">kfence</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kprobes/"><span class="tag">kprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kretprobes/"><span class="tag">kretprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvmtool/"><span class="tag">kvmtool</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/last-kmsg/"><span class="tag">last_kmsg</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/launch-json/"><span class="tag">launch.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-kernel/"><span class="tag">linux kernel</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-native-aio/"><span class="tag">linux native aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lock-stat/"><span class="tag">lock_stat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory/"><span class="tag">memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory-direct-reclaim/"><span class="tag">memory direct reclaim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/menuconfig/"><span class="tag">menuconfig</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mm/"><span class="tag">mm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mount/"><span class="tag">mount</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/node/"><span class="tag">node</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oom/"><span class="tag">oom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagemap/"><span class="tag">pagemap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf/"><span class="tag">perf</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf-c2c/"><span class="tag">perf c2c</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pid-namespace/"><span class="tag">pid namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/poll/"><span class="tag">poll</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/posix/"><span class="tag">posix</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/power-management/"><span class="tag">power management</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preemption/"><span class="tag">preemption</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pressure/"><span class="tag">pressure</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/process-madvise/"><span class="tag">process_madvise</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psi/"><span class="tag">psi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psoix-aio/"><span class="tag">psoix aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pstore/"><span class="tag">pstore</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pyqt5/"><span class="tag">pyqt5</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/randomize-va-space/"><span class="tag">randomize_va_space</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rcu/"><span class="tag">rcu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sched-latency/"><span class="tag">sched latency</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/schedule/"><span class="tag">schedule</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/select/"><span class="tag">select</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slab/"><span class="tag">slab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-backtrace/"><span class="tag">stack_backtrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-overflow/"><span class="tag">stack_overflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-key/"><span class="tag">static_key</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sync/"><span class="tag">sync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systrace/"><span class="tag">systrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-json/"><span class="tag">task.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-struct/"><span class="tag">task_struct</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread-info/"><span class="tag">thread_info</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tracepoint/"><span class="tag">tracepoint</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/use-after-free/"><span class="tag">use after free</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uts-namespace/"><span class="tag">uts namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vdso/"><span class="tag">vdso</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmstat/"><span class="tag">vmstat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xattr/"><span class="tag">xattr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zone/"><span class="tag">zone</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%B6%8A%E7%95%8C/"><span class="tag">内存泄漏越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88%E6%BA%A2%E5%87%BA/"><span class="tag">内核栈溢出</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8A%9F%E8%80%97/"><span class="tag">功耗</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8E%9F%E7%90%86/"><span class="tag">原理</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80%E9%9A%8F%E6%9C%BA%E5%8C%96/"><span class="tag">地址空间布局随机化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/QCOM/"><span class="level-start"><span class="level-item">QCOM</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/cgroup-v1/"><span class="level-start"><span class="level-item">cgroup v1</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/cgroup-v1/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/kernel-debug/cache-false-sharing/"><span class="level-start"><span class="level-item">cache false sharing</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/"><span class="level-start"><span class="level-item">linux kernel</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/deadline-schedule/"><span class="level-start"><span class="level-item">deadline schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/"><span class="level-start"><span class="level-item">frequency governer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/schedule-util/"><span class="level-start"><span class="level-item">schedule util</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/idle/"><span class="level-start"><span class="level-item">idle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">74</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/"><span class="level-start"><span class="level-item">namespace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/namespace/pid-namespace/"><span class="level-start"><span class="level-item">pid namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/uts-namespace/"><span class="level-start"><span class="level-item">uts namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/power-management/"><span class="level-start"><span class="level-item">power management</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/schedule/"><span class="level-start"><span class="level-item">schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/userspace/"><span class="level-start"><span class="level-item">userspace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/userspace/coroutinue/"><span class="level-start"><span class="level-item">coroutinue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/userspace/coroutinue/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">网络</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-20T11:00:40.000Z">2022-09-20</time></p><p class="title"><a href="/2022/09/20/mycase/benchmark+futex+stack_backtrace/">benchmark+futex+stack_backtrace</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-01T11:00:40.000Z">2022-07-01</time></p><p class="title"><a href="/2022/07/01/memory/asid/">asid</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-06-18T11:00:00.000Z">2022-06-18</time></p><p class="title"><a href="/2022/06/18/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/last_kmsg/">last_kmsg</a></p><p class="categories"><a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-04-29T11:00:00.000Z">2022-04-29</time></p><p class="title"><a href="/2022/04/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/ftrace%20%E5%8E%9F%E7%90%86/">ftrace 原理</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-04-29T11:00:00.000Z">2022-04-29</time></p><p class="title"><a href="/2022/04/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/%E5%B8%B8%E8%A7%81ftrace%E7%94%A8%E6%B3%95/">常见ftrace用法</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>