<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-15T11:00:00.000Z" title="1/15/2021, 7:00:00 PM">2021-01-15</time>发表</span><span class="level-item"><time dateTime="2021-01-18T06:07:42.051Z" title="1/18/2021, 2:07:42 PM">2021-01-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约992个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/15/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98/">文件资源泄漏问题</a></h1><div class="content"><h2 id="资源泄漏"><a href="#资源泄漏" class="headerlink" title="资源泄漏"></a>资源泄漏</h2><p>资源泄漏在实际编程中是一不小心就会遇到的一个问题，最常见的就是 <code>内存泄漏</code>。<br>内存泄漏：对于短时间存在的进程，线程即使存在内存泄漏，往往也不会变现出来，开发人员也很难感知到。<br>但是一旦是长时间运行的进程，线程存在内存泄漏的问题，那将是一个灾难，要么过一会被OOM KILL，要么<br>自己重启，更严重的就是重启机器。</p>
<p>内存泄漏是指内存被分配出来，但是后续一直未使用，且失去了这个内存的引用，一直无法释放的问题。</p>
<p>但是除了最常见内存泄漏之外，还有其他各种资源泄漏的问题，比如这次的 <code>进程文件资源泄漏</code>。</p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>虽然是嵌入式平台，也有一些业务需要做压力测试连续几天到一个月不关机长时间跑测试。</p>
<p>某个业务在运行两天之后就会出现进程挂掉的问题。</p>
<h2 id="代码复现"><a href="#代码复现" class="headerlink" title="代码复现"></a>代码复现</h2><p>如果能用简单代码复现的问题，都不大</p>
<p><a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/tree/main">代码</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line">#include &lt;dirent.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;stat.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#define DIR_NAME        &quot;&#x2F;tmp&#x2F;asdf&quot;</span><br><span class="line"></span><br><span class="line">int sync_dir(char *dir)</span><br><span class="line">&#123;</span><br><span class="line">        if(!dir) return -1;</span><br><span class="line">        int fd &#x3D; open(dir, O_ASYNC);</span><br><span class="line">        if (-1 &#x3D;&#x3D; fd) return -1;</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 0;</span><br><span class="line">        int ret &#x3D; -1;</span><br><span class="line">        for (i &#x3D; 0; i &lt; 1024 * 1024 * 64; i++) &#123;</span><br><span class="line">                ret &#x3D; sync_dir(DIR_NAME);</span><br><span class="line">                if (ret)        printf(&quot;sync_dir failed. i &#x3D; %d, ret &#x3D; %d\n&quot;, i, ret);</span><br><span class="line">                else            printf(&quot;sync_dir sucess. i &#x3D; %d\n&quot;, i);</span><br><span class="line">                usleep(1000 * 10);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>嵌入式设备上的资源限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@device_gls:&#x2F;proc&#x2F;sys&#x2F;fs # cat file-nr</span><br><span class="line">800     0       21378</span><br><span class="line">root@device_gls:&#x2F;proc&#x2F;sys&#x2F;fs #</span><br></pre></td></tr></table></figure>
<p>意思是当前系统允许打开 <code>21378</code> 个文件，已经打开了 <code>800</code>个文件了</p>
<p>我选择用 <code>ubuntu</code> 系统去复现，先将 系统 fd上限制调制与设备一样的水平</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-max</span><br><span class="line">9223372036854775807</span><br><span class="line">tencent_clould@1ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# sudo su</span><br><span class="line">VM-0-11-ubuntu# echo 21378 &gt; file-max</span><br><span class="line">VM-0-11-ubuntu# exit</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-max</span><br><span class="line">21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>

<p>尝试复现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@130ubuntu: ~&#x2F;workspace&#x2F;hexo_blog&#x2F;source&#x2F;_posts&#x2F;资源管理# .&#x2F;a.out</span><br><span class="line">sync_dir sucess. i &#x3D; 0</span><br><span class="line">sync_dir sucess. i &#x3D; 1</span><br><span class="line">....</span><br><span class="line">sync_dir sucess. i &#x3D; 5</span><br><span class="line">sync_dir sucess. i &#x3D; 18194</span><br><span class="line">sync_dir sucess. i &#x3D; 18195</span><br><span class="line">...</span><br><span class="line">sync_dir failed. i &#x3D; 18196, ret &#x3D; -1</span><br></pre></td></tr></table></figure>


<p>同时观察 <code> /proc/sys/fs/file-nr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">4704    0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">9824    0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">17760   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">20224   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">21024   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">21216   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">zsh: pipe failed: too many open files in system</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">zsh: pipe failed: too many open files in system</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>a.out</code> 最后无法 通过 <code>open</code> 打开文件了，且同时 <code>zsh</code> shell 都无法打开<br><code>file-nr</code>了。</p>
<p>与此同时，看到 <code>dmesg</code> 的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[57615.006011] VFS: file-max limit 21378 reached</span><br><span class="line">[57616.671617] VFS: file-max limit 21378 reached</span><br></pre></td></tr></table></figure>
<p>也可以比较容易定位出来。</p>
<p>这个问题困扰了当时开发同事很久，最后发现原来是 系统 <code>fd</code> 资源全部泄漏殆尽导致的。</p>
<h2 id="其他限制资源使用的方式"><a href="#其他限制资源使用的方式" class="headerlink" title="其他限制资源使用的方式"></a>其他限制资源使用的方式</h2><ol>
<li>其实还有其他方式限制资源 如 <code>ulimit</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# ulimit -a</span><br><span class="line">-t: cpu time (seconds)              unlimited</span><br><span class="line">-f: file size (blocks)              unlimited</span><br><span class="line">-d: data seg size (kbytes)          unlimited</span><br><span class="line">-s: stack size (kbytes)             8192</span><br><span class="line">-c: core file size (blocks)         0</span><br><span class="line">-m: resident set size (kbytes)      unlimited</span><br><span class="line">-u: processes                       7582</span><br><span class="line">-n: file descriptors                1024</span><br><span class="line">-l: locked-in-memory size (kbytes)  65536</span><br><span class="line">-v: address space (kbytes)          unlimited</span><br><span class="line">-x: file locks                      unlimited</span><br><span class="line">-i: pending signals                 7582</span><br><span class="line">-q: bytes in POSIX msg queues       819200</span><br><span class="line">-e: max nice                        0</span><br><span class="line">-r: max rt priority                 0</span><br><span class="line">-N 15:                              unlimited</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>/proc/pid/limits<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat &#x2F;proc&#x2F;4833&#x2F;limits</span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        0                    unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             7582                 7582                 processes</span><br><span class="line">Max open files            1024                 1048576              files</span><br><span class="line">Max locked memory         67108864             67108864             bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       7582                 7582                 signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         0                    0</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><code>/etc/security/limits.conf</code></li>
</ol>
<p>这里可以预先配置。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-11T15:00:00.000Z" title="1/11/2021, 11:00:00 PM">2021-01-11</time>发表</span><span class="level-item"><time dateTime="2021-01-15T11:33:39.371Z" title="1/15/2021, 7:33:39 PM">2021-01-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/">生活感悟</a></span><span class="level-item">8 分钟读完 (大约1225个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/11/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E6%88%91%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E7%9C%8B%E4%BB%A3%E7%A0%81/">我应该如何看代码</a></h1><div class="content"><p>每次看一个模块源码都比较痛苦，在 <code>kernel</code> 的代码海洋里面像一只无头苍蝇一样，看来半天却<br>不知所云，记录一下之后在看某个模块源码时 应该注意什么，比较快的熟悉，警醒自己！</p>
<h2 id="庞大的linux内核"><a href="#庞大的linux内核" class="headerlink" title="庞大的linux内核"></a>庞大的linux内核</h2><p>现在是 2021-01-11号，上个月linus发布了 Linux-5.10 LTS版本，往往每年的最后一个 kernel 版本就是作为LTS的版本，今年是12月13号。</p>
<p>linus 会在每个大版本发布之后都会 开启 一个merge window的时间，这个时间大家都可以尽量<br>的合入之前早就开发好的已经在next tree的 patch，大概有一两周？今年这时候恰好是圣诞节，<br>老外是基本周末都不会工作的，更何况是 <code>圣诞+元旦</code> 这种节日了，看了基本 2020-12-23 – 2021-01-04 都是没有daily next tree 版本更新的。</p>
<p>A total of 1,971 developers contributed to 5.10 — again, just short of the record set by 5.8. Of those developers, 252 (just under 13%) made their first contribution in 5.10; that is the lowest number seen since 5.6. The most active 5.10 developers were:</p>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/839772/">Linux 5.10代码统计</a></p>
<h2 id="新的模块应该如何涉及"><a href="#新的模块应该如何涉及" class="headerlink" title="新的模块应该如何涉及"></a>新的模块应该如何涉及</h2><p>首先要高明白他是干什么的</p>
<ol>
<li>结合注释去看，谷歌翻译，vscode在线、离线插件都很好用</li>
<li>结合 git log 看：<br> git log -S’xxx’ file_name</li>
<li>根据Makefile看：如果这个目录下Makefile 都没直接包含这个文件.o<br>需要使能之后才会编译到内核中的话，结合是否工作实际需要再看</li>
<li>谷歌、百度：中文 英文都可以作为关键次搜索</li>
<li>LWN 找到Archives，看看有没有介绍的文章</li>
<li>看看 Documents 目录下有没有介绍的文档</li>
<li>看这个模块 关键数据结构 和关键数据结构数据成员 如 struct_task struct_mm<br>address_space等</li>
</ol>
<h3 id="新的子系统"><a href="#新的子系统" class="headerlink" title="新的子系统"></a>新的子系统</h3><ol>
<li>知道模块子系统作用</li>
<li>找个方法实践一下，比如 docker 可以很好实践 cgroups</li>
<li>关键数据结构</li>
<li>导出到用户空间的接口，看他在 kernel中实现<br>比如<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@127ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# ls</span><br><span class="line">aio-max-nr    dir-notify-enable  inode-nr          leases-enable  overflowgid           pipe-user-pages-soft  protected_symlinks</span><br><span class="line">aio-nr        epoll              inode-state       mount-max      overflowuid           protected_fifos       quota</span><br><span class="line">binfmt_misc   file-max           inotify           mqueue         pipe-max-size         protected_hardlinks   suid_dumpable</span><br><span class="line">dentry-state  file-nr            lease-break-time  nr_open        pipe-user-pages-hard  protected_regular     verity</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">3200    0       9223372036854775807</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-max</span><br><span class="line">9223372036854775807</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>

</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static struct ctl_table fs_table[] &#x3D; &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;inode-nr&quot;,</span><br><span class="line">		.data		&#x3D; &amp;inodes_stat,</span><br><span class="line">		.maxlen		&#x3D; 2*sizeof(long),</span><br><span class="line">		.mode		&#x3D; 0444,</span><br><span class="line">		.proc_handler	&#x3D; proc_nr_inodes,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;inode-state&quot;,</span><br><span class="line">		.data		&#x3D; &amp;inodes_stat,</span><br><span class="line">		.maxlen		&#x3D; 7*sizeof(long),</span><br><span class="line">		.mode		&#x3D; 0444,</span><br><span class="line">		.proc_handler	&#x3D; proc_nr_inodes,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;file-nr&quot;,</span><br><span class="line">		.data		&#x3D; &amp;files_stat,</span><br><span class="line">		.maxlen		&#x3D; sizeof(files_stat),</span><br><span class="line">		.mode		&#x3D; 0444,</span><br><span class="line">		.proc_handler	&#x3D; proc_nr_files,</span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="如何深入"><a href="#如何深入" class="headerlink" title="如何深入"></a>如何深入</h2><p>比如我知道 page_cache 的大概了，也知道他的作用，但是看代码的时候比较迷茫？</p>
<ol>
<li><p>看看 page_cache 的API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# grep &quot;EXPORT_SYMBOL&quot; .&#x2F;filemap.c -nr</span><br><span class="line">279:EXPORT_SYMBOL(delete_from_page_cache);</span><br><span class="line">377:EXPORT_SYMBOL(filemap_check_errors);</span><br><span class="line">437:EXPORT_SYMBOL(filemap_fdatawrite);</span><br><span class="line">444:EXPORT_SYMBOL(filemap_fdatawrite_range);</span><br><span class="line">459:EXPORT_SYMBOL(filemap_flush);</span><br><span class="line">502:EXPORT_SYMBOL(filemap_range_has_page);</span><br><span class="line">557:EXPORT_SYMBOL(filemap_fdatawait_range);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在.c 文件中搜索trace_ 看看，找到他的静态追踪点 <code>tracepoints</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">amd_server@130ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# grep &quot;trace_&quot; .&#x2F;filemap.c -nr</span><br><span class="line">236:    trace_mm_filemap_delete_from_page_cache(page);</span><br><span class="line">354:            trace_mm_filemap_delete_from_page_cache(pvec-&gt;pages[i]);</span><br><span class="line">683:    trace_filemap_set_wb_err(mapping, eseq);</span><br><span class="line">724:            trace_file_check_and_advance_wb_err(file, old);</span><br><span class="line">902:    trace_mm_filemap_add_to_page_cache(page);</span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm#</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接使用 bpftrace -l 这个根据搜索你的模块，看看有那些比较重要的函数，这些重要函数往<br>往是掌握这个模块的关键，也是经常出现问题需要debug 或者观测的地方，所以 kernel 才会为他<br>设置一个静态追踪点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# sudo bpftrace -l | grep tracepoint: | grep page_cache</span><br><span class="line">tracepoint:filemap:mm_filemap_delete_from_page_cache</span><br><span class="line">tracepoint:filemap:mm_filemap_add_to_page_cache</span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm#</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="4">
<li>stat 统计数据入手<br>类似于 <code>slub</code> 这种内存分配器，内核提供了很多统计数据，可以利用这些事件统计 来跟踪关键代<br>码路径</li>
</ol>
<p>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">enum stat_item &#123;</span><br><span class="line">	ALLOC_FASTPATH,		&#x2F;* Allocation from cpu slab *&#x2F;</span><br><span class="line">	ALLOC_SLOWPATH,		&#x2F;* Allocation by getting a new cpu slab *&#x2F;</span><br><span class="line">	FREE_FASTPATH,		&#x2F;* Free to cpu slab *&#x2F;</span><br><span class="line">	FREE_SLOWPATH,		&#x2F;* Freeing not to cpu slab *&#x2F;</span><br><span class="line"></span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# grep ALLOC_FASTPATH . -nr</span><br><span class="line">.&#x2F;slub.c:2883:          stat(s, ALLOC_FASTPATH);</span><br><span class="line">.&#x2F;slub.c:5390:STAT_ATTR(ALLOC_FASTPATH, alloc_fastpath);</span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# grep ALLOC_SLOWPATH . -nr</span><br><span class="line">.&#x2F;slub.c:2666:  stat(s, ALLOC_SLOWPATH);</span><br><span class="line">.&#x2F;slub.c:5391:STAT_ATTR(ALLOC_SLOWPATH, alloc_slowpath);</span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm#</span><br></pre></td></tr></table></figure>

<p>struct_task 的 context switch 事件计数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct task_struct &#123;</span><br><span class="line">......</span><br><span class="line">	unsigned long			nvcsw;</span><br><span class="line">	unsigned long			nivcsw;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;kernel&#x2F;sched# grep &quot;nivcsw&quot; . -nr</span><br><span class="line">.&#x2F;debug.c:497:          (long long)(p-&gt;nvcsw + p-&gt;nivcsw),</span><br><span class="line">.&#x2F;debug.c:934:  nr_switches &#x3D; p-&gt;nvcsw + p-&gt;nivcsw;</span><br><span class="line">.&#x2F;debug.c:989:  __PS(&quot;nr_involuntary_switches&quot;, p-&gt;nivcsw);</span><br><span class="line">.&#x2F;core.c:4988:  switch_count &#x3D; &amp;prev-&gt;nivcsw;</span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;kernel&#x2F;sched#</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>看到静态追踪点 或者stat统计数据 之后，看看附近的函数，更上层函数等</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-09T02:00:40.000Z" title="1/9/2021, 10:00:40 AM">2021-01-09</time>发表</span><span class="level-item"><time dateTime="2021-01-14T16:53:25.527Z" title="1/15/2021, 12:53:25 AM">2021-01-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">31 分钟读完 (大约4592个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/09/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/systemTap/How%20to%20Use%20system%20Tap/">How to Use system Tap</a></h1><div class="content"><p>SystemTap允许使用者监控Linux系统当前的运行情况，以便进一步分析。这将有助于运维或开发人员缉查bug或性能问题的罪魁祸首。<br>SystemTap提供了一门领域特定语言，使得用户可以编写自定义脚本，调查和监控各种内核函数、系统调用，<br>和其它发生在内核空间的事件。</p>
<p>就此而言，SystemTap不仅仅是个工具，它是一个让你能够自定义内核取证和监控工具的生态系统。</p>
<p>当前版本的SystemTap提供的探测内核空间事件的众多选项，可以在不同版本的内核下使用。<br>然而，SystemTap对探测用户空间事件的支持依赖于内核的支持（需要uprobe机制），而多数内核缺乏这一支持。<br>结果是，仅有部分内核上的SystemTap版本支持用户空间探测。</p>
<h2 id="安装SystemTap"><a href="#安装SystemTap" class="headerlink" title="安装SystemTap"></a>安装SystemTap</h2><p>安装 systemtap 软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@ubuntu: &#x2F;var&#x2F;crash# sudo apt install systemtap</span><br><span class="line">Inspiron-5548@ubuntu: &#x2F;var&#x2F;crash# sudo apt install systemtap-runtime</span><br></pre></td></tr></table></figure>

<p>安装 kernel debug info</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@ubuntu: &#x2F;var&#x2F;crash# sudo apt install systemtap</span><br><span class="line">Inspiron-5548@ubuntu: &#x2F;var&#x2F;crash# sudo apt install systemtap-runtime</span><br></pre></td></tr></table></figure>
<h2 id="SystemTap-可以用来干什么"><a href="#SystemTap-可以用来干什么" class="headerlink" title="SystemTap 可以用来干什么"></a>SystemTap 可以用来干什么</h2><p>SystemTap允许用户仅需编写和重用简单的脚本即可获取Linux繁多的运行数据。通过SystemTap脚本，<br>你可以又好又快地提取数据、过滤数据、汇总数据。诊断复杂的性能问题（或功能问题）再也不是难事。<br>整个SystemTap脚本所做的，无非就是声明感兴趣的事件，然后添加对应的处理程序。当SystemTap脚本运行时，SystemTap会监控声明的事件；<br>一旦事件发生，Linux内核会临时切换到对应的处理程序，完成后再重拾原先的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可供监控的事件种类繁多：进入&#x2F;退出某个函数，定时器到期，会话终止，等等。处理程序由一组SystemTap语句构成，指明事件发生后要做的工作。</span><br><span class="line">其中包括从事件上下文中提取数据，存储到内部变量中，输出结果。</span><br></pre></td></tr></table></figure>

<h2 id="SystemTap-使用"><a href="#SystemTap-使用" class="headerlink" title="SystemTap 使用"></a>SystemTap 使用</h2><h3 id="最简单的一行代码"><a href="#最简单的一行代码" class="headerlink" title="最简单的一行代码"></a>最简单的一行代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@127ubuntu: ~&#x2F;workspace# echo &quot;probe timer.s(1) &#123;exit()&#125;&quot; | sudo stap -v -</span><br><span class="line"></span><br><span class="line">Pass 1: parsed user script and 476 library scripts using 108312virt&#x2F;90968res&#x2F;7440shr&#x2F;83392data kb, in 260usr&#x2F;30sys&#x2F;315real ms.</span><br><span class="line">Pass 2: analyzed script: 1 probe, 1 function, 0 embeds, 0 globals using 109896virt&#x2F;92776res&#x2F;7688shr&#x2F;84976data kb, in 10usr&#x2F;0sys&#x2F;9real ms.</span><br><span class="line">Pass 3: translated to C into &quot;&#x2F;tmp&#x2F;stappbkhvF&#x2F;stap_629b1ee8abda600005ad17f270124c66_947_src.c&quot; using 110032virt&#x2F;92776res&#x2F;7688shr&#x2F;85112data kb, in 0usr&#x2F;0sys&#x2F;1real ms.</span><br><span class="line">Pass 4: compiled C into &quot;stap_629b1ee8abda600005ad17f270124c66_947.ko&quot; in 15530usr&#x2F;2160sys&#x2F;17963real ms.</span><br><span class="line">Pass 5: starting run.</span><br><span class="line">Pass 5: run completed in 20usr&#x2F;30sys&#x2F;1459real ms.</span><br><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace#</span><br></pre></td></tr></table></figure>
<p>可以看出 SystemTap 脚本运行需要结果5个步骤，在加载 SystemTap脚本过程(生成ko)的时候，SystemTap 耗时较多，尤其是CPU资源。</p>
<p>SystemTap脚本运行时，会启动一个对应的SystemTap会话。整个会话大致流程如下：</p>
<p>首先，SystemTap会检查脚本中用到的tapset，确保它们都存在于tapset库中（通常是/usr/share/systemtap/tapset/）。然后SystemTap会把找到的tapset替换成在tapset库中对应的定义。<br>tapset是tap（听诊器）的集合，指一些预定义的SystemTap事件或函数。<a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/tapsets/">完整的tapset列表</a></p>
<p>SystemTap接着会把脚本转化成C代码，运行系统的C编译器编译出一个内核模块。完成这一步的工具包含在systemtap包中<br>SystemTap随即加载该模块，并启用脚本中所有的探针（包括事件和对应的处理程序）。这一步由system-runtime包的staprun完成。<br>每当被监控的事件发生，对应的处理程序就会被执行。<br>一旦SystemTap会话终止，探针会被禁用，内核模块也会被卸载。<br>这一串流程皆始于一个简单的命令行程序：stap。这个程序包揽了SystemTap主要的功能。</p>
<h3 id="脚本如何编写"><a href="#脚本如何编写" class="headerlink" title="脚本如何编写"></a>脚本如何编写</h3><p>在大多数情况下，SystemTap脚本是每个SystemTap会话的基石。SystemTap脚本决定了需要收集的信息类型，也决定了对收集到的信息的处理方式。<br>SystemTap脚本由两部分组成：事件和处理程序。<br>一旦SystemTap会话准备就绪，SystemTap会监控操作系统中特定的事件，并在事件发生的时候触发对应的处理程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个事件和它对应的处理程序合称探针。一个SystemTap脚本可以有多个探针。 一个探针的处理程序部分通常称之为探针主体（probe body）</span><br></pre></td></tr></table></figure>

<p>与应用开发的方式类比，使用事件和处理程序就像在程序的特定位置插入打日志的语句。每当程序运行时，这些日志会帮助你查看程序执行的流程。<br>但是SystemTasp脚本允许你在无需重新编译代码，即可插入检测指令，而且处理程序也不限于单纯地打印数据。<br>事件会触发对应的处理程序；对应的处理程序记录下感兴趣的数据，并以你指定的格式输出。</p>
<p>SystemTap脚本的后缀是.stp，并以这样的语句表示一个探针：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">probe   event &#123;statements&#125;</span><br></pre></td></tr></table></figure>

<p>SystemTap支持给一个探针指定多个事件；每个事件以逗号隔开。<br>如果给某一个探针指定了多个事件，只要其中一个事件发生，SystemTap就会执行对应的处理程序。<br>每个探针有自己对应的语句块。语句块由花括号 {} 括住，包含事件发生时需要执行的所有语句。<br>SystemTap会顺序执行这些语句；语句间通常不需要特殊的分隔符或终止符。</p>
<p>SystemTap还允许你编写函数来提取探针间公共的逻辑。<br>所以，与其在多个探针间复制粘贴重复的语句，你不如把它们放入函数中，就像函数调用一样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function function_name(arguments) &#123;statements&#125;</span><br><span class="line"></span><br><span class="line">probe event &#123;function_name(arguments)&#125;</span><br></pre></td></tr></table></figure>
<p>当探针被触发时，function_name中的语句会被执行。arguments是传递给函数的可选的入参。</p>
<h3 id="SystemTap-事件"><a href="#SystemTap-事件" class="headerlink" title="SystemTap 事件"></a>SystemTap 事件</h3><p>我们还需要了解SystemTap 事件，这里主要分为 <code>同步事件</code> 和 <code>异步事件</code>。</p>
<h4 id="同步事件"><a href="#同步事件" class="headerlink" title="同步事件"></a>同步事件</h4><p>同步事件会在任意进程执行到内核特定位置时触发。你可以用它来作为其它事件的参照点，毕竟同步事件有着清晰的上下文信息。<br>包括：</p>
<p><code>syscall.system_call</code></p>
<p>进入名为system_call的系统调用。如果想要监控的是退出某个系统调用的事件，在后面添加.return。举个例子，要想监控进入和退出系统调用close的事件，应该使用syscall.close和syscall.close.return。</p>
<p><code>vfs.file_operation</code></p>
<p>进入虚拟文件系统（VFS）名为file_operation的文件操作。跟系统调用事件一样，在后面添加.return可以监控对应的退出事件。 译注：file_operation取值的范畴，取决于当前内核中struct file_operations的定义的操作.</p>
<p><code>kernel.function(&quot;function&quot;)</code></p>
<p>进入名为function的内核函数。举个例子，kernel.function(“sys_open”)即内核函数sys_open被调用时所触发的事件。同样，kernel.function(“sys_open”).return会在sys_open函数调用返回时被触发。</p>
<p>在定义探测事件时，可以使用像*这样的通配符。你也可以用内核源码文件名限定要跟踪的函数。看下面的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">probe kernel.function(&quot;*@net&#x2F;socket.c&quot;) &#123; &#125;</span><br><span class="line">probe kernel.function(&quot;*@net&#x2F;socket.c&quot;).return &#123; &#125;</span><br></pre></td></tr></table></figure>


<p><code>kernel.trace(&quot;tracepoint&quot;)</code><br>到达名为tracepoint的静态内核探测点（tracepoint）。较新的内核（&gt;= 2.6.30）包含了特定事件的检测代码。这些事件一般会被标记成静态内核探测点。一个例子是，kernel.trace(“kfree_skb”)表示内核释放了一个网络缓冲区的事件。（译注：想知道当前内核设置了哪些静态内核探测点吗？你需要运行sudo perf list。）</p>
<p><code>module(&quot;module&quot;).function(&quot;function&quot;)</code></p>
<p>进入指定模块module的函数function。举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">probe module(&quot;ext3&quot;).function(&quot;*&quot;) &#123; &#125;</span><br><span class="line">probe module(&quot;ext3&quot;).function(&quot;*&quot;).return &#123; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="异步事件"><a href="#异步事件" class="headerlink" title="异步事件"></a>异步事件</h4><p>异步事件跟特定的指令或代码的位置无关。 这部分事件主要包含计数器、定时器和其它类似的东西。</p>
<p><code>begin</code></p>
<p>SystemTap会话的启动事件，会在脚本开始时触发。</p>
<p><code>end</code></p>
<p>SystemTap会话的结束事件，会在脚本结束时触发。</p>
<p><code>timer events</code></p>
<p>用于周期性执行某段处理程序。举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">probe timer.s(4) &#123; printf(&quot;hello world\n&quot;) &#125;</span><br></pre></td></tr></table></figure>

<p>上面的例子中，每隔4秒就会输出hello world。还可以使用其它规格的定时器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">timer.ms(milliseconds)</span><br><span class="line">timer.us(microseconds)</span><br><span class="line">timer.ns(nanoseconds)</span><br><span class="line">timer.hz(hertz)</span><br><span class="line">timer.jiffies(jiffies)</span><br></pre></td></tr></table></figure>

<p>定时事件总是跟其它事件搭配使用。其它事件负责收集信息，而定时事件定期输出当前状况，让你看到数据随时间的变化情况。</p>
<h3 id="SystemTap-处理程序"><a href="#SystemTap-处理程序" class="headerlink" title="SystemTap 处理程序"></a>SystemTap 处理程序</h3><p>有了事件之后，我们还需要在事件发生之后进行处理。</p>
<p>example1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">probe begin</span><br><span class="line">&#123;</span><br><span class="line">  printf (&quot;hello world\n&quot;)</span><br><span class="line">  exit ()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SystemTap脚本会一直运行，直到执行了exit()函数。如果你想中途退出一个脚本，可以用Ctrl+c中断。<br>这是一个异步事件 <code>begin</code> 之后开始打印 一个字符串.</p>
<p><code>printf</code> 是一个标准输出函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf (&quot;format string\n&quot;, arguments)</span><br></pre></td></tr></table></figure>


<p>example2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">probe syscall.open</span><br><span class="line">&#123;</span><br><span class="line">  printf (&quot;%s(%d) open\n&quot;, execname(), pid())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo &#39; probe syscall.open &#123;  printf (&quot;%s(%d) open\n&quot;, execname(), pid()) &#125;&#39; | sudo stap -v -</span><br></pre></td></tr></table></figure>
<p>example2中 SystemTap会在每次open被调用时，输出调用程序的名字和PID。</p>
<p>该探针输出的结果看上去会是这样(not in zsh, in bash)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~&#x2F;workspace$ echo &#39; probe syscall.open &#123;  printf (&quot;%s(%d) open\n&quot;, execname(), pid()) &#125;&#39; | sudo stap -v -</span><br><span class="line">Pass 1: parsed user script and 476 library scripts using 108308virt&#x2F;90696res&#x2F;7172shr&#x2F;83388data kb, in 290usr&#x2F;40sys&#x2F;364real ms.</span><br><span class="line">Pass 2: analyzed script: 4 probes, 5 functions, 97 embeds, 4 globals using 110292virt&#x2F;93060res&#x2F;7724shr&#x2F;85372data kb, in 230usr&#x2F;330sys&#x2F;575real</span><br><span class="line"> ms.</span><br><span class="line">Pass 3: using cached &#x2F;root&#x2F;.systemtap&#x2F;cache&#x2F;4c&#x2F;stap_4cd2c557b5457e5f955c640275432033_64778.c</span><br><span class="line">Pass 4: using cached &#x2F;root&#x2F;.systemtap&#x2F;cache&#x2F;4c&#x2F;stap_4cd2c557b5457e5f955c640275432033_64778.ko</span><br><span class="line">Pass 5: starting run.</span><br><span class="line">rg(25671) open</span><br><span class="line">rg(25671) open</span><br><span class="line">rg(25671) open</span><br><span class="line">rg(25671) open</span><br><span class="line">rg(25671) open</span><br></pre></td></tr></table></figure>

<p>下面是常用的 SystemTap 内建函数：</p>
<p><code>tid()</code></p>
<p>当前的tid（thread id）。</p>
<p><code>uid()</code></p>
<p>当前的uid。</p>
<p><code>cpu()</code></p>
<p>当前的CPU号</p>
<p><code>gettimeofday_s()</code></p>
<p>自epoch以来的秒数</p>
<p><code>ctime()</code></p>
<p>将上一个函数返回的秒数转化成时间字符串</p>
<p><code>pp()</code></p>
<p>返回描述当前处理的探测点的字符串</p>
<p><code>thread_indent()</code></p>
<p><code>name</code></p>
<p>返回系统调用的名字。这个变量只能在syscall.system_call触发的处理程序中使用。</p>
<p><code>target()</code></p>
<p>当你通过stap script -x PID或stap script -c command来执行某个脚本script时，target()会返回你指定的PID或命令名。举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">probe syscall.* &#123;</span><br><span class="line">  if (pid() &#x3D;&#x3D; target())</span><br><span class="line">    printf(&quot;%s\n&quot;, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo &#39; probe syscall.* &#123; if (pid() &#x3D;&#x3D; target()) printf(&quot;%s\n&quot;, name) &#125;&#39; | sudo stap -v -</span><br></pre></td></tr></table></figure>
<p>这个 SystemTap 脚本使用了通配符 probe了所以系统调用，在对脚本解析，编译成为 kernel module ko的时候尤其耗时，<br>在我 I5 5200U的机器上居然准备工作做了进1min…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">top - 12:38:07 up 12:53,  2 users,  load average: 2.56, 1.77, 1.14</span><br><span class="line">任务: 277 total,   5 running, 271 sleeping,   0 stopped,   1 zombie</span><br><span class="line">%Cpu(s): 10.0 us, 17.6 sy,  0.0 ni, 66.9 id,  0.0 wa,  0.0 hi,  5.5 si,  0.0 st</span><br><span class="line">MiB Mem :   3658.2 total,    196.4 free,   2043.1 used,   1418.8 buff&#x2F;cache</span><br><span class="line">MiB Swap:   2048.0 total,   1572.1 free,    475.9 used.    986.8 avail Mem</span><br><span class="line"></span><br><span class="line"> 进程号 USER      PR  NI    VIRT    RES    SHR    %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">  54775 root      20   0  171592 154320  18248 R  99.7   4.1   1:05.72 stap</span><br><span class="line">    932 ubuntu    20   0 1750472  40364  14900 S   3.7   1.1  11:16.15 Xorg</span><br><span class="line">   1279 ubuntu    20   0 4777288 218332  57988 S   3.0   5.8  12:57.76 gnome-shell</span><br><span class="line">   2458 ubuntu    20   0 4633228 103048  65556 R   3.0   2.8   0:10.23 chrome</span><br><span class="line">   1747 ubuntu    20   0  987308  43280  31604 S   1.7   1.2   0:46.33 gnome-terminal-</span><br><span class="line">   2371 ubuntu    20   0 1342876 232676  99800 S   0.7   6.2   8:23.72 chrome</span><br><span class="line">     18 root      20   0       0      0      0 S   0.3   0.0   0:01.14 ksoftirqd&#x2F;1</span><br><span class="line">     30 root      20   0       0      0      0 S   0.3   0.0   0:00.87 ksoftirqd&#x2F;3</span><br><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;drivers#</span><br></pre></td></tr></table></figure>
<p>输出是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~&#x2F;workspace$ echo &#39; probe syscall.* &#123; if (pid() &#x3D;&#x3D; target()) printf(&quot;%s\n&quot;, name) &#125;&#39; | sudo stap -v -x 2371 -</span><br><span class="line">Pass 1: parsed user script and 476 library scripts using 108312virt&#x2F;90872res&#x2F;7344shr&#x2F;83392data kb, in 510usr&#x2F;40sys&#x2F;559real ms.</span><br><span class="line">qWARNING: cross-file global variable reference to identifier &#39;syscall_string_trunc&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;syscalls_cfg_trunc.s</span><br><span class="line">tp:3:8 from: identifier &#39;syscall_string_trunc&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;sysc_add_key.stp:19:59</span><br><span class="line"> source:                         user_buffer_quoted(payload_uaddr, plen, syscall_string_trunc),</span><br><span class="line">                                                                         ^</span><br><span class="line">        in expansion of macro: operator &#39;@_SYSCALL_ADD_KEY_ARGSTR&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;sysc_add_key.stp:72:2</span><br><span class="line"> source:        @_SYSCALL_ADD_KEY_ARGSTR</span><br><span class="line">                ^</span><br><span class="line">WARNING: cross-file global variable reference to identifier &#39;syscall_string_trunc&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;syscalls_cfg_trunc.st</span><br><span class="line">p:3:8 from: identifier &#39;syscall_string_trunc&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;sysc_mount.stp:31:46</span><br><span class="line"> source:        data &#x3D; user_string_n_quoted(pointer_arg(5), syscall_string_trunc)</span><br><span class="line">                                                            ^</span><br><span class="line">WARNING: cross-file global variable reference to identifier &#39;syscall_string_trunc&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;syscalls_cfg_trunc.st</span><br><span class="line">p:3:8 from: identifier &#39;syscall_string_trunc&#39; at :23:49</span><br><span class="line"> source:        buf_str &#x3D; user_buffer_quoted(buf_uaddr, count, syscall_string_trunc)</span><br><span class="line">                                                               ^</span><br><span class="line">        in expansion of macro: operator &#39;@_SYSCALL_WRITE_REGARGS&#39; at &#x2F;usr&#x2F;share&#x2F;systemtap&#x2F;tapset&#x2F;linux&#x2F;sysc_write.stp:100:2</span><br><span class="line"> source:        @_SYSCALL_WRITE_REGARGS</span><br><span class="line">                ^</span><br><span class="line">Pass 2: analyzed script: 853 probes, 29 functions, 100 embeds, 5 globals using 129252virt&#x2F;113636res&#x2F;9172shr&#x2F;104332data kb, in 35560usr&#x2F;79740s</span><br><span class="line">ys&#x2F;116322real ms.</span><br><span class="line">Pass 3: using cached &#x2F;root&#x2F;.systemtap&#x2F;cache&#x2F;e2&#x2F;stap_e2b35608bd8c0499c68f451dc8b09a85_432536.c</span><br><span class="line">Pass 4: using cached &#x2F;root&#x2F;.systemtap&#x2F;cache&#x2F;e2&#x2F;stap_e2b35608bd8c0499c68f451dc8b09a85_432536.ko</span><br><span class="line">Pass 5: starting run.</span><br><span class="line">recvmsg</span><br><span class="line">write</span><br><span class="line">write</span><br><span class="line">epoll_wait</span><br><span class="line">epoll_wait</span><br><span class="line">epoll_wait</span><br><span class="line">recvmsg</span><br><span class="line">read</span><br><span class="line">sendto</span><br><span class="line">futex</span><br><span class="line">recvmsg</span><br><span class="line">recvmsg</span><br><span class="line">recvmsg</span><br><span class="line">poll</span><br><span class="line">recvmsg</span><br><span class="line">recvmsg</span><br></pre></td></tr></table></figure>



<h3 id="SystemTap-处理程序的基本结构"><a href="#SystemTap-处理程序的基本结构" class="headerlink" title="SystemTap 处理程序的基本结构"></a>SystemTap 处理程序的基本结构</h3><p>SystemTap 在处理程序中 它们的语法基本上类似于C或awk。</p>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p>处理程序里面当然可以使用变量，你所需的不过是给它取个好名字，把函数或表达式的值赋给它，然后就可以使用它了。<br>SystemTap可以自动判定变量的类型。举个例子，如果你用gettimeofday_s()给变量foo赋值，那么foo就是数值类型的，<br>可以在printf()中通过%d输出。</p>
<p>变量默认只能在其所定义的探针内可用。这意味着变量的生命周期仅仅是处理程序的某次运行。<br>不过你也可以在探针外定义变量，并使用global修饰它们，这样就能在探针间共享变量了。 ⁠</p>
<p>example1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">global count_jiffies, count_ms</span><br><span class="line">probe timer.jiffies(100) &#123; count_jiffies ++ &#125;</span><br><span class="line">probe timer.ms(100) &#123; count_ms ++ &#125;</span><br><span class="line">probe timer.ms(12345)</span><br><span class="line">&#123;</span><br><span class="line">  hz&#x3D;(1000*count_jiffies) &#x2F; count_ms</span><br><span class="line">  printf (&quot;jiffies:ms ratio %d:%d &#x3D;&gt; CONFIG_HZ&#x3D;%d\n&quot;,</span><br><span class="line">    count_jiffies, count_ms, hz)</span><br><span class="line">  exit ()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>example1 中 timer-jiffies.stp 通过累加jiffies和milliseconds，来求出内核的CONFIG_HZ配置。<br>global语句使得count_jiffies和count_ms在每个探针中可用。</p>
<h4 id="目标变量-Target-Variables"><a href="#目标变量-Target-Variables" class="headerlink" title="目标变量(Target Variables)"></a>目标变量(Target Variables)</h4><p>跟内核代码相关的事件，如kernel.function(“function”)和kernel.statement(“statement”)，<br>允许使用目标变量获取这部分代码中可访问到的变量的值。<br>你可以使用-L选项来列出特定探测点下可用的目标变量。<br>如果已经安装了内核调试信息，你可以通过这个命令获取vfs_read中可用的目标变量</p>
<p>由于 我当前笔记本环境问题，暂时没法使用这个，会报错，后续补充</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:&#x2F;etc&#x2F;apt$ sudo stap -L &#39;kernel.function(&quot;vfs_read&quot;)&#39;</span><br><span class="line">Tip: &#x2F;usr&#x2F;share&#x2F;doc&#x2F;systemtap&#x2F;README.Debian should help you get started.</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:&#x2F;etc&#x2F;apt$ sudo stap -e &#39;probe kernel.function(&quot;vfs_read&quot;) &#123;</span><br><span class="line">&gt;            printf (&quot;current files_stat max_files: %d\n&quot;,</span><br><span class="line">&gt;                    @var(&quot;[email protected]&#x2F;file_table.c&quot;)-&gt;max_files);</span><br><span class="line">&gt;            exit(); &#125;&#39;</span><br><span class="line">semantic error: while resolving probe point: identifier &#39;kernel&#39; at &lt;input&gt;:1:7</span><br><span class="line">        source: probe kernel.function(&quot;vfs_read&quot;) &#123;</span><br><span class="line">                      ^</span><br><span class="line"></span><br><span class="line">semantic error: missing x86_64 kernel&#x2F;module debuginfo [man warning::debuginfo] under &#39;&#x2F;lib&#x2F;modules&#x2F;5.4.0-58-generic&#x2F;build&#39;</span><br><span class="line"></span><br><span class="line">Pass 2: analysis failed.  [man error::pass2]</span><br><span class="line">Tip: &#x2F;usr&#x2F;share&#x2F;doc&#x2F;systemtap&#x2F;README.Debian should help you get started.</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:&#x2F;etc&#x2F;apt$</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;drivers# stap -l &#39;syscall.*&#39;</span><br><span class="line">syscall.accept</span><br><span class="line">syscall.accept4</span><br><span class="line">syscall.accesso</span><br><span class="line">syscall.acct</span><br><span class="line">syscall.add_key</span><br><span class="line">syscall.adjtimex</span><br><span class="line">syscall.alarm</span><br><span class="line">syscall.arch_prctl</span><br></pre></td></tr></table></figure>


<h4 id="整齐打印目标变量（Pretty-Printing-Target-Variables）"><a href="#整齐打印目标变量（Pretty-Printing-Target-Variables）" class="headerlink" title="整齐打印目标变量（Pretty Printing Target Variables）"></a>整齐打印目标变量（Pretty Printing Target Variables）</h4><p>某些场景中，我们可能需要输出当前可访问的各种变量，以便于记录底层的变化。SystemTap提供了一些操作，可以生成描述特定目标变量的字符串：</p>
<p><code>$$vars</code></p>
<p>输出作用域内每个变量的值。等价于sprintf(“parm1=%x … parmN=%x var1=%x … varN=%x”, parm1, …, parmN, var1, …, varN)。如果变量的值在运行时找不到，输出=?。</p>
<p><code>$$locals</code></p>
<p>同<code>$$vars</code>，只输出本地变量。</p>
<p><code>$$parms</code></p>
<p>同<code>$$vars</code>，只输出函数入参。</p>
<p><code>$$return</code></p>
<p>仅在带return的探针中可用。如果被监控的函数有返回值，它等价于sprintf(“return=%x”, $return)，否则为空字符串。</p>
<h4 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h4><p>有些时候，你写的SystemTap脚本较为复杂，可能需要用上条件语句。SystemTap支持C风格的条件语句，另外还支持foreach (VAR in ARRAY) {}形式的遍历。</p>
<h4 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h4><p>通过$或@加个数字的形式可以访问对应位置的命令行参数。用$会把用户输入当作整数，用@会把用户输入当作字符串。</p>
<p>probe kernel.function(@1) { }<br>probe kernel.function(@1).return { }<br>上面的脚本期望用户把要监控的函数作为命令行参数传递进来。你可以让脚本接受多个命令行参数，分别命名为@1，@2等等，按用户输入的次序逐个对应。</p>
<h2 id="Tapsets"><a href="#Tapsets" class="headerlink" title="Tapsets"></a>Tapsets</h2><p>tapsets是一些包含常用的探针和函数的内置脚本，你可以在SystemTap脚本中复用它们。</p>
<p>当用户运行一个SystemTap脚本时，SystemTap会检测脚本中的事件和处理程序，并在翻译脚本成C代码之前，加载用到的tapset。<br>就像SystemTap脚本一样，tapset的拓展名也是.stp。<br>默认情况下tapset位于/usr/share/systemtap/tapset/。</p>
<p>跟SystemTap脚本不同的是，tapset不能被直接运行；它只能作为库使用。<br>tapset库让用户能够在更高的抽象层次上定义事件和函数。<br>tapset提供了一些常用的内核函数的别名，这样用户就不需要记住完整的内核函数名了（尤其是有些函数名可能会因内核版本的不同而不同）。<br>另外tapset也提供了常用的辅助函数，比如之前我们见过的thread_indent()。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>SystemTap 使用过程中发现 他解析编译极其慢，很耗费 CPU资源，最好做到一次解析编译模块，可以到处<br>部署，实际SystemTap 也已经支持了这样的做法。</p>
<p>参考<a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/2_3_RunningSystemTapScripts.html">SystemTap 内核文档</a></p>
<p>参考 <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html-single/systemtap_beginners_guide/index">RedHat systemTap 文档</a></p>
<p>参考 <a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/index.html">文档</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-07T12:00:40.000Z" title="1/7/2021, 8:00:40 PM">2021-01-07</time>发表</span><span class="level-item"><time dateTime="2021-01-14T16:53:25.527Z" title="1/15/2021, 12:53:25 AM">2021-01-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">4 分钟读完 (大约526个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/07/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/tools/vmtouch%20%E8%A7%82%E6%B5%8B%E6%96%87%E4%BB%B6page%20cache/">vmtouch 观测文件page cache</a></h1><div class="content"><h2 id="vmtouch-介绍"><a href="#vmtouch-介绍" class="headerlink" title="vmtouch 介绍"></a>vmtouch 介绍</h2><p><code>便携式文件系统缓存诊断和控制</code> 是 <code>vmtouch</code> 作者对于vmtouch的的定义。<br>首先他可以很方便的知道某一个文件当前有多少在 kernel memory 里面作为<br><code>pagecache</code> 存在。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch haha</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 11584&#x2F;1024000  45M&#x2F;3G  1.13%</span><br><span class="line">         Elapsed: 0.031335 seconds</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ cat haha</span><br><span class="line">^C</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch haha</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 36800&#x2F;1024000  143M&#x2F;3G  3.59%</span><br><span class="line">         Elapsed: 0.033472 seconds</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br></pre></td></tr></table></figure>

<p>明显可以看到在经过 <code>cat</code> 访问之后 文件更多部分被读入 memory，作为 pagecache。</p>
<p>作者对于他的功能介绍：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 发现你的操作系统正在缓存哪些文件</span><br><span class="line">2. 告诉操作系统缓存或清除某些文件或文件区域</span><br><span class="line">3. 将文件锁定在内存中，这样操作系统就不会删除它们</span><br><span class="line">4. 在服务器故障转移时保留虚拟内存配置文件</span><br><span class="line">5. 保持“热备”文件服务器</span><br><span class="line">6. 绘制文件系统缓存随时间的使用情况</span><br><span class="line">7. 维护缓存使用的“软配额”</span><br></pre></td></tr></table></figure>



<h2 id="vmtouch-使用"><a href="#vmtouch-使用" class="headerlink" title="vmtouch 使用"></a>vmtouch 使用</h2><h3 id="控制增加-pagecache"><a href="#控制增加-pagecache" class="headerlink" title="控制增加 pagecache"></a>控制增加 pagecache</h3><p>可以将整个文件读入内存，其实我们通过访问这个文件（从头到尾）也可以做到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch -vt haha</span><br><span class="line">haha</span><br><span class="line">[OOo                                                         ] 44737&#x2F;1024000</span><br><span class="line">[OOOOOo                                                      ] 90849&#x2F;1024000</span><br><span class="line">[OOOOOOOOo                                                   ] 150209&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOo                                               ] 215937&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOo                                            ] 271489&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOo                                        ] 326305&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOo                                      ] 370721&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOo                                   ] 414305&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOo                                ] 469697&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                             ] 524289&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                          ] 577153&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                     ] 652481&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                  ] 705953&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo               ] 757281&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo            ] 810593&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo        ] 876769&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo      ] 920545&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo  ] 973473&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO] 1024000&#x2F;1024000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">   Touched Pages: 1024000 (3G)</span><br><span class="line">         Elapsed: 9.4376 seconds</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br></pre></td></tr></table></figure>


<h3 id="控制减少-pagecache"><a href="#控制减少-pagecache" class="headerlink" title="控制减少 pagecache"></a>控制减少 pagecache</h3><p>evict a file from memory<br>将一个文件的pagecache 从内存中移除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch -ve haha</span><br><span class="line">Evicting haha</span><br><span class="line"></span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">   Evicted Pages: 1024000 (3G)</span><br><span class="line">         Elapsed: 0.085208 seconds</span><br></pre></td></tr></table></figure>

<p>与<code>drop cache</code>不同，<code>vmtouch</code>做到了精准控制单个文件page_cache的效果，而 drop cache不行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-Inspiron-5548:&#x2F;home&#x2F;ubuntu# echo 1 &gt;  &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches</span><br><span class="line">root@ubuntu-Inspiron-5548:&#x2F;home&#x2F;ubuntu# echo 3 &gt;  &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches</span><br></pre></td></tr></table></figure>

<h3 id="保持文件在pagecache中"><a href="#保持文件在pagecache中" class="headerlink" title="保持文件在pagecache中"></a>保持文件在pagecache中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch -dl haha</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch: FATAL: mlock: haha (Cannot allocate memory)</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br></pre></td></tr></table></figure>
<p>(内存4G，文件4G 是没办法将文件常驻在 内存中的)<br>从此报错信息可以看出 <code>vmtouch</code> 也是通过 <code>mlock</code> 系统调用来实现 文件内容 或者 文件目录内容锁定在 内存中的</p>
<p><a target="_blank" rel="noopener" href="https://hoytech.com/vmtouch/">vmtouch 作者的文章</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-07T02:00:40.000Z" title="1/7/2021, 10:00:40 AM">2021-01-07</time>发表</span><span class="level-item"><time dateTime="2021-01-14T16:53:25.527Z" title="1/15/2021, 12:53:25 AM">2021-01-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">1 分钟读完 (大约143个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/07/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/systemTap/examples/SystemTap%20examples/">SystemTap examples</a></h1><div class="content"><p>SystemTap脚本集锦<br>本章列举了若干可用于监控和调查内核子系统的SystemTap脚本。所有这些示例都能在 <code>centos</code>的<br> <code>/usr/share/systemtap/testsuite/systemtap.examples/</code>下找到。</p>
<h2 id="SystemTap脚本集锦"><a href="#SystemTap脚本集锦" class="headerlink" title="SystemTap脚本集锦"></a>SystemTap脚本集锦</h2><p><a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/5_UsefulSystemTapScripts.html">SystemTap脚本集锦</a></p>
<h2 id="解读错误信息"><a href="#解读错误信息" class="headerlink" title="解读错误信息"></a>解读错误信息</h2><p><a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/6_UnderstandingSystemTapErrors.html">解读错误信息</a></p>
<p> 参考<a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/2_3_RunningSystemTapScripts.html">SystemTap 内核文档</a></p>
<p>参考 <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html-single/systemtap_beginners_guide/index">RedHat systemTap 文档</a></p>
<p>参考 <a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/index.html">文档</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-19T06:47:40.000Z" title="12/19/2020, 2:47:40 PM">2020-12-19</time>发表</span><span class="level-item"><time dateTime="2021-01-14T16:53:25.527Z" title="1/15/2021, 12:53:25 AM">2021-01-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/server/">server</a></span><span class="level-item">11 分钟读完 (大约1609个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/19/qemu/%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEqemu/">我的服务器配置</a></h1><div class="content"><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><p>我之前一直是使用 <code>笔记本windows+ubuntu虚拟机</code> 的开发配置，但是这样有几个限制：</p>
<ol>
<li>ubuntu 虚拟机比较耗费资源，一到夏天笔记本风扇狂转，影响体验</li>
<li>只在本地使用没有问题，但是有时候还想在公司或者出差的时候使用</li>
</ol>
<p>基于以上种种限制，我就搞了腾讯云的服务器，<code>1H2G1M3Y</code> 价格好像是 300￥，还是比较便宜的。</p>
<p>但是直到前些天才真正用起来，主要用于编译和测试，但是一直有几个缺点：</p>
<ol>
<li>云服务器基本都是基于 KVM的，然后他还禁止了租户继续使用KVM进行虚拟化</li>
<li>云服务器禁止了 邮件服务的端口，导致无法收发邮件</li>
<li>云服务器在低配置（1核心2G）下，费用较低，一旦配置升高，价格急剧上升，性价比不高</li>
<li>1核2G用来编译效率太低</li>
<li>云服务器带宽资源比较昂贵，在本地连接云服务器的时候经常会需要连接好久才能连接上</li>
</ol>
<p>考虑最近AMD cpu很强势，便配置了一个AMD 4650G的ITX机器，用作我自己的服务器。</p>
<h2 id="物理服务器安装"><a href="#物理服务器安装" class="headerlink" title="物理服务器安装"></a>物理服务器安装</h2><p>我直接选择了 ubuntu20.04.1 版本，通过UltraISO 工具将iso写入SD卡中，然后开启U盘启动，安装ubuntu。<br>还需要通过 主板 BIOS开启 KVM，通过CPU设置开启 SVM:<br>如果不开启KVM直接用qemu开启 ubuntu虚拟机，效率比开启KVM虚拟机要慢 50倍左右，这也是我不想用 云服务器的原因。<br>换用<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">清华源</a></p>
<h2 id="物理服务器安装qemu-ubuntu虚拟机"><a href="#物理服务器安装qemu-ubuntu虚拟机" class="headerlink" title="物理服务器安装qemu-ubuntu虚拟机"></a>物理服务器安装qemu-ubuntu虚拟机</h2><p>可以参考文章:<a target="_blank" rel="noopener" href="https://spyff.github.io/linux/2018/07/20/qemu-vm/">qemu起ubuntu server</a></p>
<p>在云服务器上按着文章成功配置了qemu虚拟机，但是在服务器上一直是失败的，原因就是起了服务器之后一直无法登陆。所以最后我用了桌面版本ubuntu 20.04.1，而不是 ubuntu server。</p>
<ol>
<li><p>下载 ubuntu iso</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu-releases&#x2F;20.04.1&#x2F;ubuntu-20.04.1-desktop-amd64.iso</span><br><span class="line">mv ubuntu-20.04.1-desktop-amd64.iso ubuntu.iso</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建磁盘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -q -f qcow2 stable_ubuntu.img 32G</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装虚拟机<br>这一步尽量不要用 ssh做，直接在物理机器上搞比较快，第一次安装需要 -cdrom指定iso文件位置，后面就不需要了。在安装的之后需要指定 用户名密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装</span><br><span class="line">sudo qemu-system-x86_64 ubuntu.img -m 1024 -cdrom ubuntu.iso --enable-kvm</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动虚拟机<br>启动虚拟机分为两种:<br>a. 直接启动原来内核的虚拟机(可以直接联网，下载软件)<br>也可以ssh链接： ssh -v <a href="mailto:&#114;&#x6c;&#107;&#64;&#x31;&#50;&#x37;&#x2e;&#48;&#x2e;&#48;&#46;&#49;">&#114;&#x6c;&#107;&#64;&#x31;&#50;&#x37;&#x2e;&#48;&#x2e;&#48;&#46;&#49;</a> -p 2222</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">    -hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;stable_ubuntu.img \</span><br><span class="line">    -smp 4 \</span><br><span class="line">    -m 4096 \</span><br><span class="line">    --enable-kvm \</span><br><span class="line">    -net nic \</span><br><span class="line">    -net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">    --nographic \</span><br><span class="line">    -fsdev local,id&#x3D;fs1,path&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share,security_model&#x3D;none \</span><br><span class="line">    -device virtio-9p-pci,fsdev&#x3D;fs1,mount_tag&#x3D;host_share</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>b. 用新kernel代替 stable_ubuntu.img中 的 kernel(替代内核)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">    -kernel &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;stable&#x2F;bzImage \</span><br><span class="line">    -hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;stable_ubuntu.img \</span><br><span class="line">    -append &quot;root&#x3D;&#x2F;dev&#x2F;sda5 console&#x3D;ttyS0&quot; \</span><br><span class="line">    -smp 4 \</span><br><span class="line">    -m 4096 \</span><br><span class="line">    --enable-kvm \</span><br><span class="line">    -net nic \</span><br><span class="line">    -net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">    --nographic \</span><br><span class="line">    -fsdev local,id&#x3D;fs1,path&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share,security_model&#x3D;none \</span><br><span class="line">    -device virtio-9p-pci,fsdev&#x3D;fs1,mount_tag&#x3D;host_share</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>至于开机启动都是 /etc/rc.local 里面配置<br><a target="_blank" rel="noopener" href="https://gitee.com/shshshsh/cloud_server_shell">https://gitee.com/shshshsh/cloud_server_shell</a></p>
</li>
<li><p>test 相关<br>a. ltp（linux kernel test project）：linux内核测试 project 编译安装，运行<br><a target="_blank" rel="noopener" href="https://github.com/linux-test-project/ltp">https://github.com/linux-test-project/ltp</a></p>
</li>
</ol>
<p>b. mmetst 可以测试 linux kernel 不同版本之间性能差异<br><a target="_blank" rel="noopener" href="https://github.com/gormanm/mmtests">https://github.com/gormanm/mmtests</a><br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/820823/">https://lwn.net/Articles/820823/</a><br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/463339/">https://lwn.net/Articles/463339/</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Linux_Everything/article/details/106485101">https://blog.csdn.net/Linux_Everything/article/details/106485101</a></p>
<p>c. lkp （linux kernel performance）:是 intel发起的一个kernel performance test项目<br><a target="_blank" rel="noopener" href="https://github.com/fengguang/lkp-">https://github.com/fengguang/lkp-</a><br><a target="_blank" rel="noopener" href="https://01.org/lkp">https://01.org/lkp</a><br><a target="_blank" rel="noopener" href="https://01.org/blogs/jdu1/2017/lkp-tests-linux-kernel-performance-test-and-analysis-tool">https://01.org/blogs/jdu1/2017/lkp-tests-linux-kernel-performance-test-and-analysis-tool</a><br><a target="_blank" rel="noopener" href="https://github.com/sammcj/kernel-ci">https://github.com/sammcj/kernel-ci</a><br><a target="_blank" rel="noopener" href="http://hejq.me/2014/10/30/lkp-tests-notes/">http://hejq.me/2014/10/30/lkp-tests-notes/</a><br><a target="_blank" rel="noopener" href="https://libraries.io/github/openthos/lkp-analysis">https://libraries.io/github/openthos/lkp-analysis</a></p>
<ol start="7">
<li>学习kvm<br><a target="_blank" rel="noopener" href="https://www.linux-kvm.org/page/Kvmtools">https://www.linux-kvm.org/page/Kvmtools</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/leoufung/article/details/48781119">https://blog.csdn.net/leoufung/article/details/48781119</a><br>git://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git</li>
</ol>
<h2 id="远程访问本地服务器"><a href="#远程访问本地服务器" class="headerlink" title="远程访问本地服务器"></a>远程访问本地服务器</h2><p>由于本地服务器其实是没有固定ip的，所以需要一台固定ip的服务器做中转，<br>这样才能从任何地方远程访问到我的物理服务器，正好有一个腾讯云服务器，就充当了这个角色。</p>
<p>我使用的是 nps 这个开源代理工具，相比于其他工具来说，配置简单，直接在网页上就可以配置<br>参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/102138783">超好用轻量级NPS内网穿透</a></p>
<h3 id="NPS问题"><a href="#NPS问题" class="headerlink" title="NPS问题"></a>NPS问题</h3><ol>
<li><p>稳定性：<br>这个我其实已经使用了超过1个月了，机器都没重启过，服务都还正常，对于个人使用来说完全足够了</p>
</li>
<li><p>带宽<br>由于我的腾讯云服务器带宽了 <code>1Mbps</code>,其实峰值带宽也就 <code>128Kb/s</code>。</p>
</li>
</ol>
<p>我使用服务器主要场景是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 有编译任务</span><br><span class="line">2. ssh 到服务器</span><br><span class="line">3. vscode ssh 到服务器看代码，写代码</span><br></pre></td></tr></table></figure>

<p>其实 1 和 2对 带宽要求都很低，但是 vscode ssh 对于带宽要求还是比较高的，<br>从腾讯云后台监控数据上看，我的服务器 每次都是 vscode ssh 到腾讯云的时候<br>或者服务器的时候带宽都用满了，导致有时候ssh需要连 几min 才能连接上。</p>
<p>vscode ssh 在连接上之后对于带宽使用率其实很低，在连接瞬间有较高要求。</p>
<p>我无奈之下就想给 腾讯云的服务搞成按流量计费的，一通操作下来没想到腾讯云居然不支持<br>活动时候买的服务器改网络配置。。</p>
<p>那就只能升级到2M带宽 或者更高了，升级了一下到 2Mbps,然后再用 vscode shh连接 就很丝滑了，然后我就想能不能通过调整vscode ssh配置来达到这样目的的，发现好像还真有个 timeout 时间，默认 <code>15s</code>，我改到了30s，也可能如果不升级带宽,仅仅将配置改到<code>30s</code> vscode经常超时的问题就好了呢？</p>
<p>等到5月份之后不续费再继续看看情况。。。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-12T06:47:40.000Z" title="12/12/2020, 2:47:40 PM">2020-12-12</time>发表</span><span class="level-item"><time dateTime="2020-12-05T11:21:23.583Z" title="12/5/2020, 7:21:23 PM">2020-12-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/docker/">docker</a></span><span class="level-item">10 分钟读完 (大约1497个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/12/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E4%B8%8Ecgroup%E5%A6%82%E4%BD%95%E8%81%94%E7%B3%BB%E8%B5%B7%E6%9D%A5%E7%9A%84/">docker与cgroup如何联系起来的</a></h1><div class="content"><p>一直说Docker 是基于linux三大技术 Cgroups, Namespace, OverlayFs 技术。<br>Cgroups, Namespace 着重的是 docker 的运行时，OverlayFs 着重的是 docker Image.<br>但是Docker 与 Cgroups, Namespace, OverlayFs 是怎么联系起来的呢，却很少有人说的明白，<br>我是一个好奇心很重的人，我会用几篇文章来记录分析一下他们怎么练习起来的。</p>
<p>这篇文章主要实操看一看 Docker 与 Cgroup 的联系。</p>
<ol>
<li><p>首先去 /sys/fs/cgroup/ 目录看一下当前支持的子系统controller，各个子系统controller下面一般情况下都是空的，表明系统中没有额外的cgroup，基本都只有root_cgroup.<br>虽然4.5版本之后 cgroup v2 就进入mainline了，但是 现在（2020.12.01）docker 基本还是在使用 cgroup v1, 应该也算是一个历史原因了吧，不知道何时 docker能迁移到 cgroup v2 上，期待ing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls</span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  rdma     unified</span><br><span class="line">cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids        systemd</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# mount | grep cgroup</span><br><span class="line">tmpfs on &#x2F;sys&#x2F;fs&#x2F;cgroup type tmpfs (ro,nosuid,nodev,noexec,mode&#x3D;755)</span><br><span class="line">cgroup2 on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;unified type cgroup2 (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name&#x3D;systemd)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset,clone_children)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">freezer on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer type cgroup (rw,relatime,freezer)</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls memory</span><br><span class="line">cgroup.clone_children  memory.kmem.failcnt                 memory.limit_in_bytes            memory.usage_in_bytes</span><br><span class="line">cgroup.event_control   memory.kmem.limit_in_bytes          memory.max_usage_in_bytes        memory.use_hierarchy</span><br><span class="line">cgroup.procs           memory.kmem.max_usage_in_bytes      memory.move_charge_at_immigrate  notify_on_release</span><br><span class="line">cgroup.sane_behavior   memory.kmem.slabinfo                memory.numa_stat                 release_agent</span><br><span class="line">docker                 memory.kmem.tcp.failcnt             memory.oom_control               system.slice</span><br><span class="line">init.scope             memory.kmem.tcp.limit_in_bytes      memory.pressure_level            tasks</span><br><span class="line">machine.slice          memory.kmem.tcp.max_usage_in_bytes  memory.soft_limit_in_bytes       user</span><br><span class="line">memory.failcnt         memory.kmem.tcp.usage_in_bytes      memory.stat                      user.slice</span><br><span class="line">memory.force_empty     memory.kmem.usage_in_bytes          memory.swappiness</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# cat memory&#x2F;tasks</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">....</span><br><span class="line">1728692</span><br><span class="line">1731590</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于 ubuntu image新建一个docker，限制memory 为 4MB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# sudo docker run -t -i -m 4MB ubuntu &#x2F;bin&#x2F;bash</span><br><span class="line">WARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.</span><br><span class="line">root@b3c618bb4df9:&#x2F;#</span><br></pre></td></tr></table></figure>
<p>警告可以忽略，可以看到docker的 id是 b3c618bb4df9。</p>
</li>
<li><p>可以发现各个子系统目录都会新建一个docker目录，且docker目录下有一个目录就是上面的docker container 的id。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls</span><br><span class="line">cgroup.clone_children           memory.kmem.slabinfo                memory.soft_limit_in_bytes</span><br><span class="line">cgroup.event_control            memory.kmem.tcp.failcnt             memory.stat</span><br><span class="line">cgroup.procs                    memory.kmem.tcp.limit_in_bytes      memory.swappiness</span><br><span class="line">cgroup.sane_behavior            memory.kmem.tcp.max_usage_in_bytes  memory.usage_in_bytes</span><br><span class="line">docker                          memory.kmem.tcp.usage_in_bytes      memory.use_hierarchy</span><br><span class="line">init.scope                      memory.kmem.usage_in_bytes          notify_on_release</span><br><span class="line">machine.slice                   memory.limit_in_bytes               release_agent</span><br><span class="line">memory.failcnt                  memory.max_usage_in_bytes           system.slice</span><br><span class="line">memory.force_empty              memory.move_charge_at_immigrate     tasks</span><br><span class="line">memory.kmem.failcnt             memory.numa_stat                    user</span><br><span class="line">memory.kmem.limit_in_bytes      memory.oom_control                  user.slice</span><br><span class="line">memory.kmem.max_usage_in_bytes  memory.pressure_level</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls docker</span><br><span class="line">1f3a24f9105950f6f463da0effa2465a518039c3bec76de71c6e20626dcfb286  memory.kmem.usage_in_bytes</span><br><span class="line">b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df  memory.limit_in_bytes</span><br><span class="line">cgroup.clone_children                                             memory.max_usage_in_bytes</span><br><span class="line">cgroup.event_control                                              memory.move_charge_at_immigrate</span><br><span class="line">cgroup.procs                                                      memory.numa_stat</span><br><span class="line">memory.failcnt                                                    memory.oom_control</span><br><span class="line">memory.force_empty                                                memory.pressure_level</span><br><span class="line">memory.kmem.failcnt                                               memory.soft_limit_in_bytes</span><br><span class="line">memory.kmem.limit_in_bytes                                        memory.stat</span><br><span class="line">memory.kmem.max_usage_in_bytes                                    memory.swappiness</span><br><span class="line">memory.kmem.slabinfo                                              memory.usage_in_bytes</span><br><span class="line">memory.kmem.tcp.failcnt                                           memory.use_hierarchy</span><br><span class="line">memory.kmem.tcp.limit_in_bytes                                    notify_on_release</span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes                                tasks</span><br><span class="line">memory.kmem.tcp.usage_in_bytes</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中 docker 目录下除了 container id的目录其他目录都是无效的，docker这个目录只是限制所有container id的一个顶层目录而已。通过 docker/tasks 为空就可以看出来。<br>可以看到 <code>memory/docker/b3c618bb4df9/</code> 目录下的最大内存限制，就是创建这个容器时设置的最大内存使用示4MB的限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat memory.limit_in_bytes</span><br><span class="line">4194304</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox 1733194</span><br></pre></td></tr></table></figure>
<p>可以看到这个 <code>1733194</code> 进程就是启动 容器时的 /bin/bash 进程</p>
</li>
<li><p>由于其他的 cgroup子系统我们没有对刚刚启动的 container 进行限制，所以也理论上从 cgroup上看到的也是没有限制的，可以看看 cpu controller.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cd -</span><br><span class="line">&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_quota_us</span><br><span class="line">-1</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>这里就不具体介绍 各个子系统目录下文件含义了。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-12T06:47:40.000Z" title="12/12/2020, 2:47:40 PM">2020-12-12</time>发表</span><span class="level-item"><time dateTime="2020-12-05T11:31:20.695Z" title="12/5/2020, 7:31:20 PM">2020-12-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/docker/">docker</a></span><span class="level-item">9 分钟读完 (大约1397个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/12/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E4%B8%8Enamespace%E5%A6%82%E4%BD%95%E8%81%94%E7%B3%BB%E8%B5%B7%E6%9D%A5%E7%9A%84/">docker与cgroup如何联系起来的</a></h1><div class="content"><p>这篇文章主要实操看一看 Docker 与 Namespace 的联系。</p>
<ol>
<li><p>首先去 /sys/fs/cgroup/ 目录看一下当前支持的子系统controller，各个子系统controller下面一般情况下都是空的，表明系统中没有额外的cgroup，基本都只有root_cgroup.<br>虽然4.5版本之后 cgroup v2 就进入mainline了，但是 现在（2020.12.01）docker 基本还是在使用 cgroup v1, 应该也算是一个历史原因了吧，不知道何时 docker能迁移到 cgroup v2 上，期待ing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls</span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  rdma     unified</span><br><span class="line">cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids        systemd</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# mount | grep cgroup</span><br><span class="line">tmpfs on &#x2F;sys&#x2F;fs&#x2F;cgroup type tmpfs (ro,nosuid,nodev,noexec,mode&#x3D;755)</span><br><span class="line">cgroup2 on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;unified type cgroup2 (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name&#x3D;systemd)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset,clone_children)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">freezer on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer type cgroup (rw,relatime,freezer)</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls memory</span><br><span class="line">cgroup.clone_children  memory.kmem.failcnt                 memory.limit_in_bytes            memory.usage_in_bytes</span><br><span class="line">cgroup.event_control   memory.kmem.limit_in_bytes          memory.max_usage_in_bytes        memory.use_hierarchy</span><br><span class="line">cgroup.procs           memory.kmem.max_usage_in_bytes      memory.move_charge_at_immigrate  notify_on_release</span><br><span class="line">cgroup.sane_behavior   memory.kmem.slabinfo                memory.numa_stat                 release_agent</span><br><span class="line">docker                 memory.kmem.tcp.failcnt             memory.oom_control               system.slice</span><br><span class="line">init.scope             memory.kmem.tcp.limit_in_bytes      memory.pressure_level            tasks</span><br><span class="line">machine.slice          memory.kmem.tcp.max_usage_in_bytes  memory.soft_limit_in_bytes       user</span><br><span class="line">memory.failcnt         memory.kmem.tcp.usage_in_bytes      memory.stat                      user.slice</span><br><span class="line">memory.force_empty     memory.kmem.usage_in_bytes          memory.swappiness</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# cat memory&#x2F;tasks</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">....</span><br><span class="line">1728692</span><br><span class="line">1731590</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于 ubuntu image新建一个docker，限制memory 为 4MB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# sudo docker run -t -i -m 4MB ubuntu &#x2F;bin&#x2F;bash</span><br><span class="line">WARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.</span><br><span class="line">root@b3c618bb4df9:&#x2F;#</span><br></pre></td></tr></table></figure>
<p>警告可以忽略，可以看到docker的 id是 b3c618bb4df9。</p>
</li>
<li><p>可以发现各个子系统目录都会新建一个docker目录，且docker目录下有一个目录就是上面的docker container 的id。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls</span><br><span class="line">cgroup.clone_children           memory.kmem.slabinfo                memory.soft_limit_in_bytes</span><br><span class="line">cgroup.event_control            memory.kmem.tcp.failcnt             memory.stat</span><br><span class="line">cgroup.procs                    memory.kmem.tcp.limit_in_bytes      memory.swappiness</span><br><span class="line">cgroup.sane_behavior            memory.kmem.tcp.max_usage_in_bytes  memory.usage_in_bytes</span><br><span class="line">docker                          memory.kmem.tcp.usage_in_bytes      memory.use_hierarchy</span><br><span class="line">init.scope                      memory.kmem.usage_in_bytes          notify_on_release</span><br><span class="line">machine.slice                   memory.limit_in_bytes               release_agent</span><br><span class="line">memory.failcnt                  memory.max_usage_in_bytes           system.slice</span><br><span class="line">memory.force_empty              memory.move_charge_at_immigrate     tasks</span><br><span class="line">memory.kmem.failcnt             memory.numa_stat                    user</span><br><span class="line">memory.kmem.limit_in_bytes      memory.oom_control                  user.slice</span><br><span class="line">memory.kmem.max_usage_in_bytes  memory.pressure_level</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls docker</span><br><span class="line">1f3a24f9105950f6f463da0effa2465a518039c3bec76de71c6e20626dcfb286  memory.kmem.usage_in_bytes</span><br><span class="line">b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df  memory.limit_in_bytes</span><br><span class="line">cgroup.clone_children                                             memory.max_usage_in_bytes</span><br><span class="line">cgroup.event_control                                              memory.move_charge_at_immigrate</span><br><span class="line">cgroup.procs                                                      memory.numa_stat</span><br><span class="line">memory.failcnt                                                    memory.oom_control</span><br><span class="line">memory.force_empty                                                memory.pressure_level</span><br><span class="line">memory.kmem.failcnt                                               memory.soft_limit_in_bytes</span><br><span class="line">memory.kmem.limit_in_bytes                                        memory.stat</span><br><span class="line">memory.kmem.max_usage_in_bytes                                    memory.swappiness</span><br><span class="line">memory.kmem.slabinfo                                              memory.usage_in_bytes</span><br><span class="line">memory.kmem.tcp.failcnt                                           memory.use_hierarchy</span><br><span class="line">memory.kmem.tcp.limit_in_bytes                                    notify_on_release</span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes                                tasks</span><br><span class="line">memory.kmem.tcp.usage_in_bytes</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中 docker 目录下除了 container id的目录其他目录都是无效的，docker这个目录只是限制所有container id的一个顶层目录而已。通过 docker/tasks 为空就可以看出来。<br>可以看到 <code>memory/docker/b3c618bb4df9/</code> 目录下的最大内存限制，就是创建这个容器时设置的最大内存使用示4MB的限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat memory.limit_in_bytes</span><br><span class="line">4194304</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox 1733194</span><br></pre></td></tr></table></figure>
<p>可以看到这个 <code>1733194</code> 进程就是启动 容器时的 /bin/bash 进程</p>
</li>
<li><p>由于其他的 cgroup子系统我们没有对刚刚启动的 container 进行限制，所以也理论上从 cgroup上看到的也是没有限制的，可以看看 cpu controller.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cd -</span><br><span class="line">&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_quota_us</span><br><span class="line">-1</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>这里就不具体介绍 各个子系统目录下文件含义了。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-01T06:47:40.000Z" title="12/1/2020, 2:47:40 PM">2020-12-01</time>发表</span><span class="level-item"><time dateTime="2020-12-05T10:46:17.871Z" title="12/5/2020, 6:46:17 PM">2020-12-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/docker/">docker</a></span><span class="level-item">2 分钟读完 (大约319个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/01/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/">docker如何使用</a></h1><div class="content"><p>这是一个简单概括docker 安装，拉取image,docker 命令使用的 记录。</p>
<ol>
<li><p>在ubuntu平台上安装 docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>拉取ubuntu的 image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于ubuntu的 image 创建并运行一个docker，限制4MB内存，开启 bash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -t -i -m 4MB ubuntu &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前有哪些运行的docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">1f3a24f91059        ubuntu              &quot;&#x2F;bin&#x2F;bash&quot;         47 hours ago        Up 47 hours                             hhhh</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前有哪些的docker(运行中 + 非运行中)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# sudo docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">1f3a24f91059        ubuntu              &quot;&#x2F;bin&#x2F;bash&quot;         47 hours ago        Up 47 hours                             hhhhh</span><br></pre></td></tr></table></figure>
</li>
<li><p>给 hhh 的容器重命名为 my_ubuntu</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rename  hhh my_ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止 my_ubuntu 容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop my_ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启开启 my_ubuntu 容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker start my_ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入运行中的 my_ubuntu 容器的 bash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -ti my_ubuntu &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>其他常用命令想起来再记录</p>
<p>这些命令还是比较长的，可以缩写到 bashrc 的alias里面，比较方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# cat ~&#x2F;.zshrc | grep &quot;alias d&quot;</span><br><span class="line">alias dn&#x3D;&quot;sudo docker run -t -i -m 128MB ubuntu &#x2F;bin&#x2F;bash&quot;</span><br><span class="line">alias ds&#x3D;&quot;sudo docker start my_ubuntu&quot;</span><br><span class="line">alias dk&#x3D;&quot;sudo docker stop my_ubuntu&quot;</span><br><span class="line">alias di&#x3D;&quot;sudo docker exec -ti my_ubuntu &#x2F;bin&#x2F;bash&quot;</span><br><span class="line">alias dps&#x3D;&quot;sudo docker ps&quot;</span><br><span class="line">alias dpsa&#x3D;&quot;sudo docker ps -a&quot;</span><br><span class="line">alias drma&#x3D;&quot;sudo  docker container prune&quot;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-22T15:00:00.000Z" title="9/22/2020, 11:00:00 PM">2020-09-22</time>发表</span><span class="level-item"><time dateTime="2020-10-21T15:43:50.000Z" title="10/21/2020, 11:43:50 PM">2020-10-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/">生活感悟</a></span><span class="level-item">10 分钟读完 (大约1530个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/22/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E4%B8%AAkernel%20patch/">记录第一个kernel patch</a></h1><div class="content"><p>之前也提过两个patch给社区不过都被否了，很多大佬第一次提patch也是从改改标点开始的。<br>最近在看文件系统相关的代码，看到有个地方定义和注释不一致，可以给社区贡献一下，也顺便记录一下，搭建环境的过程（之前用的ubuntu18虚拟机被我删了…现在用ubuntu20重新搞一下）</p>
<h2 id="修改代码，形成patch"><a href="#修改代码，形成patch" class="headerlink" title="修改代码，形成patch"></a>修改代码，形成patch</h2><p>其实我这个patch很简单，只是修改一个注释而已：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ git diff</span><br><span class="line">diff --git a&#x2F;include&#x2F;linux&#x2F;jbd2.h b&#x2F;include&#x2F;linux&#x2F;jbd2.h</span><br><span class="line">index 08f904943ab2..a1ef05412acf 100644</span><br><span class="line">--- a&#x2F;include&#x2F;linux&#x2F;jbd2.h</span><br><span class="line">+++ b&#x2F;include&#x2F;linux&#x2F;jbd2.h</span><br><span class="line">@@ -452,8 +452,8 @@ struct jbd2_inode &#123;</span><br><span class="line"> struct jbd2_revoke_table_s;</span><br><span class="line"> </span><br><span class="line"> &#x2F;**</span><br><span class="line">- * struct handle_s - The handle_s type is the concrete type associated with</span><br><span class="line">- *     handle_t.</span><br><span class="line">+ * struct jbd2_journal_handle - The jbd2_journal_handle type is the concrete</span><br><span class="line">+ *     type associated with handle_t.</span><br><span class="line">  * @h_transaction: Which compound transaction is this update a part of?</span><br><span class="line">  * @h_journal: Which journal handle belongs to - used iff h_reserved set.</span><br><span class="line">  * @h_rsv_handle: Handle reserved for finishing the logical operation.</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ git log -1</span><br><span class="line">commit f8db1794205285c44d4b0b7d83f0fda1b9adec00 (HEAD -&gt; master)</span><br><span class="line">Author: Hui Su &lt;sh_def@163.com&gt;</span><br><span class="line">Date:   Tue Sep 22 23:28:05 2020 +0800</span><br><span class="line"></span><br><span class="line">    FIX the comment of struct jbd2_journal_handle</span><br><span class="line">    </span><br><span class="line">    the struct name was modified long ago, but the comment still</span><br><span class="line">    use struct handle_s.</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: Hui Su &lt;sh_def@163.com&gt;</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ git format-patch HEAD^</span><br><span class="line">0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br></pre></td></tr></table></figure>

<p>如果第一个版本有问题则需要重新提第二个版本patch，与第一个版本差别就是加上 ‘ -v2’<br> ‘ -v3’ 等，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux-stable$ git format-patch HEAD^ -v2</span><br><span class="line">v2-0001-tools-time-access-sys-kernel-debug-udelay_test-be.patch</span><br></pre></td></tr></table></figure>
<p>在邮件发出之后会自动变成<br>[PATCH v2] tools/time: access /sys/kernel/debug/udelay_test before test</p>
<p>如果不是一个patch，而是一系列patch怎么办呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">肯定是有办法的，目前我还没这个需求，留白，后续补充</span><br><span class="line">lkml中的邮件格式：</span><br><span class="line">[PATCH v6 00&#x2F;25] Add support for Clang LTO</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/section/1138664">git format-patch</a></p>
<h2 id="找到修改代码部分的maintainer"><a href="#找到修改代码部分的maintainer" class="headerlink" title="找到修改代码部分的maintainer"></a>找到修改代码部分的maintainer</h2><ol>
<li>先用 <code>perl scripts/checkpatch.pl</code> 检查patch有无语法错误</li>
<li>再用 <code>perl scripts/get_maintainer.pl</code> 获取patch修改的代码的 maintainer<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ perl scripts&#x2F;checkpatch.pl  0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch </span><br><span class="line">total: 0 errors, 0 warnings, 10 lines checked</span><br><span class="line"></span><br><span class="line">0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch has no obvious style problems and is ready for submission.</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ </span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ perl scripts&#x2F;get_maintainer.pl  0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch </span><br><span class="line">&quot;Theodore Ts&#39;o&quot; &lt;tytso@mit.edu&gt; (maintainer:JOURNALLING LAYER FOR BLOCK DEVICES (JBD2))</span><br><span class="line">Jan Kara &lt;jack@suse.com&gt; (maintainer:JOURNALLING LAYER FOR BLOCK DEVICES (JBD2))</span><br><span class="line">linux-ext4@vger.kernel.org (open list:JOURNALLING LAYER FOR BLOCK DEVICES (JBD2))</span><br><span class="line">linux-kernel@vger.kernel.org (open list)</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="安装配置邮件客户端"><a href="#安装配置邮件客户端" class="headerlink" title="安装配置邮件客户端"></a>安装配置邮件客户端</h2><p>安装下面工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install sendmail</span><br><span class="line">sudo apt  install mutt</span><br><span class="line">sudo apt install smtp</span><br></pre></td></tr></table></figure>

<p>配置一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~$ cat .muttrc </span><br><span class="line">set sendmail&#x3D;&quot;&#x2F;usr&#x2F;bin&#x2F;msmtp&quot;</span><br><span class="line">set envelope_from&#x3D;yes</span><br><span class="line">set realname&#x3D;&quot;Hui Su&quot;</span><br><span class="line">set from&#x3D;sh_def@163.com</span><br><span class="line">set use_from&#x3D;yes</span><br><span class="line">set envelope_from&#x3D;yes</span><br><span class="line">sh@ubuntu:~$ </span><br><span class="line">sh@ubuntu:~$ </span><br><span class="line">sh@ubuntu:~$ </span><br><span class="line">sh@ubuntu:~$ cat .msmtprc </span><br><span class="line">account default</span><br><span class="line">host smtp.163.com</span><br><span class="line">port 25</span><br><span class="line">from sh_def@163.com</span><br><span class="line">auth plain</span><br><span class="line">tls off</span><br><span class="line">user sh_def@163.com</span><br><span class="line">password #这里填授权码</span><br><span class="line">sh@ubuntu:~$ </span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~$ echo &quot;test&quot; |mutt -s &quot;my_first_test&quot; xxx@163.com</span><br><span class="line">sh@ubuntu:~$ echo &quot;test&quot; |mutt -s &quot;my_first_test&quot; xxxx@qq.com</span><br></pre></td></tr></table></figure>
<p>吐槽一下，如果是第一次配置还是比较难搞的<br>参考<a target="_blank" rel="noopener" href="https://learnku.com/articles/13307/mutt-mail-sending">参考</a></p>
<h2 id="git-配置"><a href="#git-配置" class="headerlink" title="git 配置"></a>git 配置</h2><p>这个应该在 git commit 阶段就已经配置好了，不赘述</p>
<h2 id="推送patch"><a href="#推送patch" class="headerlink" title="推送patch"></a>推送patch</h2><p>只需要在各个邮箱之间加上,即可，不赘述</p>
<h2 id="回复邮件"><a href="#回复邮件" class="headerlink" title="回复邮件"></a>回复邮件</h2><p>一般情况下社区大佬都会在几天到一周内回复你的patch邮件，如果你的patch需要修改，<br>然后你需要重新回复他们的邮件，这应该如何做呢</p>
<ol>
<li><p>第一步配置好fetchmail</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~$ sudo apt install fetchmail </span><br><span class="line">[sudo] password for rlk: </span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">fetchmail is already the newest version (6.4.2-2).</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 369 not upgraded.</span><br><span class="line">sh@ubuntu:~$ cat ~&#x2F;.fetchmailrc </span><br><span class="line">poll pop3.163.com</span><br><span class="line">protocol POP3</span><br><span class="line">user &quot;xxx@163.com&quot; </span><br><span class="line">password &quot;客户端授权码&quot;</span><br><span class="line">sh@ubuntu:~$ ll | grep rc | grep fetch</span><br><span class="line">-rwx------  1 rlk  rlk       83 10月  8 01:38 .fetchmailrc*</span><br><span class="line"></span><br><span class="line"># 接收邮件</span><br><span class="line">sh@ubuntu:~$ fetchmail  -v</span><br><span class="line">fetchmail: 6.4.2 querying pop3.163.com (protocol POP3) at 2020年10月08日 星期四 01时38分51秒: poll started</span><br><span class="line">Trying to connect to 220.181.12.110&#x2F;110...connected.</span><br><span class="line">fetchmail: POP3&lt; +OK Welcome to coremail Mail Pop3 Server (163coms[10774b260cc7a37d26d71b52404dcf5cs])</span><br><span class="line">fetchmail: POP3&gt; CAPA</span><br><span class="line">fetchmail: POP3&lt; +OK Capability list follows</span><br><span class="line">...............</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看接收的邮件<br>然后直接 mutt 就可以看到接收到的邮件了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">q:Quit  d:Del  u:Undel  s:Save  m:Mail  r:Reply  g:Group  ?:Help</span><br><span class="line">   1 O + 9月 09 iovisor-dev@lis ( 378) [iovisor-dev] iovisor-dev@lists.iovisor.org Daily Summary</span><br><span class="line">   2   + 9月 22 Mail Delivery S (  50) Returned mail: see transcript for details</span><br><span class="line">   3   + 9月 22 Mail Delivery S (  50) Returned mail: see transcript for details</span><br><span class="line">   4 O F 9月 23 To sh_def@163.c (  75) [PATCH] mm,page_alloc: fix the count of free pages</span><br><span class="line">   5 O T 9月 23 Jan Kara        (  38) ┬─&gt;Re: [PATCH] FIX the comment of struct jbd2_journal_handle</span><br><span class="line">   6 O T 10月 03 Theodore Y. Ts&#39; (  11) └─&gt;Re: [PATCH] FIX the comment of struct jbd2_journal_handle</span><br><span class="line">   7 O + 9月 25 Josh Poimboeuf  (   3) ┬─&gt;Re: [PATCH] mm,kmemleak-test.c: move kmemleak-test.c to samples dir</span><br><span class="line">   8 O T 10月 05 Catalin Marinas (  12) └─&gt;Re: [PATCH] mm,kmemleak-test.c: move kmemleak-test.c to samples dir</span><br><span class="line">   9 O T 9月 25 akpm@linux-foun ( 313) + mmkmemleak-testc-move-kmemleak-testc-to-samples-dir.patch added to -mm tree</span><br><span class="line">  10 O T 9月 25 akpm@linux-foun (  92) + mm-fix-some-comments-in-page_allocc-and-mempolicyc.patch added to -mm tree</span><br><span class="line">  11 O T 9月 28 Ira Weiny       (  57) Re: [PATCH] mm&#x2F;vmalloc.c: check the addr first</span><br><span class="line">  12 O T 9月 28 akpm@linux-foun (  56) + mm-vmscan-fix-comments-for-isolate_lru_page.patch added to -mm tree</span><br><span class="line">  13 O T 9月 28 akpm@linux-foun (  59) + mm-vmallocc-update-the-comment-in-__vmalloc_area_node.patch added to -mm tree</span><br><span class="line">  14 O T 9月 28 akpm@linux-foun (  66) + mm-vmallocc-fix-the-comment-of-find_vm_area.patch added to -mm tree</span><br><span class="line">  15 O T 9月 28 akpm@linux-foun (  65) + mmz3fold-use-xx_zalloc-instead-xx_alloc-and-memset.patch added to -mm tree</span><br><span class="line">  16 O + 9月 29 haifei.wang@car ( 312) 阿里云&#x2F;今日头条Linux内核研发专家职位推荐</span><br><span class="line">  17 O T 9月 29 Dietmar Eggeman (  59) Re: [PATCH] sched,fair: use list_for_each_entry() in print_cfs_stats()</span><br><span class="line">  18 O + 9月 29 iovisor-dev@lis ( 378) [iovisor-dev] iovisor-dev@lists.iovisor.org Daily Summary</span><br><span class="line">  19 O T 9月 29 Steven Rostedt  (  61) Re: [PATCH] sched&#x2F;rt.c remove unnecessary parameter in pick_next_rt_entity</span><br><span class="line">  20 O T 9月 30 boris.ostrovsky (  13) Re: [PATCH] arch&#x2F;x86: fix some typos in xen_pagetable_p2m_free()</span><br><span class="line">  21 O T 10月 01 David Hildenbra (  57) Re: [PATCH] mm: fix some comments in page_alloc.c and mempolicy.c</span><br><span class="line">  22 O T 10月 01 Joe Perches     (  14) └─&gt;</span><br><span class="line">  23 O + 10月 01 iovisor-dev@lis ( 378) [iovisor-dev] iovisor-dev@lists.iovisor.org Daily Summary</span><br><span class="line">  24 O   10月 02 George Worden   (   1)</span><br><span class="line">  25 O T 10月 02 akpm@linux-foun (  81) [to-be-updated] mm-fix-some-comments-in-page_allocc-and-mempolicyc.patch removed from -mm tree</span><br><span class="line">  26 O + 10月 08 流浪人          (  75) Re:[PATCH] mm&#x2F;hugetlb.c: just use put_page_testzero() instead of page_count()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---Mutt: &#x2F;var&#x2F;mail&#x2F;rlk [Msgs:26 Old:24 Post:8 174K]---(threads&#x2F;date)---------------------------------------------------------------------------------------------------------------------------------(all)--</span><br></pre></td></tr></table></figure>
</li>
<li><p>回复邮件<br><a target="_blank" rel="noopener" href="https://lkml.org/lkml/2020/9/22/824">我的第一个patch</a></p>
</li>
</ol>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">39</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">68</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内存越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-23T11:00:00.000Z">2021-01-23</time></p><p class="title"><a href="/2021/01/23/crash%E4%B8%93%E9%A2%98/x86%20%E5%B9%B3%E5%8F%B0%E5%B8%B8%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8%E5%92%8C%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/">x86 平台常用寄存器和函数调用分析</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-23T11:00:00.000Z">2021-01-23</time></p><p class="title"><a href="/2021/01/23/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/%E4%BD%BF%E8%83%BDlock_dep%E8%A7%A3%E5%86%B3%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/">使能lock_dep解决死锁问题</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-21T07:00:00.000Z">2021-01-21</time></p><p class="title"><a href="/2021/01/21/crash%E4%B8%93%E9%A2%98/%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E7%A9%BA%E6%8C%87%E9%92%88oops/">最简单的空指针oops</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-20T02:49:13.873Z">2021-01-20</time></p><p class="title"><a href="/2021/01/20/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/kdump+crash%E5%AE%9A%E4%BD%8D%E7%A8%B3%E5%AE%9A%E6%80%A7%E9%97%AE%E9%A2%98/">kdump+crash定位稳定性问题</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-17T11:00:00.000Z">2021-01-17</time></p><p class="title"><a href="/2021/01/17/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/valgrind%20%E5%AE%9A%E4%BD%8D%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">valgrind 定位用户空间内存泄漏</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>