<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-06T11:00:00.000Z" title="7/6/2021, 7:00:00 PM">2021-07-06</time>发表</span><span class="level-item"><time dateTime="2021-07-08T04:26:54.956Z" title="7/8/2021, 12:26:54 PM">2021-07-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/cgroup-v2/">cgroup v2</a></span><span class="level-item">4 分钟读完 (大约609个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/06/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/cgroup%20v2%20%E4%BD%BF%E7%94%A8/">cgroup v2 使用</a></h1><div class="content"><h2 id="如何加入-cgroup"><a href="#如何加入-cgroup" class="headerlink" title="如何加入 cgroup"></a>如何加入 cgroup</h2><p><code>cgroup.procs</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;tmp# sleep 10000 &amp;</span><br><span class="line">[2] 9087</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;tmp# echo 9087 &gt; cgroup.procs</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;tmp# cat cgroup.procs</span><br><span class="line">7412</span><br><span class="line">9087</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><h2 id="新建一个-cgroup"><a href="#新建一个-cgroup" class="headerlink" title="新建一个 cgroup"></a>新建一个 cgroup</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;tmp# mkdir 123</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;tmp# ls</span><br><span class="line">123                     cgroup.type            io.stat              memory.stat</span><br></pre></td></tr></table></figure>

<h3 id="code-1"><a href="#code-1" class="headerlink" title="code"></a>code</h3><h2 id="pid-cgroup"><a href="#pid-cgroup" class="headerlink" title="pid cgroup"></a>pid cgroup</h2><h2 id="freeze-cgroup"><a href="#freeze-cgroup" class="headerlink" title="freeze cgroup"></a>freeze cgroup</h2><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# cat cgroup.freeze</span><br><span class="line">0</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# echo 1 &gt; cgroup.freeze</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope#</span><br></pre></td></tr></table></figure>
<p>在这个session 中的所有 task都不执行了，相对于被冻住了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# ps -aux</span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.3 167756 11436 ?        Ss   10:32   0:01 &#x2F;sbin&#x2F;init</span><br><span class="line">root           2  0.0  0.0      0     0 ?        S    10:32   0:00 [kthreadd]</span><br><span class="line">root           3  0.0  0.0      0     0 ?        I&lt;   10:32   0:00 [rcu_gp]</span><br><span class="line">root        3342  0.0  0.0   3864  1044 pts&#x2F;2    S+   10:33   0:00 stress -c 3</span><br><span class="line">root        3343 77.4  0.0   3864   100 pts&#x2F;2    S+   10:33  26:01 stress -c 3</span><br><span class="line">root        3344 77.2  0.0   3864   100 pts&#x2F;2    S+   10:33  25:56 stress -c 3</span><br><span class="line">root        3345 77.2  0.0   3864   100 pts&#x2F;2    S+   10:33  25:56 stress -c 3</span><br></pre></td></tr></table></figure>
<p><code>ps -aux</code> 看到 stress thread 都是 处于 sleep状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# echo 0 &gt; cgroup.freeze</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope#</span><br></pre></td></tr></table></figure>
<p>解除 freeze之后，再通过 <code>ps -aux</code> 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# ps -aux</span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.3 167756 11436 ?        Ss   10:32   0:01 &#x2F;sbin&#x2F;init</span><br><span class="line">root           2  0.0  0.0      0     0 ?        S    10:32   0:00 [kthreadd]</span><br><span class="line">root           3  0.0  0.0      0     0 ?        I&lt;   10:32   0:00 [rcu_gp]</span><br><span class="line">root        3343 72.7  0.0   3864   100 pts&#x2F;2    R+   10:33  26:11 stress -c 3</span><br><span class="line">root        3344 72.4  0.0   3864   100 pts&#x2F;2    R+   10:33  26:05 stress -c 3</span><br><span class="line">root        3345 72.5  0.0   3864   100 pts&#x2F;2    R+   10:33  26:06 stress -c 3</span><br></pre></td></tr></table></figure>
<p>stress 基本一直处于 <code>R+</code> 状态。</p>
<h2 id="cpu-cgroup"><a href="#cpu-cgroup" class="headerlink" title="cpu cgroup"></a>cpu cgroup</h2><p>通过 各个层级的<code>cgroup.controllers</code> 和 <code>cat cgroup.subtree_control</code> 设置，将 <code>user.slice/user-1000.slice/session-1.scope</code> 开启 cpu cgroup.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# ls -a | grep cpu</span><br><span class="line">cpu.max</span><br><span class="line">cpu.max.burst</span><br><span class="line">cpu.pressure</span><br><span class="line">cpu.stat</span><br><span class="line">cpu.weight</span><br><span class="line">cpu.weight.nice</span><br></pre></td></tr></table></figure>

<h3 id="控制cpu配额"><a href="#控制cpu配额" class="headerlink" title="控制cpu配额"></a>控制cpu配额</h3><p>默认值 <code>max 100000</code>，标识不显示 cpu使用率</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# cat cpu.max</span><br><span class="line">max 100000</span><br></pre></td></tr></table></figure>

<p>设置限制 单核 50%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# echo 50000 100000 &gt; cpu.max</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope# cat cpu.max</span><br><span class="line">50000 100000</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-1.scope#</span><br></pre></td></tr></table></figure>

<p>四核心 机器上 top 看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">top - 11:01:26 up 28 min,  3 users,  load average: 0.27, 1.84, 2.08                                                                               [1&#x2F;11]</span><br><span class="line">Tasks: 191 total,   4 running, 187 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s): 12.9 us,  0.2 sy,  0.0 ni, 86.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem :   3671.7 total,   2367.6 free,    644.6 used,    659.5 buff&#x2F;cache</span><br><span class="line">MiB Swap:   1497.1 total,   1497.1 free,      0.0 used.   2972.4 avail Mem</span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">   3343 root      20   0    3864    100      0 R  17.4   0.0  25:21.85 stress</span><br><span class="line">   3345 root      20   0    3864    100      0 R  16.5   0.0  25:18.51 stress</span><br><span class="line">   3344 root      20   0    3864    100      0 R  15.8   0.0  25:19.38 stress</span><br><span class="line">    163 root      20   0       0      0      0 I   0.3   0.0   0:00.34 kworker&#x2F;2:3-events</span><br></pre></td></tr></table></figure>


<h3 id="控制cpu权重"><a href="#控制cpu权重" class="headerlink" title="控制cpu权重"></a>控制cpu权重</h3><p>后续补充。。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-06T11:00:00.000Z" title="7/6/2021, 7:00:00 PM">2021-07-06</time>发表</span><span class="level-item"><time dateTime="2021-07-07T08:58:54.145Z" title="7/7/2021, 4:58:54 PM">2021-07-07</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/namespace/">namespace</a><span> / </span><a class="link-muted" href="/categories/namespace/pid-namespace/">pid namespace</a></span><span class="level-item">13 分钟读完 (大约1977个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/06/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/namespace%E4%B9%8Bpid/">namespace之pid</a></h1><div class="content"><h2 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h2><p>shell 1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# echo $$</span><br><span class="line">4371</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# readlink &#x2F;proc&#x2F;$$&#x2F;ns&#x2F;pid</span><br><span class="line">pid:[4026531836]</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash#</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo unshare --pid --mount-proc --fork &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# readlink &#x2F;proc&#x2F;$$&#x2F;ns&#x2F;pid</span><br><span class="line">pid:[4026532210]</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# ps</span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line">      1 pts&#x2F;3    00:00:00 bash</span><br><span class="line">     10 pts&#x2F;3    00:00:00 ps</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# stress -c 10</span><br><span class="line">stress: info: [11] dispatching hogs: 10 cpu, 0 io, 0 vm, 0 hdd</span><br><span class="line">^Z</span><br><span class="line">[1]+  Stopped                 stress -c 10</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# ps -aux</span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.1  18476  4136 pts&#x2F;3    S    12:10   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">root          11  0.0  0.0   3864   984 pts&#x2F;3    T    12:12   0:00 stress -c 10</span><br><span class="line">root          12 36.8  0.0   3864   100 pts&#x2F;3    T    12:12   1:21 stress -c 10</span><br><span class="line">root          13 39.4  0.0   3864   100 pts&#x2F;3    T    12:12   1:27 stress -c 10</span><br><span class="line">root          14 40.0  0.0   3864   100 pts&#x2F;3    T    12:12   1:28 stress -c 10</span><br><span class="line">root          15 38.8  0.0   3864   100 pts&#x2F;3    T    12:12   1:25 stress -c 10</span><br><span class="line">root          16 39.3  0.0   3864   100 pts&#x2F;3    T    12:12   1:26 stress -c 10</span><br><span class="line">root          17 38.8  0.0   3864   100 pts&#x2F;3    T    12:12   1:25 stress -c 10</span><br><span class="line">root          18 40.3  0.0   3864   100 pts&#x2F;3    T    12:12   1:29 stress -c 10</span><br><span class="line">root          19 39.4  0.0   3864   100 pts&#x2F;3    T    12:12   1:27 stress -c 10</span><br><span class="line">root          20 40.4  0.0   3864   100 pts&#x2F;3    T    12:12   1:29 stress -c 10</span><br><span class="line">root          21 38.3  0.0   3864   100 pts&#x2F;3    T    12:12   1:24 stress -c 10</span><br><span class="line">root          22  0.0  0.0  20312  3608 pts&#x2F;3    R+   12:16   0:00 ps -aux</span><br></pre></td></tr></table></figure>


<p>shell 2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root        4501  0.0  0.0   3864   984 pts&#x2F;3    S+   12:12   0:00 stress -c 10</span><br><span class="line">root        4502 37.2  0.0   3864   100 pts&#x2F;3    R+   12:12   1:18 stress -c 10</span><br><span class="line">root        4503 40.1  0.0   3864   100 pts&#x2F;3    R+   12:12   1:24 stress -c 10</span><br><span class="line">root        4504 40.9  0.0   3864   100 pts&#x2F;3    R+   12:12   1:26 stress -c 10</span><br><span class="line">root        4505 39.4  0.0   3864   100 pts&#x2F;3    R+   12:12   1:22 stress -c 10</span><br><span class="line">root        4506 39.9  0.0   3864   100 pts&#x2F;3    R+   12:12   1:23 stress -c 10</span><br><span class="line">root        4507 39.4  0.0   3864   100 pts&#x2F;3    R+   12:12   1:22 stress -c 10</span><br><span class="line">root        4508 41.0  0.0   3864   100 pts&#x2F;3    R+   12:12   1:26 stress -c 10</span><br><span class="line">root        4509 40.2  0.0   3864   100 pts&#x2F;3    R+   12:12   1:24 stress -c 10                       &quot;rlk-Standard-PC-i440F&quot; 12:18 07-7月-21</span><br><span class="line">root        4510 41.0  0.0   3864   100 pts&#x2F;3    R+   12:12   1:26 stress -c 10</span><br><span class="line">root        4511 39.1  0.0   3864   100 pts&#x2F;3    R+   12:12   1:22 stress -c 10</span><br><span class="line">rlk         4522  0.0  0.0  20312  3744 pts&#x2F;2    R+   12:15   0:00 ps -aux</span><br></pre></td></tr></table></figure>


<p>debug log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[ 2276.675896] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 11</span><br><span class="line">[ 2276.679264] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4501</span><br><span class="line">[ 2276.694094] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 12</span><br><span class="line">[ 2276.697715] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4502</span><br><span class="line">[ 2276.700705] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 13</span><br><span class="line">[ 2276.703495] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4503</span><br><span class="line">[ 2276.706523] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 14</span><br><span class="line">[ 2276.709158] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4504</span><br><span class="line">[ 2276.712157] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 15</span><br><span class="line">[ 2276.714937] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4505</span><br><span class="line">[ 2276.717940] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 16</span><br><span class="line">[ 2276.720724] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4506</span><br><span class="line">[ 2276.723808] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 17</span><br><span class="line">[ 2276.726108] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4507</span><br><span class="line">[ 2276.728367] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 18</span><br><span class="line">[ 2276.730191] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4508</span><br><span class="line">[ 2276.732382] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 19</span><br><span class="line">[ 2276.734118] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4509</span><br><span class="line">[ 2276.736167] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 20</span><br><span class="line">[ 2276.737602] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4510</span><br><span class="line">[ 2276.739537] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 21</span><br><span class="line">[ 2276.740830] [robert] alloc_pid level &#x3D; 1, pid-&gt;numbers[i].nr &#x3D; 4511</span><br><span class="line">[ 2279.849411] [robert] alloc_pid level &#x3D; 0, pid-&gt;numbers[i].nr &#x3D; 4512</span><br></pre></td></tr></table></figure>
<p>可以看到， new pid_namespace 中的 21 对应 old pid_namespace 中的 4511…</p>
<p>添加 log的 patch是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ git diff</span><br><span class="line">diff --git a&#x2F;kernel&#x2F;pid.c b&#x2F;kernel&#x2F;pid.c</span><br><span class="line">index ebdf9c60cd0b..eb80bac14e13 100644</span><br><span class="line">--- a&#x2F;kernel&#x2F;pid.c</span><br><span class="line">+++ b&#x2F;kernel&#x2F;pid.c</span><br><span class="line">@@ -186,7 +186,6 @@ struct pid *alloc_pid(struct pid_namespace *ns, pid_t *set_tid,</span><br><span class="line"></span><br><span class="line">        for (i &#x3D; ns-&gt;level; i &gt;&#x3D; 0; i--) &#123;</span><br><span class="line">                int tid &#x3D; 0;</span><br><span class="line">-</span><br><span class="line">                if (set_tid_size) &#123;</span><br><span class="line">                        tid &#x3D; set_tid[ns-&gt;level - i];</span><br><span class="line"></span><br><span class="line">@@ -243,6 +242,9 @@ struct pid *alloc_pid(struct pid_namespace *ns, pid_t *set_tid,</span><br><span class="line"></span><br><span class="line">                pid-&gt;numbers[i].nr &#x3D; nr;</span><br><span class="line">                pid-&gt;numbers[i].ns &#x3D; tmp;</span><br><span class="line">+               pr_err(&quot;[robert] alloc_pid level &#x3D; %d, pid-&gt;numbers[i].nr &#x3D; %d\n&quot;,</span><br><span class="line">+                       pid-&gt;level, nr);</span><br><span class="line">+</span><br><span class="line">                tmp &#x3D; tmp-&gt;parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">diff --git a&#x2F;kernel&#x2F;pid_namespace.c b&#x2F;kernel&#x2F;pid_namespace.c</span><br><span class="line">index ca43239a255a..72ad5a3ddf29 100644</span><br><span class="line">--- a&#x2F;kernel&#x2F;pid_namespace.c</span><br><span class="line">+++ b&#x2F;kernel&#x2F;pid_namespace.c</span><br><span class="line">@@ -46,6 +46,7 @@ static struct kmem_cache *create_pid_cachep(unsigned int level)</span><br><span class="line">        if (kc)</span><br><span class="line">                return kc;</span><br><span class="line"></span><br><span class="line">+       pr_err(&quot;[robert] create_pid_cachep level &#x3D; %d\n&quot;, level);</span><br><span class="line">        snprintf(name, sizeof(name), &quot;pid_%u&quot;, level + 1);</span><br><span class="line">        len &#x3D; sizeof(struct pid) + level * sizeof(struct upid);</span><br><span class="line">        mutex_lock(&amp;pid_caches_mutex);</span><br><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $</span><br></pre></td></tr></table></figure>

<h2 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h2><p>shell1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rlk@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash$ echo $$</span><br><span class="line">4724</span><br><span class="line">rlk@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash$ sudo unshare --pid --mount-proc --fork &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# echo $$</span><br><span class="line">1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# sudo unshare --pid --mount-proc --fork &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# echo $$</span><br><span class="line">1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# sudo unshare --pid --mount-proc --fork &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# echo $$</span><br><span class="line">1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# sudo unshare --pid --mount-proc --fork &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# stress -c 10</span><br><span class="line">stress: info: [9] dispatching hogs: 10 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>


<p>shell2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# pstree -p 4724</span><br><span class="line">bash(4724)───sudo(4734)───unshare(4735)───bash(4736)───sudo(4744)───unshare(4746)───bash(4747)───sudo(4759)───unshare(4760)───bash(4761)───sudo(4770)──+++</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# grep pid &#x2F;proc&#x2F;4761&#x2F;status</span><br><span class="line">NSpid:	4761	21	11	1</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>第四个 bash 在 四个 pid namespace 中 分配 到的 pid 分别是<br><code>4761</code> <code>21</code>  <code>11</code> <code>1</code></p>
<h2 id="pid-namespace-实现"><a href="#pid-namespace-实现" class="headerlink" title="pid_namespace 实现"></a>pid_namespace 实现</h2><h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">copy_processes-&gt;copy_namespaces-&gt;create_new_namespaces-&gt;copy_pid_ns-&gt;create_pid_namespace</span><br><span class="line"></span><br><span class="line"> +----------------------+</span><br><span class="line"> |                      |</span><br><span class="line"> |                      |</span><br><span class="line"> |    copy_processes    |</span><br><span class="line"> |                      |</span><br><span class="line"> +----------+-----------+</span><br><span class="line">            |</span><br><span class="line">            |</span><br><span class="line">+-----------v------------+</span><br><span class="line">|                        |</span><br><span class="line">|                        |</span><br><span class="line">|    copy_namespaces     |</span><br><span class="line">|                        |</span><br><span class="line">+----------+-------------+</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">+----------v--------------+</span><br><span class="line">|                         |</span><br><span class="line">|                         |</span><br><span class="line">|  create_new_namespaces  |</span><br><span class="line">|                         |</span><br><span class="line">+----------+--------------+</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">+----------v------------+</span><br><span class="line">|                       |</span><br><span class="line">|                       |</span><br><span class="line">|     copy_pid_ns       |</span><br><span class="line">|                       |</span><br><span class="line">+----------+------------+</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">  +--------v------------+</span><br><span class="line">  |                     |</span><br><span class="line">  |                     |</span><br><span class="line">  | create_pid_namespace|</span><br><span class="line">  |                     |</span><br><span class="line">  +---------------------+</span><br></pre></td></tr></table></figure>

<p><code>create_pid_namespace</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">static struct pid_namespace *create_pid_namespace(struct user_namespace *user_ns,</span><br><span class="line">	struct pid_namespace *parent_pid_ns)</span><br><span class="line">&#123;</span><br><span class="line">	struct pid_namespace *ns;</span><br><span class="line">	unsigned int level &#x3D; parent_pid_ns-&gt;level + 1; &#x2F;&#x2F; level 在 parent的基础上 +1</span><br><span class="line">	struct ucounts *ucounts;</span><br><span class="line">	int err;</span><br><span class="line"></span><br><span class="line">	err &#x3D; -ENOMEM;</span><br><span class="line">	ns &#x3D; kmem_cache_zalloc(pid_ns_cachep, GFP_KERNEL);</span><br><span class="line">	if (ns &#x3D;&#x3D; NULL)</span><br><span class="line">		goto out_dec;</span><br><span class="line"></span><br><span class="line">	idr_init(&amp;ns-&gt;idr);</span><br><span class="line"></span><br><span class="line">	ns-&gt;pid_cachep &#x3D; create_pid_cachep(level);  &#x2F;&#x2F; 创建 cachep, 是根据 level 创建的。最大level 是 32</span><br><span class="line">	if (ns-&gt;pid_cachep &#x3D;&#x3D; NULL)</span><br><span class="line">		goto out_free_idr;</span><br><span class="line"></span><br><span class="line">	err &#x3D; ns_alloc_inum(&amp;ns-&gt;ns);</span><br><span class="line">	if (err)</span><br><span class="line">		goto out_free_idr;</span><br><span class="line">	ns-&gt;ns.ops &#x3D; &amp;pidns_operations;</span><br><span class="line"></span><br><span class="line">	refcount_set(&amp;ns-&gt;ns.count, 1);</span><br><span class="line">	ns-&gt;level &#x3D; level;                      &#x2F;&#x2F; 设置 level</span><br><span class="line">	ns-&gt;parent &#x3D; get_pid_ns(parent_pid_ns); &#x2F;&#x2F; 设置 parent</span><br><span class="line">	ns-&gt;user_ns &#x3D; get_user_ns(user_ns);</span><br><span class="line">	ns-&gt;ucounts &#x3D; ucounts;</span><br><span class="line">	ns-&gt;pid_allocated &#x3D; PIDNS_ADDING;</span><br><span class="line"></span><br><span class="line">	return ns;</span><br><span class="line"></span><br><span class="line">out_free_idr:</span><br><span class="line">	idr_destroy(&amp;ns-&gt;idr);</span><br><span class="line">	kmem_cache_free(pid_ns_cachep, ns);</span><br><span class="line">out_dec:</span><br><span class="line">	dec_pid_namespaces(ucounts);</span><br><span class="line">out:</span><br><span class="line">	return ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="alloc"><a href="#alloc" class="headerlink" title="alloc"></a>alloc</h3><p><code>alloc_pid</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">struct pid *alloc_pid(struct pid_namespace *ns, pid_t *set_tid,</span><br><span class="line">		      size_t set_tid_size)</span><br><span class="line">&#123;</span><br><span class="line">	struct pid *pid;</span><br><span class="line">	enum pid_type type;</span><br><span class="line">	int i, nr;</span><br><span class="line">	struct pid_namespace *tmp;</span><br><span class="line">	struct upid *upid;</span><br><span class="line">	int retval &#x3D; -ENOMEM;</span><br><span class="line"></span><br><span class="line">	pid &#x3D; kmem_cache_alloc(ns-&gt;pid_cachep, GFP_KERNEL);</span><br><span class="line">	if (!pid)</span><br><span class="line">		return ERR_PTR(retval);</span><br><span class="line"></span><br><span class="line">	tmp &#x3D; ns;</span><br><span class="line">	pid-&gt;level &#x3D; ns-&gt;level; &#x2F;&#x2F; 设置 level</span><br><span class="line"></span><br><span class="line">	for (i &#x3D; ns-&gt;level; i &gt;&#x3D; 0; i--) &#123;              &#x2F;&#x2F; 循环遍历 各个level，从大到小，pid的值从小到大（debug log中看到）</span><br><span class="line">		int tid &#x3D; 0;</span><br><span class="line"></span><br><span class="line">		idr_preload(GFP_KERNEL);</span><br><span class="line">		spin_lock_irq(&amp;pidmap_lock);</span><br><span class="line"></span><br><span class="line">		if (tid) &#123;</span><br><span class="line">			nr &#x3D; idr_alloc(&amp;tmp-&gt;idr, NULL, tid,</span><br><span class="line">				       tid + 1, GFP_ATOMIC); &#x2F;&#x2F; 从 tmp-&gt;idr 中分配</span><br><span class="line">			&#x2F;*</span><br><span class="line">			 * If ENOSPC is returned it means that the PID is</span><br><span class="line">			 * alreay in use. Return EEXIST in that case.</span><br><span class="line">			 *&#x2F;</span><br><span class="line">			if (nr &#x3D;&#x3D; -ENOSPC)</span><br><span class="line">				nr &#x3D; -EEXIST;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			int pid_min &#x3D; 1;</span><br><span class="line">			&#x2F;*</span><br><span class="line">			 * init really needs pid 1, but after reaching the</span><br><span class="line">			 * maximum wrap back to RESERVED_PIDS</span><br><span class="line">			 *&#x2F;</span><br><span class="line">			if (idr_get_cursor(&amp;tmp-&gt;idr) &gt; RESERVED_PIDS)</span><br><span class="line">				pid_min &#x3D; RESERVED_PIDS;</span><br><span class="line"></span><br><span class="line">			&#x2F;*</span><br><span class="line">			 * Store a null pointer so find_pid_ns does not find</span><br><span class="line">			 * a partially initialized PID (see below).</span><br><span class="line">			 *&#x2F;</span><br><span class="line">			nr &#x3D; idr_alloc_cyclic(&amp;tmp-&gt;idr, NULL, pid_min,</span><br><span class="line">					      pid_max, GFP_ATOMIC);</span><br><span class="line">		&#125;</span><br><span class="line">		spin_unlock_irq(&amp;pidmap_lock);</span><br><span class="line">		idr_preload_end();</span><br><span class="line"></span><br><span class="line">		if (nr &lt; 0) &#123;</span><br><span class="line">			retval &#x3D; (nr &#x3D;&#x3D; -ENOSPC) ? -EAGAIN : nr;</span><br><span class="line">			goto out_free;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pid-&gt;numbers[i].nr &#x3D; nr; &#x2F;&#x2F; pid 结构保存 各个level 的 pid数值，获取pid 的时候需要带上当前在哪一个 level上</span><br><span class="line">		pid-&gt;numbers[i].ns &#x3D; tmp;</span><br><span class="line">		pr_err(&quot;[robert] alloc_pid level &#x3D; %d, pid-&gt;numbers[i].nr &#x3D; %d\n&quot;,</span><br><span class="line">			pid-&gt;level, nr);</span><br><span class="line"></span><br><span class="line">		tmp &#x3D; tmp-&gt;parent; &#x2F;&#x2F; 获取上层的 pid_namespace</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="unshare-、-nsenter-用法"><a href="#unshare-、-nsenter-用法" class="headerlink" title="unshare 、 nsenter 用法"></a>unshare 、 nsenter 用法</h2><p>这些都是 shell 提供的和namespace 相关的命令</p>
<h3 id="unshare"><a href="#unshare" class="headerlink" title="unshare"></a>unshare</h3><p>unshare 解除 namespaces share, 创建新的进程，是Linux容器工作的基础之一。<br>通过 strace 工具看一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo strace unshare  -p -u -i &#x2F;bin&#x2F;bash</span><br><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;unshare&quot;, [&quot;unshare&quot;, &quot;-p&quot;, &quot;-u&quot;, &quot;-i&quot;, &quot;&#x2F;bin&#x2F;bash&quot;], 0x7ffeeb2594b0 &#x2F;* 22 vars *&#x2F;) &#x3D; 0</span><br><span class="line">unshare(CLONE_NEWUTS|CLONE_NEWIPC|CLONE_NEWPID) &#x3D; 0</span><br><span class="line">execve(&quot;&#x2F;bin&#x2F;bash&quot;, [&quot;&#x2F;bin&#x2F;bash&quot;], 0x7ffc50847728 &#x2F;* 22 vars *&#x2F;) &#x3D; 0</span><br></pre></td></tr></table></figure>
<p>可以看到 unshare(1) 是通过 unshare(2) 实现的<br><code>mount</code>  <code>mount-proc</code> 区别：</p>
<ul>
<li>mount: 创建 mount namespace</li>
<li>mount-proc: 自动挂载 /proc 文件系统，无需我们手动执行 mount -t proc proc /proc 命令。</li>
</ul>
<p>-p -f 一般是一起使用。</p>
<h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><p>一个最典型的用途就是进入容器的网络命令空间。<br>相当多的容器为了轻量级，是不包含较为基础的命令的，比如说ip address，ping，telnet，ss，tcpdump等等命令，<br>这就给调试容器网络带来相当大的困扰：只能通过docker inspect ContainerID命令获取到容器IP，<br>以及无法测试和其他网络的连通性。这时就可以使用nsenter命令仅进入该容器的网络命名空间，<br>使用宿主机的命令调试容器网络。</p>
<p>此外，nsenter也可以进入mnt, uts, ipc, pid, user命令空间，以及指定根目录和工作目录。<br>shell1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# sleep 100000 &amp;</span><br><span class="line">[2] 23</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# dmesg |tail -n 30</span><br><span class="line">[ 1515.281875] [robert] alloc_pid level &#x3D; 5, pid-&gt;numbers[i].nr &#x3D; 23</span><br><span class="line">[ 1515.285805] [robert] alloc_pid level &#x3D; 5, pid-&gt;numbers[i].nr &#x3D; 33</span><br><span class="line">[ 1515.287239] [robert] alloc_pid level &#x3D; 5, pid-&gt;numbers[i].nr &#x3D; 54</span><br><span class="line">[ 1515.288000] [robert] alloc_pid level &#x3D; 5, pid-&gt;numbers[i].nr &#x3D; 64</span><br><span class="line">[ 1515.288656] [robert] alloc_pid level &#x3D; 5, pid-&gt;numbers[i].nr &#x3D; 74</span><br><span class="line">[ 1515.289393] [robert] alloc_pid level &#x3D; 5, pid-&gt;numbers[i].nr &#x3D; 3791</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>
<p>这是在 一个 独立 namespace 中的 shell，在 global namespace中 pid是 3791</p>
<p>shell2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo nsenter -p -t3791</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# ls &amp;</span><br><span class="line">[1] 36</span><br></pre></td></tr></table></figure>

<p>通过 strace 工具看一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@1kernel: &#x2F;var&#x2F;crash# sudo strace nsenter -p  -t4123 ls -al</span><br><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;nsenter&quot;, [&quot;nsenter&quot;, &quot;-p&quot;, &quot;-t4123&quot;, &quot;ls&quot;, &quot;-al&quot;], 0x7fff5f859620 &#x2F;* 22 vars *&#x2F;) &#x3D; 0</span><br><span class="line">setns(3, CLONE_NEWPID)                  &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>nsenter相当于在setns的示例程序之上做了一层封装，使我们无需指定命名空间的文件描述符，而是指定进程号即可。</p>
<h2 id="unshare-、-setns-、-clone-用法"><a href="#unshare-、-setns-、-clone-用法" class="headerlink" title="unshare 、 setns 、 clone 用法"></a>unshare 、 setns 、 clone 用法</h2><p>后续有空 用 C实现一下 example。。。</p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://staight.github.io/2019/10/02/%E5%AE%B9%E5%99%A8%E5%AE%9E%E7%8E%B0-namespace/">容器实现-namespace</a><br><a href=""></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-06T11:00:00.000Z" title="7/6/2021, 7:00:00 PM">2021-07-06</time>发表</span><span class="level-item"><time dateTime="2021-07-06T09:45:56.928Z" title="7/6/2021, 5:45:56 PM">2021-07-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/cgroup-v1/">cgroup v1</a><span> / </span><a class="link-muted" href="/categories/cgroup-v1/cgroup-v2/">cgroup v2</a></span><span class="level-item">4 分钟读完 (大约600个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/06/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/cgroup%20v1%20&amp;&amp;%20v2/">cgroup v1 v2</a></h1><div class="content"><ol>
<li>cgroup v1 与 v2 可以同时并存吗？</li>
</ol>
<p>cgroup v1 v2 在编译时，是同时被编译进 kernel Image的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ cat kernel&#x2F;cgroup&#x2F;Makefile</span><br><span class="line"># SPDX-License-Identifier: GPL-2.0</span><br><span class="line">obj-y :&#x3D; cgroup.o rstat.o namespace.o cgroup-v1.o freezer.o</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>ubuntu 如何区分当前正在使用的是 cgroup v1 还是 v2<br>cgroup v1:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# mount | grep cgroup</span><br><span class="line">tmpfs on &#x2F;sys&#x2F;fs&#x2F;cgroup type tmpfs (ro,nosuid,nodev,noexec,mode&#x3D;755)</span><br><span class="line">cgroup2 on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;unified type cgroup2 (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name&#x3D;systemd)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset,clone_children)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>cgroup v2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ mount | grep cgroup</span><br><span class="line">cgroup2 on &#x2F;sys&#x2F;fs&#x2F;cgroup type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate)</span><br><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如何是的默认开启 cgroup v2<br>a. 修改 command line<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ cat &#x2F;etc&#x2F;default&#x2F;grub | grep LINE</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT&#x3D;&quot;quiet splash&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX&#x3D;&quot;systemd.unified_cgroup_hierarchy&#x3D;1&quot;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>b. 修改 command line, 来disable 所有 cgroup v1 的 feature</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cgroup_no_v1&#x3D;all</span><br></pre></td></tr></table></figure>
<p>对应 <code>kernel/cgroup/cgroup-v1.c</code> 中 <code>cgroup_no_v1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int __init cgroup_no_v1(char *str);</span><br></pre></td></tr></table></figure>

<p>c. 可以在 其他挂载点，重新挂载 cgroup2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cgroup2 none &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>cgroup v1、v2 中task 是如何加入 cgroup的？<br>cgroup v1:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# cat  &#x2F;proc&#x2F;$$&#x2F;cgroup</span><br><span class="line">12:pids:&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-99270.scope</span><br><span class="line">11:rdma:&#x2F;</span><br><span class="line">10:freezer:&#x2F;user&#x2F;ubuntu&#x2F;0</span><br><span class="line">9:net_cls,net_prio:&#x2F;</span><br><span class="line">8:hugetlb:&#x2F;</span><br><span class="line">7:perf_event:&#x2F;</span><br><span class="line">6:memory:&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-99270.scope</span><br><span class="line">5:blkio:&#x2F;user.slice</span><br><span class="line">4:cpuset:&#x2F;</span><br><span class="line">3:devices:&#x2F;user.slice</span><br><span class="line">2:cpu,cpuacct:&#x2F;user.slice</span><br><span class="line">1:name&#x3D;systemd:&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-99270.scope</span><br><span class="line">0::&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-99270.scope</span><br><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace#</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>cgroup v1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ cat &#x2F;proc&#x2F;$$&#x2F;cgroup</span><br><span class="line">0::&#x2F;user.slice&#x2F;user-1000.slice&#x2F;session-166.scope</span><br><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $</span><br></pre></td></tr></table></figure>

<p>可以看到 cgroup v1中，一个 task会存在多个 子系统的目录下，即使这个子系统没有起作用（在子系统根目录）；在 cgroup v2 中，一个 task 只会存在一个 目录下，简洁（一个目录根据 cgoups.controller 来使能相关的 子系统）</p>
<ol start="5">
<li>a</li>
</ol>
<ol start="6">
<li>aa</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-06T11:00:00.000Z" title="7/6/2021, 7:00:00 PM">2021-07-06</time>发表</span><span class="level-item"><time dateTime="2021-07-07T09:03:42.477Z" title="7/7/2021, 5:03:42 PM">2021-07-07</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/namespace/">namespace</a><span> / </span><a class="link-muted" href="/categories/namespace/uts-namespace/">uts namespace</a></span><span class="level-item">7 分钟读完 (大约997个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/06/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/namespace%E4%B9%8Buts/">namespace之uts</a></h1><div class="content"><h2 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h2><p>shell1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@1kernel: &#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo unshare -p -f &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br></pre></td></tr></table></figure>

<p>shell2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo unshare -p -f &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname hhh</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">hhh</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>shell1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@1kernel: &#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo unshare -p -f &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">hhh</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>可以看出在没有新建uts namespace的时候， 他们都是同一个 uts name；<br>只要修改任何一个 uts 中的 hostname 的话，所有的都会被修改</p>
<h2 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h2><p>shell1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo unshare -p -f -u &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname shell1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">shell1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>shell2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo unshare -p -f -u &#x2F;bin&#x2F;bash</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname shell2</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">shell2</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>shell3:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# hostname</span><br><span class="line">rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>可以看出，只要新建了 uts namespace 之后，在 new uts namespace中做任何对 hostname 的修改，都不会影响到 其他 old uts namespace 的 hostname.</p>
<h2 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h2><p>shell1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">shell1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# sleep 10000 &amp;</span><br><span class="line">[1] 18</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<p>shell2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# ps -aux | grep sleep</span><br><span class="line">root        3860  0.0  0.0  16716   528 pts&#x2F;0    S    17:02   0:00 sleep 10000</span><br><span class="line">rlk         3862  0.0  0.0  17676   728 pts&#x2F;1    S+   17:02   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox sleep</span><br><span class="line">stable_kernel@1kernel: &#x2F;var&#x2F;crash# sudo nsenter -u -t3860</span><br><span class="line">xhost:  unable to open display &quot;&quot;</span><br><span class="line">root@shell1:&#x2F;var&#x2F;crash# hostname</span><br><span class="line">shell1</span><br><span class="line">root@shell1:&#x2F;var&#x2F;crash#</span><br></pre></td></tr></table></figure>

<h2 id="uts-namespace-实现"><a href="#uts-namespace-实现" class="headerlink" title="uts_namespace 实现"></a>uts_namespace 实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">copy_processes-&gt;copy_namespaces-&gt;create_new_namespaces-&gt;copy_utsname</span><br><span class="line"></span><br><span class="line"> +----------------------+</span><br><span class="line"> |                      |</span><br><span class="line"> |                      |</span><br><span class="line"> |    copy_processes    |</span><br><span class="line"> |                      |</span><br><span class="line"> +----------+-----------+</span><br><span class="line">            |</span><br><span class="line">            |</span><br><span class="line">+-----------v------------+</span><br><span class="line">|                        |</span><br><span class="line">|                        |</span><br><span class="line">|    copy_namespaces     |</span><br><span class="line">|                        |</span><br><span class="line">+----------+-------------+</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">+----------v--------------+</span><br><span class="line">|                         |</span><br><span class="line">|                         |</span><br><span class="line">|  create_new_namespaces  |</span><br><span class="line">|                         |</span><br><span class="line">+----------+--------------+</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">           |</span><br><span class="line">+----------v------------+</span><br><span class="line">|                       |</span><br><span class="line">|                       |</span><br><span class="line">|     copy_utsname      |</span><br><span class="line">|                       |</span><br><span class="line">+----------+------------+</span><br></pre></td></tr></table></figure>



<p><code>clone_uts_ns</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">static struct uts_namespace *clone_uts_ns(struct user_namespace *user_ns,</span><br><span class="line">					  struct uts_namespace *old_ns)</span><br><span class="line">&#123;</span><br><span class="line">	struct uts_namespace *ns;</span><br><span class="line">	struct ucounts *ucounts;</span><br><span class="line">	int err;</span><br><span class="line"></span><br><span class="line">	err &#x3D; -ENOSPC;</span><br><span class="line">	ucounts &#x3D; inc_uts_namespaces(user_ns);</span><br><span class="line">	if (!ucounts)</span><br><span class="line">		goto fail;</span><br><span class="line"></span><br><span class="line">	err &#x3D; -ENOMEM;</span><br><span class="line">	ns &#x3D; create_uts_ns();</span><br><span class="line">	if (!ns)</span><br><span class="line">		goto fail_dec;</span><br><span class="line"></span><br><span class="line">	err &#x3D; ns_alloc_inum(&amp;ns-&gt;ns);</span><br><span class="line">	if (err)</span><br><span class="line">		goto fail_free;</span><br><span class="line"></span><br><span class="line">	ns-&gt;ucounts &#x3D; ucounts;</span><br><span class="line">	ns-&gt;ns.ops &#x3D; &amp;utsns_operations;</span><br><span class="line"></span><br><span class="line">	down_read(&amp;uts_sem);</span><br><span class="line">	memcpy(&amp;ns-&gt;name, &amp;old_ns-&gt;name, sizeof(ns-&gt;name)); 	&#x2F;&#x2F; name 是 struct new_utsname 类型，不是 string</span><br><span class="line">	ns-&gt;user_ns &#x3D; get_user_ns(user_ns);</span><br><span class="line">	up_read(&amp;uts_sem);</span><br><span class="line">	return ns;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct uts_namespace *copy_utsname(unsigned long flags,</span><br><span class="line">	struct user_namespace *user_ns, struct uts_namespace *old_ns)</span><br><span class="line">&#123;</span><br><span class="line">	struct uts_namespace *new_ns;</span><br><span class="line"></span><br><span class="line">	BUG_ON(!old_ns);</span><br><span class="line">	get_uts_ns(old_ns);</span><br><span class="line"></span><br><span class="line">	if (!(flags &amp; CLONE_NEWUTS))</span><br><span class="line">		return old_ns;</span><br><span class="line"></span><br><span class="line">	new_ns &#x3D; clone_uts_ns(user_ns, old_ns);  &#x2F;&#x2F; 完全 clone parent 的 uts_namespace</span><br><span class="line"></span><br><span class="line">	put_uts_ns(old_ns);</span><br><span class="line">	return new_ns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><p>看一下 strace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# strace hostname shell0</span><br><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;hostname&quot;, [&quot;hostname&quot;, &quot;shell0&quot;], 0x7ffd8feacde8 &#x2F;* 27 vars *&#x2F;) &#x3D; 0</span><br><span class="line">sethostname(&quot;shell0&quot;, 6)                &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>linux 是通过 sethostname syscall 来修改 hostname(保存在 nodename 中)的。<br><code>sethostname</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">static struct ctl_table uts_kern_table[] &#x3D; &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;hostname&quot;,</span><br><span class="line">		.data		&#x3D; init_uts_ns.name.nodename,</span><br><span class="line">		.maxlen		&#x3D; sizeof(init_uts_ns.name.nodename),</span><br><span class="line">		.mode		&#x3D; 0644,</span><br><span class="line">		.proc_handler	&#x3D; proc_do_uts_string,</span><br><span class="line">		.poll		&#x3D; &amp;hostname_poll,</span><br><span class="line">	&#125;,</span><br><span class="line">......</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE2(sethostname, char __user *, name, int, len)</span><br><span class="line">&#123;</span><br><span class="line">	int errno;</span><br><span class="line">	char tmp[__NEW_UTS_LEN];</span><br><span class="line"></span><br><span class="line">	if (!ns_capable(current-&gt;nsproxy-&gt;uts_ns-&gt;user_ns, CAP_SYS_ADMIN))</span><br><span class="line">		return -EPERM;</span><br><span class="line"></span><br><span class="line">	if (len &lt; 0 || len &gt; __NEW_UTS_LEN)</span><br><span class="line">		return -EINVAL;</span><br><span class="line">	errno &#x3D; -EFAULT;</span><br><span class="line">	if (!copy_from_user(tmp, name, len)) &#123;</span><br><span class="line">		struct new_utsname *u;</span><br><span class="line"></span><br><span class="line">		down_write(&amp;uts_sem);</span><br><span class="line">		u &#x3D; utsname();</span><br><span class="line">		memcpy(u-&gt;nodename, tmp, len);</span><br><span class="line">		memset(u-&gt;nodename + len, 0, sizeof(u-&gt;nodename) - len);</span><br><span class="line">		errno &#x3D; 0;</span><br><span class="line">		uts_proc_notify(UTS_PROC_HOSTNAME);</span><br><span class="line">		up_write(&amp;uts_sem);</span><br><span class="line">	&#125;</span><br><span class="line">	return errno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>看一下 strace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;var&#x2F;crash# strace hostname</span><br><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;hostname&quot;, [&quot;hostname&quot;], 0x7ffe740a5980 &#x2F;* 27 vars *&#x2F;) &#x3D; 0</span><br><span class="line">uname(&#123;sysname&#x3D;&quot;Linux&quot;, nodename&#x3D;&quot;shell2&quot;, ...&#125;) &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>linux 是通过 uname syscall 来获取 uts 相关信息的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE1(uname, struct old_utsname __user *, name)</span><br><span class="line">&#123;</span><br><span class="line">	struct old_utsname tmp;</span><br><span class="line"></span><br><span class="line">	if (!name)</span><br><span class="line">		return -EFAULT;</span><br><span class="line"></span><br><span class="line">	down_read(&amp;uts_sem);</span><br><span class="line">	memcpy(&amp;tmp, utsname(), sizeof(tmp));		&#x2F;&#x2F; 获取 task相关utsname 信息</span><br><span class="line">	up_read(&amp;uts_sem);</span><br><span class="line">	if (copy_to_user(name, &amp;tmp, sizeof(tmp)))	&#x2F;&#x2F; copy 到 user space</span><br><span class="line">		return -EFAULT;</span><br><span class="line"></span><br><span class="line">	if (override_release(name-&gt;release, sizeof(name-&gt;release)))</span><br><span class="line">		return -EFAULT;</span><br><span class="line">	if (override_architecture(name))</span><br><span class="line">		return -EFAULT;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








<p>参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sparkdev/p/9377072.html">Linux Namespace : UTS</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-15T11:00:00.000Z" title="6/15/2021, 7:00:00 PM">2021-06-15</time>发表</span><span class="level-item"><time dateTime="2021-06-15T08:20:49.884Z" title="6/15/2021, 4:20:49 PM">2021-06-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux-kernel/">linux kernel</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/">linux schedule</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/idle/">idle</a></span><span class="level-item">3 分钟读完 (大约375个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/15/schedule/idle%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%94%B1%E6%9D%A5/">idle 进程的由来</a></h1><div class="content"><h2 id="idle-线程"><a href="#idle-线程" class="headerlink" title="idle 线程"></a>idle 线程</h2><p>linux 中给 per cpu都安排了一个结构<code>runqueue</code>，只要此 runqueue中有 runnable的thread,<br>scheduler 就不会进入 idle状态；相反，只要没有runnable的task，scheduler就会执行 <code>idle task</code>，使得cpu进入 idle模式。</p>
<h2 id="idle-线程如何产生的？"><a href="#idle-线程如何产生的？" class="headerlink" title="idle 线程如何产生的？"></a>idle 线程如何产生的？</h2><h3 id="单cpu-core架构中"><a href="#单cpu-core架构中" class="headerlink" title="单cpu core架构中"></a>单cpu core架构中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void cpu_startup_entry(enum cpuhp_state state)</span><br><span class="line">&#123;</span><br><span class="line">	arch_cpu_idle_prepare();</span><br><span class="line">	cpuhp_online_idle(state);</span><br><span class="line">	while (1)</span><br><span class="line">		do_idle();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">noinline void __ref rest_init(void)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">	cpu_startup_entry(CPUHP_ONLINE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __init __weak arch_call_rest_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	rest_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asmlinkage __visible void __init __no_sanitize_address start_kernel(void)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">      	arch_call_rest_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="smp架构中"><a href="#smp架构中" class="headerlink" title="smp架构中"></a>smp架构中</h3><p>smp 架构在boot的时候也是单cpu 先boot,然后结果smp_init()，将系统中其他cpu boot起来。<br>所以在 boot cpu中，idle线程还是通过 <code>rest_init()</code> 产生的。</p>
<p>非 <code>boot cpu</code> 的情况下，idle 线程是通过<code>idle_threads_init()</code> 产生的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">static inline void idle_init(unsigned int cpu)</span><br><span class="line">&#123;</span><br><span class="line">	struct task_struct *tsk &#x3D; per_cpu(idle_threads, cpu);</span><br><span class="line"></span><br><span class="line">	if (!tsk) &#123;</span><br><span class="line">		tsk &#x3D; fork_idle(cpu);</span><br><span class="line">		if (IS_ERR(tsk))</span><br><span class="line">			pr_err(&quot;SMP: fork_idle() failed for CPU %u\n&quot;, cpu);</span><br><span class="line">		else</span><br><span class="line">			per_cpu(idle_threads, cpu) &#x3D; tsk;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * idle_threads_init - Initialize idle threads for all cpus</span><br><span class="line"> *&#x2F;</span><br><span class="line">void __init idle_threads_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned int cpu, boot_cpu;</span><br><span class="line"></span><br><span class="line">	boot_cpu &#x3D; smp_processor_id();</span><br><span class="line"></span><br><span class="line">	for_each_possible_cpu(cpu) &#123;</span><br><span class="line">		if (cpu !&#x3D; boot_cpu)</span><br><span class="line">			idle_init(cpu);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* Called by boot processor to activate the rest. *&#x2F;</span><br><span class="line">void __init smp_init(void)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">	idle_threads_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static noinline void __init kernel_init_freeable(void)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">	smp_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int __ref kernel_init(void *unused)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	kernel_init_freeable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">noinline void __ref rest_init(void)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">	pid &#x3D; kernel_thread(kernel_init, NULL, CLONE_FS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rest_init<br>  – kernel_init<br>    – kernel_init_freeable<br>      – smp_init<br>        – idle_threads_init<br>          – idle_init</p>
<h2 id="idle-线程干了啥？"><a href="#idle-线程干了啥？" class="headerlink" title="idle 线程干了啥？"></a>idle 线程干了啥？</h2><p>后续熟悉 arm cpu指令再补充..</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-11T11:00:00.000Z" title="6/11/2021, 7:00:00 PM">2021-06-11</time>发表</span><span class="level-item"><time dateTime="2021-06-11T09:22:33.005Z" title="6/11/2021, 5:22:33 PM">2021-06-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">4 分钟读完 (大约661个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/11/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/kfence%20%E4%BD%BF%E7%94%A8/">kfence 使用</a></h1><div class="content"><h2 id="Kfence-配置"><a href="#Kfence-配置" class="headerlink" title="Kfence 配置"></a>Kfence 配置</h2><p>看下<code>.config</code>的改变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ diff .&#x2F;out&#x2F;.config &#x2F;tmp&#x2F;.config</span><br><span class="line">4713c4713,4717</span><br><span class="line">&lt; # CONFIG_KFENCE is not set</span><br><span class="line">---</span><br><span class="line">&gt; CONFIG_KFENCE&#x3D;y</span><br><span class="line">&gt; CONFIG_KFENCE_STATIC_KEYS&#x3D;y</span><br><span class="line">&gt; CONFIG_KFENCE_SAMPLE_INTERVAL&#x3D;100</span><br><span class="line">&gt; CONFIG_KFENCE_NUM_OBJECTS&#x3D;255</span><br><span class="line">&gt; CONFIG_KFENCE_STRESS_TEST_FAULTS&#x3D;0</span><br></pre></td></tr></table></figure>

<h2 id="Kfence-使用"><a href="#Kfence-使用" class="headerlink" title="Kfence 使用"></a>Kfence 使用</h2><p>写了一个test case，参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/memory/kfence/kfence_debug.c">代码</a></p>
<h3 id="oob检测"><a href="#oob检测" class="headerlink" title="oob检测"></a>oob检测</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static int kfence_debug_oob(void *data)</span><br><span class="line">&#123;</span><br><span class="line">	char *p[100] &#x3D; &#123;NULL, &#125;;</span><br><span class="line">	int i &#x3D; 0;</span><br><span class="line">	data &#x3D; data;</span><br><span class="line"></span><br><span class="line">	msleep(1000 * 5);</span><br><span class="line">	for (i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">		p[i] &#x3D; (char *)kmalloc(32, GFP_KERNEL);</span><br><span class="line">		p[i][32] &#x3D; &#39;a&#39;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	while(!kthread_should_stop()) &#123;</span><br><span class="line">		msleep_interruptible(1000);</span><br><span class="line">	&#125;</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要就是越界写了 1byte的 kmalloc数据。</p>
<p>insmod 之后立刻报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[  779.341929] kfence_debug: loading out-of-tree module taints kernel.</span><br><span class="line">[  784.638024] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[  784.641414] BUG: KFENCE: out-of-bounds write in kfence_debug_oob+0x26&#x2F;0x60 [kfence_debug]</span><br><span class="line"></span><br><span class="line">[  784.643513] Out-of-bounds write at 0x00000000514f5e22 (32B right of kfence-#176):</span><br><span class="line">[  784.644142]  kfence_debug_oob+0x26&#x2F;0x60 [kfence_debug]</span><br><span class="line">[  784.644144]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[  784.644146]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[  784.644283] kfence-#176 [0x000000001f204f03-0x00000000533650da, size&#x3D;32, cache&#x3D;kmalloc-32] allocated by task 3757:</span><br><span class="line">[  784.644288]  kfence_debug_oob+0x26&#x2F;0x60 [kfence_debug]</span><br><span class="line">[  784.644289]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[  784.644290]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[  784.644423] CPU: 2 PID: 3757 Comm: kfence_debug Kdump: loaded Tainted: G           O      5.13.0-rc5+ #4</span><br><span class="line">[  784.645207] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[  784.646006] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p><code>oob</code> 的 代码堆栈直接也打印出来了，十分清晰</p>
<h3 id="use-after-free-检测"><a href="#use-after-free-检测" class="headerlink" title="use after free 检测"></a>use after free 检测</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static int kfence_debug_use_after_free(void *data)</span><br><span class="line">&#123;</span><br><span class="line">	char *p[100] &#x3D; &#123;NULL, &#125;;</span><br><span class="line">	int i &#x3D; 0;</span><br><span class="line">	data &#x3D; data;</span><br><span class="line"></span><br><span class="line">	msleep(1000 * 5);</span><br><span class="line">	for (i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">		p[i] &#x3D; (char *)kmalloc(32, GFP_KERNEL);</span><br><span class="line">		p[i][30] &#x3D; &#39;a&#39;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for (i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">		kfree(p[i]);</span><br><span class="line">		msleep_interruptible(100);</span><br><span class="line">		p[i][30] &#x3D; &#39;a&#39;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	while(!kthread_should_stop()) &#123;</span><br><span class="line">		msleep_interruptible(1000);</span><br><span class="line">	&#125;</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>user after free:</p>
<ul>
<li>kmalloc 32 bytes mem =&gt; p</li>
<li>assign val to p[30]</li>
<li>free p</li>
<li>assign val to p[30]</li>
</ul>
<p>insmod 之后立刻报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ 1779.536493] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[ 1779.539850] BUG: KFENCE: use-after-free write in kfence_debug_use_after_free+0x7e&#x2F;0xd0 [kfence_debug]</span><br><span class="line"></span><br><span class="line">[ 1779.542427] Use-after-free write at 0x0000000013fef528 (in kfence-#218):</span><br><span class="line">[ 1779.542985]  kfence_debug_use_after_free+0x7e&#x2F;0xd0 [kfence_debug]</span><br><span class="line">[ 1779.542987]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[ 1779.542990]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[ 1779.543123] kfence-#218 [0x000000007dc7fe8d-0x0000000000dd0a85, size&#x3D;32, cache&#x3D;kmalloc-32] allocated by task 3868:</span><br><span class="line">[ 1779.543127]  kfence_debug_use_after_free+0x58&#x2F;0xd0 [kfence_debug]</span><br><span class="line">[ 1779.543129]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[ 1779.543130]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[ 1779.543131]</span><br><span class="line">               freed by task 3868:</span><br><span class="line">[ 1779.543133]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[ 1779.543134]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[ 1779.543266] CPU: 1 PID: 3868 Comm: kfence_debug Kdump: loaded Tainted: G    B      O      5.13.0-rc5+ #4</span><br><span class="line">[ 1779.544051] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[ 1779.544818] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>可以看出这是一个 <code>kmalloc-32</code> 的 mem，且是 <code>allocated</code> by task 3868，<code>freed</code> by task 3868。<br>也可以看到详细堆栈。</p>
<h3 id="double-free-检测"><a href="#double-free-检测" class="headerlink" title="double free 检测"></a>double free 检测</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">static int kfence_debug_double_free(void *data)</span><br><span class="line">&#123;</span><br><span class="line">	char *p[100] &#x3D; &#123;NULL, &#125;;</span><br><span class="line">	int i &#x3D; 0;</span><br><span class="line">	data &#x3D; data;</span><br><span class="line"></span><br><span class="line">	msleep(1000 * 5);</span><br><span class="line">	for (i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">		p[i] &#x3D; (char *)kmalloc(32, GFP_KERNEL);</span><br><span class="line">		p[i][30] &#x3D; &#39;a&#39;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for (i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">		kfree(p[i]);</span><br><span class="line">		msleep_interruptible(100);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for (i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">		kfree(p[i]);</span><br><span class="line">		msleep_interruptible(100);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	while(!kthread_should_stop()) &#123;</span><br><span class="line">		msleep_interruptible(1000);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>double free:</p>
<ul>
<li>kmalloc 32 bytes mem =&gt; p</li>
<li>free p</li>
<li>free p</li>
</ul>
<p>insmod 之后立刻报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[ 2489.576810] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[ 2489.577668] BUG: KFENCE: invalid free in kthread+0xf9&#x2F;0x130</span><br><span class="line"></span><br><span class="line">[ 2489.578464] Invalid free of 0x00000000ed008e01 (in kfence-#160):</span><br><span class="line">[ 2489.579128]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[ 2489.579131]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[ 2489.579305] kfence-#160 [0x00000000ed008e01-0x0000000086ffed42, size&#x3D;32, cache&#x3D;kmalloc-32] allocated by task 3914:</span><br><span class="line">[ 2489.579310]  kfence_debug_double_free+0x58&#x2F;0xd0 [kfence_debug]</span><br><span class="line">[ 2489.579312]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[ 2489.579313]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[ 2489.579315]</span><br><span class="line">               freed by task 3914:</span><br><span class="line">[ 2489.579318]  kthread+0xf9&#x2F;0x130</span><br><span class="line">[ 2489.579319]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[ 2489.579492] CPU: 3 PID: 3914 Comm: kfence_debug Kdump: loaded Tainted: G    B      O      5.13.0-rc5+ #4</span><br><span class="line">[ 2489.580590] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[ 2489.581698] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>可以看出这是一个 <code>kmalloc-32</code> 的 mem，且是 <code>allocated</code> by task 3914, <code>freed</code> by task 3914。<br>也可以看到详细堆栈。</p>
<h2 id="Kfence-原理"><a href="#Kfence-原理" class="headerlink" title="Kfence 原理"></a>Kfence 原理</h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-01T11:00:00.000Z" title="6/1/2021, 7:00:00 PM">2021-06-01</time>发表</span><span class="level-item"><time dateTime="2022-01-11T06:43:57.999Z" title="1/11/2022, 2:43:57 PM">2022-01-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux-kernel/">linux kernel</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/">linux schedule</a></span><span class="level-item">8 分钟读完 (大约1266个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/01/schedule/benchmark/">benchmark</a></h1><div class="content"><p>参考<a target="_blank" rel="noopener" href="https://lwn.net/Articles/725238/">LWN文章</a></p>
<h2 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h2><h2 id="hackbench"><a href="#hackbench" class="headerlink" title="hackbench"></a>hackbench</h2><p><code>hackbench</code> 包含在 <code>rt-tests</code> 中，主要是 rt性能 的测试。<br>可以下载<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/utils/rt-tests/rt-tests.git">源码</a>编译安装<br>或者<code>rt-tests</code>安装包安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;test $ sudo apt-cache search hackbench</span><br><span class="line">rt-tests - Test programs for rt kernels</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;test $</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;test $ hackbench</span><br><span class="line">Running in process mode with 10 groups using 40 file descriptors each (&#x3D;&#x3D; 400 tasks)</span><br><span class="line">Each sender will pass 100 messages of 100 bytes</span><br><span class="line">Time: 0.093</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;test $</span><br></pre></td></tr></table></figure>







<h2 id="schbench"><a href="#schbench" class="headerlink" title="schbench"></a>schbench</h2><p><code>schbench</code> 需要自己手动编译安装，地址在 <a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/mason/schbench.git/tree/">这里</a><br>下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git:&#x2F;&#x2F;git.kernel.org&#x2F;pub&#x2F;scm&#x2F;linux&#x2F;kernel&#x2F;git&#x2F;mason&#x2F;schbench.git</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ ls</span><br><span class="line">Makefile  schbench.c  schedstat.py</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ make</span><br><span class="line">gcc -o schbench.o -c -Wall -O2 -g -W -D_GNU_SOURCE -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS&#x3D;64 schbench.c</span><br><span class="line">gcc -Wall -O2 -g -W -D_GNU_SOURCE -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS&#x3D;64 -o schbench schbench.o -lpthread</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ ls</span><br><span class="line">Makefile  schbench  schbench.c  schbench.o  schedstat.py</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ ls</span><br><span class="line">Makefile  schbench  schbench.c  schbench.o  schedstat.py</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ sudo mv schbench &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ ls</span><br><span class="line">Makefile  schbench.c  schbench.o  schedstat.py</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $</span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $ schbench</span><br><span class="line"></span><br><span class="line">warmup done, zeroing stats</span><br><span class="line">Latency percentiles (usec) runtime 10 (s) (1649 total samples)</span><br><span class="line">	50.0th: 80 (833 samples)</span><br><span class="line">	75.0th: 8040 (404 samples)</span><br><span class="line">	90.0th: 14352 (248 samples)</span><br><span class="line">	95.0th: 16016 (95 samples)</span><br><span class="line">	*99.0th: 24992 (54 samples)</span><br><span class="line">	99.5th: 28960 (7 samples)</span><br><span class="line">	99.9th: 31968 (8 samples)</span><br><span class="line">	min&#x3D;4, max&#x3D;31999</span><br><span class="line">Latency percentiles (usec) runtime 20 (s) (4929 total samples)</span><br><span class="line">	50.0th: 77 (2473 samples)</span><br><span class="line">	75.0th: 8056 (1234 samples)</span><br><span class="line">	90.0th: 14160 (735 samples)</span><br><span class="line">	95.0th: 15824 (247 samples)</span><br><span class="line">	*99.0th: 24736 (193 samples)</span><br><span class="line">	99.5th: 28000 (24 samples)</span><br><span class="line">	99.9th: 32032 (22 samples)</span><br><span class="line">	min&#x3D;3, max&#x3D;39652</span><br><span class="line">Latency percentiles (usec) runtime 30 (s) (8274 total samples)</span><br><span class="line">	50.0th: 75 (4163 samples)</span><br><span class="line">	75.0th: 8008 (2059 samples)</span><br><span class="line">	90.0th: 14096 (1226 samples)</span><br><span class="line">	95.0th: 15760 (415 samples)</span><br><span class="line">	*99.0th: 24096 (329 samples)</span><br><span class="line">	99.5th: 26976 (41 samples)</span><br><span class="line">	99.9th: 31968 (34 samples)</span><br><span class="line">	min&#x3D;3, max&#x3D;39652</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench $</span><br></pre></td></tr></table></figure>






<h2 id="adrestia"><a href="#adrestia" class="headerlink" title="adrestia"></a>adrestia</h2><p><code>adrestia</code> 需要自己手动编译安装，地址在 <a target="_blank" rel="noopener" href="https://github.com/mfleming/adrestia.git">这里</a></p>
<p>下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;mfleming&#x2F;adrestia.git</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench&#x2F;adrestia $ make</span><br><span class="line">cc -Wall -lpthread -I &#x2F;tmp&#x2F;schbench&#x2F;adrestia&#x2F;include -g   -c -o wake.o wake.c</span><br><span class="line">cc -Wall -lpthread -I &#x2F;tmp&#x2F;schbench&#x2F;adrestia&#x2F;include -g   -c -o stats.o stats.c</span><br><span class="line">cc -Wall -lpthread -I &#x2F;tmp&#x2F;schbench&#x2F;adrestia&#x2F;include -g adrestia.c wake.o stats.o -o adrestia -lpthread</span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench&#x2F;adrestia $ .&#x2F;adrestia</span><br><span class="line">wakeup cost (single): 11us</span><br><span class="line">wakeup cost (periodic, 10us): 12us</span><br><span class="line">ubuntu@zeku_server:&#x2F;tmp&#x2F;schbench&#x2F;adrestia $</span><br></pre></td></tr></table></figure>










<h2 id="rt-app"><a href="#rt-app" class="headerlink" title="rt-app"></a>rt-app</h2><p><code>rt-app</code> 需要自己手动编译安装，地址在 <a target="_blank" rel="noopener" href="https://github.com/scheduler-tools/rt-app">这里</a></p>
<p>下载 编译 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;scheduler-tools&#x2F;rt-app</span><br></pre></td></tr></table></figure>

<p>也可以直接安装包安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;rt-tests $ sudo apt-cache search rt-app</span><br><span class="line">pixelmed-webstart-apps - DICOM implementation containing Image Viewer and a ECG Viewer - jnlp</span><br><span class="line">rt-app - Test application which simulates a real-time periodic load</span><br></pre></td></tr></table></figure>

<p>guide 在 <code>rt-app/doc/tutorial.txt</code> 目录下，有几个比较重要的 配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;cpus&quot; : [2,3], &#x2F;*  set cpu affinity*&#x2F;</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>运行直接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rt-app tmp.json</span><br></pre></td></tr></table></figure>

<p>利用rt-app 可以做很多场景的模拟，doc/example目录中有模拟 mp3 codec的json文件，<br>后续再研究。</p>
<h2 id="cyclictest"><a href="#cyclictest" class="headerlink" title="cyclictest"></a>cyclictest</h2><p>也是 <code>rt-tests</code> 中一个组件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;rt-tests $ .&#x2F;cyclictest --help</span><br><span class="line">cyclictest V 2.30</span><br><span class="line">Usage:</span><br><span class="line">cyclictest &lt;options&gt;</span><br><span class="line"></span><br><span class="line">-a [CPUSET] --affinity     Run thread #N on processor #N, if possible, or if CPUSET</span><br><span class="line">                           given, pin threads to that set of processors in round-</span><br><span class="line">                           robin order.  E.g. -a 2 pins all threads to CPU 2,</span><br><span class="line">                           but -a 3-5,0 -t 5 will run the first and fifth</span><br><span class="line">                           threads on CPU (0),thread #2 on CPU 3, thread #3</span><br><span class="line">                           on CPU 4, and thread #5 on CPU 5.</span><br><span class="line">-A USEC  --aligned&#x3D;USEC    align thread wakeups to a specific offset</span><br><span class="line">-b USEC  --breaktrace&#x3D;USEC send break trace command when latency &gt; USEC</span><br><span class="line">-c CLOCK --clock&#x3D;CLOCK     select clock</span><br><span class="line">                           0 &#x3D; CLOCK_MONOTONIC (default)</span><br><span class="line">                           1 &#x3D; CLOCK_REALTIME</span><br><span class="line">         --default-system  Don&#39;t attempt to tune the system from cyclictest.</span><br><span class="line">                           Power management is not suppressed.</span><br><span class="line">                           This might give poorer results, but will allow you</span><br><span class="line">                           to discover if you need to tune the system</span><br><span class="line">-d DIST  --distance&#x3D;DIST   distance of thread intervals in us, default&#x3D;500</span><br><span class="line">-D       --duration&#x3D;TIME   specify a length for the test run.</span><br><span class="line">                           Append &#39;m&#39;, &#39;h&#39;, or &#39;d&#39; to specify minutes, hours or days.</span><br><span class="line">-F       --fifo&#x3D;&lt;path&gt;     create a named pipe at path and write stats to it</span><br><span class="line">-h       --histogram&#x3D;US    dump a latency histogram to stdout after the run</span><br><span class="line">                           US is the max latency time to be tracked in microseconds</span><br><span class="line">                           This option runs all threads at the same priority.</span><br><span class="line">-H       --histofall&#x3D;US    same as -h except with an additional summary column</span><br><span class="line">         --histfile&#x3D;&lt;path&gt; dump the latency histogram to &lt;path&gt; instead of stdout</span><br><span class="line">-i INTV  --interval&#x3D;INTV   base interval of thread in us default&#x3D;1000</span><br><span class="line">         --json&#x3D;FILENAME   write final results into FILENAME, JSON formatted</span><br><span class="line">         --laptop          Save battery when running cyclictest</span><br><span class="line">                           This will give you poorer realtime results</span><br><span class="line">                           but will not drain your battery so quickly</span><br><span class="line">         --latency&#x3D;PM_QOS  power management latency target value</span><br><span class="line">                           This value is written to &#x2F;dev&#x2F;cpu_dma_latency</span><br><span class="line">                           and affects c-states. The default is 0</span><br><span class="line">-l LOOPS --loops&#x3D;LOOPS     number of loops: default&#x3D;0(endless)</span><br><span class="line">         --mainaffinity&#x3D;CPUSET</span><br><span class="line">                           Run the main thread on CPU #N. This only affects</span><br><span class="line">                           the main thread and not the measurement threads</span><br><span class="line">-m       --mlockall        lock current and future memory allocations</span><br><span class="line">-M       --refresh_on_max  delay updating the screen until a new max</span><br><span class="line">                           latency is hit. Useful for low bandwidth.</span><br><span class="line">-N       --nsecs           print results in ns instead of us (default us)</span><br><span class="line">-o RED   --oscope&#x3D;RED      oscilloscope mode, reduce verbose output by RED</span><br><span class="line">-p PRIO  --priority&#x3D;PRIO   priority of highest prio thread</span><br><span class="line">         --policy&#x3D;NAME     policy of measurement thread, where NAME may be one</span><br><span class="line">                           of: other, normal, batch, idle, fifo or rr.</span><br><span class="line">         --priospread      spread priority levels starting at specified value</span><br><span class="line">-q       --quiet           print a summary only on exit</span><br><span class="line">-r       --relative        use relative timer instead of absolute</span><br><span class="line">-R       --resolution      check clock resolution, calling clock_gettime() many</span><br><span class="line">                           times.  List of clock_gettime() values will be</span><br><span class="line">                           reported with -X</span><br><span class="line">         --secaligned [USEC] align thread wakeups to the next full second</span><br><span class="line">                           and apply the optional offset</span><br><span class="line">-s       --system          use sys_nanosleep and sys_setitimer</span><br><span class="line">-S       --smp             Standard SMP testing: options -a -t and same priority</span><br><span class="line">                           of all threads</span><br><span class="line">        --spike&#x3D;&lt;trigger&gt;  record all spikes &gt; trigger</span><br><span class="line">        --spike-nodes&#x3D;[num of nodes]</span><br><span class="line">                           These are the maximum number of spikes we can record.</span><br><span class="line">                           The default is 1024 if not specified</span><br><span class="line">         --smi             Enable SMI counting</span><br><span class="line">-t       --threads         one thread per available processor</span><br><span class="line">-t [NUM] --threads&#x3D;NUM     number of threads:</span><br><span class="line">                           without NUM, threads &#x3D; max_cpus</span><br><span class="line">                           without -t default &#x3D; 1</span><br><span class="line">         --tracemark       write a trace mark when -b latency is exceeded</span><br><span class="line">-u       --unbuffered      force unbuffered output for live processing</span><br><span class="line">-v       --verbose         output values on stdout for statistics</span><br><span class="line">                           format: n:c:v n&#x3D;tasknum c&#x3D;count v&#x3D;value in us</span><br><span class="line">         --dbg_cyclictest  print info useful for debugging cyclictest</span><br><span class="line">-x       --posix_timers    use POSIX timers instead of clock_nanosleep.</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://elinux.org/Realtime_Testing_Best_Practices">Realtime Testing Best Practices</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-25T11:00:00.000Z" title="5/25/2021, 7:00:00 PM">2021-05-25</time>发表</span><span class="level-item"><time dateTime="2021-05-26T01:59:02.564Z" title="5/26/2021, 9:59:02 AM">2021-05-26</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux-kernel/">linux kernel</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/">linux schedule</a></span><span class="level-item">7 分钟读完 (大约1047个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/25/schedule/sched_features/">sched_features</a></h1><div class="content"><h2 id="WHAT"><a href="#WHAT" class="headerlink" title="WHAT?"></a>WHAT?</h2><p><code>sched features</code> 是 linux scheduler 的一些 feature实现开关，可以在系统运行中动态开关，相关 feature 在 <code>kernel/sched/features.h</code> 有定义。</p>
<h2 id="feature-拆解"><a href="#feature-拆解" class="headerlink" title="feature 拆解"></a>feature 拆解</h2><p>每个 feature 对调度行为都有一定影响或者优化，但是需要根据实际情况来选择是否开启 这个 feature.</p>
<h3 id="GENTLE-FAIR-SLEEPERS"><a href="#GENTLE-FAIR-SLEEPERS" class="headerlink" title="GENTLE_FAIR_SLEEPERS"></a>GENTLE_FAIR_SLEEPERS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Only give sleepers 50% of their service deficit. This allows</span><br><span class="line"> * them to run sooner, but does not allow tons of sleepers to</span><br><span class="line"> * rip the spread apart.</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(GENTLE_FAIR_SLEEPERS, true)</span><br></pre></td></tr></table></figure>
<p><code>GENTLE_FAIR_SLEEPERS</code> 主要是 减少对 sleep task的 vruntime 补偿。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">		 * Halve their sleep time&#39;s effect, to allow</span><br><span class="line">		 * for a gentler effect of sleepers:</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		if (sched_feat(GENTLE_FAIR_SLEEPERS))</span><br><span class="line">			thresh &gt;&gt;&#x3D; 1;</span><br><span class="line"></span><br><span class="line">		vruntime -&#x3D; thresh;</span><br></pre></td></tr></table></figure>
<p>实际 使用时，仅仅是将 补偿时间减少一半。</p>
<h3 id="START-DEBIT"><a href="#START-DEBIT" class="headerlink" title="START_DEBIT"></a>START_DEBIT</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Place new tasks ahead so that they do not starve already running</span><br><span class="line"> * tasks</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(START_DEBIT, true)</span><br></pre></td></tr></table></figure>
<p><code>START_DEBIT</code> 主要是 对 initial task 的一种惩罚，对 vruntime 增加，可以让运行时间减少 和 不会立刻运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static void</span><br><span class="line">place_entity(struct cfs_rq *cfs_rq, struct sched_entity *se, int initial)</span><br><span class="line">&#123;</span><br><span class="line">	u64 vruntime &#x3D; cfs_rq-&gt;min_vruntime;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * The &#39;current&#39; period is already promised to the current tasks,</span><br><span class="line">	 * however the extra weight of the new task will slow them down a</span><br><span class="line">	 * little, place the new task so that it fits in the slot that</span><br><span class="line">	 * stays open at the end.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	if (initial &amp;&amp; sched_feat(START_DEBIT))</span><br><span class="line">		vruntime +&#x3D; sched_vslice(cfs_rq, se);</span><br></pre></td></tr></table></figure>

<h3 id="NEXT-BUDDY"><a href="#NEXT-BUDDY" class="headerlink" title="NEXT_BUDDY"></a>NEXT_BUDDY</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Prefer to schedule the task we woke last (assuming it failed</span><br><span class="line"> * wakeup-preemption), since its likely going to consume data we</span><br><span class="line"> * touched, increases cache locality.</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(NEXT_BUDDY, false)</span><br></pre></td></tr></table></figure>
<p><code>NEXT_BUDDY</code> 主要是 希望可以 尽快调度到 抢占 <code>curr</code>的 task.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static void check_preempt_wakeup(struct rq *rq, struct task_struct *p, int wake_flags)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	if (sched_feat(NEXT_BUDDY) &amp;&amp; scale &amp;&amp; !(wake_flags &amp; WF_FORK)) &#123;</span><br><span class="line">		set_next_buddy(pse);</span><br><span class="line">		next_buddy_marked &#x3D; 1;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LAST-BUDDY"><a href="#LAST-BUDDY" class="headerlink" title="LAST_BUDDY"></a>LAST_BUDDY</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Prefer to schedule the task that ran last (when we did</span><br><span class="line"> * wake-preempt) as that likely will touch the same data, increases</span><br><span class="line"> * cache locality.</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(LAST_BUDDY, true)</span><br></pre></td></tr></table></figure>
<p><code>LAST_BUDDY</code> 主要是 希望可以尽快调度到上次被 <code>wakeup task</code> <code>preempt</code> 的task。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static void check_preempt_wakeup(struct rq *rq, struct task_struct *p, int wake_flags)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	if (sched_feat(LAST_BUDDY) &amp;&amp; scale &amp;&amp; entity_is_task(se))</span><br><span class="line">		set_last_buddy(se);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CACHE-HOT-BUDDY"><a href="#CACHE-HOT-BUDDY" class="headerlink" title="CACHE_HOT_BUDDY"></a>CACHE_HOT_BUDDY</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Consider buddies to be cache hot, decreases the likeliness of a</span><br><span class="line"> * cache buddy being migrated away, increases cache locality.</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(CACHE_HOT_BUDDY, true)</span><br></pre></td></tr></table></figure>
<p>认为 [last|next]buddies 是 cache hot的，所以不能让他们 migrate away，增加 cache 命中率。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Is this task likely cache-hot:</span><br><span class="line"> *&#x2F;</span><br><span class="line">static int task_hot(struct task_struct *p, struct lb_env *env)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Buddy candidates are cache hot:</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	if (sched_feat(CACHE_HOT_BUDDY) &amp;&amp; env-&gt;dst_rq-&gt;nr_running &amp;&amp;</span><br><span class="line">			(&amp;p-&gt;se &#x3D;&#x3D; cfs_rq_of(&amp;p-&gt;se)-&gt;next ||</span><br><span class="line">			 &amp;p-&gt;se &#x3D;&#x3D; cfs_rq_of(&amp;p-&gt;se)-&gt;last))</span><br><span class="line">		return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WAKEUP-PREEMPTION"><a href="#WAKEUP-PREEMPTION" class="headerlink" title="WAKEUP_PREEMPTION"></a>WAKEUP_PREEMPTION</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Allow wakeup-time preemption of the current task:</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(WAKEUP_PREEMPTION, true)</span><br></pre></td></tr></table></figure>
<p>是否可以唤醒强占， 后续补充</p>
<h3 id="HRTICK-HRTICK-DL-DOUBLE-TICK"><a href="#HRTICK-HRTICK-DL-DOUBLE-TICK" class="headerlink" title="HRTICK HRTICK_DL DOUBLE_TICK"></a>HRTICK HRTICK_DL DOUBLE_TICK</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SCHED_FEAT(HRTICK, false)</span><br><span class="line">SCHED_FEAT(HRTICK_DL, false)</span><br><span class="line">SCHED_FEAT(DOUBLE_TICK, false)</span><br></pre></td></tr></table></figure>
<p><code>HRTICK HRTICK_DL DOUBLE_TICK</code> 这三个 feature 主要是利用 <code>rq-&gt;hrtick_timer</code> 优化调度行为的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static void __sched notrace __schedule(bool preempt)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	if (sched_feat(HRTICK) || sched_feat(HRTICK_DL))</span><br><span class="line">		hrtick_clear(rq);</span><br></pre></td></tr></table></figure>

<p>主要是 <code>dl task</code> 会使用 这个 hrtimer 在<code>dl-&gt;runtime</code>到期的时候 发生一个 tick，使得任务运行时间更加精准</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static void start_hrtick_dl(struct rq *rq, struct task_struct *p)</span><br><span class="line">&#123;</span><br><span class="line">	hrtick_start(rq, p-&gt;dl.runtime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void set_next_task_dl(struct rq *rq, struct task_struct *p, bool first)</span><br><span class="line">&#123;</span><br><span class="line">	p-&gt;se.exec_start &#x3D; rq_clock_task(rq);</span><br><span class="line"></span><br><span class="line">	if (hrtick_enabled_dl(rq))</span><br><span class="line">		start_hrtick_dl(rq, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>cfs task</code> 会使用 这个 hrtimer 在<code>delta</code> 期望运行时间 到期的时候 发生一个 tick_fair，使得运行时间更加精准。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">static void hrtick_start_fair(struct rq *rq, struct task_struct *p)</span><br><span class="line">&#123;</span><br><span class="line">	struct sched_entity *se &#x3D; &amp;p-&gt;se;</span><br><span class="line">	struct cfs_rq *cfs_rq &#x3D; cfs_rq_of(se);</span><br><span class="line"></span><br><span class="line">	SCHED_WARN_ON(task_rq(p) !&#x3D; rq);</span><br><span class="line"></span><br><span class="line">	if (rq-&gt;cfs.h_nr_running &gt; 1) &#123;</span><br><span class="line">		u64 slice &#x3D; sched_slice(cfs_rq, se);</span><br><span class="line">		u64 ran &#x3D; se-&gt;sum_exec_runtime - se-&gt;prev_sum_exec_runtime;</span><br><span class="line">		s64 delta &#x3D; slice - ran;</span><br><span class="line"></span><br><span class="line">		if (delta &lt; 0) &#123;</span><br><span class="line">			if (task_current(rq, p))</span><br><span class="line">				resched_curr(rq);</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		hrtick_start(rq, delta);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct task_struct *</span><br><span class="line">pick_next_task_fair(struct rq *rq, struct task_struct *prev, struct rq_flags *rf)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	if (hrtick_enabled_fair(rq))</span><br><span class="line">		hrtick_start_fair(rq, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="NONTASK-CAPACITY"><a href="#NONTASK-CAPACITY" class="headerlink" title="NONTASK_CAPACITY"></a>NONTASK_CAPACITY</h3><h3 id="TTWU-QUEUE"><a href="#TTWU-QUEUE" class="headerlink" title="TTWU_QUEUE"></a>TTWU_QUEUE</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Queue remote wakeups on the target CPU and process them</span><br><span class="line"> * using the scheduler IPI. Reduces rq-&gt;lock contention&#x2F;bounces.</span><br><span class="line"> *&#x2F;</span><br><span class="line">SCHED_FEAT(TTWU_QUEUE, true)</span><br></pre></td></tr></table></figure>
<p><code>TTWU_QUEUE</code> 主要是 使用 <code>IPI</code> 去唤醒 <code>remote queue</code> 上的task，而不是操作<code>rq-&gt;lock</code>，然后操作队列上的 entity，这会减少 <code>rq-&gt;lock</code>的争用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static bool ttwu_queue_wakelist(struct task_struct *p, int cpu, int wake_flags)</span><br><span class="line">&#123;</span><br><span class="line">	if (sched_feat(TTWU_QUEUE) &amp;&amp; ttwu_queue_cond(cpu, wake_flags)) &#123;</span><br><span class="line">		if (WARN_ON_ONCE(cpu &#x3D;&#x3D; smp_processor_id()))</span><br><span class="line">			return false;</span><br><span class="line"></span><br><span class="line">		sched_clock_cpu(cpu); &#x2F;* Sync clocks across CPUs *&#x2F;</span><br><span class="line">		__ttwu_queue_wakelist(p, cpu, wake_flags);</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="SIS-PROP"><a href="#SIS-PROP" class="headerlink" title="SIS_PROP"></a>SIS_PROP</h3><h3 id="WARN-DOUBLE-CLOCK"><a href="#WARN-DOUBLE-CLOCK" class="headerlink" title="WARN_DOUBLE_CLOCK"></a>WARN_DOUBLE_CLOCK</h3><h3 id="RT-PUSH-IPI"><a href="#RT-PUSH-IPI" class="headerlink" title="RT_PUSH_IPI"></a>RT_PUSH_IPI</h3><h3 id="RT-RUNTIME-SHARE"><a href="#RT-RUNTIME-SHARE" class="headerlink" title="RT_RUNTIME_SHARE"></a>RT_RUNTIME_SHARE</h3><h3 id="LB-MIN"><a href="#LB-MIN" class="headerlink" title="LB_MIN"></a>LB_MIN</h3><h3 id="ATTACH-AGE-LOAD"><a href="#ATTACH-AGE-LOAD" class="headerlink" title="ATTACH_AGE_LOAD"></a>ATTACH_AGE_LOAD</h3><h3 id="WA-IDLE"><a href="#WA-IDLE" class="headerlink" title="WA_IDLE"></a>WA_IDLE</h3><h3 id="WA-WEIGHT"><a href="#WA-WEIGHT" class="headerlink" title="WA_WEIGHT"></a>WA_WEIGHT</h3><h3 id="WA-BIAS"><a href="#WA-BIAS" class="headerlink" title="WA_BIAS"></a>WA_BIAS</h3></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-19T11:00:00.000Z" title="5/19/2021, 7:00:00 PM">2021-05-19</time>发表</span><span class="level-item"><time dateTime="2021-09-16T07:53:18.392Z" title="9/16/2021, 3:53:18 PM">2021-09-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux-kernel/">linux kernel</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/">linux schedule</a></span><span class="level-item">5 分钟读完 (大约718个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/19/schedule/stop_task/">stop_task</a></h1><div class="content"><h2 id="stop-task"><a href="#stop-task" class="headerlink" title="stop_task"></a>stop_task</h2><p><code>stop_task</code> 实现在 <code>kernel/sched/stop_task.c</code> 中，在所有调度类中<br><code>stop_sched_class</code>的优先级是最高的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#define SCHED_DATA				\</span><br><span class="line">	STRUCT_ALIGN();				\</span><br><span class="line">	__begin_sched_classes &#x3D; .;		\</span><br><span class="line">	*(__idle_sched_class)			\</span><br><span class="line">	*(__fair_sched_class)			\</span><br><span class="line">	*(__rt_sched_class)			\</span><br><span class="line">	*(__dl_sched_class)			\</span><br><span class="line">	*(__stop_sched_class)			\</span><br><span class="line">	__end_sched_classes &#x3D; .;</span><br></pre></td></tr></table></figure>


<p>其实在 linux中一个 per cpu的 rq中，每个rq只会有一个 stop task</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct rq &#123;</span><br><span class="line">	&#x2F;* runqueue lock: *&#x2F;</span><br><span class="line">	raw_spinlock_t		lock;</span><br><span class="line"></span><br><span class="line">	struct task_struct __rcu	*curr;</span><br><span class="line">	struct task_struct	*idle;</span><br><span class="line">	struct task_struct	*stop;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>且 <code>stop task</code> never migrates，不会迁移，只会固定在某个 cpu上跑，所以 select_task_rq_stop 实现:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">select_task_rq_stop(struct task_struct *p, int cpu, int flags)</span><br><span class="line">&#123;</span><br><span class="line">	return task_cpu(p); &#x2F;* stop tasks as never migrate *&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>且 <code>stop task</code> can not be preempted，不会被抢占，check_preempt_curr_stop 实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static void</span><br><span class="line">check_preempt_curr_stop(struct rq *rq, struct task_struct *p, int flags)</span><br><span class="line">&#123;</span><br><span class="line">	&#x2F;* we&#39;re never preempted *&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 <code>stop_task</code>， rq上只有一个stop_sched_class的 task，所以 pick_next_task_stop 实现很简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static struct task_struct *pick_next_task_stop(struct rq *rq)</span><br><span class="line">&#123;</span><br><span class="line">	if (!sched_stop_runnable(rq))</span><br><span class="line">		return NULL;</span><br><span class="line"></span><br><span class="line">	set_next_task_stop(rq, rq-&gt;stop, true);</span><br><span class="line">	return rq-&gt;stop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h2 id="外部模块使用"><a href="#外部模块使用" class="headerlink" title="外部模块使用"></a>外部模块使用</h2><p>在 soft lockup 检测模块中，就利用了stop_class 这个调度类。<br><code>watchdog.c</code> 中使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* watchdog kicker functions *&#x2F;</span><br><span class="line">static enum hrtimer_restart watchdog_timer_fn(struct hrtimer *hrtimer)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long touch_ts, period_ts, now;</span><br><span class="line">	struct pt_regs *regs &#x3D; get_irq_regs();</span><br><span class="line">	int duration;</span><br><span class="line">	int softlockup_all_cpu_backtrace &#x3D; sysctl_softlockup_all_cpu_backtrace;</span><br><span class="line"></span><br><span class="line">	if (!watchdog_enabled)</span><br><span class="line">		return HRTIMER_NORESTART;</span><br><span class="line"></span><br><span class="line">	&#x2F;* kick the hardlockup detector *&#x2F;</span><br><span class="line">	watchdog_interrupt_count();</span><br><span class="line"></span><br><span class="line">	&#x2F;* kick the softlockup detector *&#x2F;</span><br><span class="line">	if (completion_done(this_cpu_ptr(&amp;softlockup_completion))) &#123;</span><br><span class="line">		reinit_completion(this_cpu_ptr(&amp;softlockup_completion));</span><br><span class="line">		stop_one_cpu_nowait(smp_processor_id(),</span><br><span class="line">				softlockup_fn, NULL,</span><br><span class="line">				this_cpu_ptr(&amp;softlockup_stop_work));</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>stop_one_cpu_nowait</code> 并不直接调用 <code>softlockup_fn</code>函数，只是将他 queue work 而已</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* queue @work to @stopper.  if offline, @work is completed immediately *&#x2F;</span><br><span class="line">static bool cpu_stop_queue_work(unsigned int cpu, struct cpu_stop_work *work)</span><br><span class="line">&#123;</span><br><span class="line">	struct cpu_stopper *stopper &#x3D; &amp;per_cpu(cpu_stopper, cpu);</span><br><span class="line">	DEFINE_WAKE_Q(wakeq);</span><br><span class="line">	unsigned long flags;</span><br><span class="line">	bool enabled;</span><br><span class="line"></span><br><span class="line">	preempt_disable();</span><br><span class="line">	raw_spin_lock_irqsave(&amp;stopper-&gt;lock, flags);</span><br><span class="line">	enabled &#x3D; stopper-&gt;enabled;</span><br><span class="line">	if (enabled)</span><br><span class="line">		__cpu_stop_queue_work(stopper, work, &amp;wakeq);</span><br><span class="line">	else if (work-&gt;done)</span><br><span class="line">		cpu_stop_signal_done(work-&gt;done);</span><br><span class="line">	raw_spin_unlock_irqrestore(&amp;stopper-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">	wake_up_q(&amp;wakeq);</span><br><span class="line">	preempt_enable();</span><br><span class="line"></span><br><span class="line">	return enabled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool stop_one_cpu_nowait(unsigned int cpu, cpu_stop_fn_t fn, void *arg,</span><br><span class="line">			struct cpu_stop_work *work_buf)</span><br><span class="line">&#123;</span><br><span class="line">	*work_buf &#x3D; (struct cpu_stop_work)&#123; .fn &#x3D; fn, .arg &#x3D; arg, .caller &#x3D; _RET_IP_, &#125;;</span><br><span class="line">	return cpu_stop_queue_work(cpu, work_buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 stopper 是 <code>&amp;per_cpu(cpu_stopper, cpu)</code>, 定义是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct cpu_stopper &#123;</span><br><span class="line">	struct task_struct	*thread;</span><br><span class="line"></span><br><span class="line">	raw_spinlock_t		lock;</span><br><span class="line">	bool			enabled;	&#x2F;* is this stopper enabled? *&#x2F;</span><br><span class="line">	struct list_head	works;		&#x2F;* list of pending works *&#x2F;</span><br><span class="line"></span><br><span class="line">	struct cpu_stop_work	stop_work;	&#x2F;* for stop_cpus *&#x2F;</span><br><span class="line">	unsigned long		caller;</span><br><span class="line">	cpu_stop_fn_t		fn;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static DEFINE_PER_CPU(struct cpu_stopper, cpu_stopper);</span><br></pre></td></tr></table></figure>

<p>在 每个 CPU 上的 stop_class 进程是 <code>migration/x</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static struct smp_hotplug_thread cpu_stop_threads &#x3D; &#123;</span><br><span class="line">	.store			&#x3D; &amp;cpu_stopper.thread,</span><br><span class="line">	.thread_should_run	&#x3D; cpu_stop_should_run,</span><br><span class="line">	.thread_fn		&#x3D; cpu_stopper_thread,</span><br><span class="line">	.thread_comm		&#x3D; &quot;migration&#x2F;%u&quot;,</span><br><span class="line">	.create			&#x3D; cpu_stop_create,</span><br><span class="line">	.park			&#x3D; cpu_stop_park,</span><br><span class="line">	.selfparking		&#x3D; true,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>shell 可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $ ps -aux | grep migration</span><br><span class="line">root          14  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;0]</span><br><span class="line">root          19  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;1]</span><br><span class="line">root          25  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;2]</span><br><span class="line">root          31  0.0  0.0      0     0 ?        S    9月03   0:04 [migration&#x2F;3]</span><br><span class="line">root          37  0.0  0.0      0     0 ?        S    9月03   0:04 [migration&#x2F;4]</span><br><span class="line">root          43  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;5]</span><br><span class="line">root          49  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;6]</span><br><span class="line">root          55  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;7]</span><br><span class="line">root          61  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;8]</span><br><span class="line">root          67  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;9]</span><br><span class="line">root          73  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;10]</span><br><span class="line">root          79  0.0  0.0      0     0 ?        S    9月03   0:05 [migration&#x2F;11]</span><br><span class="line">ubuntu     35458  0.0  0.0  12224   836 pts&#x2F;0    S+   15:26   0:00 grep --color&#x3D;auto migration</span><br><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;linux $</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-01T11:00:00.000Z" title="5/1/2021, 7:00:00 PM">2021-05-01</time>发表</span><span class="level-item"><time dateTime="2022-02-17T07:43:37.494Z" title="2/17/2022, 3:43:37 PM">2022-02-17</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux-kernel/">linux kernel</a><span> / </span><a class="link-muted" href="/categories/linux-kernel/linux-schedule/">linux schedule</a></span><span class="level-item">9 分钟读完 (大约1391个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/01/schedule/uclamp/">uclamp</a></h1><div class="content"><h2 id="WHAT"><a href="#WHAT" class="headerlink" title="WHAT?"></a>WHAT?</h2><p>uclamp(utilzation clamp) 是说 任务 cpu使用率夹钳，主要是 userspace 对 scheduler的一些hint。</p>
<ol>
<li>比如某个 task 对用户体验有直接的影响，此 task至少需要 20%cpu，那么计算 cpu使用率，select_rq的时候，必须考虑此task的 minimum “requested”，然后选择 <code>rq</code> 和 <code>freq</code>。</li>
<li>比如某个低优先级的 task 对用户体验没有影响，此 task最多需要 60%cpu（60% &lt; 1024），那么计算 cpu使用率，select_rq的时候，必须考虑此task的 maximum “requested”，然后选择 <code>rq</code> 和<code>freq</code>。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sched&#x2F;cpufreq, sched&#x2F;uclamp: Add clamps for FAIR and RT tasks</span><br><span class="line"></span><br><span class="line">    Each time a frequency update is required via schedutil, a frequency is</span><br><span class="line">    selected to (possibly) satisfy the utilization reported by each</span><br><span class="line">    scheduling class and irqs. However, when utilization clamping is in use,</span><br><span class="line">    the frequency selection should consider userspace utilization clamping</span><br><span class="line">    hints.  This will allow, for example, to:</span><br><span class="line"></span><br><span class="line">     - boost tasks which are directly affecting the user experience</span><br><span class="line">       by running them at least at a minimum &quot;requested&quot; frequency</span><br><span class="line"></span><br><span class="line">     - cap low priority tasks not directly affecting the user experience</span><br><span class="line">       by running them only up to a maximum &quot;allowed&quot; frequency</span><br></pre></td></tr></table></figure>

<p>在uapi 的头文件<code>include/uapi/linux/sched/types.h</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> @sched_util_min	represents the minimum utilization</span><br><span class="line"> @sched_util_max	represents the maximum utilization</span><br><span class="line"></span><br><span class="line">Utilization is a value in the range [0..SCHED_CAPACITY_SCALE]. It</span><br><span class="line">represents the percentage of CPU time used by a task when running at the</span><br><span class="line">maximum frequency on the highest capacity CPU of the system. For example, a</span><br><span class="line">20% utilization task is a task running for 2ms every 10ms at maximum</span><br><span class="line">frequency.</span><br><span class="line"></span><br><span class="line">A task with a min utilization value bigger than 0 is more likely scheduled</span><br><span class="line">on a CPU with a capacity big enough to fit the specified value.</span><br><span class="line">A task with a max utilization value smaller than 1024 is more likely</span><br><span class="line">scheduled on a CPU with no more capacity than the specified value.</span><br></pre></td></tr></table></figure>

<p>uclamp 的min..max 指的都是最大 freq下 的cpu使用率， 20%使用率 说的是在最大频率下，task 每10ms需要运行2ms。</p>
<h2 id="data-structure"><a href="#data-structure" class="headerlink" title="data structure"></a>data structure</h2><p>uclamp 分为<code>per sched_entity</code> 和 <code>per rq</code> 两种，分别使用 <code>struct uclamp_se</code>  <code>struct uclamp_rq</code>来描述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct uclamp_se &#123;</span><br><span class="line">	unsigned int value		: bits_per(SCHED_CAPACITY_SCALE);</span><br><span class="line">	unsigned int bucket_id		: bits_per(UCLAMP_BUCKETS);</span><br><span class="line">	unsigned int active		: 1;</span><br><span class="line">	unsigned int user_defined	: 1;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct uclamp_rq &#123;</span><br><span class="line">	unsigned int value;</span><br><span class="line">	struct uclamp_bucket bucket[UCLAMP_BUCKETS];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct rq &#123;</span><br><span class="line">	&#x2F;* runqueue lock: *&#x2F;</span><br><span class="line">	raw_spinlock_t		lock;</span><br><span class="line">#ifdef CONFIG_UCLAMP_TASK</span><br><span class="line">	&#x2F;* Utilization clamp values based on CPU&#39;s RUNNABLE tasks *&#x2F;</span><br><span class="line">	struct uclamp_rq	uclamp[UCLAMP_CNT] ____cacheline_aligned;</span><br><span class="line">	unsigned int		uclamp_flags;</span><br><span class="line">#define UCLAMP_FLAG_IDLE 0x01</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>per sched entity</code> 又分为两种，一种是 <code>per task</code>，一种是 <code>per task group</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct task_struct &#123;</span><br><span class="line">        ......</span><br><span class="line">#ifdef CONFIG_UCLAMP_TASK</span><br><span class="line">	&#x2F;* Clamp values requested for a scheduling entity *&#x2F;</span><br><span class="line">	struct uclamp_se		uclamp_req[UCLAMP_CNT];</span><br><span class="line">	&#x2F;* Effective clamp values used for a scheduling entity *&#x2F;</span><br><span class="line">	struct uclamp_se		uclamp[UCLAMP_CNT];</span><br><span class="line">#endif</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct task_group &#123;</span><br><span class="line">	struct cgroup_subsys_state css;</span><br><span class="line">#ifdef CONFIG_UCLAMP_TASK_GROUP</span><br><span class="line">	&#x2F;* The two decimal precision [%] value requested from user-space *&#x2F;</span><br><span class="line">	unsigned int		uclamp_pct[UCLAMP_CNT];</span><br><span class="line">	&#x2F;* Clamp values requested for a task group *&#x2F;</span><br><span class="line">	struct uclamp_se	uclamp_req[UCLAMP_CNT];</span><br><span class="line">	&#x2F;* Effective clamp values used for a task group *&#x2F;</span><br><span class="line">	struct uclamp_se	uclamp[UCLAMP_CNT];</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="api"><a href="#api" class="headerlink" title="api"></a>api</h2><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static void __init init_uclamp(void)</span><br><span class="line">&#123;</span><br><span class="line">	struct uclamp_se uc_max &#x3D; &#123;&#125;;</span><br><span class="line">	enum uclamp_id clamp_id;</span><br><span class="line">	int cpu;</span><br><span class="line"></span><br><span class="line">	mutex_init(&amp;uclamp_mutex);</span><br><span class="line"></span><br><span class="line">	for_each_possible_cpu(cpu)</span><br><span class="line">		init_uclamp_rq(cpu_rq(cpu));</span><br><span class="line"></span><br><span class="line">	for_each_clamp_id(clamp_id) &#123;</span><br><span class="line">		uclamp_se_set(&amp;init_task.uclamp_req[clamp_id],</span><br><span class="line">			      uclamp_none(clamp_id), false);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;* System defaults allow max clamp values for both indexes *&#x2F;</span><br><span class="line">	uclamp_se_set(&amp;uc_max, uclamp_none(UCLAMP_MAX), false);</span><br><span class="line">	for_each_clamp_id(clamp_id) &#123;</span><br><span class="line">		uclamp_default[clamp_id] &#x3D; uc_max;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="kernel-api"><a href="#kernel-api" class="headerlink" title="kernel api"></a>kernel api</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static inline void uclamp_rq_inc(struct rq *rq, struct task_struct *p) &#123; &#125;</span><br><span class="line">static inline void uclamp_rq_dec(struct rq *rq, struct task_struct *p) &#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static inline void enqueue_task(struct rq *rq, struct task_struct *p, int flags)</span><br><span class="line">&#123;</span><br><span class="line">	if (!(flags &amp; ENQUEUE_NOCLOCK))</span><br><span class="line">		update_rq_clock(rq);</span><br><span class="line"></span><br><span class="line">	if (!(flags &amp; ENQUEUE_RESTORE)) &#123;</span><br><span class="line">		sched_info_queued(rq, p);</span><br><span class="line">		psi_enqueue(p, flags &amp; ENQUEUE_WAKEUP);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uclamp_rq_inc(rq, p);</span><br><span class="line">	p-&gt;sched_class-&gt;enqueue_task(rq, p, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void dequeue_task(struct rq *rq, struct task_struct *p, int flags)</span><br><span class="line">&#123;</span><br><span class="line">	if (!(flags &amp; DEQUEUE_NOCLOCK))</span><br><span class="line">		update_rq_clock(rq);</span><br><span class="line"></span><br><span class="line">	if (!(flags &amp; DEQUEUE_SAVE)) &#123;</span><br><span class="line">		sched_info_dequeued(rq, p);</span><br><span class="line">		psi_dequeue(p, flags &amp; DEQUEUE_SLEEP);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uclamp_rq_dec(rq, p);</span><br><span class="line">	p-&gt;sched_class-&gt;dequeue_task(rq, p, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>enqueue_task</code> <code>dequeue_task</code> 中会 根据 此task是否 开启 uclamp来更改 <code>rq</code>的统计的<code>uclamp_rq</code> 数据。</p>
<p><img src="/images/image.jpg"></p>
<h3 id="user-api"><a href="#user-api" class="headerlink" title="user api"></a>user api</h3><p>uclamp 在 <code>userspace</code> 提供了三类接口</p>
<ul>
<li>全局uclamp接口 <code>/proc/sys/kernel/sched_util_clamp_min</code> <code>/proc/sys/kernel/sched_util_clamp_max</code></li>
<li>cgroup based API <code>cpu.uclamp.max</code> <code>cpu.uclamp.min</code></li>
<li>per-task API</li>
</ul>
<p>一般全局uclamp接口都是设置为 min-1024 max-1024。<br>cgroup 接口一般只会限制最大使用率<br>per-task的情况较为复杂，以pixel6为例：</p>
<p>在pixel6搭载的Android 12中，google去除了<code>schedtue</code> <code>sched boost</code>等机制，pixel6 且采用了双X1架构的芯片，没有使用walt算法。为了尽量提升用户流畅性体验，所以对uclamp较为依赖。</p>
<p>kernel space对外提供的接口是 <code>sched_setattr</code>, android 框架层对他做了封装<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:hardware/google/pixel/power-libperfmgr/aidl/PowerHintSession.cpp;bpv=1;bpt=1;l=181?q=sched_setattr">setUclamp</a></p>
<p>在 <code>pixel6</code> 中使用 uclamp的场景大概分为以下几类:</p>
<ul>
<li>应用启动</li>
<li>滑动boost</li>
<li>top-app</li>
</ul>
<p>首先是应用启动，应用启动往往需要创建多个线程，读取很多资源。所以在应用冷启动时刻，除了将所有cpu的频率固定在最高频之外，还将应用的 <code>UI_thread</code> <code>Render_thread</code> <code>hwui_task0</code> <code>hwui_task1</code> uclamp直接设置为 512，这样会使得这几个重载线程在启动时刻就跑在超大核心上，减少应用冷启动时间。</p>
<p>滑动场景，由于滑动场景有较多复杂的动画，<code>UI_thread</code> <code>Render_thread</code> <code>hwui_task0</code> <code>hwui_task1</code>的负载较重，如果不及时上超大核，有丢帧的风险，所以滑动场景也是将这几个task的uclamp_min 设置为 512，来保证可以上超大核。</p>
<p>游戏场景，由于游戏等前台应用对响应时间较为敏感，pixel6 上android的框架层直接将 <code>ta_uclamp_min</code> 设置为 185或者更多，这样游戏进程主线程或者其他前台进程主线程就无法泡在小核心上，至少是大核起步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">raven:&#x2F;sys&#x2F;kernel&#x2F;vendor_sched # cat ta_uclamp_min</span><br><span class="line">185</span><br><span class="line">raven:&#x2F;sys&#x2F;kernel&#x2F;vendor_sched #</span><br></pre></td></tr></table></figure>

</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/2/">上一页</a></div><div class="pagination-next"><a href="/page/4/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link is-current" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/12/">12</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">115</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">143</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/explore" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BRK/"><span class="tag">BRK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HW/"><span class="tag">HW</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QCOM/"><span class="tag">QCOM</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aarch64/"><span class="tag">aarch64</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/acl/"><span class="tag">acl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android-framework/"><span class="tag">android framework</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android12-gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/"><span class="tag">android12 gdb64调试进程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v1/"><span class="tag">cgroup v1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v2/"><span class="tag">cgroup v2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu%E8%B0%83%E9%A2%91/"><span class="tag">cpu调频</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dd/"><span class="tag">dd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debugfs/"><span class="tag">debugfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/double-free/"><span class="tag">double free</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drop-caches/"><span class="tag">drop_caches</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dumpe2fs/"><span class="tag">dumpe2fs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eas/"><span class="tag">eas</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ext2/"><span class="tag">ext2</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-attr/"><span class="tag">file attr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-hole/"><span class="tag">file hole</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filesystem/"><span class="tag">filesystem</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fsck/"><span class="tag">fsck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hrtimer/"><span class="tag">hrtimer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hugepage/"><span class="tag">hugepage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interrupt/"><span class="tag">interrupt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt/"><span class="tag">intrrrupt</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt-storm/"><span class="tag">intrrrupt storm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kallsyms/"><span class="tag">kallsyms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kfence/"><span class="tag">kfence</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kprobes/"><span class="tag">kprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kretprobes/"><span class="tag">kretprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvmtool/"><span class="tag">kvmtool</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/launch-json/"><span class="tag">launch.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-kernel/"><span class="tag">linux kernel</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-native-aio/"><span class="tag">linux native aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lock-stat/"><span class="tag">lock_stat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory/"><span class="tag">memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory-direct-reclaim/"><span class="tag">memory direct reclaim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mount/"><span class="tag">mount</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/node/"><span class="tag">node</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oom/"><span class="tag">oom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagemap/"><span class="tag">pagemap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf/"><span class="tag">perf</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf-c2c/"><span class="tag">perf c2c</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pid-namespace/"><span class="tag">pid namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preemption/"><span class="tag">preemption</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pressure/"><span class="tag">pressure</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/process-madvise/"><span class="tag">process_madvise</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psi/"><span class="tag">psi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psoix-aio/"><span class="tag">psoix aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/randomize-va-space/"><span class="tag">randomize_va_space</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rcu/"><span class="tag">rcu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sched-latency/"><span class="tag">sched latency</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/schedule/"><span class="tag">schedule</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slab/"><span class="tag">slab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-overflow/"><span class="tag">stack_overflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-key/"><span class="tag">static_key</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sync/"><span class="tag">sync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systrace/"><span class="tag">systrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-json/"><span class="tag">task.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-struct/"><span class="tag">task_struct</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread-info/"><span class="tag">thread_info</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tracepoint/"><span class="tag">tracepoint</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/use-after-free/"><span class="tag">use after free</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uts-namespace/"><span class="tag">uts namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vdso/"><span class="tag">vdso</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmstat/"><span class="tag">vmstat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xattr/"><span class="tag">xattr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zone/"><span class="tag">zone</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%B6%8A%E7%95%8C/"><span class="tag">内存泄漏越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88%E6%BA%A2%E5%87%BA/"><span class="tag">内核栈溢出</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80%E9%9A%8F%E6%9C%BA%E5%8C%96/"><span class="tag">地址空间布局随机化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/QCOM/"><span class="level-start"><span class="level-item">QCOM</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/cgroup-v1/"><span class="level-start"><span class="level-item">cgroup v1</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/cgroup-v1/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/kernel-debug/cache-false-sharing/"><span class="level-start"><span class="level-item">cache false sharing</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/"><span class="level-start"><span class="level-item">linux kernel</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/deadline-schedule/"><span class="level-start"><span class="level-item">deadline schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/"><span class="level-start"><span class="level-item">frequency governer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/schedule-util/"><span class="level-start"><span class="level-item">schedule util</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/idle/"><span class="level-start"><span class="level-item">idle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">68</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/"><span class="level-start"><span class="level-item">namespace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/namespace/pid-namespace/"><span class="level-start"><span class="level-item">pid namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/uts-namespace/"><span class="level-start"><span class="level-item">uts namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/schedule/"><span class="level-start"><span class="level-item">schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-24T11:00:00.000Z">2022-01-24</time></p><p class="title"><a href="/2022/01/24/schedule/cpu%E8%B0%83%E9%A2%91/">cpu调频</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-20T08:42:37.115Z">2022-01-20</time></p><p class="title"><a href="/2022/01/20/schedule/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0%E8%B0%83%E5%BA%A6/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-05T11:00:00.000Z">2022-01-05</time></p><p class="title"><a href="/2022/01/05/schedule/eas/">eas</a></p><p class="categories"><a href="/categories/linux-kernel/">linux kernel</a> / <a href="/categories/linux-kernel/linux-schedule/">linux schedule</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-03T11:00:00.000Z">2021-11-03</time></p><p class="title"><a href="/2021/11/03/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20c2c/">perf c2c</a></p><p class="categories"><a href="/categories/kernel-debug/">kernel debug</a> / <a href="/categories/kernel-debug/cache-false-sharing/">cache false sharing</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-23T11:00:00.000Z">2021-09-23</time></p><p class="title"><a href="/2021/09/23/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/android12%20gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/">android12 gdb64调试进程</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>