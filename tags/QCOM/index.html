<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>标签: QCOM - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">QCOM</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-30T11:00:00.000Z" title="4/30/2021, 7:00:00 PM">2021-04-30</time>发表</span><span class="level-item"><time dateTime="2021-05-18T09:28:05.668Z" title="5/18/2021, 5:28:05 PM">2021-05-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/QCOM/">QCOM</a></span><span class="level-item">几秒读完 (大约0个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/30/schedule/Qcom%20kernel/core_ctl/">core_ctl</a></h1><div class="content"></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-28T11:00:00.000Z" title="4/28/2021, 7:00:00 PM">2021-04-28</time>发表</span><span class="level-item"><time dateTime="2021-05-18T09:28:05.664Z" title="5/18/2021, 5:28:05 PM">2021-05-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/QCOM/">QCOM</a></span><span class="level-item">8 分钟读完 (大约1243个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/28/schedule/Qcom%20kernel/boost/">boost</a></h1><div class="content"><h2 id="WHAT"><a href="#WHAT" class="headerlink" title="WHAT?"></a>WHAT?</h2><p>Scheduler boost 是一个机制：将task放到capacity比自己需求大很多 cpu上的机制，<br>开启 <code>boost</code> 的entity也需要为他结束负责。</p>
<p>boost机制 主要是给上层 or framework层写文件节点的，改变<code>boost机制</code>，是<code>整个系统生效的</code>，并不是针对于某单个thread。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Scheduler boost is a mechanism to temporarily place tasks on CPUs</span><br><span class="line">with higher capacity than those where a task would have normally</span><br><span class="line">ended up with their load characteristics. Any entity enabling</span><br><span class="line">boost is responsible for disabling it as well.</span><br></pre></td></tr></table></figure>


<h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY?"></a>WHY?</h2><h2 id="boost-基本概念"><a href="#boost-基本概念" class="headerlink" title="boost 基本概念"></a>boost 基本概念</h2><p>boost type 分为以下几种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define NO_BOOST 0</span><br><span class="line">#define FULL_THROTTLE_BOOST 1</span><br><span class="line">#define CONSERVATIVE_BOOST 2</span><br><span class="line">#define RESTRAINED_BOOST 3</span><br><span class="line">#define FULL_THROTTLE_BOOST_DISABLE -1</span><br><span class="line">#define CONSERVATIVE_BOOST_DISABLE -2</span><br><span class="line">#define RESTRAINED_BOOST_DISABLE -3</span><br><span class="line">#define MAX_NUM_BOOST_TYPE (RESTRAINED_BOOST+1)</span><br></pre></td></tr></table></figure>

<p>可以通过<code>sched_boost()</code>获得</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extern unsigned int sched_boost_type;</span><br><span class="line">static inline int sched_boost(void)</span><br><span class="line">&#123;</span><br><span class="line">	return sched_boost_type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>boost policy 分为以下几种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">enum sched_boost_policy &#123;</span><br><span class="line">	SCHED_BOOST_NONE,</span><br><span class="line">	SCHED_BOOST_ON_BIG,</span><br><span class="line">	SCHED_BOOST_ON_ALL,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以通过<code>sched_boost_policy()</code>获得</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extern enum sched_boost_policy boost_policy;</span><br><span class="line">static inline enum sched_boost_policy sched_boost_policy(void)</span><br><span class="line">&#123;</span><br><span class="line">	return boost_policy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>每个boost type有相关的<code>enter</code>，<code>exit</code>方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">struct sched_boost_data &#123;</span><br><span class="line">	int refcount;</span><br><span class="line">	void (*enter)(void);</span><br><span class="line">	void (*exit)(void);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct sched_boost_data sched_boosts[] &#x3D; &#123;</span><br><span class="line">	[NO_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_no_boost_nop,</span><br><span class="line">		.exit &#x3D; sched_no_boost_nop,</span><br><span class="line">	&#125;,</span><br><span class="line">	[FULL_THROTTLE_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_full_throttle_boost_enter,</span><br><span class="line">		.exit &#x3D; sched_full_throttle_boost_exit,</span><br><span class="line">	&#125;,</span><br><span class="line">	[CONSERVATIVE_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_conservative_boost_enter,</span><br><span class="line">		.exit &#x3D; sched_conservative_boost_exit,</span><br><span class="line">	&#125;,</span><br><span class="line">	[RESTRAINED_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_restrained_boost_enter,</span><br><span class="line">		.exit &#x3D; sched_restrained_boost_exit,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="api"><a href="#api" class="headerlink" title="api"></a>api</h2><p>写<code>/proc</code> 文件节点 最后调用到<code>sched_boost_handler()</code>–&gt;<code>_sched_set_boost()</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static void _sched_set_boost(int type)</span><br><span class="line">&#123;</span><br><span class="line">	if (type &#x3D;&#x3D; 0)</span><br><span class="line">		sched_boost_disable_all();</span><br><span class="line">	else if (type &gt; 0)</span><br><span class="line">		sched_boost_enable(type);</span><br><span class="line">	else</span><br><span class="line">		sched_boost_disable(-type);</span><br><span class="line"></span><br><span class="line">	sched_boost_type &#x3D; sched_effective_boost();</span><br><span class="line">	sysctl_sched_boost &#x3D; sched_boost_type;</span><br><span class="line">	set_boost_policy(sysctl_sched_boost);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int sched_boost_handler(struct ctl_table *table, int write,</span><br><span class="line">		void __user *buffer, size_t *lenp,</span><br><span class="line">		loff_t *ppos)</span><br><span class="line">&#123;</span><br><span class="line">	mutex_lock(&amp;boost_mutex);</span><br><span class="line">	_sched_set_boost(*data);</span><br><span class="line">done:</span><br><span class="line">	mutex_unlock(&amp;boost_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_sched_set_boost(int type) type可能是以下一种：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define NO_BOOST 0</span><br><span class="line">#define FULL_THROTTLE_BOOST 1</span><br><span class="line">#define CONSERVATIVE_BOOST 2</span><br><span class="line">#define RESTRAINED_BOOST 3</span><br><span class="line">#define FULL_THROTTLE_BOOST_DISABLE -1</span><br><span class="line">#define CONSERVATIVE_BOOST_DISABLE -2</span><br><span class="line">#define RESTRAINED_BOOST_DISABLE -3</span><br></pre></td></tr></table></figure>
<p>type == NO_BOOST ==&gt; disable all<br>type &gt; NO_BOOST ==&gt; enable one boost<br>type &lt; NO_BOOST ==&gt; disable one boost</p>
<p>sched_boosts 使用了refcount机制，已经开启的boost_type的 <code>refcount &gt; 0</code>，如果使能多个<code>boost type</code>，则哪个值大，生效哪个，可以重复开启某一个type的 boost，由于有refcount，所以也需要多次disable。</p>
<p><code>sched_boost_disable_all()</code>，直接调用所有<code>refcount &gt; 0</code>的 boost type的 <code>.exit()</code>方法，然后 <code>refcount = 0</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static void sched_boost_disable_all(void)</span><br><span class="line">&#123;</span><br><span class="line">	int i;</span><br><span class="line"></span><br><span class="line">	for (i &#x3D; SCHED_BOOST_START; i &lt; SCHED_BOOST_END; i++) &#123;</span><br><span class="line">		if (sched_boosts[i].refcount &gt; 0) &#123;</span><br><span class="line">			sched_boosts[i].exit();</span><br><span class="line">			sched_boosts[i].refcount &#x3D; 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sched_boost_enable()</code> 首先<code>refcount++</code>，最终调用到 <code>.enter()</code>方法然后实现enable。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static void sched_boost_enable(int type)</span><br><span class="line">&#123;</span><br><span class="line">	struct sched_boost_data *sb &#x3D; &amp;sched_boosts[type];</span><br><span class="line">	int next_boost, prev_boost &#x3D; sched_boost_type;</span><br><span class="line"></span><br><span class="line">	sb-&gt;refcount++;</span><br><span class="line"></span><br><span class="line">	if (sb-&gt;refcount !&#x3D; 1) &#x2F;&#x2F; 如果已经处于这种模式了，那就直接返回</span><br><span class="line">		return;</span><br><span class="line">	next_boost &#x3D; sched_effective_boost();</span><br><span class="line">	if (next_boost &#x3D;&#x3D; prev_boost)</span><br><span class="line">		return;</span><br><span class="line"></span><br><span class="line">	sched_boosts[prev_boost].exit();</span><br><span class="line">	sched_boosts[next_boost].enter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="boost-type实现"><a href="#boost-type实现" class="headerlink" title="boost type实现"></a>boost type实现</h2><p>针对于每种<code>boost type</code>，Q实现了其 <code>struct sched_boost_data</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct sched_boost_data &#123;</span><br><span class="line">	int refcount;</span><br><span class="line">	void (*enter)(void);</span><br><span class="line">	void (*exit)(void);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="NO-BOOST"><a href="#NO-BOOST" class="headerlink" title="NO_BOOST"></a>NO_BOOST</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct sched_boost_data sched_boosts[] &#x3D; &#123;</span><br><span class="line">	[NO_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_no_boost_nop,</span><br><span class="line">		.exit &#x3D; sched_no_boost_nop,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>sched_no_boost_nop() 就是 nop空函数</p>
<h3 id="FULL-THROTTLE-BOOST"><a href="#FULL-THROTTLE-BOOST" class="headerlink" title="FULL_THROTTLE_BOOST"></a>FULL_THROTTLE_BOOST</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct sched_boost_data sched_boosts[] &#x3D; &#123;</span><br><span class="line">	[FULL_THROTTLE_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_full_throttle_boost_enter,</span><br><span class="line">		.exit &#x3D; sched_full_throttle_boost_exit,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>.enter()</code> <code>.exit()</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static void sched_full_throttle_boost_enter(void)</span><br><span class="line">&#123;</span><br><span class="line">	core_ctl_set_boost(true); &#x2F;&#x2F; 与 core_ctl强相关，后面再看</span><br><span class="line">	walt_enable_frequency_aggregation(true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void sched_full_throttle_boost_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	core_ctl_set_boost(false);</span><br><span class="line">	walt_enable_frequency_aggregation(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CONSERVATIVE-BOOST"><a href="#CONSERVATIVE-BOOST" class="headerlink" title="CONSERVATIVE_BOOST"></a>CONSERVATIVE_BOOST</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct sched_boost_data sched_boosts[] &#x3D; &#123;</span><br><span class="line">	[CONSERVATIVE_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_conservative_boost_enter,</span><br><span class="line">		.exit &#x3D; sched_conservative_boost_exit,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>.enter()</code> <code>.exit()</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void sched_conservative_boost_enter(void)</span><br><span class="line">&#123;</span><br><span class="line">	update_cgroup_boost_settings();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void sched_conservative_boost_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	restore_cgroup_boost_settings();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RESTRAINED-BOOST"><a href="#RESTRAINED-BOOST" class="headerlink" title="RESTRAINED_BOOST"></a>RESTRAINED_BOOST</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct sched_boost_data sched_boosts[] &#x3D; &#123;</span><br><span class="line">	[RESTRAINED_BOOST] &#x3D; &#123;</span><br><span class="line">		.refcount &#x3D; 0,</span><br><span class="line">		.enter &#x3D; sched_restrained_boost_enter,</span><br><span class="line">		.exit &#x3D; sched_restrained_boost_exit,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>.enter()</code> <code>.exit()</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void sched_restrained_boost_enter(void)</span><br><span class="line">&#123;</span><br><span class="line">	walt_enable_frequency_aggregation(true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void sched_restrained_boost_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	walt_enable_frequency_aggregation(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Full throttle： FULL_THROTTLE_BOOST</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、通过core control，将所有cpu都进行unisolation</span><br><span class="line">2、通过freq聚合，将load计算放大。从而触发提升freq，或者迁移等</span><br><span class="line">3、通过设置boost policy&#x3D; SCHED_BOOST_ON_BIG，迁移挑选target cpu时，只会选择大核</span><br><span class="line">最终效果应该尽可能把任务都放在大核运行（除了cpuset中有限制）</span><br></pre></td></tr></table></figure>

<p>Conservative： CONSERVATIVE_BOOST</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、通过更新group boost配置，仅让top-app和foreground组进行task placement boost</span><br><span class="line">2、提高min_task_util的门限，让进行up migrate的条件更苛刻。只有load较大（&gt;1ms）的task，会进行up migrate。</span><br><span class="line">2、同上，更改min_task_util门限后，会提醒系统task与cpu是misfit，需要进行迁移。</span><br><span class="line">3、通过设置boost policy&#x3D; SCHED_BOOST_ON_BIG，迁移挑选target cpu时，只会选择大核</span><br><span class="line">最终效果：top-app和foreground的一些task会迁移到大核运行</span><br></pre></td></tr></table></figure>

<p>Restrained： RESTRAINED_BOOST</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、通过freq聚合，将load计算放大。从而触发提升freq，或者迁移等</span><br><span class="line">load放大后，仍遵循基本EAS。提升freq或者迁移，视情况而定。</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-28T11:00:00.000Z" title="4/28/2021, 7:00:00 PM">2021-04-28</time>发表</span><span class="level-item"><time dateTime="2021-05-18T09:28:05.668Z" title="5/18/2021, 5:28:05 PM">2021-05-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/QCOM/">QCOM</a></span><span class="level-item">12 分钟读完 (大约1823个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/28/schedule/Qcom%20kernel/walt/">walt</a></h1><div class="content"><h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY?"></a>WHY?</h2><h2 id="WHAT"><a href="#WHAT" class="headerlink" title="WHAT?"></a>WHAT?</h2><p>walt (Windows Assisted load tracking–窗口协助负载跟踪算法)，主要是跟踪过去一段时间内 entity，rq的负载，给++调频、预测负载、负载均衡++ 等一些调度行为提供一些参考。</p>
<h2 id="walt-数据结构"><a href="#walt-数据结构" class="headerlink" title="walt 数据结构"></a>walt 数据结构</h2><p><code>struct walt_task_struct</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">struct walt_task_struct &#123;</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * &#39;mark_start&#39; marks the beginning of an event (task waking up, task</span><br><span class="line">	 * starting to execute, task being preempted) within a window</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;sum&#39; represents how runnable a task has been within current</span><br><span class="line">	 * window. It incorporates both running time and wait time and is</span><br><span class="line">	 * frequency scaled.</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;sum_history&#39; keeps track of history of &#39;sum&#39; seen over previous</span><br><span class="line">	 * RAVG_HIST_SIZE windows. Windows where task was entirely sleeping are</span><br><span class="line">	 * ignored.</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;demand&#39; represents maximum sum seen over previous</span><br><span class="line">	 * sysctl_sched_ravg_hist_size windows. &#39;demand&#39; could drive frequency</span><br><span class="line">	 * demand for tasks.</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;curr_window_cpu&#39; represents task&#39;s contribution to cpu busy time on</span><br><span class="line">	 * various CPUs in the current window</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;prev_window_cpu&#39; represents task&#39;s contribution to cpu busy time on</span><br><span class="line">	 * various CPUs in the previous window</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;curr_window&#39; represents the sum of all entries in curr_window_cpu</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;prev_window&#39; represents the sum of all entries in prev_window_cpu</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;pred_demand&#39; represents task&#39;s current predicted cpu busy time</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;busy_buckets&#39; groups historical busy time into different buckets</span><br><span class="line">	 * used for prediction</span><br><span class="line">	 *</span><br><span class="line">	 * &#39;demand_scaled&#39; represents task&#39;s demand scaled to 1024</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	u64				mark_start; &#x2F;&#x2F; beginning of events(task start executing or waking up)</span><br><span class="line">	u32				sum; &#x2F;&#x2F; runnable time within a window</span><br><span class="line">	u32				demand; &#x2F;&#x2F; max sum in past serval(sysctl_sched_ravg_hist_size &#x3D;&#x3D; 5) windows</span><br><span class="line">	u32				coloc_demand;</span><br><span class="line">	u32				sum_history[RAVG_HIST_SIZE_MAX];</span><br><span class="line">	u32				*curr_window_cpu, *prev_window_cpu;</span><br><span class="line">	u32				curr_window, prev_window;</span><br><span class="line">	u32				pred_demand;</span><br><span class="line">	u8				busy_buckets[NUM_BUSY_BUCKETS];</span><br><span class="line">	u16				demand_scaled;</span><br><span class="line">	u16				pred_demand_scaled;</span><br><span class="line">	u64				active_time;</span><br><span class="line">	int				boost;</span><br><span class="line">	bool				wake_up_idle;</span><br><span class="line">	bool				misfit;</span><br><span class="line">	bool				rtg_high_prio;</span><br><span class="line">	u8				low_latency;</span><br><span class="line">	u64				boost_period;</span><br><span class="line">	u64				boost_expires;</span><br><span class="line">	u64				last_sleep_ts;</span><br><span class="line">	u32				init_load_pct;</span><br><span class="line">	u32				unfilter;</span><br><span class="line">	u64				last_wake_ts;</span><br><span class="line">	u64				last_enqueued_ts;</span><br><span class="line">	struct walt_related_thread_group __rcu	*grp;</span><br><span class="line">	struct list_head		grp_list;</span><br><span class="line">	u64				cpu_cycles;</span><br><span class="line">	cpumask_t			cpus_requested;</span><br><span class="line">	bool				iowaited;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct task_struct &#123;</span><br><span class="line">	......</span><br><span class="line">	struct sched_entity		se;</span><br><span class="line">	struct sched_rt_entity		rt;</span><br><span class="line">#ifdef CONFIG_SCHED_WALT</span><br><span class="line">	struct walt_task_struct		wts;</span><br><span class="line">#endif</span><br><span class="line">	......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p><code>struct walt_rq</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">struct walt_rq &#123;</span><br><span class="line">	struct task_struct	*push_task;</span><br><span class="line">	struct walt_sched_cluster *cluster;</span><br><span class="line">	struct cpumask		freq_domain_cpumask;</span><br><span class="line">	struct walt_sched_stats walt_stats;</span><br><span class="line"></span><br><span class="line">	u64			window_start;</span><br><span class="line">	u32			prev_window_size;</span><br><span class="line">	unsigned long		walt_flags;</span><br><span class="line"></span><br><span class="line">	u64			avg_irqload;</span><br><span class="line">	u64			last_irq_window;</span><br><span class="line">	u64			prev_irq_time;</span><br><span class="line">	struct task_struct	*ed_task;</span><br><span class="line">	u64			task_exec_scale;</span><br><span class="line">	u64			old_busy_time;</span><br><span class="line">	u64			old_estimated_time;</span><br><span class="line">	u64			curr_runnable_sum;</span><br><span class="line">	u64			prev_runnable_sum;</span><br><span class="line">	u64			nt_curr_runnable_sum;</span><br><span class="line">	u64			nt_prev_runnable_sum;</span><br><span class="line">	u64			cum_window_demand_scaled;</span><br><span class="line">	struct group_cpu_time	grp_time;</span><br><span class="line">	struct load_subtractions load_subs[NUM_TRACKED_WINDOWS];</span><br><span class="line">	DECLARE_BITMAP_ARRAY(top_tasks_bitmap,</span><br><span class="line">			NUM_TRACKED_WINDOWS, NUM_LOAD_INDICES);</span><br><span class="line">	u8			*top_tasks[NUM_TRACKED_WINDOWS];</span><br><span class="line">	u8			curr_table;</span><br><span class="line">	int			prev_top;</span><br><span class="line">	int			curr_top;</span><br><span class="line">	bool			notif_pending;</span><br><span class="line">	bool			high_irqload;</span><br><span class="line">	u64			last_cc_update;</span><br><span class="line">	u64			cycles;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct rq &#123;</span><br><span class="line">#ifdef CONFIG_SCHED_WALT</span><br><span class="line">	struct walt_rq		wrq;</span><br><span class="line">#endif &#x2F;* CONFIG_SCHED_WALT *&#x2F;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h2 id="walt-api使用"><a href="#walt-api使用" class="headerlink" title="walt api使用"></a>walt api使用</h2><ol>
<li><p>init</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void walt_sched_init_rq(struct rq *rq)</span><br><span class="line">&#123;</span><br><span class="line">	int j;</span><br><span class="line"></span><br><span class="line">	if (cpu_of(rq) &#x3D;&#x3D; 0)</span><br><span class="line">		walt_init_once();</span><br><span class="line"></span><br><span class="line">	cpumask_set_cpu(cpu_of(rq), &amp;rq-&gt;wrq.freq_domain_cpumask);</span><br><span class="line"></span><br><span class="line">	rq-&gt;wrq.walt_stats.cumulative_runnable_avg_scaled &#x3D; 0;</span><br><span class="line">	rq-&gt;wrq.prev_window_size &#x3D; sched_ravg_window;</span><br><span class="line">	rq-&gt;wrq.window_start &#x3D; 0;</span><br><span class="line">	rq-&gt;wrq.walt_stats.nr_big_tasks &#x3D; 0;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __init sched_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">	for_each_possible_cpu(i) &#123;</span><br><span class="line">		struct rq *rq;</span><br><span class="line"> 		walt_sched_init_rq(rq);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>set_start()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void set_window_start(struct rq *rq)</span><br><span class="line">&#123;</span><br><span class="line">	static int sync_cpu_available;</span><br><span class="line"></span><br><span class="line">	if (likely(rq-&gt;wrq.window_start))</span><br><span class="line">		return;</span><br><span class="line">	if (!sync_cpu_available) &#123;</span><br><span class="line">		rq-&gt;wrq.window_start &#x3D; 1;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>‘</p>
</li>
<li><p>a</p>
</li>
<li></li>
</ol>
<h3 id="WALT-TIME"><a href="#WALT-TIME" class="headerlink" title="WALT TIME"></a>WALT TIME</h3><p>由于存在多个cluster，不同 cluster的频率 和架构都不一样，所以同一 task在不同 cluster上运行，<br>需要的时间是不一样的。为了更好衡量一个 task的负载或者需求，我们必须考虑 cpu freq 和 ipc的差异，<br>所以需要将不同cpu 上运行的task时间 归一化 到同一个度量尺子上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; delta 是 task实际 运行时间</span><br><span class="line">&#x2F;&#x2F; task_exec_scale 是task 执行时间的 刻度，每次在 update_task_rq_cpu_cycles 中更新</span><br><span class="line">static inline u64 scale_exec_time(u64 delta, struct rq *rq)</span><br><span class="line">&#123;</span><br><span class="line">	return (delta * rq-&gt;wrq.task_exec_scale) &gt;&gt; 10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unsigned long topology_get_cpu_scale(int cpu)</span><br><span class="line">&#123;</span><br><span class="line">	return per_cpu(cpu_scale, cpu);</span><br><span class="line">&#125;</span><br><span class="line">#define arch_scale_cpu_capacity topology_get_cpu_scale</span><br><span class="line"></span><br><span class="line">static void</span><br><span class="line">update_task_rq_cpu_cycles(struct task_struct *p, struct rq *rq, int event,</span><br><span class="line">			  u64 wallclock, u64 irqtime)</span><br><span class="line">&#123;</span><br><span class="line">      rq-&gt;wrq.task_exec_scale &#x3D; DIV64_U64_ROUNDUP(cpu_cur_freq(cpu) *</span><br><span class="line">         	arch_scale_cpu_capacity(cpu),</span><br><span class="line">         	rq-&gt;wrq.cluster-&gt;max_possible_freq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>        cur_freq</code></pre>
<p>task_exec_scale  =    ———— * scale_capacity<br>            max_freq</p>
<pre><code>            cur_freq</code></pre>
<p>scale_exec_time  =  delta *   ———— * scale_capacity<br>                max_freq</p>
<p><code>scale_capacity</code> 是driver 初始化的时候设置的。</p>
<h3 id="WALT-update"><a href="#WALT-update" class="headerlink" title="WALT update"></a>WALT update</h3><p><code>walt_update_task_ravg()</code> 是 walt的最主要输入，在各种<code>event</code> 下更新负载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">enum task_event &#123;</span><br><span class="line">	PUT_PREV_TASK   &#x3D; 0,</span><br><span class="line">	PICK_NEXT_TASK  &#x3D; 1,</span><br><span class="line">	TASK_WAKE       &#x3D; 2,</span><br><span class="line">	TASK_MIGRATE    &#x3D; 3,</span><br><span class="line">	TASK_UPDATE     &#x3D; 4,</span><br><span class="line">	IRQ_UPDATE      &#x3D; 5,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;* Reflect task activity on its demand and cpu&#39;s busy time statistics *&#x2F;</span><br><span class="line">void walt_update_task_ravg(struct task_struct *p, struct rq *rq, int event,</span><br><span class="line">						u64 wallclock, u64 irqtime)</span><br><span class="line">&#123;</span><br><span class="line">	u64 old_window_start;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; rq没有初始化 or task的 mark_start 与 wallclock相等&#x3D;&#x3D;&gt;刚刚才更新过</span><br><span class="line">	if (!rq-&gt;wrq.window_start || p-&gt;wts.mark_start &#x3D;&#x3D; wallclock)</span><br><span class="line">		return;</span><br><span class="line"></span><br><span class="line">	old_window_start &#x3D; update_window_start(rq, wallclock, event); &#x2F;&#x2F; 更新 rq-&gt;wrq.window_start，方便后面计算</span><br><span class="line"></span><br><span class="line">	if (!p-&gt;wts.mark_start) &#123;</span><br><span class="line">		update_task_cpu_cycles(p, cpu_of(rq), wallclock);</span><br><span class="line">		goto done;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	update_task_rq_cpu_cycles(p, rq, event, wallclock, irqtime); &#x2F;&#x2F; 更新 task_exec_scale</span><br><span class="line">	&#x2F;&#x2F; 更新 task的 demand 和 perd_demand 期望下一个window 的运行时间</span><br><span class="line">	update_task_demand(p, rq, event, wallclock);</span><br><span class="line">	update_cpu_busy_time(p, rq, event, wallclock, irqtime); &#x2F;&#x2F;</span><br><span class="line">	update_task_pred_demand(rq, p, event);</span><br><span class="line">	if (event &#x3D;&#x3D; PUT_PREV_TASK &amp;&amp; p-&gt;state)</span><br><span class="line">		p-&gt;wts.iowaited &#x3D; p-&gt;in_iowait;</span><br><span class="line"></span><br><span class="line">	trace_sched_update_task_ravg(p, rq, event, wallclock, irqtime,</span><br><span class="line">				&amp;rq-&gt;wrq.grp_time);</span><br><span class="line">	trace_sched_update_task_ravg_mini(p, rq, event, wallclock, irqtime,</span><br><span class="line">				&amp;rq-&gt;wrq.grp_time);</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">	p-&gt;wts.mark_start &#x3D; wallclock;</span><br><span class="line">&#x2F;&#x2F;	void walt_irq_work(struct irq_work *irq_work)</span><br><span class="line">	run_walt_irq_work(old_window_start, rq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面关注<code>update_task_demand()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">static u64 update_task_demand(struct task_struct *p, struct rq *rq,</span><br><span class="line">			       int event, u64 wallclock)</span><br><span class="line">&#123;</span><br><span class="line">	u64 mark_start &#x3D; p-&gt;wts.mark_start;</span><br><span class="line">	u64 delta, window_start &#x3D; rq-&gt;wrq.window_start;</span><br><span class="line">	int new_window, nr_full_windows;</span><br><span class="line">	u32 window_size &#x3D; sched_ravg_window;</span><br><span class="line">	u64 runtime;</span><br><span class="line"></span><br><span class="line">	new_window &#x3D; mark_start &lt; window_start;</span><br><span class="line">	&#x2F;&#x2F; window_start &#x3D; rq-&gt;wrq.window_start 在之前俩函数已经更新过了，</span><br><span class="line">	&#x2F;&#x2F; 正常如果经历了新的window，new_window &#x3D;1</span><br><span class="line">	if (!account_busy_for_task_demand(rq, p, event)) &#123;</span><br><span class="line">		if (new_window)</span><br><span class="line">			&#x2F;*</span><br><span class="line">			 * If the time accounted isn&#39;t being accounted as</span><br><span class="line">			 * busy time, and a new window started, only the</span><br><span class="line">			 * previous window need be closed out with the</span><br><span class="line">			 * pre-existing demand. Multiple windows may have</span><br><span class="line">			 * elapsed, but since empty windows are dropped,</span><br><span class="line">			 * it is not necessary to account those.</span><br><span class="line">			 *&#x2F;</span><br><span class="line">			update_history(rq, p, p-&gt;wts.sum, 1, event);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; case: 没有经历新的window，p-&gt;wts.sum +&#x3D; delta， sum是保存所有不满一个 window的时间</span><br><span class="line">	if (!new_window) &#123;</span><br><span class="line">		&#x2F;*</span><br><span class="line">		 * The simple case - busy time contained within the existing</span><br><span class="line">		 * window.</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		return add_to_task_demand(rq, p, wallclock - mark_start);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Busy time spans at least two windows. Temporarily rewind</span><br><span class="line">	 * window_start to first window boundary after mark_start.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	delta &#x3D; window_start - mark_start;</span><br><span class="line">	nr_full_windows &#x3D; div64_u64(delta, window_size);</span><br><span class="line">	window_start -&#x3D; (u64)nr_full_windows * (u64)window_size;</span><br><span class="line"></span><br><span class="line">	&#x2F;* Process (window_start - mark_start) first *&#x2F;</span><br><span class="line">	runtime &#x3D; add_to_task_demand(rq, p, window_start - mark_start);</span><br><span class="line"></span><br><span class="line">	&#x2F;* Push new sample(s) into task&#39;s demand history *&#x2F;</span><br><span class="line">	update_history(rq, p, p-&gt;wts.sum, 1, event);</span><br><span class="line">	if (nr_full_windows) &#123;</span><br><span class="line">		u64 scaled_window &#x3D; scale_exec_time(window_size, rq);</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; 为啥这里没有 add_to_task_demand()? ,因为 更新demand也只是更新 p-&gt;wts.sum， 这里</span><br><span class="line">		&#x2F;&#x2F; 因为涉及多个 window，所以 sum肯定会超过一个window的时间。</span><br><span class="line">		&#x2F;&#x2F; 关注 update_history() 中的 p-&gt;wts.sum &#x3D; 0;</span><br><span class="line">		update_history(rq, p, scaled_window, nr_full_windows, event);</span><br><span class="line">		runtime +&#x3D; nr_full_windows * scaled_window;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Roll window_start back to current to process any remainder</span><br><span class="line">	 * in current window.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	window_start +&#x3D; (u64)nr_full_windows * (u64)window_size;</span><br><span class="line"></span><br><span class="line">	&#x2F;* Process (wallclock - window_start) next *&#x2F;</span><br><span class="line">	mark_start &#x3D; window_start;</span><br><span class="line">	runtime +&#x3D; add_to_task_demand(rq, p, wallclock - mark_start);</span><br><span class="line"></span><br><span class="line">	return runtime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>add_to_task_demand()</code> 只是在 <code>scale-invariant</code>的尺度上将当前运行时间累计到 <code>task-&gt;wts.sum</code>上，<code>update_history()</code> 是 更新 <code>p-&gt;wts.sum_history[5]</code> 这个历史窗口的数据，类似不停地滚动，<code>update_history()</code>参数<code>runtime</code>也是 scale之后的，demand是根据不同的WINDOW_STATS_XXX决定的；然后根据 <code>predict_and_update_buckets()</code> 来预测 perd_demand需求，这里用到了buckets算法（不是重点）。</p>
<p>freq_policy_load() – __cpu_util_freq_walt() – cpu_util_freq_walt() – schedutil 使用此接口去获得 cpu使用率</p>
<h3 id="walt-输出api"><a href="#walt-输出api" class="headerlink" title="walt 输出api"></a>walt 输出api</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task_util()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">以can_migrate_task()函数为例：</span><br><span class="line"></span><br><span class="line">通过task_util()获取该task的demand，即task级负载</span><br><span class="line"></span><br><span class="line">cpu_util_cum()获取cpu rq的累计demand，即cpu级负载</span><br><span class="line"></span><br><span class="line">如果 dst_cpu累计demand + task_demand &gt; src_cpu累计demand + task_demand，那么说明不满足迁移条件。</span><br></pre></td></tr></table></figure></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">92</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">21</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">120</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/explore" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QCOM/"><span class="tag">QCOM</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v1/"><span class="tag">cgroup v1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v2/"><span class="tag">cgroup v2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dd/"><span class="tag">dd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debugfs/"><span class="tag">debugfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/double-free/"><span class="tag">double free</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drop-caches/"><span class="tag">drop_caches</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dumpe2fs/"><span class="tag">dumpe2fs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ext2/"><span class="tag">ext2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-attr/"><span class="tag">file attr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-hole/"><span class="tag">file hole</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filesystem/"><span class="tag">filesystem</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fsck/"><span class="tag">fsck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hrtimer/"><span class="tag">hrtimer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hugepage/"><span class="tag">hugepage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt/"><span class="tag">intrrrupt</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt-storm/"><span class="tag">intrrrupt storm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kfence/"><span class="tag">kfence</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kprobes/"><span class="tag">kprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kretprobes/"><span class="tag">kretprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvmtool/"><span class="tag">kvmtool</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/launch-json/"><span class="tag">launch.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-kernel/"><span class="tag">linux kernel</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory/"><span class="tag">memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory-direct-reclaim/"><span class="tag">memory direct reclaim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mount/"><span class="tag">mount</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/node/"><span class="tag">node</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oom/"><span class="tag">oom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf/"><span class="tag">perf</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pid-namespace/"><span class="tag">pid namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pressure/"><span class="tag">pressure</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psi/"><span class="tag">psi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rcu/"><span class="tag">rcu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sched-latency/"><span class="tag">sched latency</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/schedule/"><span class="tag">schedule</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slab/"><span class="tag">slab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-overflow/"><span class="tag">stack_overflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sync/"><span class="tag">sync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-json/"><span class="tag">task.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-struct/"><span class="tag">task_struct</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread-info/"><span class="tag">thread_info</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/use-after-free/"><span class="tag">use after free</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uts-namespace/"><span class="tag">uts namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vdso/"><span class="tag">vdso</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmstat/"><span class="tag">vmstat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xattr/"><span class="tag">xattr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zone/"><span class="tag">zone</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%B6%8A%E7%95%8C/"><span class="tag">内存泄漏越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88%E6%BA%A2%E5%87%BA/"><span class="tag">内核栈溢出</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/QCOM/"><span class="level-start"><span class="level-item">QCOM</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/cgroup-v1/"><span class="level-start"><span class="level-item">cgroup v1</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/cgroup-v1/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/"><span class="level-start"><span class="level-item">linux kernel</span></span><span class="level-end"><span class="level-item tag">12</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">12</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/deadline-schedule/"><span class="level-start"><span class="level-item">deadline schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/"><span class="level-start"><span class="level-item">frequency governer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/schedule-util/"><span class="level-start"><span class="level-item">schedule util</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/idle/"><span class="level-start"><span class="level-item">idle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">53</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/"><span class="level-start"><span class="level-item">namespace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/namespace/pid-namespace/"><span class="level-start"><span class="level-item">pid namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/uts-namespace/"><span class="level-start"><span class="level-item">uts namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-16T11:00:40.000Z">2021-07-16</time></p><p class="title"><a href="/2021/07/16/filesystem/file%20hole/">file hole</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-15T11:00:40.000Z">2021-07-15</time></p><p class="title"><a href="/2021/07/15/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20kernel%20subsys/">perf kernel subsys</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-15T11:00:40.000Z">2021-07-15</time></p><p class="title"><a href="/2021/07/15/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20example/">perf example</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-15T11:00:40.000Z">2021-07-15</time></p><p class="title"><a href="/2021/07/15/filesystem/fsck/">fsck</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-14T11:20:59.152Z">2021-07-14</time></p><p class="title"><a href="/2021/07/14/filesystem/buffer_head/"> </a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>