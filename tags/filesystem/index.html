<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>标签: filesystem - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">filesystem</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-16T11:00:40.000Z" title="7/16/2021, 7:00:40 PM">2021-07-16</time>发表</span><span class="level-item"><time dateTime="2021-07-15T03:40:04.216Z" title="7/15/2021, 11:40:04 AM">2021-07-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">几秒读完 (大约0个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/16/filesystem/file%20hole/">file hole</a></h1><div class="content"></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-15T11:00:40.000Z" title="7/15/2021, 7:00:40 PM">2021-07-15</time>发表</span><span class="level-item"><time dateTime="2021-07-15T06:52:03.336Z" title="7/15/2021, 2:52:03 PM">2021-07-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约1057个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/15/filesystem/fsck/">fsck</a></h1><div class="content"><h2 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h2><p><code>ext2</code> for example</p>
<p>以 <code>ext2</code> filesystem 为例。<br>在qemu环境中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# mkdir ext2_dir</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;ext2.img bs&#x3D;4k count&#x3D;1024</span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">4194304 bytes (4.2 MB, 4.0 MiB) copied, 0.00530677 s, 790 MB&#x2F;s</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# mkfs.ext2 ext2.img</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Discarding device blocks: done</span><br><span class="line">Creating filesystem with 1024 4k blocks and 1024 inodes</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo mount ext2.img ext2_dir</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs#</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# echo -n &quot;FFFFFFFF&quot; &gt; file</span><br><span class="line">stable_kernel@130kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -alih</span><br><span class="line">total 28K</span><br><span class="line">     2 drwxrwxrwx 3 root root 4.0K 7月  15 11:30 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk  4.0K 7月  15 14:07 ..</span><br><span class="line">    12 -rw-rw-r-- 1 rlk  rlk     8 7月  15 14:09 file</span><br><span class="line">    11 drwx------ 2 root root  16K 7月  15 11:28 lost+found</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>


<p>dumpe2fs 信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dumpe2fs &#x2F;dev&#x2F;loop0  | tail -n 8</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Group 0: (Blocks 0-1023)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Block bitmap at 2 (+2)</span><br><span class="line">  Inode bitmap at 3 (+3)</span><br><span class="line">  Inode table at 4-35 (+4)</span><br><span class="line">  981 free blocks, 1012 free inodes, 2 directories</span><br><span class="line">  Free blocks: 43-1023</span><br><span class="line">  Free inodes: 13-1024</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p><code>Block bitmap</code> 数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;2 count&#x3D;1 | xxd -u -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 5.4055e-05 s, 75.8 MB&#x2F;s</span><br><span class="line">00000000: FFFF FFFF FF07 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p><code>Inode bitmap</code> 数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;3 count&#x3D;1 | xxd -u -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 6.0532e-05 s, 67.7 MB&#x2F;s</span><br><span class="line">00000000: FF0F 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>



<h3 id="Block-bitmap-数据被破坏"><a href="#Block-bitmap-数据被破坏" class="headerlink" title="Block bitmap 数据被破坏"></a>Block bitmap 数据被破坏</h3><p><code>Block bitmap</code> 在 <code>block-2</code> 上，<code>block-size</code>是 4096，<br>我们破坏掉 <code>block-2</code> 上<code>32--63</code> 区域的数据，将其改写为1；<br>需要跨过 4096*2+32 = 257 * 32</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cat file</span><br><span class="line">FFFFFFFF%</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;file of&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;32 seek&#x3D;257 count&#x3D;1</span><br><span class="line">0+1 records in</span><br><span class="line">0+1 records out</span><br><span class="line">8 bytes copied, 0.00134476 s, 5.9 kB&#x2F;s</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>
<p><code>skip</code> 是 跳过 input<br><code>seek</code> 是 跳过 output</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seek&#x3D;N skip N obs-sized blocks at start of output</span><br><span class="line">skip&#x3D;N skip N ibs-sized blocks at start of input</span><br></pre></td></tr></table></figure>

<p>将 <code>Block bitmap</code> 的 <code>32-63</code> byte 数据 dd 出来看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;2 count&#x3D;1 | xxd -u -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.4243e-05 s, 92.6 MB&#x2F;s</span><br><span class="line">00000000: FFFF FFFF FF07 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 4646 4646 4646 4646 0000 0000 0000 0000  FFFFFFFF........</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs#</span><br></pre></td></tr></table></figure>

<p>可以看到与 <code>Block bitmap</code> 没被破坏之前的数据对比。</p>
<p>如何修复？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FSCK(8)                                                   System Administration                                                   FSCK(8)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">       fsck - check and repair a Linux filesystem</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       fsck [-lsAVRTMNP] [-r [fd]] [-C [fd]] [-t fstype] [filesystem...] [--] [fs-specific-options]</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       fsck  is  used  to  check  and  optionally  repair  one or more Linux filesystems.  filesys can be a device name (e.g.  &#x2F;dev&#x2F;hdc1,</span><br><span class="line">       &#x2F;dev&#x2F;sdb2),   a   mount   point   (e.g.    &#x2F;,   &#x2F;usr,   &#x2F;home),   or   an   filesystem   label    or    UUID    specifier    (e.g.</span><br><span class="line">       UUID&#x3D;8868abf6-88c5-4a83-98b8-bfc24057f7bd  or LABEL&#x3D;root).  Normally, the fsck program will try to handle filesystems on different</span><br><span class="line">       physical disk drives in parallel to reduce the total amount of time needed to check all of them.</span><br><span class="line"></span><br><span class="line">       If no filesystems are specified on the command line, and the -A option is not specified, fsck will default to checking filesystems</span><br><span class="line">       in &#x2F;etc&#x2F;fstab serially.  This is equivalent to the -As options.</span><br><span class="line"></span><br><span class="line">       The exit code returned by fsck is the sum of the following conditions:</span><br></pre></td></tr></table></figure>

<p>直接检查 ext2.img</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# fsck.ext2 ext2.img</span><br><span class="line">e2fsck 1.45.5 (07-Jan-2020)</span><br><span class="line">ext2.img was not cleanly unmounted, check forced.</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">Block bitmap differences:  -(257--258) -262 -(265--266) -270 -(273--274) -278 -(281--282) -286 -(289--290) -294 -(297--298) -302 -(305--306) -310 -(313--314) -318</span><br><span class="line">Fix&lt;y&gt;? yes</span><br><span class="line"></span><br><span class="line">ext2.img: ***** FILE SYSTEM WAS MODIFIED *****</span><br><span class="line">ext2.img: 12&#x2F;1024 files (0.0% non-contiguous), 43&#x2F;1024 blocks</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs#</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>fsck.ext2</code> 检查出了 <code>Block bitmap</code> 的 differences，选择 <code>y</code> 之后就直接修<br>复了。</p>
<p>然后 <code>dd</code> <code>Block bitmap</code> 数据看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;2 count&#x3D;1 | xxd -u -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 5.6547e-05 s, 72.4 MB&#x2F;s</span><br><span class="line">00000000: FFFF FFFF FF07 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs#</span><br></pre></td></tr></table></figure>
<p><code>Block bitmap</code>已经恢复到了 被破坏之前的数据</p>
<h3 id="Inode-bitmap-数据被破坏"><a href="#Inode-bitmap-数据被破坏" class="headerlink" title="Inode bitmap 数据被破坏"></a>Inode bitmap 数据被破坏</h3><p><code>Inode bitmap</code> 在 <code>block-3</code> 上，<code>block-size</code>是 4096，<br>我们破坏掉 <code>block-3</code> 上<code>32--63</code> 区域的数据，将其改写为1；<br>需要跨过 4096*3+32 = 385 * 32</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cat file</span><br><span class="line">FFFFFFFF%</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;file of&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;32 seek&#x3D;385 count&#x3D;1</span><br><span class="line">0+1 records in</span><br><span class="line">0+1 records out</span><br><span class="line">8 bytes copied, 0.00134476 s, 5.9 kB&#x2F;s</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p><code>dd</code>可以看到与 <code>Inode bitmap</code> 没被破坏之前的数据对比。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;3 count&#x3D;1 | xxd -u -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.842e-05 s, 84.6 MB&#x2F;s</span><br><span class="line">00000000: FF0F 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 4646 4646 4646 4646 0000 0000 0000 0000  FFFFFFFF........</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs#</span><br></pre></td></tr></table></figure>

<p>直接可以使用 <code>fsck.ext2</code> 进行修复</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# fsck.ext2 ext2.img</span><br><span class="line">e2fsck 1.45.5 (07-Jan-2020)</span><br><span class="line">ext2.img was not cleanly unmounted, check forced.</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">Inode bitmap differences:  -(258--259) -263 -(266--267) -271 -(274--275) -279 -(282--283) -287 -(290--291) -295 -(298--299) -303 -(306--307) -311 -(314--315) -319</span><br><span class="line">Fix&lt;y&gt;? yes</span><br><span class="line"></span><br><span class="line">ext2.img: ***** FILE SYSTEM WAS MODIFIED *****</span><br><span class="line">ext2.img: 12&#x2F;1024 files (0.0% non-contiguous), 43&#x2F;1024 blocks</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs#</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>fsck.ext2</code> 检查出了 <code>Inode bitmap</code> 的 differences，选择 <code>y</code> 之后就直接修<br>复了。</p>
<h2 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h2><p>ext4 for example</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-15T11:00:40.000Z" title="7/15/2021, 7:00:40 PM">2021-07-15</time>发表</span><span class="level-item"><time dateTime="2021-07-21T06:17:53.281Z" title="7/21/2021, 2:17:53 PM">2021-07-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">6 分钟读完 (大约962个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/15/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20example/">perf example</a></h1><div class="content"><h2 id="perf-event-open-demo"><a href="#perf-event-open-demo" class="headerlink" title="perf_event_open demo"></a>perf_event_open demo</h2><p>performance counters 是在现代cpu上的一种特殊硬件寄存器，可以对某些特定hw events进行计数，比如指令执行数目，cache miss数量等。<br>perf 子系统给应用层单独开放的接口 是 <code>perf_event_open</code>，会返回 一个fd，后续的操作都是围绕这个 fd来的，可以用 ioctl,fcntl 来控制这个fd。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdint.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;syscall.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;perf_event.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;ioctl.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;目前perf_event_open在glibc中没有封装，需要手工封装一下</span><br><span class="line">int perf_event_open(struct perf_event_attr *attr, pid_t pid, int cpu, int group_fd, unsigned long flags)</span><br><span class="line">&#123;</span><br><span class="line">    return syscall(__NR_perf_event_open, attr, pid, cpu, group_fd, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * read instructions</span><br><span class="line">*&#x2F;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    struct perf_event_attr attr;</span><br><span class="line">    memset(&amp;attr, 0, sizeof(struct perf_event_attr));</span><br><span class="line">    attr.size &#x3D; sizeof(struct perf_event_attr);</span><br><span class="line">    &#x2F;&#x2F;监测硬件</span><br><span class="line">    attr.type &#x3D; PERF_TYPE_HARDWARE;</span><br><span class="line">    &#x2F;&#x2F;监测指令数</span><br><span class="line">    attr.config &#x3D; PERF_COUNT_HW_INSTRUCTIONS;</span><br><span class="line">    &#x2F;&#x2F;初始状态为禁用</span><br><span class="line">    attr.disabled &#x3D; 1;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;创建perf文件描述符，其中pid&#x3D;0,cpu&#x3D;-1表示监测当前进程，不论运行在那个cpu上</span><br><span class="line">    int fd &#x3D; perf_event_open(&amp;attr, 0, -1, -1, 0);</span><br><span class="line">    if (fd &lt; 0) &#123;</span><br><span class="line">        perror(&quot;Cannot open perf fd!&quot;);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启用（开始计数）</span><br><span class="line">    ioctl(fd, PERF_EVENT_IOC_ENABLE, 0);</span><br><span class="line">    while (1) &#123;</span><br><span class="line">        uint64_t instructions;</span><br><span class="line">        &#x2F;&#x2F;读取最新的计数值</span><br><span class="line">        read(fd, &amp;instructions, sizeof(instructions));</span><br><span class="line">        printf(&quot;instructions &#x3D; %ld\n&quot;, instructions);</span><br><span class="line">        sleep(1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;performance&#x2F;perf_event_open $ gcc perf_count.c</span><br><span class="line">ubuntu@zeku_server:~&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;performance&#x2F;perf_event_open $ sudo .&#x2F;a.out</span><br><span class="line">instructions &#x3D; 7516</span><br><span class="line">instructions &#x3D; 82866</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>

<h2 id="接口分析"><a href="#接口分析" class="headerlink" title="接口分析"></a>接口分析</h2><p>通过 <code>perf_event_open</code>、<code>ioctl</code> 等实现了 <code>perf</code> 部分功能。<br>调用<code>perf_event_open</code> 之前需要先构造<code>attr</code>，attr属性主要有<br><code>type</code>，主要有六类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * attr.type</span><br><span class="line"> *&#x2F;</span><br><span class="line">enum perf_type_id &#123;</span><br><span class="line">	PERF_TYPE_HARDWARE			&#x3D; 0,</span><br><span class="line">	PERF_TYPE_SOFTWARE			&#x3D; 1,</span><br><span class="line">	PERF_TYPE_TRACEPOINT			&#x3D; 2,</span><br><span class="line">	PERF_TYPE_HW_CACHE			&#x3D; 3,</span><br><span class="line">	PERF_TYPE_RAW				&#x3D; 4,</span><br><span class="line">	PERF_TYPE_BREAKPOINT			&#x3D; 5,</span><br><span class="line"></span><br><span class="line">	PERF_TYPE_MAX,				&#x2F;* non-ABI *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每个type还有具体细分<br>如 <code>perf_hw_cache_id</code> <code>perf_hw_cache_op_id</code> <code>perf_hw_cache_op_result_id</code> <code>perf_sw_ids</code> 等：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Generalized hardware cache events:</span><br><span class="line"> *</span><br><span class="line"> *       &#123; L1-D, L1-I, LLC, ITLB, DTLB, BPU, NODE &#125; x</span><br><span class="line"> *       &#123; read, write, prefetch &#125; x</span><br><span class="line"> *       &#123; accesses, misses &#125;</span><br><span class="line"> *&#x2F;</span><br><span class="line">enum perf_hw_cache_id &#123;</span><br><span class="line">	PERF_COUNT_HW_CACHE_L1D			&#x3D; 0,</span><br><span class="line">	PERF_COUNT_HW_CACHE_L1I			&#x3D; 1,</span><br><span class="line">	PERF_COUNT_HW_CACHE_LL			&#x3D; 2,</span><br><span class="line">	PERF_COUNT_HW_CACHE_DTLB		&#x3D; 3,</span><br><span class="line">	PERF_COUNT_HW_CACHE_ITLB		&#x3D; 4,</span><br><span class="line">	PERF_COUNT_HW_CACHE_BPU			&#x3D; 5,</span><br><span class="line">	PERF_COUNT_HW_CACHE_NODE		&#x3D; 6,</span><br><span class="line"></span><br><span class="line">	PERF_COUNT_HW_CACHE_MAX,		&#x2F;* non-ABI *&#x2F;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">enum perf_hw_cache_op_id &#123;</span><br><span class="line">	PERF_COUNT_HW_CACHE_OP_READ		&#x3D; 0,</span><br><span class="line">	PERF_COUNT_HW_CACHE_OP_WRITE		&#x3D; 1,</span><br><span class="line">	PERF_COUNT_HW_CACHE_OP_PREFETCH		&#x3D; 2,</span><br><span class="line"></span><br><span class="line">	PERF_COUNT_HW_CACHE_OP_MAX,		&#x2F;* non-ABI *&#x2F;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">enum perf_hw_cache_op_result_id &#123;</span><br><span class="line">	PERF_COUNT_HW_CACHE_RESULT_ACCESS	&#x3D; 0,</span><br><span class="line">	PERF_COUNT_HW_CACHE_RESULT_MISS		&#x3D; 1,</span><br><span class="line"></span><br><span class="line">	PERF_COUNT_HW_CACHE_RESULT_MAX,		&#x2F;* non-ABI *&#x2F;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * Special &quot;software&quot; events provided by the kernel, even if the hardware</span><br><span class="line"> * does not support performance events. These events measure various</span><br><span class="line"> * physical and sw events of the kernel (and allow the profiling of them as</span><br><span class="line"> * well):</span><br><span class="line"> *&#x2F;</span><br><span class="line">enum perf_sw_ids &#123;</span><br><span class="line">	PERF_COUNT_SW_CPU_CLOCK			&#x3D; 0,</span><br><span class="line">	PERF_COUNT_SW_TASK_CLOCK		&#x3D; 1,</span><br><span class="line">	PERF_COUNT_SW_PAGE_FAULTS		&#x3D; 2,</span><br><span class="line">	PERF_COUNT_SW_CONTEXT_SWITCHES		&#x3D; 3,</span><br><span class="line">	PERF_COUNT_SW_CPU_MIGRATIONS		&#x3D; 4,</span><br><span class="line">	PERF_COUNT_SW_PAGE_FAULTS_MIN		&#x3D; 5,</span><br><span class="line">	PERF_COUNT_SW_PAGE_FAULTS_MAJ		&#x3D; 6,</span><br><span class="line">	PERF_COUNT_SW_ALIGNMENT_FAULTS		&#x3D; 7,</span><br><span class="line">	PERF_COUNT_SW_EMULATION_FAULTS		&#x3D; 8,</span><br><span class="line">	PERF_COUNT_SW_DUMMY			&#x3D; 9,</span><br><span class="line">	PERF_COUNT_SW_BPF_OUTPUT		&#x3D; 10,</span><br><span class="line">	PERF_COUNT_SW_CGROUP_SWITCHES		&#x3D; 11,</span><br><span class="line"></span><br><span class="line">	PERF_COUNT_SW_MAX,			&#x2F;* non-ABI *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="pid-cpu-参数"><a href="#pid-cpu-参数" class="headerlink" title="pid cpu 参数"></a>pid cpu 参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pid &#x3D;&#x3D; 0 and cpu &#x3D;&#x3D; -1</span><br><span class="line">      This measures the calling process&#x2F;thread on any CPU.</span><br><span class="line"></span><br><span class="line">pid &#x3D;&#x3D; 0 and cpu &gt;&#x3D; 0</span><br><span class="line">      This measures the calling process&#x2F;thread only when running on the specified CPU.</span><br><span class="line"></span><br><span class="line">pid &gt; 0 and cpu &#x3D;&#x3D; -1</span><br><span class="line">      This measures the specified process&#x2F;thread on any CPU.</span><br><span class="line"></span><br><span class="line">pid &gt; 0 and cpu &gt;&#x3D; 0</span><br><span class="line">      This measures the specified process&#x2F;thread only when running on the specified CPU.</span><br><span class="line"></span><br><span class="line">pid &#x3D;&#x3D; -1 and cpu &gt;&#x3D; 0</span><br><span class="line">      This  measures  all  processes&#x2F;threads on the specified CPU.  This requires CAP_PERFMON (since Linux 5.8) or</span><br><span class="line">      CAP_SYS_ADMIN capability or a &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;perf_event_paranoid value of less than 1.</span><br><span class="line"></span><br><span class="line">pid &#x3D;&#x3D; -1 and cpu &#x3D;&#x3D; -1</span><br><span class="line">      This setting is invalid and will return an error.</span><br></pre></td></tr></table></figure>


<h2 id="perf-tool-分析"><a href="#perf-tool-分析" class="headerlink" title="perf tool 分析"></a>perf tool 分析</h2><p>perf tool 提供了多种多样的功能，是使用 perf tool的关键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">static struct cmd_struct commands[] &#x3D; &#123;</span><br><span class="line">	&#123; &quot;buildid-cache&quot;, cmd_buildid_cache, 0 &#125;,</span><br><span class="line">	&#123; &quot;buildid-list&quot;, cmd_buildid_list, 0 &#125;,</span><br><span class="line">	&#123; &quot;config&quot;,	cmd_config,	0 &#125;,</span><br><span class="line">	&#123; &quot;c2c&quot;,	cmd_c2c,	0 &#125;,</span><br><span class="line">	&#123; &quot;diff&quot;,	cmd_diff,	0 &#125;,</span><br><span class="line">	&#123; &quot;evlist&quot;,	cmd_evlist,	0 &#125;,</span><br><span class="line">	&#123; &quot;help&quot;,	cmd_help,	0 &#125;,</span><br><span class="line">	&#123; &quot;kallsyms&quot;,	cmd_kallsyms,	0 &#125;,</span><br><span class="line">	&#123; &quot;list&quot;,	cmd_list,	0 &#125;,</span><br><span class="line">	&#123; &quot;record&quot;,	cmd_record,	0 &#125;,</span><br><span class="line">	&#123; &quot;report&quot;,	cmd_report,	0 &#125;,</span><br><span class="line">	&#123; &quot;bench&quot;,	cmd_bench,	0 &#125;,</span><br><span class="line">	&#123; &quot;stat&quot;,	cmd_stat,	0 &#125;,</span><br><span class="line">	&#123; &quot;timechart&quot;,	cmd_timechart,	0 &#125;,</span><br><span class="line">	&#123; &quot;top&quot;,	cmd_top,	0 &#125;,</span><br><span class="line">	&#123; &quot;annotate&quot;,	cmd_annotate,	0 &#125;,</span><br><span class="line">	&#123; &quot;version&quot;,	cmd_version,	0 &#125;,</span><br><span class="line">	&#123; &quot;script&quot;,	cmd_script,	0 &#125;,</span><br><span class="line">	&#123; &quot;sched&quot;,	cmd_sched,	0 &#125;,</span><br><span class="line">#ifdef HAVE_LIBELF_SUPPORT</span><br><span class="line">	&#123; &quot;probe&quot;,	cmd_probe,	0 &#125;,</span><br><span class="line">#endif</span><br><span class="line">	&#123; &quot;kmem&quot;,	cmd_kmem,	0 &#125;,</span><br><span class="line">	&#123; &quot;lock&quot;,	cmd_lock,	0 &#125;,</span><br><span class="line">	&#123; &quot;kvm&quot;,	cmd_kvm,	0 &#125;,</span><br><span class="line">	&#123; &quot;test&quot;,	cmd_test,	0 &#125;,</span><br><span class="line">#if defined(HAVE_LIBAUDIT_SUPPORT) || defined(HAVE_SYSCALL_TABLE_SUPPORT)</span><br><span class="line">	&#123; &quot;trace&quot;,	cmd_trace,	0 &#125;,</span><br><span class="line">#endif</span><br><span class="line">	&#123; &quot;inject&quot;,	cmd_inject,	0 &#125;,</span><br><span class="line">	&#123; &quot;mem&quot;,	cmd_mem,	0 &#125;,</span><br><span class="line">	&#123; &quot;data&quot;,	cmd_data,	0 &#125;,</span><br><span class="line">	&#123; &quot;ftrace&quot;,	cmd_ftrace,	0 &#125;,</span><br><span class="line">	&#123; &quot;daemon&quot;,	cmd_daemon,	0 &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/muahao/p/8933384.html">perf-perf stat用户层代码分析</a></p>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/tools/perf/design.txt">design.txt</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-15T11:00:40.000Z" title="7/15/2021, 7:00:40 PM">2021-07-15</time>发表</span><span class="level-item"><time dateTime="2021-07-21T07:24:57.017Z" title="7/21/2021, 3:24:57 PM">2021-07-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">9 分钟读完 (大约1373个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/15/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20kernel%20subsys/">perf kernel subsys</a></h1><div class="content"><h2 id="perf-架构"><a href="#perf-架构" class="headerlink" title="perf 架构"></a>perf 架构</h2><p>perf的基本包装模型是这样的，对每一个event分配一个对应的perf_event结构。所有对event的操作都是围绕perf_event来展开的：</p>
<p>通过perf_event_open系统调用分配到perf_event以后，会返回一个文件句柄fd，这样这个perf_event结构可以通过read/write/ioctl/mmap通用文件接口来操作。<br>perf_event提供两种类型的trace数据：count和sample。count只是记录了event的发生次数，sample记录了大量信息(比如：IP、ADDR、TID、TIME、CPU、BT)。如果需要使用sample功能，需要给perf_event分配ringbuffer空间，并且把这部分空间通过mmap映射到用户空间。这和定位问题时从粗到细的思路是相符的，首先从counter的比例上找出问题热点在哪个模块，再使用详细记录抓取更多信息来进一步定位。具体分别对应“perf stat”和“perf record/report”命令。<br>perf的开销应该是比ftrace要大的，因为它给每个event都独立一套数据结构perf_event，对应独立的attr和pmu。在数据记录时的开销肯定大于ftrace，但是每个event的ringbuffer是独立的所以也不需要ftrace复杂的ringbuffer操作。perf也有比ftrace开销小的地方，它的sample数据存储的ringbuffer空间会通过mmap映射到到用户态，这样在读取数据的时候就会少一次拷贝。不过perf的设计初衷也不是让成百上千的event同时使用，只会挑出一些event重点debug。</p>
<h2 id="pmu-硬件"><a href="#pmu-硬件" class="headerlink" title="pmu 硬件"></a>pmu 硬件</h2><p>performance monitor unit</p>
<h3 id="arm"><a href="#arm" class="headerlink" title="arm"></a>arm</h3><p>arm 有很多pmu，大致分为 普通PMU、DSU-PMU、SPE-PMU、SMMU-PMU等。</p>
<p>SPE(Statistical Profiling Extension (SPE) Performance Monitor Units):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spe-pmu &#123;</span><br><span class="line">        compatible &#x3D; &quot;arm,statistical-profiling-extension-v1&quot;;</span><br><span class="line">        interrupts &#x3D; &lt;GIC_PPI 05 IRQ_TYPE_LEVEL_HIGH &amp;part1&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/Documentation/devicetree/bindings/arm/spe-pmu.txt">spe-pmu</a></p>
<p>DSU(DynamIQ Shared Unit (DSU) Performance Monitor Unit):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dsu-pmu-0 &#123;</span><br><span class="line">	compatible &#x3D; &quot;arm,dsu-pmu&quot;;</span><br><span class="line">	interrupts &#x3D; &lt;GIC_SPI 02 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">	cpus &#x3D; &lt;&amp;cpu_0&gt;, &lt;&amp;cpu_1&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/Documentation/devicetree/bindings/arm/arm-dsu-pmu.txt">dsu-pmu</a></p>
<h4 id="arm-v9-2021-新feature"><a href="#arm-v9-2021-新feature" class="headerlink" title="arm v9 2021 新feature"></a>arm v9 2021 新feature</h4><ul>
<li>Branch events</li>
<li>Bulk memory operations</li>
<li>Stall events</li>
<li>Atomics events</li>
<li>Data source or target (cache hit) events</li>
<li>Cache line state tracking</li>
<li>TLB events</li>
<li>Latency events</li>
</ul>
<h4 id="SPE-的扩展"><a href="#SPE-的扩展" class="headerlink" title="SPE 的扩展"></a>SPE 的扩展</h4><ul>
<li>Counter packet size</li>
<li>Hardware management of the dirty state and Access Flag</li>
<li>External abort handling</li>
<li>Second address packet generation</li>
<li>Sampling Tag operations</li>
<li>Sampling memory copy/set operations</li>
</ul>
<h4 id="Trace-and-Branch-Recording-Extensions"><a href="#Trace-and-Branch-Recording-Extensions" class="headerlink" title="Trace and Branch Recording Extensions"></a>Trace and Branch Recording Extensions</h4><ul>
<li>Hardware management of the dirty state and Access Flag</li>
<li>External abort handling</li>
<li>Trace Architecture updates for the 2021 Architecture Extensions</li>
<li>Self-hosted branch recording of EL3 using BRBE</li>
</ul>
<h2 id="perf-软件结构"><a href="#perf-软件结构" class="headerlink" title="perf 软件结构"></a>perf 软件结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">                           +-----------------+</span><br><span class="line">                           |                 |</span><br><span class="line">                           |    Application  |</span><br><span class="line"> userspace                 +-----------------+</span><br><span class="line"></span><br><span class="line">                     +-----------------------------+</span><br><span class="line">                     |                             |</span><br><span class="line">                     |          perf               |</span><br><span class="line">                     |                             |</span><br><span class="line">                     +-----------------------------+</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">            +------------------------+      +-------------------------------------+</span><br><span class="line">            |                        +-----&gt;|                                     |</span><br><span class="line">            |   kernel&#x2F;event&#x2F;core.c  |      | arch&#x2F;arm64&#x2F;kernel&#x2F;perf_event.c      |</span><br><span class="line">            +------------------------+&lt;-----+                                     |</span><br><span class="line">kernelspace                                 +-------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           +-----------------------------------------------------+</span><br><span class="line">           |                                                     |</span><br><span class="line">           |                   PMU counters                      |</span><br><span class="line">           |                                                     |</span><br><span class="line">           +-----------------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><p>userspace perf 代码在 <code>tools/perf</code> 目录下</p>
</li>
<li><p>kernelspace perf 框架代码在 <code>kernel/events</code> 目录下，<code>kernel/Makefile</code> 中可以看出<br>events目录都是和 perf相关的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-$(CONFIG_PERF_EVENTS) +&#x3D; events&#x2F;</span><br></pre></td></tr></table></figure>
</li>
<li><p>arm64 架构相关代码在 <code>arch/arm64/kernel/perf_event.c</code> 中，<code>arch/arm64/kernel/Makefile</code> 可以看出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj-$(CONFIG_PERF_EVENTS)		+&#x3D; perf_regs.o perf_callchain.o</span><br><span class="line">obj-$(CONFIG_HW_PERF_EVENTS)		+&#x3D; perf_event.o</span><br></pre></td></tr></table></figure>
</li>
<li><p>arm 相关drivers 代码在 <code>drivers/perf</code> 目录中<br><code>drivers/perf/Makefile</code> 可以看到如下各种 PMU CONFIG，有<code>DSU</code> <code>SPE</code> 等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">obj-$(CONFIG_ARM_CCI_PMU) +&#x3D; arm-cci.o</span><br><span class="line">obj-$(CONFIG_ARM_CCN) +&#x3D; arm-ccn.o</span><br><span class="line">obj-$(CONFIG_ARM_CMN) +&#x3D; arm-cmn.o</span><br><span class="line">obj-$(CONFIG_ARM_DSU_PMU) +&#x3D; arm_dsu_pmu.o</span><br><span class="line">obj-$(CONFIG_ARM_PMU) +&#x3D; arm_pmu.o arm_pmu_platform.o</span><br><span class="line">obj-$(CONFIG_ARM_PMU_ACPI) +&#x3D; arm_pmu_acpi.o</span><br><span class="line">obj-$(CONFIG_ARM_SMMU_V3_PMU) +&#x3D; arm_smmuv3_pmu.o</span><br><span class="line">obj-$(CONFIG_FSL_IMX8_DDR_PMU) +&#x3D; fsl_imx8_ddr_perf.o</span><br><span class="line">obj-$(CONFIG_HISI_PMU) +&#x3D; hisilicon&#x2F;</span><br><span class="line">obj-$(CONFIG_QCOM_L2_PMU)	+&#x3D; qcom_l2_pmu.o</span><br><span class="line">obj-$(CONFIG_QCOM_L3_PMU) +&#x3D; qcom_l3_pmu.o</span><br><span class="line">obj-$(CONFIG_THUNDERX2_PMU) +&#x3D; thunderx2_pmu.o</span><br><span class="line">obj-$(CONFIG_XGENE_PMU) +&#x3D; xgene_pmu.o</span><br><span class="line">obj-$(CONFIG_ARM_SPE_PMU) +&#x3D; arm_spe_pmu.o</span><br><span class="line">obj-$(CONFIG_ARM_DMC620_PMU) +&#x3D; arm_dmc620_pmu.o</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="perf-init"><a href="#perf-init" class="headerlink" title="perf init"></a>perf init</h2><p><code>perf_event_init</code>注册不同 类型(sw)的 <code>pmu</code>，<br>如<code>perf_swevent</code>，<code>perf_tracepoint</code>，<code>perf_kprobe</code>，<code>perf_uprobe</code>，<code>perf_cpu_clock</code>等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void __init perf_event_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	perf_event_init_all_cpus();</span><br><span class="line">	init_srcu_struct(&amp;pmus_srcu);</span><br><span class="line">	perf_pmu_register(&amp;perf_swevent, &quot;software&quot;, PERF_TYPE_SOFTWARE);</span><br><span class="line">	perf_pmu_register(&amp;perf_cpu_clock, NULL, -1);</span><br><span class="line">	perf_pmu_register(&amp;perf_task_clock, NULL, -1);</span><br><span class="line">	perf_tp_register();</span><br><span class="line">	perf_event_init_cpu(smp_processor_id());</span><br><span class="line">	register_reboot_notifier(&amp;perf_reboot_notifier);</span><br><span class="line"></span><br><span class="line">	ret &#x3D; init_hw_breakpoint();</span><br><span class="line">	WARN(ret, &quot;hw_breakpoint initialization failed with: %d&quot;, ret);</span><br><span class="line"></span><br><span class="line">	perf_event_cache &#x3D; KMEM_CACHE(perf_event, SLAB_PANIC);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>arm 硬件架构相关的<code>pmu</code> 注册在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">static const struct of_device_id armv8_pmu_of_device_ids[] &#x3D; &#123;</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,armv8-pmuv3&quot;,	.data &#x3D; armv8_pmuv3_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a34-pmu&quot;,	.data &#x3D; armv8_a34_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a35-pmu&quot;,	.data &#x3D; armv8_a35_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a53-pmu&quot;,	.data &#x3D; armv8_a53_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a55-pmu&quot;,	.data &#x3D; armv8_a55_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a57-pmu&quot;,	.data &#x3D; armv8_a57_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a65-pmu&quot;,	.data &#x3D; armv8_a65_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a72-pmu&quot;,	.data &#x3D; armv8_a72_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a73-pmu&quot;,	.data &#x3D; armv8_a73_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a75-pmu&quot;,	.data &#x3D; armv8_a75_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a76-pmu&quot;,	.data &#x3D; armv8_a76_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a77-pmu&quot;,	.data &#x3D; armv8_a77_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,cortex-a78-pmu&quot;,	.data &#x3D; armv8_a78_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,neoverse-e1-pmu&quot;,	.data &#x3D; armv8_e1_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;arm,neoverse-n1-pmu&quot;,	.data &#x3D; armv8_n1_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;cavium,thunder-pmu&quot;,	.data &#x3D; armv8_thunder_pmu_init&#125;,</span><br><span class="line">	&#123;.compatible &#x3D; &quot;brcm,vulcan-pmu&quot;,	.data &#x3D; armv8_vulcan_pmu_init&#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int armv8_pmu_device_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	return arm_pmu_device_probe(pdev, armv8_pmu_of_device_ids, NULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>arm_pmu_device_probe</code> 中，最终会调用到<code>perf_pmu_register</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">int armpmu_register(struct arm_pmu *pmu)</span><br><span class="line">&#123;</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	ret &#x3D; cpu_pmu_init(pmu);</span><br><span class="line">	if (ret)</span><br><span class="line">		return ret;</span><br><span class="line"></span><br><span class="line">	if (!pmu-&gt;set_event_filter)</span><br><span class="line">		pmu-&gt;pmu.capabilities |&#x3D; PERF_PMU_CAP_NO_EXCLUDE;</span><br><span class="line"></span><br><span class="line">	ret &#x3D; perf_pmu_register(&amp;pmu-&gt;pmu, pmu-&gt;name, -1);</span><br><span class="line">	if (ret)</span><br><span class="line">		goto out_destroy;</span><br><span class="line"></span><br><span class="line">	pr_info(&quot;enabled with %s PMU driver, %d counters available%s\n&quot;,</span><br><span class="line">		pmu-&gt;name, pmu-&gt;num_events,</span><br><span class="line">		has_nmi ? &quot;, using NMIs&quot; : &quot;&quot;);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int arm_pmu_device_probe(struct platform_device *pdev,</span><br><span class="line">			 const struct of_device_id *of_table,</span><br><span class="line">			 const struct pmu_probe_info *probe_table)</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">	ret &#x3D; armpmu_request_irqs(pmu);</span><br><span class="line"></span><br><span class="line">	ret &#x3D; armpmu_register(pmu);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


















<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/a515983690/article/details/51504789">Linux perf 1.1、perf_event内核框架</a><br>参考<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=xV4UHWLH_7Y&ab_channel=LinaroOrg">linaroOrg视频</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-14T11:00:40.000Z" title="7/14/2021, 7:00:40 PM">2021-07-14</time>发表</span><span class="level-item"><time dateTime="2021-07-15T07:56:49.972Z" title="7/15/2021, 3:56:49 PM">2021-07-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">36 分钟读完 (大约5469个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/14/filesystem/dd%20dumpe2fs%20debugfs%20%E6%8E%A2%E7%B4%A2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">dd dumpe2fs debugfs 探索文件系统</a></h1><div class="content"><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>以 <code>ext2</code> filesystem 为例。<br>在qemu环境中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# mkdir ext2_dir</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;ext2.img bs&#x3D;4k count&#x3D;1024</span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">4194304 bytes (4.2 MB, 4.0 MiB) copied, 0.00530677 s, 790 MB&#x2F;s</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# mkfs.ext2 ext2.img</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Discarding device blocks: done</span><br><span class="line">Creating filesystem with 1024 4k blocks and 1024 inodes</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo mount ext2.img ext2_dir</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs#</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo su</span><br><span class="line">oot@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# dmesg &gt; dmesg</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cp dmesg dmesg1</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# echo suhui &gt; file</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# pwd</span><br><span class="line">&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ln -s &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file file_link</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls</span><br><span class="line">dmesg  dmesg1  file  file_link  lost+found</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@130kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# df</span><br><span class="line">Filesystem     1K-blocks      Used Available Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;root       32377648  21931288   8778624  72% &#x2F;</span><br><span class="line">devtmpfs         1873504         0   1873504   0% &#x2F;dev</span><br><span class="line">tmpfs            1875824         0   1875824   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs             375168      1088    374080   1% &#x2F;run</span><br><span class="line">tmpfs               5120         0      5120   0% &#x2F;run&#x2F;lock</span><br><span class="line">host_share     244568380 149197884  82877440  65% &#x2F;tmp&#x2F;share</span><br><span class="line">&#x2F;dev&#x2F;sda1         523248         4    523244   1% &#x2F;boot&#x2F;efi</span><br><span class="line">tmpfs             375164        20    375144   1% &#x2F;run&#x2F;user&#x2F;1000</span><br><span class="line">&#x2F;dev&#x2F;loop0          3952        60      3688   2% &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dumpe2fs &#x2F;dev&#x2F;loop0</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          7e4b766b-1cd0-4bb4-b53f-6cf250f4d1d0</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision #:    1 (dynamic)</span><br><span class="line">Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super large_file</span><br><span class="line">Filesystem flags:         signed_directory_hash</span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         not clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS type:       Linux</span><br><span class="line">Inode count:              1024</span><br><span class="line">Block count:              1024</span><br><span class="line">Reserved block count:     51</span><br><span class="line">Free blocks:              973</span><br><span class="line">Free inodes:              1009</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         1024</span><br><span class="line">Inode blocks per group:   32</span><br><span class="line">Filesystem created:       Tue Jul 13 15:53:45 2021</span><br><span class="line">Last mount time:          n&#x2F;a</span><br><span class="line">Last write time:          Tue Jul 13 15:54:49 2021</span><br><span class="line">Mount count:              2</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Tue Jul 13 15:53:45 2021</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:               128</span><br><span class="line">Default directory hash:   half_md4</span><br><span class="line">Directory Hash Seed:      a894ce52-595d-4d99-aa0e-10289f427598</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Group 0: (Blocks 0-1023)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Block bitmap at 2 (+2)</span><br><span class="line">  Inode bitmap at 3 (+3)</span><br><span class="line">  Inode table at 4-35 (+4)</span><br><span class="line">  973 free blocks, 1009 free inodes, 2 directories</span><br><span class="line">  Free blocks: 42-50, 60-1023</span><br><span class="line">  Free inodes: 16-1024</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<h3 id="inode"><a href="#inode" class="headerlink" title="inode"></a>inode</h3><p>可以通过 <code>ls</code> 看到 <code>file</code>的 <code>inode</code> 号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LS(1)                                               User Commands                                               LS(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">       ls - list directory contents</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       ls [OPTION]... [FILE]...</span><br><span class="line">......</span><br><span class="line">       -i, --inode</span><br><span class="line">              print the index number of each file</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ali</span><br><span class="line">total 60</span><br><span class="line">     2 drwxr-xr-x 3 root root  4096 7月  13 15:58 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br><span class="line">    12 -rw-r--r-- 1 root root     0 7月  13 15:57 dmesg</span><br><span class="line">    13 -rw-r--r-- 1 root root 34001 7月  13 15:57 dmesg1</span><br><span class="line">    14 -rw-r--r-- 1 root root     0 7月  13 15:57 file</span><br><span class="line">    15 lrwxrwxrwx 1 root root    36 7月  13 15:58 file_link -&gt; &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file</span><br><span class="line">    11 drwx------ 2 root root 16384 7月  13 15:53 lost+found</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>dmesg</code> 的 <code>inode</code>号 是 12</p>
<h3 id="regular-file"><a href="#regular-file" class="headerlink" title="regular file"></a>regular file</h3><p>可以通过 debugfs 看到 <code>inode</code> 号为 12的 文件详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo debugfs -R &quot;stat &lt;12&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 12   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 2322689703    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 34178</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 1   Blockcount: 72</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ed4ae9 -- Tue Jul 13 16:12:25 2021</span><br><span class="line">atime: 0x60ed4753 -- Tue Jul 13 15:57:07 2021</span><br><span class="line">mtime: 0x60ed4ae9 -- Tue Jul 13 16:12:25 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0-8):42-50</span><br><span class="line">TOTAL: 9</span><br></pre></td></tr></table></figure>
<p>可以看到文件类型是 <code>regular</code>，权限是 <code>0644</code>，size 是 <code>34178</code>;<br>其中 BLOCKS 是 42-50 之间。</p>
<p>通过<code>dd</code> 工具 将 <code>block-42</code> 内容dump出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;42 count&#x3D;1 | xxd -b -l 32</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.6639e-05 s, 87.8 MB&#x2F;s</span><br><span class="line">00000000: 01011011 00100000 00100000 00100000 00100000 00110000  [    0</span><br><span class="line">00000006: 00101110 00110000 00110000 00110000 00110000 00110000  .00000</span><br><span class="line">0000000c: 00110000 01011101 00100000 01001100 01101001 01101110  0] Lin</span><br><span class="line">00000012: 01110101 01111000 00100000 01110110 01100101 01110010  ux ver</span><br><span class="line">00000018: 01110011 01101001 01101111 01101110 00100000 00110101  sion 5</span><br><span class="line">0000001e: 00101110 00110001                                      .1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cat dmesg | head -n 3</span><br><span class="line">[    0.000000] Linux version 5.14.0-rc1+ (ubuntu@ubuntu-HP-ProDesk-680-G4-MT) (gcc (Ubuntu 10.3.0-1ubuntu1) 10.3.0, GNU ld (GNU Binutils for Ubuntu) 2.36.1) #48 SMP Tue Jul 13 10:42:02 CST 2021</span><br><span class="line">[    0.000000] Command line: root&#x3D;&#x2F;dev&#x2F;sda5 console&#x3D;ttyS0 crashkernel&#x3D;256M systemd.unified_cgroup_hierarchy&#x3D;1</span><br><span class="line">[    0.000000] x86&#x2F;fpu: x87 FPU will use FXSAVE</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>
<p>可以看到 skip 42 个 block之后，dd 出来一个 block 内容就是 <code>dmesg</code> 文件的内容。</p>
<h3 id="directory"><a href="#directory" class="headerlink" title="directory"></a>directory</h3><p>在目录下创建 目录，并新建两个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo mkdir tmp</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo touch tmp&#x2F;filename_1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo touch tmp&#x2F;filename_2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -alhi</span><br><span class="line">total 104K</span><br><span class="line">     2 drwxr-xr-x 4 root root 4.0K 7月  13 16:53 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk  4.0K 7月  13 15:56 ..</span><br><span class="line">    12 -rw-r--r-- 1 root root  35K 7月  13 16:45 dmesg</span><br><span class="line">    13 -rw-r--r-- 1 root root  35K 7月  13 16:45 dmesg1</span><br><span class="line">    14 -rw-r--r-- 1 root root    6 7月  13 16:45 file</span><br><span class="line">    15 lrwxrwxrwx 1 root root   36 7月  13 16:46 file_link -&gt; &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file</span><br><span class="line">    11 drwx------ 2 root root  16K 7月  13 16:45 lost+found</span><br><span class="line">    16 drwxr-xr-x 2 root root 4.0K 7月  13 16:55 tmp</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>tmp</code> dir的 <code>inode</code>号 是 16，通过 debugfs 看到 <code>inode</code> 号为 16的 文件详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo debugfs -R &quot;stat &lt;16&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 16   Type: directory    Mode:  0755   Flags: 0x0</span><br><span class="line">Generation: 2149799966    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 4096</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 2   Blockcount: 8</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ed550e -- Tue Jul 13 16:55:42 2021</span><br><span class="line">atime: 0x60ed547e -- Tue Jul 13 16:53:18 2021</span><br><span class="line">mtime: 0x60ed550e -- Tue Jul 13 16:55:42 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0):61</span><br><span class="line">TOTAL: 1</span><br></pre></td></tr></table></figure>
<p>可以看到文件类型是 <code>directory</code>，权限是 <code>0755</code>，size 是 <code>4096</code>;<br>文件比较小，只包含一个 block，位于 block 61位置处。</p>
<p>通过<code>dd</code> 工具 将 <code>block-61</code> 内容dump出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;61 count&#x3D;1 | xxd -u  -l 150</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 7.5436e-05 s, 54.3 MB&#x2F;s</span><br><span class="line">00000000: 1000 0000 0C00 0102 2E00 0000 0200 0000  ................</span><br><span class="line">00000010: 0C00 0202 2E2E 0000 1100 0000 1400 0A01  ................</span><br><span class="line">00000020: 6669 6C65 6E61 6D65 5F31 0000 1200 0000  filename_1......</span><br><span class="line">00000030: D40F 0A01 6669 6C65 6E61 6D65 5F32 0000  ....filename_2..</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000090: 0000 0000 0000                           ......</span><br></pre></td></tr></table></figure>
<p><code>.</code> ascii 是 <code>2E</code><br><code>..</code> ascii 是 <code>2E2E</code><br><code>filename_1</code> ascii 是 <code>6669 6C65 6E61 6D65 5F31</code><br><code>filename_1</code> ascii 是 <code>6669 6C65 6E61 6D65 5F32</code></p>
<p>dir entry 的 <code>data block</code> 数据需要结合 <code>struct ext2_dir_entry_2</code> 来看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct ext2_dir_entry_2 &#123;</span><br><span class="line">	__le32	inode;			&#x2F;* Inode number *&#x2F;</span><br><span class="line">	__le16	rec_len;		&#x2F;* Directory entry length *&#x2F;</span><br><span class="line">	__u8	name_len;		&#x2F;* Name length *&#x2F;</span><br><span class="line">	__u8	file_type;</span><br><span class="line">	char	name[];			&#x2F;* File name, up to EXT2_NAME_LEN *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 filename 之前有 <code>8 bytes</code> file name的属性</p>
<p><code>filename_1</code> 对应的是 <code>1100 0000 1400 0A01</code>， inode是 <code>0x11</code>，即 <code>17</code>；rec_len是 <code>0x14</code>；<br>name_len 是 <code>0x0A</code>，即10 byte, file type是 1。</p>
<p><code>.</code> 对应的是 <code>1000 0000 0C00 0102</code>， inode是 <code>0x10</code>，即 <code>16</code>，与 tmp 的inode号一致；rec_len是 <code>0x0c</code>；<br>name_len 是 <code>0x01</code>，即1 byte, file type是 2。</p>
<p><code>..</code> 对应的是 <code>0200 0000 0C00 0202</code>， inode是 <code>0x02</code>，即 <code>2</code>，与 ext2_dir 的inode号一致；rec_len是 <code>0x0c</code>；<br>name_len 是 <code>0x02</code>，即1 byte, file type是 2。</p>
<p>每个filename结尾都自动加了 <code>\0\0</code></p>
<h4 id="directory-下目录文件太多怎么办"><a href="#directory-下目录文件太多怎么办" class="headerlink" title="directory 下目录文件太多怎么办"></a>directory 下目录文件太多怎么办</h4><p>通过上面 demo可以看出，dir的 <code>data block</code> 是存储的目录的 <code>inode</code> 和 <code>filename</code> 等信息，按照文件名字 10 byte,大概一个文件占用 20byte空间，而 <code>data block</code> 大小是 4096 byte，所以至少创建 200+ 文件才能使得 <code>dir inode</code> 的 <code>data block</code> 数量大于1；通过命令<code>for i in $(seq 1 250); do sudo touch filename_$i; done</code>自动创建 250 个文件</p>
<p>通过<code>debugfs</code> 查看此时<code>inode-16</code>的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo debugfs -R &quot;stat &lt;16&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 16   Type: directory    Mode:  0755   Flags: 0x0</span><br><span class="line">Generation: 2149799966    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 8192</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 2   Blockcount: 16</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ed7ae7 -- Tue Jul 13 19:37:11 2021</span><br><span class="line">atime: 0x60ed5917 -- Tue Jul 13 17:12:55 2021</span><br><span class="line">mtime: 0x60ed7ae7 -- Tue Jul 13 19:37:11 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0):61, (1):64</span><br><span class="line">TOTAL: 2</span><br></pre></td></tr></table></figure>
<p>由于此时<code>tmp</code> 目录下文件很多，导致此时一个 <code>data block</code> 无法存储所有目录项的<code>inode</code> 和 <code>filename</code> 信息等，扩展到了 两个 <code>data block</code>。</p>
<p>通过dd查看 <code>block-61</code>  尾部数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;61 count&#x3D;1 | xxd -u  -l 4096 | tail -n 10</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 3.5019e-05 s, 117 MB&#x2F;s</span><br><span class="line">00000f60: 6E61 6D65 5F31 3936 D600 0000 1400 0C01  name_196........</span><br><span class="line">00000f70: 6669 6C65 6E61 6D65 5F31 3937 D700 0000  filename_197....</span><br><span class="line">00000f80: 1400 0C01 6669 6C65 6E61 6D65 5F31 3938  ....filename_198</span><br><span class="line">00000f90: D800 0000 1400 0C01 6669 6C65 6E61 6D65  ........filename</span><br><span class="line">00000fa0: 5F31 3939 D900 0000 1400 0C01 6669 6C65  _199........file</span><br><span class="line">00000fb0: 6E61 6D65 5F32 3030 DA00 0000 1400 0C01  name_200........</span><br><span class="line">00000fc0: 6669 6C65 6E61 6D65 5F32 3031 DB00 0000  filename_201....</span><br><span class="line">00000fd0: 1400 0C01 6669 6C65 6E61 6D65 5F32 3032  ....filename_202</span><br><span class="line">00000fe0: DC00 0000 2000 0C01 6669 6C65 6E61 6D65  .... ...filename</span><br><span class="line">00000ff0: 5F32 3033 0000 0000 0000 0000 0000 0000  _203............</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<p>通过dd查看 <code>block-64</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;64 count&#x3D;1 | xxd -u  -l 150</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 3.4552e-05 s, 119 MB&#x2F;s</span><br><span class="line">00000000: DD00 0000 1400 0C01 6669 6C65 6E61 6D65  ........filename</span><br><span class="line">00000010: 5F32 3034 DE00 0000 1400 0C01 6669 6C65  _204........file</span><br><span class="line">00000020: 6E61 6D65 5F32 3035 DF00 0000 1400 0C01  name_205........</span><br><span class="line">00000030: 6669 6C65 6E61 6D65 5F32 3036 E000 0000  filename_206....</span><br><span class="line">00000040: 1400 0C01 6669 6C65 6E61 6D65 5F32 3037  ....filename_207</span><br><span class="line">00000050: E100 0000 1400 0C01 6669 6C65 6E61 6D65  ........filename</span><br><span class="line">00000060: 5F32 3038 E200 0000 1400 0C01 6669 6C65  _208........file</span><br><span class="line">00000070: 6E61 6D65 5F32 3039 E300 0000 1400 0C01  name_209........</span><br><span class="line">00000080: 6669 6C65 6E61 6D65 5F32 3130 E400 0000  filename_210....</span><br><span class="line">00000090: 1400 0C01 6669                           ....fi</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>
<p><code>data block-61</code> 和 <code>data block-64</code> 数据内容是正好相连的。</p>
<h3 id="link"><a href="#link" class="headerlink" title="link"></a>link</h3><p>link 在 linux上也分为两种<code>soft link</code> 和 <code>hard link</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ali</span><br><span class="line">total 120</span><br><span class="line">     2 drwxr-xr-x 5 root root  8192 7月  13 20:29 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br><span class="line">    14 -rw-r--r-- 2 root root     6 7月  13 16:45 file</span><br><span class="line">    15 lrwxrwxrwx 1 root root    36 7月  13 16:46 file_link -&gt; &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file</span><br><span class="line">    14 -rw-r--r-- 2 root root     6 7月  13 16:45 file_link_hard</span><br></pre></td></tr></table></figure>
<p><code>file</code> 是实际文件，inode号是 14<br><code>file_link</code> 是软链接，inode号是 15<br><code>file_link_hard</code> 是硬链接，inode号是 14</p>
<h4 id="soft-link"><a href="#soft-link" class="headerlink" title="soft link"></a>soft link</h4><p>通过<code>debugfs</code> 查看此时<code>file_link</code>的 inode，即<code>inode-15</code>的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Inode: 15   Type: symlink    Mode:  0777   Flags: 0x0</span><br><span class="line">Generation: 2149799965    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 36</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 1   Blockcount: 0</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ed52ce -- Tue Jul 13 16:46:06 2021</span><br><span class="line">atime: 0x60ed52d0 -- Tue Jul 13 16:46:08 2021</span><br><span class="line">mtime: 0x60ed52ce -- Tue Jul 13 16:46:06 2021</span><br><span class="line">Fast link dest: &quot;&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file&quot;</span><br></pre></td></tr></table></figure>
<p>可以看到文件类型是 <code>symlink</code>，权限是 <code>0777</code>，size 是 <code>36</code>，就是软链接地址字符的长度;<br>并不包含 <code>data block</code> 区域。</p>
<h4 id="hard-link"><a href="#hard-link" class="headerlink" title="hard link"></a>hard link</h4><p>通过<code>debugfs</code> 查看此时<code>file_link_hard</code>的 inode，即<code>inode-14</code>的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo debugfs -R &quot;stat &lt;14&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 14   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 2149799964    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 6</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 2   Blockcount: 8</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ed8722 -- Tue Jul 13 20:29:22 2021</span><br><span class="line">atime: 0x60ed52c6 -- Tue Jul 13 16:45:58 2021</span><br><span class="line">mtime: 0x60ed52c6 -- Tue Jul 13 16:45:58 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0):60</span><br><span class="line">TOTAL: 1</span><br></pre></td></tr></table></figure>
<p>和 file 的inode号一样，所以 hardlink 在删除源文件之后，仍然是存在的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -alhi</span><br><span class="line">total 120K</span><br><span class="line">     2 drwxr-xr-x 5 root root 8.0K 7月  13 20:43 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk  4.0K 7月  13 15:56 ..</span><br><span class="line">    12 -rw-r--r-- 1 root root  35K 7月  13 16:45 dmesg</span><br><span class="line">    13 -rw-r--r-- 1 root root  35K 7月  13 16:45 dmesg1</span><br><span class="line">    14 -rw-r--r-- 2 root root    6 7月  13 16:45 file</span><br><span class="line">    15 lrwxrwxrwx 1 root root   36 7月  13 16:46 file_link -&gt; &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file</span><br><span class="line">    14 -rw-r--r-- 2 root root    6 7月  13 16:45 file_link_hard</span><br><span class="line">    19 drwxr-xr-x 2 root root 4.0K 7月  13 17:41 file.txt</span><br><span class="line">    11 drwx------ 2 root root  16K 7月  13 16:45 lost+found</span><br><span class="line">    16 drwxr-xr-x 2 root root 8.0K 7月  13 19:37 tmp</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cat file</span><br><span class="line">suhui</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cat file_link_hard</span><br><span class="line">suhui</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo rm file</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cat file_link_hard</span><br><span class="line">suhui</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<h4 id="soft-link-与-hard-link-如何区分"><a href="#soft-link-与-hard-link-如何区分" class="headerlink" title="soft link 与 hard link 如何区分"></a>soft link 与 hard link 如何区分</h4><p>在 <code>.</code> 目录中 <code>hard link</code> 和 <code>soft link</code> 如何存储的？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ali</span><br><span class="line">total 24</span><br><span class="line">     2 drwxr-xr-x 3 root root  4096 7月  14 10:52 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br><span class="line">    12 -rw-r--r-- 1 root root     0 7月  14 10:51 1</span><br><span class="line">    13 -rw-r--r-- 1 root root     0 7月  14 10:51 2</span><br><span class="line">    14 -rw-r--r-- 2 root root     0 7月  14 10:51 file</span><br><span class="line">    15 lrwxrwxrwx 1 root root    36 7月  14 10:52 file_link -&gt; &#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;file</span><br><span class="line">    14 -rw-r--r-- 2 root root     0 7月  14 10:51 file_link_hard</span><br><span class="line">    11 drwx------ 2 root root 16384 7月  14 10:51 lost+found</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p>通过<code>debugfs</code> 看到 <code>inode-2</code> 的详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo debugfs -R &quot;stat &lt;2&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 2   Type: directory    Mode:  0755   Flags: 0x0</span><br><span class="line">Generation: 0    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 4096</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 3   Blockcount: 8</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ee516d -- Wed Jul 14 10:52:29 2021</span><br><span class="line">atime: 0x60ee5172 -- Wed Jul 14 10:52:34 2021</span><br><span class="line">mtime: 0x60ee516d -- Wed Jul 14 10:52:29 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0):36</span><br><span class="line">TOTAL: 1</span><br></pre></td></tr></table></figure>

<p>通过<code>dd</code> 工具 将 <code>data block-36</code> 内容dump出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;36 count&#x3D;1 | xxd -u  -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.8568e-05 s, 84.3 MB&#x2F;s</span><br><span class="line">00000000: 0200 0000 0C00 0102 2E00 0000 0200 0000  ................</span><br><span class="line">00000010: 0C00 0202 2E2E 0000 0B00 0000 1400 0A02  ................</span><br><span class="line">00000020: 6C6F 7374 2B66 6F75 6E64 0000 0C00 0000  lost+found......</span><br><span class="line">00000030: 0C00 0101 3100 0000 0D00 0000 0C00 0101  ....1...........</span><br><span class="line">00000040: 3200 0000 0E00 0000 0C00 0401 6669 6C65  2...........file</span><br><span class="line">00000050: 0E00 0000 1800 0E01 6669 6C65 5F6C 696E  ........file_lin</span><br><span class="line">00000060: 6B5F 6861 7264 0000 0F00 0000 980F 0907  k_hard..........</span><br><span class="line">00000070: 6669 6C65 5F6C 696E 6B00 0000 0000 0000  file_link.......</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p>可以看到 各个文件属性</p>
<ul>
<li><code>file</code>: <code>0E00 0000 0C00 0401</code></li>
<li><code>file_link_hard</code>: <code>0E00 0000 1800 0E01</code></li>
<li><code>file_link</code>: <code>0F00 0000 980F 0907</code></li>
</ul>
<p><code>file</code> 对应的是 <code>0E00 0000 0C00 0401</code>， inode是 <code>0x0E</code>，即 <code>14</code>，与 file 的inode号一致；rec_len是 <code>0x0c</code>；<br>name_len 是 <code>0x04</code>，即4 byte, file type是 1。</p>
<p><code>file_link_hard</code> 对应的是 <code>0E00 0000 1800 0E01</code>， inode是 <code>0x0E</code>，即 <code>14</code>，与 file_link_hard 的inode号一致；rec_len是 <code>0x18</code>；<br>name_len 是 <code>0x0E</code>，即14 byte, file type是 1。</p>
<p><code>file_link</code> 对应的是 <code>0F00 0000 980F 0907</code>， inode是 <code>0x0F</code>，即 <code>15</code>，与 file_link 的inode号一致；rec_len是 <code>0x980F</code>；<br>name_len 是 <code>0x09</code>，即9 byte, file type是 7。</p>
<h3 id="empty-dir-entry"><a href="#empty-dir-entry" class="headerlink" title="empty dir entry"></a>empty dir entry</h3><p>众所周知，linux 文件系统中，至少包含两个文件<code>.</code> 和 <code>..</code>。<br>所以<code>empty dir entry</code> 和普通 <code>dir entry</code> 没有什么区别。</p>
<h3 id="empty-file"><a href="#empty-file" class="headerlink" title="empty file"></a>empty file</h3><p><code>filename_1</code> 是一个空文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# cat filename_1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# ls -i filename_1</span><br><span class="line">17 filename_1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<p>通过<code>debugfs</code> 看到 <code>inode-17</code> 的详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo debugfs -R &quot;stat &lt;17&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 17   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 2853187968    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 0</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 1   Blockcount: 0</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ee5464 -- Wed Jul 14 11:05:08 2021</span><br><span class="line">atime: 0x60ee559d -- Wed Jul 14 11:10:21 2021</span><br><span class="line">mtime: 0x60ee5464 -- Wed Jul 14 11:05:08 2021</span><br><span class="line">BLOCKS:</span><br><span class="line"></span><br><span class="line">(END)</span><br></pre></td></tr></table></figure>
<p>可以看到 file type等，但是最后 BLOCKS是 空的，意味着 <code>inode-17</code> 对应的文件是没有 <code>data block</code> 的，没有数据块，也就是空文件。</p>
<h2 id="ext2-磁盘文件系统布局分析"><a href="#ext2-磁盘文件系统布局分析" class="headerlink" title="ext2 磁盘文件系统布局分析"></a>ext2 磁盘文件系统布局分析</h2><p>通过 <code>dumpe2fs</code> 可以看到系统 <code>inode-size</code> <code>Block-size</code> 等信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo dumpe2fs &#x2F;dev&#x2F;loop0 | grep size</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super large_file</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Inode size:               128</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<p>还可以看到 group 块组的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo dumpe2fs &#x2F;dev&#x2F;loop0 | tail -n 8</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Group 0: (Blocks 0-1023)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Block bitmap at 2 (+2)</span><br><span class="line">  Inode bitmap at 3 (+3)</span><br><span class="line">  Inode table at 4-35 (+4)</span><br><span class="line">  980 free blocks, 758 free inodes, 3 directories</span><br><span class="line">  Free blocks: 44-1023</span><br><span class="line">  Free inodes: 267-1024</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<p>可以将 ext2.img 分成 若干个<code>4k</code> 小块:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">             group description      inode bitmap</span><br><span class="line"></span><br><span class="line">+-----------+----------+-----------+------------+---------------------------------+----------+-----------+------------------------------+</span><br><span class="line">|           |          |           |            |                                 |          |           |                              |</span><br><span class="line">|           |          |           |            |                                 |          |           |                              |</span><br><span class="line">|           |          |           |            |                                 |          |           |                              |</span><br><span class="line">+-----------+----------+-----------+------------+---------------------------------+----------+-----------+------------------------------+</span><br><span class="line"></span><br><span class="line">  super block          block bitmap                  inode table&#x3D; (35 - 4 +1) * 4096 &#x3D; 131072</span><br><span class="line"></span><br><span class="line">                                                      131072 &#x2F; 128 &#x3D; 1024</span><br></pre></td></tr></table></figure>

<ul>
<li><code>block-0</code>: super block</li>
<li><code>block-1</code>: group description</li>
<li><code>block-2</code>: block bitmap</li>
<li><code>block-3</code>: inode bitmap</li>
<li><code>block-4&lt;--&gt;35</code>: inode table, inode-size = 128，这个 group中 有 32个 block 作为 inode-table，总size 是 32 * 4096 = 131072，inode 个数是 131072 / 128 = 1024</li>
<li><code>block-36&lt;--&gt;1023</code>: data block，是实际存储数据的block，<code>empty file</code> 没有 <code>data block</code></li>
</ul>
<h3 id="从-inode-到-data-block"><a href="#从-inode-到-data-block" class="headerlink" title="从 inode 到 data block"></a>从 inode 到 data block</h3><p>通过 <code>dumpe2fs</code> 可以看到系统 <code>inode-size</code> <code>Block-size</code> 等信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo dumpe2fs &#x2F;dev&#x2F;loop0 | tail -n 8</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Group 0: (Blocks 0-1023)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Block bitmap at 2 (+2)</span><br><span class="line">  Inode bitmap at 3 (+3)</span><br><span class="line">  Inode table at 4-35 (+4)</span><br><span class="line">  980 free blocks, 758 free inodes, 3 directories</span><br><span class="line">  Free blocks: 44-1023</span><br><span class="line">  Free inodes: 267-1024</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<p>可以看到从 <code>block-4</code> 开始是 <code>inode table</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ailtotal 32</span><br><span class="line">     2 drwxr-xr-x 4 root root  4096 7月  14 11:04 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br></pre></td></tr></table></figure>
<p><code>.</code> 的 inode号是 <code>2</code></p>
<p>inode-size 是 128，将 <code>block-4</code> 前 256 bytes dump出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;4 count&#x3D;1 | xxd -u  -l 256</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.924e-05 s, 83.2 MB&#x2F;s</span><br><span class="line">00000000: 0000 0000 0000 0000 3151 EE60 3151 EE60  ........1Q.&#96;1Q.&#96;</span><br><span class="line">00000010: 3151 EE60 0000 0000 0000 0000 0000 0000  1Q.&#96;............</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000080: ED41 0000 0010 0000 4F54 EE60 4E54 EE60  .A......OT.&#96;NT.&#96;</span><br><span class="line">00000090: 4E54 EE60 0000 0000 0000 0400 0800 0000  NT.&#96;............</span><br><span class="line">000000a0: 0000 0000 0000 0000 2400 0000 0000 0000  ........$.......</span><br><span class="line">000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p>在对 inode 磁盘结构不清楚的情况下，只知道 <code>inode-2</code> 对应的 <code>data block</code> 是 <code>36</code>，即<code>0x24</code></p>
<p><code>inode-2</code> 完整数据是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00000080: ED41 0000 0010 0000 4F54 EE60 4E54 EE60  .A......OT.&#96;NT.&#96;</span><br><span class="line">00000090: 4E54 EE60 0000 0000 0000 0400 0800 0000  NT.&#96;............</span><br><span class="line">000000a0: 0000 0000 0000 0000 2400 0000 0000 0000  ........$.......</span><br><span class="line">000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>

<p>结合 <code>struct ext2_inode</code> 来看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Structure of an inode on the disk</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct ext2_inode &#123;</span><br><span class="line">	__le16	i_mode;		&#x2F;* File mode *&#x2F;</span><br><span class="line">	__le16	i_uid;		&#x2F;* Low 16 bits of Owner Uid *&#x2F;</span><br><span class="line">	__le32	i_size;		&#x2F;* Size in bytes *&#x2F;</span><br><span class="line">	__le32	i_atime;	&#x2F;* Access time *&#x2F;</span><br><span class="line">	__le32	i_ctime;	&#x2F;* Creation time *&#x2F;</span><br><span class="line">	__le32	i_mtime;	&#x2F;* Modification time *&#x2F;</span><br><span class="line">	__le32	i_dtime;	&#x2F;* Deletion Time *&#x2F;</span><br><span class="line">	__le16	i_gid;		&#x2F;* Low 16 bits of Group Id *&#x2F;</span><br><span class="line">	__le16	i_links_count;	&#x2F;* Links count *&#x2F;</span><br><span class="line">	__le32	i_blocks;	&#x2F;* Blocks count *&#x2F;</span><br><span class="line">	__le32	i_flags;	&#x2F;* File flags *&#x2F;</span><br><span class="line">	union &#123;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__le32  l_i_reserved1;</span><br><span class="line">		&#125; linux1;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__le32  h_i_translator;</span><br><span class="line">		&#125; hurd1;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__le32  m_i_reserved1;</span><br><span class="line">		&#125; masix1;</span><br><span class="line">	&#125; osd1;				&#x2F;* OS dependent 1 *&#x2F;</span><br><span class="line">	__le32	i_block[EXT2_N_BLOCKS];&#x2F;* Pointers to blocks *&#x2F;</span><br><span class="line">	__le32	i_generation;	&#x2F;* File version (for NFS) *&#x2F;</span><br><span class="line">	__le32	i_file_acl;	&#x2F;* File ACL *&#x2F;</span><br><span class="line">	__le32	i_dir_acl;	&#x2F;* Directory ACL *&#x2F;</span><br><span class="line">	__le32	i_faddr;	&#x2F;* Fragment address *&#x2F;</span><br><span class="line">	union &#123;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__u8	l_i_frag;	&#x2F;* Fragment number *&#x2F;</span><br><span class="line">			__u8	l_i_fsize;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">			__u16	i_pad1;</span><br><span class="line">			__le16	l_i_uid_high;	&#x2F;* these 2 fields    *&#x2F;</span><br><span class="line">			__le16	l_i_gid_high;	&#x2F;* were reserved2[0] *&#x2F;</span><br><span class="line">			__u32	l_i_reserved2;</span><br><span class="line">		&#125; linux2;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__u8	h_i_frag;	&#x2F;* Fragment number *&#x2F;</span><br><span class="line">			__u8	h_i_fsize;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">			__le16	h_i_mode_high;</span><br><span class="line">			__le16	h_i_uid_high;</span><br><span class="line">			__le16	h_i_gid_high;</span><br><span class="line">			__le32	h_i_author;</span><br><span class="line">		&#125; hurd2;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__u8	m_i_frag;	&#x2F;* Fragment number *&#x2F;</span><br><span class="line">			__u8	m_i_fsize;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">			__u16	m_pad1;</span><br><span class="line">			__u32	m_i_reserved2[2];</span><br><span class="line">		&#125; masix2;</span><br><span class="line">	&#125; osd2;				&#x2F;* OS dependent 2 *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第41 byte 是 block pointers，即 <code>0x24(36)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__le32	i_block[EXT2_N_BLOCKS];&#x2F;* Pointers to blocks *&#x2F;</span><br></pre></td></tr></table></figure>

<p>第33 byte 是 block count，即 <code>0x8(8)</code> (按照 block-size == 512 计算)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__le32	i_blocks;	&#x2F;* Blocks count *&#x2F;</span><br></pre></td></tr></table></figure>
<p>和 <code>dir-&gt;i_blocks &gt;&gt; (PAGE_SHIFT - 9)</code> <code>dir-&gt;i_blocks &gt;&gt; (12 - 9)</code>计算 方式一致</p>
<p>第29 byte 是 links count，即 <code>0x4(4)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__le16	i_links_count;	&#x2F;* Links count *&#x2F;</span><br></pre></td></tr></table></figure>

<p>与 debugfs 结果一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo debugfs -R &quot;stat &lt;2&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 2   Type: directory    Mode:  0755   Flags: 0x0</span><br><span class="line">Generation: 0    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 4096</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 4   Blockcount: 8</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ee6d97 -- Wed Jul 14 12:52:39 2021</span><br><span class="line">atime: 0x60ee6e96 -- Wed Jul 14 12:56:54 2021</span><br><span class="line">mtime: 0x60ee6d97 -- Wed Jul 14 12:52:39 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0):36</span><br><span class="line">TOTAL: 1</span><br><span class="line"></span><br><span class="line">(END)</span><br></pre></td></tr></table></figure>

<h3 id="super-block"><a href="#super-block" class="headerlink" title="super block"></a>super block</h3><h3 id="Group-descriptors"><a href="#Group-descriptors" class="headerlink" title="Group descriptors"></a>Group descriptors</h3><p>GDT（Group Descriptor Table）组描述符表：<br>由多组描述符组成，整个分区分成多少个组就对应多少个组描述符。<br>每个组描述符（Group Descriptor）存储一个组的描述信息，例如这个组中从哪里是inode表、<br>哪里开始是数据块、空闲的inode和数据块还有多少等。</p>
<h3 id="Block-bitmap-与-Inode-bitmap"><a href="#Block-bitmap-与-Inode-bitmap" class="headerlink" title="Block bitmap 与 Inode bitmap"></a>Block bitmap 与 Inode bitmap</h3><p>重新格式化 ext2.img，之后mount<br>由于 都只有 1024 个 inode 和 block，所以只需要 <code>1024 / 8 = 128 byte</code> 即可<br>查看 <code>Block bitmap</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;2 count&#x3D;1 | xxd -u  -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 6.4301e-05 s, 63.7 MB&#x2F;s</span><br><span class="line">00000000: FFFF FFFF FF03 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>
<p>看到 <code>block(0-41)</code> 都已经被使用了</p>
<p>查看 <code>Inode bitmap</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;3 count&#x3D;1 | xxd -u  -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000236682 s, 17.3 MB&#x2F;s</span><br><span class="line">00000000: FF07 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>
<p>看到 <code>inode(1-11)</code> 都已经被使用了</p>
<p>此时 目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ali</span><br><span class="line">total 24</span><br><span class="line">     2 drwxr-xr-x 3 root root  4096 7月  14 14:50 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br><span class="line">    11 drwx------ 2 root root 16384 7月  14 14:50 lost+found</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<h4 id="创建空文件"><a href="#创建空文件" class="headerlink" title="创建空文件"></a>创建空文件</h4><p><code>sudo touch 1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ali</span><br><span class="line">total 24</span><br><span class="line">     2 drwxr-xr-x 3 root root  4096 7月  14 14:58 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br><span class="line">    12 -rw-r--r-- 1 root root     0 7月  14 14:58 1</span><br><span class="line">    11 drwx------ 2 root root 16384 7月  14 14:50 lost+found</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p>查看此时 <code>Indoe bitmap</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;3 count&#x3D;1 | xxd -u  -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.8758e-05 s, 84.0 MB&#x2F;s</span><br><span class="line">00000000: FF0F 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>
<p><code>bit-12</code> 已经 set为1了。</p>
<p>查看此时 <code>Block bitmap</code>，由于是空文件，<code>Block bitmap</code> 和之前保持一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;2 count&#x3D;1 | xxd -u  -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.8515e-05 s, 84.4 MB&#x2F;s</span><br><span class="line">00000000: FFFF FFFF FF03 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>


<h4 id="向空文件中写数据"><a href="#向空文件中写数据" class="headerlink" title="向空文件中写数据"></a>向空文件中写数据</h4><p>向文件<code>1</code> 写入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls</span><br><span class="line">1  lost+found</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;home&#x2F;rlk&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# dmesg &gt; 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# ls -ali</span><br><span class="line">total 64</span><br><span class="line">     2 drwxr-xr-x 3 root root  4096 7月  14 14:58 .</span><br><span class="line">791692 drwxrwxr-x 3 rlk  rlk   4096 7月  13 15:56 ..</span><br><span class="line">    12 -rw-r--r-- 1 root root 38922 7月  14 15:06 1</span><br><span class="line">    11 drwx------ 2 root root 16384 7月  14 14:50 lost+found</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>

<p>通过<code>debugfs</code> 看到 <code>inode-12</code> 的详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo debugfs -R &quot;stat &lt;12&gt;&quot; &#x2F;dev&#x2F;loop0</span><br><span class="line">debugfs 1.45.5 (07-Jan-2020)</span><br><span class="line">Inode: 12   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 1697274386    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 38922</span><br><span class="line">File ACL: 0</span><br><span class="line">Links: 1   Blockcount: 80</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x60ee8d09 -- Wed Jul 14 15:06:49 2021</span><br><span class="line">atime: 0x60ee8afb -- Wed Jul 14 14:58:03 2021</span><br><span class="line">mtime: 0x60ee8d09 -- Wed Jul 14 15:06:49 2021</span><br><span class="line">BLOCKS:</span><br><span class="line">(0-9):42-51</span><br><span class="line">TOTAL: 10</span><br><span class="line">(END)</span><br></pre></td></tr></table></figure>
<p>可以看出来，<code>inode-12</code> 占用了10个 <code>data block</code>, 从 <code>block-42</code> –&gt; <code>block-51</code>。</p>
<p>从 <code>Block bitmap</code> 数据看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# sudo dd if&#x3D;&#x2F;dev&#x2F;loop0 bs&#x3D;4096 skip&#x3D;2 count&#x3D;1 | xxd -u  -l 128</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 4.911e-05 s, 83.4 MB&#x2F;s</span><br><span class="line">00000000: FFFF FFFF FFFF 0F00 0000 0000 0000 0000  ................</span><br><span class="line">00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir#</span><br></pre></td></tr></table></figure>
<p>从 <code>FFFF FFFF FF03 0000</code> 到 <code>FFFF FFFF FFFF 0F00</code> 正好有 10 bit 数据被设置为了1。</p>
<p>这里可以看到 <code>Inode bitmap</code> 与 <code>Inode</code>, <code>Block bitmap</code> 与 <code>data block</code> 之间关系。<br>这里引申出两个问题：<br>1.为什么用df命令比du命令统计整个磁盘的已用空间非常快呢？<br>  因为df命令只需要查看每个块组的块位图即可，而不需要搜遍整个分区。<br>  相反，用du命令查看一个较大目录的已用空间就非常慢，因为不可避免地要搜遍整个目录的所有文件。<br>  df命令用于显示磁盘上的可使用的磁盘空间。du命令是对文件和目录磁盘使用的空间的查看。</p>
<ol start="2">
<li>在格式化一个分区时究竟会划出多少个块组呢？<br>  格式化一个分区有多少个块组，主要取决于分区大小和块的大小。<br>因为Block Bitmap占一个块，即4K字节，其有4K * 8bit，可以标注32K个块，<br>每个块的大小为4K，即标注区域为32K * 4K = 128MB，即一个块组Group的上限为128M。<br>若分区为32G，则ext2文件系统需要32 G / 128M = 256个块组。</li>
</ol>
<h3 id="small-file"><a href="#small-file" class="headerlink" title="small file"></a>small file</h3><p>常见的磁盘空间不够 是因为 单个文件数据过多，导致<code>data block</code> 区域被用完了，无法再分配 <code>data block</code> 区域。<br>还有一种是因为磁盘上存在着太多的小文件，导致 <code>inode</code> 被耗尽，而不能创建新文件的情况</p>
<p>先 dump 整个文件系统信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo dumpe2fs &#x2F;dev&#x2F;loop0  | tail -n 8</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Group 0: (Blocks 0-1023)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Block bitmap at 2 (+2)</span><br><span class="line">  Inode bitmap at 3 (+3)</span><br><span class="line">  Inode table at 4-35 (+4)</span><br><span class="line">  981 free blocks, 1012 free inodes, 2 directories</span><br><span class="line">  Free blocks: 43-1023</span><br><span class="line">  Free inodes: 13-1024</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs#</span><br></pre></td></tr></table></figure>

<p>可以知道还剩余 1012个 <code>inodes</code>，创建 1024个 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# mkdir tmp</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir# cd tmp</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# for i in $(seq 1 1024); do sudo touch filename_$i; done</span><br><span class="line">touch: cannot touch &#39;filename_1012&#39;: No space left on device</span><br><span class="line">touch: cannot touch &#39;filename_1013&#39;: No space left on device</span><br><span class="line">......</span><br><span class="line">touch: cannot touch &#39;filename_1023&#39;: No space left on device</span><br><span class="line">touch: cannot touch &#39;filename_1024&#39;: No space left on device</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>

<p>会发现最后面的几个文件都没法创建，显示 <code>No space left on device</code>，dump整个文件系统状态来看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp# sudo dumpe2fs &#x2F;dev&#x2F;loop0  | tail -n 8</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Group 0: (Blocks 0-1023)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Block bitmap at 2 (+2)</span><br><span class="line">  Inode bitmap at 3 (+3)</span><br><span class="line">  Inode table at 4-35 (+4)</span><br><span class="line">  976 free blocks, 0 free inodes, 3 directories</span><br><span class="line">  Free blocks: 48-1023</span><br><span class="line">  Free inodes:</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;tmp#</span><br></pre></td></tr></table></figure>
<p>会发现此时 <code>Free inodes</code> 已经是0了。</p>
<h2 id="big-image"><a href="#big-image" class="headerlink" title="big image"></a>big image</h2><p>之前ext2.img 只有4MB, 导致只有一个 group<br>重新dd 一个 ext2.img</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;ext2.img bs&#x3D;4k count&#x3D;102400</span><br><span class="line">102400+0 records in</span><br><span class="line">102400+0 records out</span><br><span class="line">419430400 bytes (419 MB, 400 MiB) copied, 0.890318 s, 471 MB&#x2F;s</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# mkfs.ext2 ext2.img</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Discarding device blocks: done</span><br><span class="line">Creating filesystem with 102400 4k blocks and 102400 inodes</span><br><span class="line">Filesystem UUID: 4529647b-d4f6-4110-bf12-27b6e6df472d</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">        32768, 98304</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br></pre></td></tr></table></figure>

<p>重新 mount 之后，dumpe2fs 看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs# sudo dumpe2fs &#x2F;dev&#x2F;loop0</span><br><span class="line">dumpe2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          4529647b-d4f6-4110-bf12-27b6e6df472d</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision #:    1 (dynamic)</span><br><span class="line">Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super large_file</span><br><span class="line">Filesystem flags:         signed_directory_hash</span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         not clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS type:       Linux</span><br><span class="line">Inode count:              102400</span><br><span class="line">Block count:              102400</span><br><span class="line">Reserved block count:     5120</span><br><span class="line">Free blocks:              99108</span><br><span class="line">Free inodes:              102389</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Reserved GDT blocks:      24</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         25600</span><br><span class="line">Inode blocks per group:   800</span><br><span class="line">Filesystem created:       Wed Jul 14 15:30:15 2021</span><br><span class="line">Last mount time:          n&#x2F;a</span><br><span class="line">Last write time:          Wed Jul 14 15:30:21 2021</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Wed Jul 14 15:30:15 2021</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:               128</span><br><span class="line">Default directory hash:   half_md4</span><br><span class="line">Directory Hash Seed:      12d83817-68c9-4e5c-a665-94e370a4eb80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Group 0: (Blocks 0-32767)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Reserved GDT blocks at 2-25</span><br><span class="line">  Block bitmap at 26 (+26)</span><br><span class="line">  Inode bitmap at 27 (+27)</span><br><span class="line">  Inode table at 28-827 (+28)</span><br><span class="line">  31934 free blocks, 25589 free inodes, 2 directories</span><br><span class="line">  Free blocks: 834-32767</span><br><span class="line">  Free inodes: 12-25600</span><br><span class="line">Group 1: (Blocks 32768-65535)</span><br><span class="line">  Backup superblock at 32768, Group descriptors at 32769-32769</span><br><span class="line">  Reserved GDT blocks at 32770-32793</span><br><span class="line">  Block bitmap at 32794 (+26)</span><br><span class="line">  Inode bitmap at 32795 (+27)</span><br><span class="line">  Inode table at 32796-33595 (+28)</span><br><span class="line">  31940 free blocks, 25600 free inodes, 0 directories</span><br><span class="line">  Free blocks: 33596-65535</span><br><span class="line">  Free inodes: 25601-51200</span><br><span class="line">Group 2: (Blocks 65536-98303)</span><br><span class="line">  Block bitmap at 65536 (+0)</span><br><span class="line">  Inode bitmap at 65537 (+1)</span><br><span class="line">  Inode table at 65538-66337 (+2)</span><br><span class="line">  31966 free blocks, 25600 free inodes, 0 directories</span><br><span class="line">  Free blocks: 66338-98303</span><br><span class="line">  Free inodes: 51201-76800</span><br><span class="line">Group 3: (Blocks 98304-102399)</span><br><span class="line">  Backup superblock at 98304, Group descriptors at 98305-98305</span><br><span class="line">  Reserved GDT blocks at 98306-98329</span><br><span class="line">  Block bitmap at 98330 (+26)</span><br><span class="line">  Inode bitmap at 98331 (+27)</span><br><span class="line">  Inode table at 98332-99131 (+28)</span><br><span class="line">  3268 free blocks, 25600 free inodes, 0 directories</span><br><span class="line">  Free blocks: 99132-102399</span><br><span class="line">  Free inodes: 76801-102400</span><br></pre></td></tr></table></figure>

<p>生成一个文件之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Group 0: (Blocks 0-32767)</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">  Reserved GDT blocks at 2-25</span><br><span class="line">  Block bitmap at 26 (+26)</span><br><span class="line">  Inode bitmap at 27 (+27)</span><br><span class="line">  Inode table at 28-827 (+28)</span><br><span class="line">  21694 free blocks, 25588 free inodes, 2 directories</span><br><span class="line">  Free blocks: 834-22527</span><br><span class="line">  Free inodes: 13-25600</span><br><span class="line">Group 1: (Blocks 32768-65535)</span><br><span class="line">  Backup superblock at 32768, Group descriptors at 32769-32769</span><br><span class="line">  Reserved GDT blocks at 32770-32793</span><br><span class="line">  Block bitmap at 32794 (+26)</span><br><span class="line">  Inode bitmap at 32795 (+27)</span><br><span class="line">  Inode table at 32796-33595 (+28)</span><br><span class="line">  10213 free blocks, 25600 free inodes, 0 directories</span><br><span class="line">  Free blocks: 33596-33599, 55327-65535</span><br><span class="line">  Free inodes: 25601-51200</span><br><span class="line">Group 2: (Blocks 65536-98303)</span><br><span class="line">  Block bitmap at 65536 (+0)</span><br><span class="line">  Inode bitmap at 65537 (+1)</span><br><span class="line">  Inode table at 65538-66337 (+2)</span><br><span class="line">  31966 free blocks, 25600 free inodes, 0 directories</span><br><span class="line">  Free blocks: 66338-98303</span><br><span class="line">  Free inodes: 51201-76800</span><br><span class="line">Group 3: (Blocks 98304-102399)</span><br><span class="line">  Backup superblock at 98304, Group descriptors at 98305-98305</span><br><span class="line">  Reserved GDT blocks at 98306-98329</span><br><span class="line">  Block bitmap at 98330 (+26)</span><br><span class="line">  Inode bitmap at 98331 (+27)</span><br><span class="line">  Inode table at 98332-99131 (+28)</span><br><span class="line">  3268 free blocks, 25600 free inodes, 0 directories</span><br><span class="line">  Free blocks: 99132-102399</span><br><span class="line">  Free inodes: 76801-102400</span><br></pre></td></tr></table></figure>















<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/XD_hebuters/article/details/79574902">Ext2文件系统布局及核心数据结构</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-12T11:00:40.000Z" title="7/12/2021, 7:00:40 PM">2021-07-12</time>发表</span><span class="level-item"><time dateTime="2021-07-12T08:32:09.972Z" title="7/12/2021, 4:32:09 PM">2021-07-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">6 分钟读完 (大约853个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/12/filesystem/file%20attr/">file attr</a></h1><div class="content"><h2 id="file-attributes-概念"><a href="#file-attributes-概念" class="headerlink" title="file attributes 概念"></a>file attributes 概念</h2><p>除了控制用户和组读取，写和执行权限的文件模式位之外，几个文件系统支持文件属性，<br>可以进一步自定义允许的文件操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apart from the file mode bits that control user and group read, write and execute permissions, several file systems support file attributes that enable further customization of allowable file operations. This section describes some of these attributes and how to work with them.</span><br></pre></td></tr></table></figure>

<p><code>cp</code> <code>rsync</code> 等操作不会保留 <code>file attributes</code>。<br>只有部分 filesystem 支持这样的属性，常见的 <code>ext2</code> <code>ext3</code> <code>ext4</code> 都是支持的。</p>
<h2 id="file-attributes-FLAG"><a href="#file-attributes-FLAG" class="headerlink" title="file attributes FLAG"></a>file attributes FLAG</h2><p><code>include/uapi/linux/fs.h</code> 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Inode flags (FS_IOC_GETFLAGS &#x2F; FS_IOC_SETFLAGS)</span><br><span class="line"> *</span><br><span class="line"> * Note: for historical reasons, these flags were originally used and</span><br><span class="line"> * defined for use by ext2&#x2F;ext3, and then other file systems started</span><br><span class="line"> * using these flags so they wouldn&#39;t need to write their own version</span><br><span class="line"> * of chattr&#x2F;lsattr (which was shipped as part of e2fsprogs).  You</span><br><span class="line"> * should think twice before trying to use these flags in new</span><br><span class="line"> * contexts, or trying to assign these flags, since they are used both</span><br><span class="line"> * as the UAPI and the on-disk encoding for ext2&#x2F;3&#x2F;4.  Also, we are</span><br><span class="line"> * almost out of 32-bit flags.  :-)</span><br><span class="line"> *</span><br><span class="line"> * We have recently hoisted FS_IOC_FSGETXATTR &#x2F; FS_IOC_FSSETXATTR from</span><br><span class="line"> * XFS to the generic FS level interface.  This uses a structure that</span><br><span class="line"> * has padding and hence has more room to grow, so it may be more</span><br><span class="line"> * appropriate for many new use cases.</span><br><span class="line"> *</span><br><span class="line"> * Please do not change these flags or interfaces before checking with</span><br><span class="line"> * linux-fsdevel@vger.kernel.org and linux-api@vger.kernel.org.</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define	FS_SECRM_FL			0x00000001 &#x2F;* Secure deletion *&#x2F;</span><br><span class="line">#define	FS_UNRM_FL			0x00000002 &#x2F;* Undelete *&#x2F;</span><br><span class="line">#define	FS_COMPR_FL			0x00000004 &#x2F;* Compress file *&#x2F;</span><br><span class="line">#define FS_SYNC_FL			0x00000008 &#x2F;* Synchronous updates *&#x2F;</span><br><span class="line">#define FS_IMMUTABLE_FL			0x00000010 &#x2F;* Immutable file *&#x2F;</span><br><span class="line">#define FS_APPEND_FL			0x00000020 &#x2F;* writes to file may only append *&#x2F;</span><br><span class="line">#define FS_NODUMP_FL			0x00000040 &#x2F;* do not dump file *&#x2F;</span><br><span class="line">#define FS_NOATIME_FL			0x00000080 &#x2F;* do not update atime *&#x2F;</span><br></pre></td></tr></table></figure>

<p>这些 FLAG get set 都是通过 ioctl(FS_IOC_FSGETXATTR / FS_IOC_FSSETXATTR) 命令来实现的。</p>
<p>可以通过<code>chattr</code>的 如下命令修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">a  -- append only</span><br><span class="line">A  -- no atime updates</span><br><span class="line">c  -- compressed</span><br><span class="line">C  -- no copy on write</span><br><span class="line">d  -- no dump</span><br><span class="line">D  -- no synchronous directory updates</span><br><span class="line">e  -- extent format</span><br><span class="line">i  -- immutable</span><br><span class="line">j  -- data journalling</span><br><span class="line">P  -- project hierarchy</span><br><span class="line">s  -- secure deletion</span><br><span class="line">S  -- synchronous updates</span><br><span class="line">t  -- no tail-merging</span><br><span class="line">T  -- top of directory hierarchy</span><br><span class="line">u  -- undeletable</span><br></pre></td></tr></table></figure>


<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p><code>i</code> 属性就是 <code>immutable</code>，意思是不可变的。</p>
<h3 id="immutable-不可变属性"><a href="#immutable-不可变属性" class="headerlink" title="immutable 不可变属性"></a>immutable 不可变属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# touch 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# touch 2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# lsattr</span><br><span class="line">-------------------- .&#x2F;1</span><br><span class="line">-------------------- .&#x2F;2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# chattr +i 1</span><br><span class="line">chattr: Operation not permitted while setting flags on 1</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# sudo chattr +i 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# lsattr</span><br><span class="line">----i--------------- .&#x2F;1</span><br><span class="line">-------------------- .&#x2F;2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# rm 1</span><br><span class="line">rm: cannot remove &#39;1&#39;: Operation not permitted</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# rm 2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# ls</span><br><span class="line">1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# sudo rm 1</span><br><span class="line">rm: cannot remove &#39;1&#39;: Operation not permitted</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# chattr -i 1</span><br><span class="line">chattr: Operation not permitted while setting flags on 1</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# sudo chattr -i 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# rm 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# ls</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123#</span><br></pre></td></tr></table></figure>

<h3 id="file-attributes-cp-时保留吗？"><a href="#file-attributes-cp-时保留吗？" class="headerlink" title="file attributes cp 时保留吗？"></a>file attributes cp 时保留吗？</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# touch 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# lsattr</span><br><span class="line">-------------------- .&#x2F;1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# sudo chattr +i 1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# lsattr</span><br><span class="line">----i--------------- .&#x2F;1</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# cp 1 2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# lsattr</span><br><span class="line">----i--------------- .&#x2F;1</span><br><span class="line">-------------------- .&#x2F;2</span><br><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# mv 1 11</span><br><span class="line">mv: cannot move &#39;1&#39; to &#39;11&#39;: Operation not permitted</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# sudo mv 1 11</span><br><span class="line">mv: cannot move &#39;1&#39; to &#39;11&#39;: Operation not permitted</span><br><span class="line">stable_kernel@1kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123#</span><br></pre></td></tr></table></figure>

<p>可以看到在 执行 <code>cp</code> 命令时， file attributes 是不保留的。</p>
<h2 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h2><p><code>chattr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# sudo strace chattr +i 1</span><br><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;chattr&quot;, [&quot;chattr&quot;, &quot;+i&quot;, &quot;1&quot;], 0x7fffa9701fd0 &#x2F;* 22 vars *&#x2F;) &#x3D; 0</span><br><span class="line">......</span><br><span class="line">openat(AT_FDCWD, &quot;1&quot;, O_RDONLY|O_NONBLOCK) &#x3D; 3</span><br><span class="line">ioctl(3, FS_IOC_GETFLAGS, 0x7ffe9578ee3c) &#x3D; 0</span><br><span class="line">close(3)                                &#x3D; 0</span><br><span class="line">lstat(&quot;1&quot;, &#123;st_mode&#x3D;S_IFREG|0664, st_size&#x3D;0, ...&#125;) &#x3D; 0</span><br><span class="line">openat(AT_FDCWD, &quot;1&quot;, O_RDONLY|O_NONBLOCK) &#x3D; 3</span><br><span class="line">ioctl(3, FS_IOC_SETFLAGS, 0x7ffe9578ee3c) &#x3D; 0</span><br><span class="line">close(3)                                &#x3D; 0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>


<p><code>lsattr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~&#x2F;workspace&#x2F;fs&#x2F;ext2_dir&#x2F;123# strace lsattr</span><br><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;lsattr&quot;, [&quot;lsattr&quot;], 0x7ffca62b1850 &#x2F;* 37 vars *&#x2F;) &#x3D; 0</span><br><span class="line">openat(AT_FDCWD, &quot;.&#x2F;2&quot;, O_RDONLY|O_NONBLOCK) &#x3D; 4</span><br><span class="line">ioctl(4, FS_IOC_GETFLAGS, 0x7ffc5889dbac) &#x3D; 0</span><br><span class="line">close(4)                                &#x3D; 0</span><br><span class="line">write(1, &quot;-------------------- .&#x2F;2\n&quot;, 25-------------------- .&#x2F;2</span><br><span class="line">) &#x3D; 25</span><br><span class="line">getdents64(3, &#x2F;* 0 entries *&#x2F;, 32768)   &#x3D; 0</span><br><span class="line">close(3)                                &#x3D; 0</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-12T11:00:40.000Z" title="7/12/2021, 7:00:40 PM">2021-07-12</time>发表</span><span class="level-item"><time dateTime="2021-07-13T03:29:56.952Z" title="7/13/2021, 11:29:56 AM">2021-07-13</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">12 分钟读完 (大约1759个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/12/filesystem/ext2/ext2%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">ext2 数据结构</a></h1><div class="content"><h2 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h2><p>对于文件系统 struct，首先要区分好 他们在 磁盘上，还是在 memory中。</p>
<h3 id="磁盘上-ext2-inode-相关结构"><a href="#磁盘上-ext2-inode-相关结构" class="headerlink" title="磁盘上 ext2 inode 相关结构"></a>磁盘上 ext2 inode 相关结构</h3><p><code>ext2_inode</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">struct ext2_inode &#123;</span><br><span class="line">	__le16	i_mode;		&#x2F;* File mode *&#x2F;</span><br><span class="line">	__le16	i_uid;		&#x2F;* Low 16 bits of Owner Uid *&#x2F;</span><br><span class="line">	__le32	i_size;		&#x2F;* Size in bytes *&#x2F;</span><br><span class="line">	__le32	i_atime;	&#x2F;* Access time *&#x2F;</span><br><span class="line">	__le32	i_ctime;	&#x2F;* Creation time *&#x2F;</span><br><span class="line">	__le32	i_mtime;	&#x2F;* Modification time *&#x2F;</span><br><span class="line">	__le32	i_dtime;	&#x2F;* Deletion Time *&#x2F;</span><br><span class="line">	__le16	i_gid;		&#x2F;* Low 16 bits of Group Id *&#x2F;</span><br><span class="line">	__le16	i_links_count;	&#x2F;* Links count *&#x2F;</span><br><span class="line">	__le32	i_blocks;	&#x2F;* Blocks count *&#x2F;</span><br><span class="line">	__le32	i_flags;	&#x2F;* File flags *&#x2F;</span><br><span class="line">	union &#123;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__le32  l_i_reserved1;</span><br><span class="line">		&#125; linux1;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__le32  h_i_translator;</span><br><span class="line">		&#125; hurd1;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__le32  m_i_reserved1;</span><br><span class="line">		&#125; masix1;</span><br><span class="line">	&#125; osd1;				&#x2F;* OS dependent 1 *&#x2F;</span><br><span class="line">	__le32	i_block[EXT2_N_BLOCKS];&#x2F;* Pointers to blocks *&#x2F;</span><br><span class="line">	__le32	i_generation;	&#x2F;* File version (for NFS) *&#x2F;</span><br><span class="line">	__le32	i_file_acl;	&#x2F;* File ACL *&#x2F;</span><br><span class="line">	__le32	i_dir_acl;	&#x2F;* Directory ACL *&#x2F;</span><br><span class="line">	__le32	i_faddr;	&#x2F;* Fragment address *&#x2F;</span><br><span class="line">	union &#123;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__u8	l_i_frag;	&#x2F;* Fragment number *&#x2F;</span><br><span class="line">			__u8	l_i_fsize;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">			__u16	i_pad1;</span><br><span class="line">			__le16	l_i_uid_high;	&#x2F;* these 2 fields    *&#x2F;</span><br><span class="line">			__le16	l_i_gid_high;	&#x2F;* were reserved2[0] *&#x2F;</span><br><span class="line">			__u32	l_i_reserved2;</span><br><span class="line">		&#125; linux2;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__u8	h_i_frag;	&#x2F;* Fragment number *&#x2F;</span><br><span class="line">			__u8	h_i_fsize;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">			__le16	h_i_mode_high;</span><br><span class="line">			__le16	h_i_uid_high;</span><br><span class="line">			__le16	h_i_gid_high;</span><br><span class="line">			__le32	h_i_author;</span><br><span class="line">		&#125; hurd2;</span><br><span class="line">		struct &#123;</span><br><span class="line">			__u8	m_i_frag;	&#x2F;* Fragment number *&#x2F;</span><br><span class="line">			__u8	m_i_fsize;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">			__u16	m_pad1;</span><br><span class="line">			__u32	m_i_reserved2[2];</span><br><span class="line">		&#125; masix2;</span><br><span class="line">	&#125; osd2;				&#x2F;* OS dependent 2 *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="磁盘上-ext2-super-block-相关结构"><a href="#磁盘上-ext2-super-block-相关结构" class="headerlink" title="磁盘上 ext2 super_block 相关结构"></a>磁盘上 ext2 super_block 相关结构</h3><p><code>ext2_super_block</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">struct ext2_super_block &#123;</span><br><span class="line">	__le32	s_inodes_count;		&#x2F;* Inodes count *&#x2F;</span><br><span class="line">	__le32	s_blocks_count;		&#x2F;* Blocks count *&#x2F;</span><br><span class="line">	__le32	s_r_blocks_count;	&#x2F;* Reserved blocks count *&#x2F;</span><br><span class="line">	__le32	s_free_blocks_count;	&#x2F;* Free blocks count *&#x2F;</span><br><span class="line">	__le32	s_free_inodes_count;	&#x2F;* Free inodes count *&#x2F;</span><br><span class="line">	__le32	s_first_data_block;	&#x2F;* First Data Block *&#x2F;</span><br><span class="line">	__le32	s_log_block_size;	&#x2F;* Block size *&#x2F;</span><br><span class="line">	__le32	s_log_frag_size;	&#x2F;* Fragment size *&#x2F;</span><br><span class="line">	__le32	s_blocks_per_group;	&#x2F;* # Blocks per group *&#x2F;</span><br><span class="line">	__le32	s_frags_per_group;	&#x2F;* # Fragments per group *&#x2F;</span><br><span class="line">	__le32	s_inodes_per_group;	&#x2F;* # Inodes per group *&#x2F;</span><br><span class="line">	__le32	s_mtime;		&#x2F;* Mount time *&#x2F;</span><br><span class="line">	__le32	s_wtime;		&#x2F;* Write time *&#x2F;</span><br><span class="line">	__le16	s_mnt_count;		&#x2F;* Mount count *&#x2F;</span><br><span class="line">	__le16	s_max_mnt_count;	&#x2F;* Maximal mount count *&#x2F;</span><br><span class="line">	__le16	s_magic;		&#x2F;* Magic signature *&#x2F;</span><br><span class="line">	__le16	s_state;		&#x2F;* File system state *&#x2F;</span><br><span class="line">	__le16	s_errors;		&#x2F;* Behaviour when detecting errors *&#x2F;</span><br><span class="line">	__le16	s_minor_rev_level; 	&#x2F;* minor revision level *&#x2F;</span><br><span class="line">	__le32	s_lastcheck;		&#x2F;* time of last check *&#x2F;</span><br><span class="line">	__le32	s_checkinterval;	&#x2F;* max. time between checks *&#x2F;</span><br><span class="line">	__le32	s_creator_os;		&#x2F;* OS *&#x2F;</span><br><span class="line">	__le32	s_rev_level;		&#x2F;* Revision level *&#x2F;</span><br><span class="line">	__le16	s_def_resuid;		&#x2F;* Default uid for reserved blocks *&#x2F;</span><br><span class="line">	__le16	s_def_resgid;		&#x2F;* Default gid for reserved blocks *&#x2F;</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * These fields are for EXT2_DYNAMIC_REV superblocks only.</span><br><span class="line">	 *</span><br><span class="line">	 * Note: the difference between the compatible feature set and</span><br><span class="line">	 * the incompatible feature set is that if there is a bit set</span><br><span class="line">	 * in the incompatible feature set that the kernel doesn&#39;t</span><br><span class="line">	 * know about, it should refuse to mount the filesystem.</span><br><span class="line">	 *</span><br><span class="line">	 * e2fsck&#39;s requirements are more strict; if it doesn&#39;t know</span><br><span class="line">	 * about a feature in either the compatible or incompatible</span><br><span class="line">	 * feature set, it must abort and not try to meddle with</span><br><span class="line">	 * things it doesn&#39;t understand...</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	__le32	s_first_ino; 		&#x2F;* First non-reserved inode *&#x2F;</span><br><span class="line">	__le16   s_inode_size; 		&#x2F;* size of inode structure *&#x2F;</span><br><span class="line">	__le16	s_block_group_nr; 	&#x2F;* block group # of this superblock *&#x2F;</span><br><span class="line">	__le32	s_feature_compat; 	&#x2F;* compatible feature set *&#x2F;</span><br><span class="line">	__le32	s_feature_incompat; 	&#x2F;* incompatible feature set *&#x2F;</span><br><span class="line">	__le32	s_feature_ro_compat; 	&#x2F;* readonly-compatible feature set *&#x2F;</span><br><span class="line">	__u8	s_uuid[16];		&#x2F;* 128-bit uuid for volume *&#x2F;</span><br><span class="line">	char	s_volume_name[16]; 	&#x2F;* volume name *&#x2F;</span><br><span class="line">	char	s_last_mounted[64]; 	&#x2F;* directory where last mounted *&#x2F;</span><br><span class="line">	__le32	s_algorithm_usage_bitmap; &#x2F;* For compression *&#x2F;</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Performance hints.  Directory preallocation should only</span><br><span class="line">	 * happen if the EXT2_COMPAT_PREALLOC flag is on.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	__u8	s_prealloc_blocks;	&#x2F;* Nr of blocks to try to preallocate*&#x2F;</span><br><span class="line">	__u8	s_prealloc_dir_blocks;	&#x2F;* Nr to preallocate for dirs *&#x2F;</span><br><span class="line">	__u16	s_padding1;</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Journaling support valid if EXT3_FEATURE_COMPAT_HAS_JOURNAL set.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	__u8	s_journal_uuid[16];	&#x2F;* uuid of journal superblock *&#x2F;</span><br><span class="line">	__u32	s_journal_inum;		&#x2F;* inode number of journal file *&#x2F;</span><br><span class="line">	__u32	s_journal_dev;		&#x2F;* device number of journal file *&#x2F;</span><br><span class="line">	__u32	s_last_orphan;		&#x2F;* start of list of inodes to delete *&#x2F;</span><br><span class="line">	__u32	s_hash_seed[4];		&#x2F;* HTREE hash seed *&#x2F;</span><br><span class="line">	__u8	s_def_hash_version;	&#x2F;* Default hash version to use *&#x2F;</span><br><span class="line">	__u8	s_reserved_char_pad;</span><br><span class="line">	__u16	s_reserved_word_pad;</span><br><span class="line">	__le32	s_default_mount_opts;</span><br><span class="line"> 	__le32	s_first_meta_bg; 	&#x2F;* First metablock block group *&#x2F;</span><br><span class="line">	__u32	s_reserved[190];	&#x2F;* Padding to the end of the block *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="磁盘上-ext2-dir-entry-相关结构"><a href="#磁盘上-ext2-dir-entry-相关结构" class="headerlink" title="磁盘上 ext2 dir_entry 相关结构"></a>磁盘上 ext2 dir_entry 相关结构</h3><p><code>ext2_dir_entry</code> <code>ext2_dir_entry_2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">struct ext2_dir_entry &#123;</span><br><span class="line">	__le32	inode;			&#x2F;* Inode number *&#x2F;</span><br><span class="line">	__le16	rec_len;		&#x2F;* Directory entry length *&#x2F;</span><br><span class="line">	__le16	name_len;		&#x2F;* Name length *&#x2F;</span><br><span class="line">	char	name[];			&#x2F;* File name, up to EXT2_NAME_LEN *&#x2F;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * The new version of the directory entry.  Since EXT2 structures are</span><br><span class="line"> * stored in intel byte order, and the name_len field could never be</span><br><span class="line"> * bigger than 255 chars, it&#39;s safe to reclaim the extra byte for the</span><br><span class="line"> * file_type field.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct ext2_dir_entry_2 &#123;</span><br><span class="line">	__le32	inode;			&#x2F;* Inode number *&#x2F;</span><br><span class="line">	__le16	rec_len;		&#x2F;* Directory entry length *&#x2F;</span><br><span class="line">	__u8	name_len;		&#x2F;* Name length *&#x2F;</span><br><span class="line">	__u8	file_type;</span><br><span class="line">	char	name[];			&#x2F;* File name, up to EXT2_NAME_LEN *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="memory中-ext2-inode-data-相关结构"><a href="#memory中-ext2-inode-data-相关结构" class="headerlink" title="memory中 ext2 inode data 相关结构"></a>memory中 ext2 inode data 相关结构</h3><p><code>ext2_inode_info</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">struct ext2_inode_info &#123;</span><br><span class="line">	__le32	i_data[15];</span><br><span class="line">	__u32	i_flags;</span><br><span class="line">	__u32	i_faddr;</span><br><span class="line">	__u8	i_frag_no;</span><br><span class="line">	__u8	i_frag_size;</span><br><span class="line">	__u16	i_state;</span><br><span class="line">	__u32	i_file_acl;</span><br><span class="line">	__u32	i_dir_acl;</span><br><span class="line">	__u32	i_dtime;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * i_block_group is the number of the block group which contains</span><br><span class="line">	 * this file&#39;s inode.  Constant across the lifetime of the inode,</span><br><span class="line">	 * it is used for making block allocation decisions - we try to</span><br><span class="line">	 * place a file&#39;s data blocks near its inode block, and new inodes</span><br><span class="line">	 * near to their parent directory&#39;s inode.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	__u32	i_block_group;</span><br><span class="line"></span><br><span class="line">	&#x2F;* block reservation info *&#x2F;</span><br><span class="line">	struct ext2_block_alloc_info *i_block_alloc_info;</span><br><span class="line"></span><br><span class="line">	__u32	i_dir_start_lookup;</span><br><span class="line">#ifdef CONFIG_EXT2_FS_XATTR</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Extended attributes can be read independently of the main file</span><br><span class="line">	 * data. Taking i_mutex even when reading would cause contention</span><br><span class="line">	 * between readers of EAs and writers of regular file data, so</span><br><span class="line">	 * instead we synchronize on xattr_sem when reading or changing</span><br><span class="line">	 * EAs.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	struct rw_semaphore xattr_sem;</span><br><span class="line">#endif</span><br><span class="line">	rwlock_t i_meta_lock;</span><br><span class="line">#ifdef CONFIG_FS_DAX</span><br><span class="line">	struct rw_semaphore dax_sem;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * truncate_mutex is for serialising ext2_truncate() against</span><br><span class="line">	 * ext2_getblock().  It also protects the internals of the inode&#39;s</span><br><span class="line">	 * reservation data structures: ext2_reserve_window and</span><br><span class="line">	 * ext2_reserve_window_node.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	struct mutex truncate_mutex;</span><br><span class="line">	struct inode	vfs_inode;</span><br><span class="line">	struct list_head i_orphan;	&#x2F;* unlinked but open inodes *&#x2F;</span><br><span class="line">#ifdef CONFIG_QUOTA</span><br><span class="line">	struct dquot *i_dquot[MAXQUOTAS];</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="struct-ops"><a href="#struct-ops" class="headerlink" title="struct ops"></a>struct ops</h2><h3 id="super-block-相关"><a href="#super-block-相关" class="headerlink" title="super block 相关"></a>super block 相关</h3><p>ext2的 <code>super_operations</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static const struct super_operations ext2_sops &#x3D; &#123;</span><br><span class="line">	.alloc_inode	&#x3D; ext2_alloc_inode,</span><br><span class="line">	.free_inode	&#x3D; ext2_free_in_core_inode,</span><br><span class="line">	.write_inode	&#x3D; ext2_write_inode,</span><br><span class="line">	.evict_inode	&#x3D; ext2_evict_inode,</span><br><span class="line">	.put_super	&#x3D; ext2_put_super,</span><br><span class="line">	.sync_fs	&#x3D; ext2_sync_fs,</span><br><span class="line">	.freeze_fs	&#x3D; ext2_freeze,</span><br><span class="line">	.unfreeze_fs	&#x3D; ext2_unfreeze,</span><br><span class="line">	.statfs		&#x3D; ext2_statfs,</span><br><span class="line">	.remount_fs	&#x3D; ext2_remount,</span><br><span class="line">	.show_options	&#x3D; ext2_show_options,</span><br><span class="line">#ifdef CONFIG_QUOTA</span><br><span class="line">	.quota_read	&#x3D; ext2_quota_read,</span><br><span class="line">	.quota_write	&#x3D; ext2_quota_write,</span><br><span class="line">	.get_dquots	&#x3D; ext2_get_dquots,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="nfsd-相关"><a href="#nfsd-相关" class="headerlink" title="nfsd 相关"></a>nfsd 相关</h3><p>for nfsd to communicate with file systems</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static const struct export_operations ext2_export_ops &#x3D; &#123;</span><br><span class="line">	.fh_to_dentry &#x3D; ext2_fh_to_dentry,</span><br><span class="line">	.fh_to_parent &#x3D; ext2_fh_to_parent,</span><br><span class="line">	.get_parent &#x3D; ext2_get_parent,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="quotactl-ops-相关"><a href="#quotactl-ops-相关" class="headerlink" title="quotactl_ops 相关"></a>quotactl_ops 相关</h3><p><code>Operations handling requests from userspace</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static const struct quotactl_ops ext2_quotactl_ops &#x3D; &#123;</span><br><span class="line">	.quota_on	&#x3D; ext2_quota_on,</span><br><span class="line">	.quota_off	&#x3D; ext2_quota_off,</span><br><span class="line">	.quota_sync	&#x3D; dquot_quota_sync,</span><br><span class="line">	.get_state	&#x3D; dquot_get_state,</span><br><span class="line">	.set_info	&#x3D; dquot_set_dqinfo,</span><br><span class="line">	.get_dqblk	&#x3D; dquot_get_dqblk,</span><br><span class="line">	.set_dqblk	&#x3D; dquot_set_dqblk,</span><br><span class="line">	.get_nextdqblk	&#x3D; dquot_get_next_dqblk,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="inode-属性相关"><a href="#inode-属性相关" class="headerlink" title="inode 属性相关"></a>inode 属性相关</h3><p><code>file</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const struct inode_operations ext2_file_inode_operations &#x3D; &#123;</span><br><span class="line">	.listxattr	&#x3D; ext2_listxattr,</span><br><span class="line">	.getattr	&#x3D; ext2_getattr,</span><br><span class="line">	.setattr	&#x3D; ext2_setattr,</span><br><span class="line">	.get_acl	&#x3D; ext2_get_acl,</span><br><span class="line">	.set_acl	&#x3D; ext2_set_acl,</span><br><span class="line">	.fiemap		&#x3D; ext2_fiemap,</span><br><span class="line">	.fileattr_get	&#x3D; ext2_fileattr_get,</span><br><span class="line">	.fileattr_set	&#x3D; ext2_fileattr_set,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>dir</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const struct inode_operations ext2_dir_inode_operations &#x3D; &#123;</span><br><span class="line">	.create		&#x3D; ext2_create,</span><br><span class="line">	.lookup		&#x3D; ext2_lookup,</span><br><span class="line">	.link		&#x3D; ext2_link,</span><br><span class="line">	.unlink		&#x3D; ext2_unlink,</span><br><span class="line">	.symlink	&#x3D; ext2_symlink,</span><br><span class="line">	.mkdir		&#x3D; ext2_mkdir,</span><br><span class="line">	.rmdir		&#x3D; ext2_rmdir,</span><br><span class="line">	.mknod		&#x3D; ext2_mknod,</span><br><span class="line">	.rename		&#x3D; ext2_rename,</span><br><span class="line">	.listxattr	&#x3D; ext2_listxattr,</span><br><span class="line">	.getattr	&#x3D; ext2_getattr,</span><br><span class="line">	.setattr	&#x3D; ext2_setattr,</span><br><span class="line">	.get_acl	&#x3D; ext2_get_acl,</span><br><span class="line">	.set_acl	&#x3D; ext2_set_acl,</span><br><span class="line">	.tmpfile	&#x3D; ext2_tmpfile,</span><br><span class="line">	.fileattr_get	&#x3D; ext2_fileattr_get,</span><br><span class="line">	.fileattr_set	&#x3D; ext2_fileattr_set,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>special inode</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const struct inode_operations ext2_special_inode_operations &#x3D; &#123;</span><br><span class="line">	.listxattr	&#x3D; ext2_listxattr,</span><br><span class="line">	.getattr	&#x3D; ext2_getattr,</span><br><span class="line">	.setattr	&#x3D; ext2_setattr,</span><br><span class="line">	.get_acl	&#x3D; ext2_get_acl,</span><br><span class="line">	.set_acl	&#x3D; ext2_set_acl,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>symlink</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const struct inode_operations ext2_symlink_inode_operations &#x3D; &#123;</span><br><span class="line">	.get_link	&#x3D; page_get_link,</span><br><span class="line">	.getattr	&#x3D; ext2_getattr,</span><br><span class="line">	.setattr	&#x3D; ext2_setattr,</span><br><span class="line">	.listxattr	&#x3D; ext2_listxattr,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>fast_symlink</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const struct inode_operations ext2_fast_symlink_inode_operations &#x3D; &#123;</span><br><span class="line">	.get_link	&#x3D; simple_get_link,</span><br><span class="line">	.getattr	&#x3D; ext2_getattr,</span><br><span class="line">	.setattr	&#x3D; ext2_setattr,</span><br><span class="line">	.listxattr	&#x3D; ext2_listxattr,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="file-操作相关"><a href="#file-操作相关" class="headerlink" title="file 操作相关"></a>file 操作相关</h3><p><code>ext2_file_operations</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const struct file_operations ext2_file_operations &#x3D; &#123;</span><br><span class="line">	.llseek		&#x3D; generic_file_llseek,</span><br><span class="line">	.read_iter	&#x3D; ext2_file_read_iter,</span><br><span class="line">	.write_iter	&#x3D; ext2_file_write_iter,</span><br><span class="line">	.unlocked_ioctl &#x3D; ext2_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">	.compat_ioctl	&#x3D; ext2_compat_ioctl,</span><br><span class="line">#endif</span><br><span class="line">	.mmap		&#x3D; ext2_file_mmap,</span><br><span class="line">	.open		&#x3D; dquot_file_open,</span><br><span class="line">	.release	&#x3D; ext2_release_file,</span><br><span class="line">	.fsync		&#x3D; ext2_fsync,</span><br><span class="line">	.get_unmapped_area &#x3D; thp_get_unmapped_area,</span><br><span class="line">	.splice_read	&#x3D; generic_file_splice_read,</span><br><span class="line">	.splice_write	&#x3D; iter_file_splice_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>ext2_dir_operations</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const struct file_operations ext2_dir_operations &#x3D; &#123;</span><br><span class="line">	.llseek		&#x3D; generic_file_llseek,</span><br><span class="line">	.read		&#x3D; generic_read_dir,</span><br><span class="line">	.iterate_shared	&#x3D; ext2_readdir,</span><br><span class="line">	.unlocked_ioctl &#x3D; ext2_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">	.compat_ioctl	&#x3D; ext2_compat_ioctl,</span><br><span class="line">#endif</span><br><span class="line">	.fsync		&#x3D; ext2_fsync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="地址空间相关"><a href="#地址空间相关" class="headerlink" title="地址空间相关"></a>地址空间相关</h3><p><code>ext2_aops</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const struct address_space_operations ext2_aops &#x3D; &#123;</span><br><span class="line">	.set_page_dirty		&#x3D; __set_page_dirty_buffers,</span><br><span class="line">	.readpage		&#x3D; ext2_readpage,</span><br><span class="line">	.readahead		&#x3D; ext2_readahead,</span><br><span class="line">	.writepage		&#x3D; ext2_writepage,</span><br><span class="line">	.write_begin		&#x3D; ext2_write_begin,</span><br><span class="line">	.write_end		&#x3D; ext2_write_end,</span><br><span class="line">	.bmap			&#x3D; ext2_bmap,</span><br><span class="line">	.direct_IO		&#x3D; ext2_direct_IO,</span><br><span class="line">	.writepages		&#x3D; ext2_writepages,</span><br><span class="line">	.migratepage		&#x3D; buffer_migrate_page,</span><br><span class="line">	.is_partially_uptodate	&#x3D; block_is_partially_uptodate,</span><br><span class="line">	.error_remove_page	&#x3D; generic_error_remove_page,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>ext2_nobh_aops</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const struct address_space_operations ext2_nobh_aops &#x3D; &#123;</span><br><span class="line">	.set_page_dirty		&#x3D; __set_page_dirty_buffers,</span><br><span class="line">	.readpage		&#x3D; ext2_readpage,</span><br><span class="line">	.readahead		&#x3D; ext2_readahead,</span><br><span class="line">	.writepage		&#x3D; ext2_nobh_writepage,</span><br><span class="line">	.write_begin		&#x3D; ext2_nobh_write_begin,</span><br><span class="line">	.write_end		&#x3D; nobh_write_end,</span><br><span class="line">	.bmap			&#x3D; ext2_bmap,</span><br><span class="line">	.direct_IO		&#x3D; ext2_direct_IO,</span><br><span class="line">	.writepages		&#x3D; ext2_writepages,</span><br><span class="line">	.migratepage		&#x3D; buffer_migrate_page,</span><br><span class="line">	.error_remove_page	&#x3D; generic_error_remove_page,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>ext2_dax_aops</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static const struct address_space_operations ext2_dax_aops &#x3D; &#123;</span><br><span class="line">	.writepages		&#x3D; ext2_dax_writepages,</span><br><span class="line">	.direct_IO		&#x3D; noop_direct_IO,</span><br><span class="line">	.set_page_dirty		&#x3D; __set_page_dirty_no_writeback,</span><br><span class="line">	.invalidatepage		&#x3D; noop_invalidatepage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>










</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-01T11:00:40.000Z" title="2/1/2021, 7:00:40 PM">2021-02-01</time>发表</span><span class="level-item"><time dateTime="2021-07-09T06:27:11.948Z" title="7/9/2021, 2:27:11 PM">2021-07-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">4 分钟读完 (大约539个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/01/filesystem/sync%20%E7%9B%B8%E5%85%B3/">sync  相关</a></h1><div class="content"><h2 id="syscalls"><a href="#syscalls" class="headerlink" title="syscalls"></a>syscalls</h2><p>linux 关于 sync的系统调用很多，都在<code>fs/sync.c</code> 目录下：</p>
<ul>
<li>sync： sync整个系统中所有 <code>sb</code></li>
<li>syncfs：sync 单个文件系统单个 <code>sb</code></li>
<li>fsync: sync 单个文件，包括 mdata</li>
<li>fdatasync: sync单个文件，不包括 mdata</li>
<li>sync_file_range：sync文件某段内容，是否脏页，应用程序最清楚</li>
<li>sync_file_range2：同 sync_file_range</li>
</ul>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="sync"><a href="#sync" class="headerlink" title="sync"></a>sync</h3><p>sync整个系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Sync everything. We start by waking flusher threads so that most of</span><br><span class="line"> * writeback runs on all devices in parallel. Then we sync all inodes reliably</span><br><span class="line"> * which effectively also waits for all flusher threads to finish doing</span><br><span class="line"> * writeback. At this point all data is on disk so metadata should be stable</span><br><span class="line"> * and we tell filesystems to sync their metadata via -&gt;sync_fs() calls.</span><br><span class="line"> * Finally, we writeout all block devices because some filesystems (e.g. ext2)</span><br><span class="line"> * just write metadata (such as inodes or bitmaps) to block device page cache</span><br><span class="line"> * and do not sync it on their own in -&gt;sync_fs().</span><br><span class="line"> *&#x2F;</span><br><span class="line">void ksys_sync(void)</span><br><span class="line">&#123;</span><br><span class="line">	int nowait &#x3D; 0, wait &#x3D; 1;</span><br><span class="line"></span><br><span class="line">	wakeup_flusher_threads(WB_REASON_SYNC); &#x2F;&#x2F; 唤醒 flusher 线程， 所有设备上的 大多数 writeback 可以并行发生</span><br><span class="line">	iterate_supers(sync_inodes_one_sb, NULL); &#x2F;&#x2F; sync all inodes</span><br><span class="line">	iterate_supers(sync_fs_one_sb, &amp;nowait);  &#x2F;&#x2F; sync filesystem metdata</span><br><span class="line">	iterate_supers(sync_fs_one_sb, &amp;wait);</span><br><span class="line">	iterate_bdevs(fdatawrite_one_bdev, NULL); &#x2F;&#x2F; writeout all block devices</span><br><span class="line">	iterate_bdevs(fdatawait_one_bdev, NULL);</span><br><span class="line">	if (unlikely(laptop_mode))</span><br><span class="line">		laptop_sync_completion();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE0(sync)</span><br><span class="line">&#123;</span><br><span class="line">	ksys_sync();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="fsync-、-fdatasync"><a href="#fsync-、-fdatasync" class="headerlink" title="fsync 、 fdatasync"></a>fsync 、 fdatasync</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * vfs_fsync - perform a fsync or fdatasync on a file</span><br><span class="line"> * @file:		file to sync</span><br><span class="line"> * @datasync:		only perform a fdatasync operation</span><br><span class="line"> *</span><br><span class="line"> * Write back data and metadata for @file to disk.  If @datasync is</span><br><span class="line"> * set only metadata needed to access modified file data is written.</span><br><span class="line"> *&#x2F;</span><br><span class="line">int vfs_fsync(struct file *file, int datasync)</span><br><span class="line">&#123;</span><br><span class="line">	return vfs_fsync_range(file, 0, LLONG_MAX, datasync);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int do_fsync(unsigned int fd, int datasync)</span><br><span class="line">&#123;</span><br><span class="line">	struct fd f &#x3D; fdget(fd);</span><br><span class="line">	int ret &#x3D; -EBADF;</span><br><span class="line"></span><br><span class="line">	if (f.file) &#123;</span><br><span class="line">		ret &#x3D; vfs_fsync(f.file, datasync);</span><br><span class="line">		fdput(f);</span><br><span class="line">	&#125;</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(fsync, unsigned int, fd)</span><br><span class="line">&#123;</span><br><span class="line">	return do_fsync(fd, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(fdatasync, unsigned int, fd)</span><br><span class="line">&#123;</span><br><span class="line">	return do_fsync(fd, 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

















<p>来trace一下看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;tmp# sudo bpftrace -e &#39;tracepoint:vmscan:mm_shrink_slab_start &#123;printf(&quot;[pid-%d:%s]: trace_mm_shrink_slab_start start\n&quot;, pid,comm)&#125;&#39;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_start start</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_start start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;tmp# sudo bpftrace -e &#39;tracepoint:vmscan:mm_shrink_slab_end &#123;printf(&quot;[pid-%d:%s]: trace_mm_shrink_slab_end total_scan &#x3D; %d\n&quot;, pid,comm, args-&gt;total_scan)&#125;&#39;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_end total_scan &#x3D; 0</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_end total_scan &#x3D; 0</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_end total_scan &#x3D; 57</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_end total_scan &#x3D; 0</span><br><span class="line">[pid-1747572:zsh]: trace_mm_shrink_slab_end total_scan &#x3D; 1</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-01T11:00:40.000Z" title="2/1/2021, 7:00:40 PM">2021-02-01</time>发表</span><span class="level-item"><time dateTime="2021-02-07T13:24:07.733Z" title="2/7/2021, 9:24:07 PM">2021-02-07</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">几秒读完 (大约0个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/01/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">ext2文件系统</a></h1><div class="content"></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-01T11:00:40.000Z" title="2/1/2021, 7:00:40 PM">2021-02-01</time>发表</span><span class="level-item"><time dateTime="2021-02-07T09:14:58.677Z" title="2/7/2021, 5:14:58 PM">2021-02-07</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">几秒读完 (大约0个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/01/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/mount%20%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">mount 流程分析</a></h1><div class="content"></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/tags/filesystem/page/0/">上一页</a></div><div class="pagination-next"><a href="/tags/filesystem/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/tags/filesystem/">1</a></li><li><a class="pagination-link" href="/tags/filesystem/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">115</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">143</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/explore" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BRK/"><span class="tag">BRK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HW/"><span class="tag">HW</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QCOM/"><span class="tag">QCOM</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aarch64/"><span class="tag">aarch64</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/acl/"><span class="tag">acl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android-framework/"><span class="tag">android framework</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android12-gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/"><span class="tag">android12 gdb64调试进程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v1/"><span class="tag">cgroup v1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v2/"><span class="tag">cgroup v2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu%E8%B0%83%E9%A2%91/"><span class="tag">cpu调频</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dd/"><span class="tag">dd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debugfs/"><span class="tag">debugfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/double-free/"><span class="tag">double free</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drop-caches/"><span class="tag">drop_caches</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dumpe2fs/"><span class="tag">dumpe2fs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eas/"><span class="tag">eas</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ext2/"><span class="tag">ext2</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-attr/"><span class="tag">file attr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-hole/"><span class="tag">file hole</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filesystem/"><span class="tag">filesystem</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fsck/"><span class="tag">fsck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hrtimer/"><span class="tag">hrtimer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hugepage/"><span class="tag">hugepage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interrupt/"><span class="tag">interrupt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt/"><span class="tag">intrrrupt</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt-storm/"><span class="tag">intrrrupt storm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kallsyms/"><span class="tag">kallsyms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kfence/"><span class="tag">kfence</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kprobes/"><span class="tag">kprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kretprobes/"><span class="tag">kretprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvmtool/"><span class="tag">kvmtool</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/launch-json/"><span class="tag">launch.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-kernel/"><span class="tag">linux kernel</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-native-aio/"><span class="tag">linux native aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lock-stat/"><span class="tag">lock_stat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory/"><span class="tag">memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory-direct-reclaim/"><span class="tag">memory direct reclaim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mount/"><span class="tag">mount</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/node/"><span class="tag">node</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oom/"><span class="tag">oom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagemap/"><span class="tag">pagemap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf/"><span class="tag">perf</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf-c2c/"><span class="tag">perf c2c</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pid-namespace/"><span class="tag">pid namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preemption/"><span class="tag">preemption</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pressure/"><span class="tag">pressure</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/process-madvise/"><span class="tag">process_madvise</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psi/"><span class="tag">psi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psoix-aio/"><span class="tag">psoix aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/randomize-va-space/"><span class="tag">randomize_va_space</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rcu/"><span class="tag">rcu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sched-latency/"><span class="tag">sched latency</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/schedule/"><span class="tag">schedule</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slab/"><span class="tag">slab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-overflow/"><span class="tag">stack_overflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-key/"><span class="tag">static_key</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sync/"><span class="tag">sync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systrace/"><span class="tag">systrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-json/"><span class="tag">task.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-struct/"><span class="tag">task_struct</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread-info/"><span class="tag">thread_info</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tracepoint/"><span class="tag">tracepoint</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/use-after-free/"><span class="tag">use after free</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uts-namespace/"><span class="tag">uts namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vdso/"><span class="tag">vdso</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmstat/"><span class="tag">vmstat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xattr/"><span class="tag">xattr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zone/"><span class="tag">zone</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%B6%8A%E7%95%8C/"><span class="tag">内存泄漏越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88%E6%BA%A2%E5%87%BA/"><span class="tag">内核栈溢出</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80%E9%9A%8F%E6%9C%BA%E5%8C%96/"><span class="tag">地址空间布局随机化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/QCOM/"><span class="level-start"><span class="level-item">QCOM</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/cgroup-v1/"><span class="level-start"><span class="level-item">cgroup v1</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/cgroup-v1/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/kernel-debug/cache-false-sharing/"><span class="level-start"><span class="level-item">cache false sharing</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/"><span class="level-start"><span class="level-item">linux kernel</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/deadline-schedule/"><span class="level-start"><span class="level-item">deadline schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/"><span class="level-start"><span class="level-item">frequency governer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/schedule-util/"><span class="level-start"><span class="level-item">schedule util</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/idle/"><span class="level-start"><span class="level-item">idle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">68</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/"><span class="level-start"><span class="level-item">namespace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/namespace/pid-namespace/"><span class="level-start"><span class="level-item">pid namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/uts-namespace/"><span class="level-start"><span class="level-item">uts namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/schedule/"><span class="level-start"><span class="level-item">schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-24T11:00:00.000Z">2022-01-24</time></p><p class="title"><a href="/2022/01/24/schedule/cpu%E8%B0%83%E9%A2%91/">cpu调频</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-20T08:42:37.115Z">2022-01-20</time></p><p class="title"><a href="/2022/01/20/schedule/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0%E8%B0%83%E5%BA%A6/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-05T11:00:00.000Z">2022-01-05</time></p><p class="title"><a href="/2022/01/05/schedule/eas/">eas</a></p><p class="categories"><a href="/categories/linux-kernel/">linux kernel</a> / <a href="/categories/linux-kernel/linux-schedule/">linux schedule</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-03T11:00:00.000Z">2021-11-03</time></p><p class="title"><a href="/2021/11/03/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20c2c/">perf c2c</a></p><p class="categories"><a href="/categories/kernel-debug/">kernel debug</a> / <a href="/categories/kernel-debug/cache-false-sharing/">cache false sharing</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-23T11:00:00.000Z">2021-09-23</time></p><p class="title"><a href="/2021/09/23/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/android12%20gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/">android12 gdb64调试进程</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>