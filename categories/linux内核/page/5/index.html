<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>分类: linux内核 - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">linux内核</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-26T11:00:00.000Z" title="1/26/2021, 7:00:00 PM">2021-01-26</time>发表</span><span class="level-item"><time dateTime="2021-01-26T14:25:52.700Z" title="1/26/2021, 10:25:52 PM">2021-01-26</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">22 分钟读完 (大约3228个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/26/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/slub%20debug%20%E5%AE%9A%E4%BD%8D%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/">slub_debug 定位内存越界</a></h1><div class="content"><h2 id="slub-debug-概述"><a href="#slub-debug-概述" class="headerlink" title="slub_debug 概述"></a>slub_debug 概述</h2><p>首先需要使能，一般情况下我们系统都是使用 <code>slub</code>的。所以只需要打开debug选项即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if [ $debug_slubdebug &#x3D;&#x3D; 1 ]</span><br><span class="line">then</span><br><span class="line">## slubdebug detect start</span><br><span class="line">	echo &quot;CONFIG_SLUB_DEBUG_ON&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">## slubdebug detect end</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>写了一个test case,参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/memory/slub_debug/slub_debug.c">代码</a></p>
<p>与 <code>KASAN</code> 可以自动检测出 内存越界，然后报错不同， <code>slub_debug</code> 需要主动触发检测，这里需要使用到<code>slabinfo</code> 这个工具（如果是很快释放的slab,其实不需要 slabinfo），源码在 <code>./tools/vm/</code> 目录下，可以直接编译得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;vm$ make</span><br><span class="line">make -C ..&#x2F;lib&#x2F;api</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;lib&#x2F;api&#39;</span><br><span class="line">make -C &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;build CFLAGS&#x3D; LDFLAGS&#x3D; fixdep</span><br><span class="line">  HOSTCC   fixdep.o</span><br><span class="line">  HOSTLD   fixdep-in.o</span><br><span class="line">  LINK     fixdep</span><br><span class="line">  CC       fd&#x2F;array.o</span><br><span class="line">  LD       fd&#x2F;libapi-in.o</span><br><span class="line">  CC       fs&#x2F;fs.o</span><br><span class="line">  CC       fs&#x2F;tracing_path.o</span><br><span class="line">  CC       fs&#x2F;cgroup.o</span><br><span class="line">  LD       fs&#x2F;libapi-in.o</span><br><span class="line">  CC       cpu.o</span><br><span class="line">  CC       debug.o</span><br><span class="line">  CC       str_error_r.o</span><br><span class="line">  LD       libapi-in.o</span><br><span class="line">  AR       libapi.a</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;lib&#x2F;api&#39;</span><br><span class="line">gcc -Wall -Wextra -I..&#x2F;lib&#x2F; -o page-types page-types.c ..&#x2F;lib&#x2F;api&#x2F;libapi.a</span><br><span class="line">gcc -Wall -Wextra -I..&#x2F;lib&#x2F; -o slabinfo slabinfo.c ..&#x2F;lib&#x2F;api&#x2F;libapi.a</span><br><span class="line">gcc -Wall -Wextra -I..&#x2F;lib&#x2F; -o page_owner_sort page_owner_sort.c ..&#x2F;lib&#x2F;api&#x2F;libapi.a</span><br><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;vm$ ls -al | grep slab</span><br><span class="line">-rwxrwxr-x  1 jenkins jenkins  50416 1月  26 13:12 slabinfo</span><br><span class="line">-rw-rw-r--  1 jenkins jenkins  37868 12月 20 22:58 slabinfo.c</span><br><span class="line">-rw-rw-r--  1 jenkins jenkins   4817 12月 20 22:58 slabinfo-gnuplot.sh</span><br><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;vm$</span><br></pre></td></tr></table></figure>

<p><code>slabinfo</code> 也有多个功能，主动触发 合法性检查<code>slabinfo -v</code> 只是一项，还有比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;slub_debug# .&#x2F;slabinfo --help</span><br><span class="line">slabinfo 4&#x2F;15&#x2F;2011. (c) 2007 sgi&#x2F;(c) 2011 Linux Foundation.</span><br><span class="line"></span><br><span class="line">slabinfo [-aABDefhilLnoPrsStTUvXz1] [N&#x3D;K] [-dafzput] [slab-regexp]</span><br><span class="line">-a|--aliases           Show aliases</span><br><span class="line">-A|--activity          Most active slabs first</span><br><span class="line">-B|--Bytes             Show size in bytes</span><br><span class="line">-D|--display-active    Switch line format to activity</span><br><span class="line">-e|--empty             Show empty slabs</span><br><span class="line">-f|--first-alias       Show first alias</span><br><span class="line">-h|--help              Show usage information</span><br><span class="line">-i|--inverted          Inverted list</span><br><span class="line">-l|--slabs             Show slabs</span><br><span class="line">-L|--Loss              Sort by loss</span><br><span class="line">-n|--numa              Show NUMA information</span><br><span class="line">-N|--lines&#x3D;K           Show the first K slabs</span><br><span class="line">-o|--ops               Show kmem_cache_ops</span><br><span class="line">-P|--partial		Sort by number of partial slabs</span><br><span class="line">-r|--report            Detailed report on single slabs</span><br><span class="line">-s|--shrink            Shrink slabs</span><br><span class="line">-S|--Size              Sort by size</span><br><span class="line">-t|--tracking          Show alloc&#x2F;free information</span><br><span class="line">-T|--Totals            Show summary information</span><br><span class="line">-U|--Unreclaim         Show unreclaimable slabs only</span><br><span class="line">-v|--validate          Validate slabs</span><br><span class="line">-X|--Xtotals           Show extended summary information</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="slab-debug使用"><a href="#slab-debug使用" class="headerlink" title="slab debug使用"></a>slab debug使用</h2><h3 id="right-redzone-oob-out-of-bounds"><a href="#right-redzone-oob-out-of-bounds" class="headerlink" title="right redzone oob(out of bounds)"></a>right redzone oob(out of bounds)</h3><p>使用这个函数 kslub_debug_right()<br>编译安装 上面test case之后，主动 <code>sudo ./slabinfo -v</code> 触发合法性检查。<br>可以看到如下输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@130kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;slub_debug# sudo .&#x2F;slabinfo -v</span><br><span class="line">[   53.423227] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   53.424083] BUG kmalloc-32 (Tainted: G           O     ): Redzone overwritten</span><br><span class="line">[   53.424083] -----------------------------------------------------------------------------</span><br><span class="line">[   53.424083]</span><br><span class="line">[   53.424083] INFO: 0x00000000de38e5d6-0x00000000de38e5d6 @offset&#x3D;64. First byte 0x61 instead of 0xcc</span><br><span class="line">[   53.424083] INFO: Allocated in kslub_debug_right+0x1c&#x2F;0x50 [slub_debug] age&#x3D;18928 cpu&#x3D;2 pid&#x3D;3159</span><br><span class="line">[   53.424083] 	__slab_alloc+0x50&#x2F;0x60</span><br><span class="line">[   53.424083] 	kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line">[   53.424083] 	kslub_debug_right+0x1c&#x2F;0x50 [slub_debug]</span><br><span class="line">[   53.424083] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   53.424083] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   53.424083] INFO: Freed in security_cred_free+0x37&#x2F;0x50 age&#x3D;18938 cpu&#x3D;1 pid&#x3D;0</span><br><span class="line">[   53.424083] 	security_cred_free+0x37&#x2F;0x50</span><br><span class="line">[   53.424083] 	put_cred_rcu+0x22&#x2F;0x80</span><br><span class="line">[   53.424083] 	rcu_core+0x25a&#x2F;0xaa0</span><br><span class="line">[   53.424083] 	__do_softirq+0xc7&#x2F;0x419</span><br><span class="line">[   53.424083] 	asm_call_irq_on_stack+0x12&#x2F;0x20</span><br><span class="line">[   53.424083] 	do_softirq_own_stack+0x56&#x2F;0x60</span><br><span class="line">[   53.424083] 	irq_exit_rcu+0xa9&#x2F;0xb0</span><br><span class="line">[   53.424083] 	sysvec_apic_timer_interrupt+0x43&#x2F;0xa0</span><br><span class="line">[   53.424083] 	asm_sysvec_apic_timer_interrupt+0x12&#x2F;0x20</span><br><span class="line">[   53.424083] 	default_idle+0xe&#x2F;0x10</span><br><span class="line">[   53.424083] 	default_idle_call+0x63&#x2F;0x1e0</span><br><span class="line">[   53.424083] 	do_idle+0x1e5&#x2F;0x240</span><br><span class="line">[   53.424083] 	cpu_startup_entry+0x14&#x2F;0x20</span><br><span class="line">[   53.424083] 	secondary_startup_64_no_verify+0xc2&#x2F;0xcb</span><br><span class="line">[   53.424083] INFO: Slab 0x00000000831bf412 objects&#x3D;19 used&#x3D;18 fp&#x3D;0x0000000083bc545d flags&#x3D;0x100000000010201</span><br><span class="line">[   53.424083] INFO: Object 0x00000000f71a6b67 @offset&#x3D;32 fp&#x3D;0x000000000629ace8</span><br><span class="line">[   53.424083]</span><br><span class="line">[   53.424083] Redzone 0000000033d4cff0: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Redzone 00000000bf62d009: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Object 00000000f71a6b67: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   53.424083] Object 00000000e9b4a4ba: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   53.424083] Redzone 00000000de38e5d6: 61 cc cc cc cc cc cc cc                          a.......</span><br><span class="line">[   53.424083] Padding 000000002dddb492: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   53.424083] Padding 0000000010d75c56: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   53.424083] CPU: 1 PID: 3198 Comm: slabinfo Kdump: loaded Tainted: G    B      O      5.11.0-rc4+ #5</span><br><span class="line">[   53.424083] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   53.424083] Call Trace:</span><br><span class="line">[   53.424083]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[   53.424083]  check_bytes_and_report.cold+0x77&#x2F;0xb4</span><br><span class="line">[   53.424083]  check_object+0x193&#x2F;0x250</span><br><span class="line">[   53.424083]  validate_slab+0x127&#x2F;0x170</span><br><span class="line">[   53.424083]  validate_store+0xac&#x2F;0x160</span><br><span class="line">[   53.424083]  slab_attr_store+0x1b&#x2F;0x30</span><br><span class="line">[   53.424083]  kernfs_fop_write+0xca&#x2F;0x1b0</span><br><span class="line">[   53.424083]  vfs_write+0xc6&#x2F;0x360</span><br><span class="line">[   53.424083]  ksys_write+0x63&#x2F;0xe0</span><br><span class="line">[   53.424083]  do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">[   53.424083]  entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">[   53.424083] RIP: 0033:0x7facb81181e7</span><br><span class="line">[   53.424083] Code: 64 89 02 48 c7 c0 ff ff ff ff eb bb 0f 1f 80 00 00 00 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 01 00 00 04</span><br><span class="line">[   53.424083] RSP: 002b:00007ffe1b3ef6c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001</span><br><span class="line">[   53.424083] RAX: ffffffffffffffda RBX: 0000000000000002 RCX: 00007facb81181e7</span><br><span class="line">[   53.424083] RDX: 0000000000000002 RSI: 00005641aa82cb40 RDI: 0000000000000003</span><br><span class="line">[   53.424083] RBP: 00005641aa82cb40 R08: 0000000000000000 R09: 0000000000000002</span><br><span class="line">[   53.424083] R10: 00005641a899065b R11: 0000000000000246 R12: 0000000000000002</span><br><span class="line">[   53.424083] R13: 00005641aa834b80 R14: 00007facb81f44a0 R15: 00007facb81f38a0</span><br><span class="line">[   53.424083] FIX kmalloc-32: Restoring 0x00000000de38e5d6-0x00000000de38e5d6&#x3D;0xcc</span><br><span class="line">[   53.424083]</span><br><span class="line">[   53.424083] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   53.424083] BUG kmalloc-32 (Tainted: G    B      O     ): Redzone overwritten</span><br><span class="line">[   53.424083] -----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>可以看到开启 slub_debug 之后内存布局是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[   53.424083] Redzone 0000000033d4cff0: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Redzone 00000000bf62d009: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Object 00000000f71a6b67: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   53.424083] Object 00000000e9b4a4ba: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   53.424083] Redzone 00000000de38e5d6: 61 cc cc cc cc cc cc cc                          a.......</span><br><span class="line">[   53.424083] Padding 000000002dddb492: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   53.424083] Padding 0000000010d75c56: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br></pre></td></tr></table></figure>

<p>在分配之后（未使用GFP_ZREO mask），object的内容都是 <code>6b</code>, 最后一个字节是<code>a5</code>，其余 redzone 的地方都是填充了<code>cc</code>，最后padding的位置填充了 <code>5a</code>，这些<code>magic num</code> 其实都是在分配的时候assign的。<br>先看各个<code>magic num</code>定义，在 <code>include/linux/poison.h</code> 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;********** mm&#x2F;slab.c **********&#x2F;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Magic nums for obj red zoning.</span><br><span class="line"> * Placed in the first word before and the first word after an obj.</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define	RED_INACTIVE	0x09F911029D74E35BULL	&#x2F;* when obj is inactive *&#x2F;</span><br><span class="line">#define	RED_ACTIVE	0xD84156C5635688C0ULL	&#x2F;* when obj is active *&#x2F;</span><br><span class="line"></span><br><span class="line">#define SLUB_RED_INACTIVE	0xbb</span><br><span class="line">#define SLUB_RED_ACTIVE		0xcc</span><br><span class="line"></span><br><span class="line">&#x2F;* ...and for poisoning *&#x2F;</span><br><span class="line">#define	POISON_INUSE	0x5a	&#x2F;* for use-uninitialised poisoning *&#x2F;</span><br><span class="line">#define POISON_FREE	0x6b	&#x2F;* for use-after-free poisoning *&#x2F;</span><br><span class="line">#define	POISON_END	0xa5	&#x2F;* end-byte of poisoning *&#x2F;</span><br></pre></td></tr></table></figure>

<p>实现主要参考 <code>mm/slub.c</code> 中代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">static int check_slab(struct kmem_cache *s, struct page *page)</span><br><span class="line">&#123;</span><br><span class="line">	int maxobj;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(!irqs_disabled());</span><br><span class="line"></span><br><span class="line">	if (!PageSlab(page)) &#123;</span><br><span class="line">		slab_err(s, page, &quot;Not a valid slab page&quot;);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	maxobj &#x3D; order_objects(compound_order(page), s-&gt;size);</span><br><span class="line">	if (page-&gt;objects &gt; maxobj) &#123;</span><br><span class="line">		slab_err(s, page, &quot;objects %u &gt; max %u&quot;,</span><br><span class="line">			page-&gt;objects, maxobj);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	if (page-&gt;inuse &gt; page-&gt;objects) &#123;</span><br><span class="line">		slab_err(s, page, &quot;inuse %u &gt; max %u&quot;,</span><br><span class="line">			page-&gt;inuse, page-&gt;objects);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;* Slab_pad_check fixes things up after itself *&#x2F;</span><br><span class="line">	slab_pad_check(s, page);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void init_object(struct kmem_cache *s, void *object, u8 val)</span><br><span class="line">&#123;</span><br><span class="line">	u8 *p &#x3D; kasan_reset_tag(object);</span><br><span class="line"></span><br><span class="line">	if (s-&gt;flags &amp; SLAB_RED_ZONE)</span><br><span class="line">		memset(p - s-&gt;red_left_pad, val, s-&gt;red_left_pad);</span><br><span class="line"></span><br><span class="line">	if (s-&gt;flags &amp; __OBJECT_POISON) &#123;</span><br><span class="line">		memset(p, POISON_FREE, s-&gt;object_size - 1);</span><br><span class="line">		p[s-&gt;object_size - 1] &#x3D; POISON_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (s-&gt;flags &amp; SLAB_RED_ZONE)</span><br><span class="line">		memset(p + s-&gt;object_size, val, s-&gt;inuse - s-&gt;object_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static noinline int alloc_debug_processing(struct kmem_cache *s,</span><br><span class="line">					struct page *page,</span><br><span class="line">					void *object, unsigned long addr)</span><br><span class="line">&#123;</span><br><span class="line">	init_object(s, object, SLUB_RED_ACTIVE);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static noinline int free_debug_processing(</span><br><span class="line">	struct kmem_cache *s, struct page *page,</span><br><span class="line">	void *head, void *tail, int bulk_cnt,</span><br><span class="line">	unsigned long addr)</span><br><span class="line">&#123;</span><br><span class="line">    if (s-&gt;flags &amp; SLAB_CONSISTENCY_CHECKS) &#123;</span><br><span class="line">		if (!check_slab(s, page))</span><br><span class="line">			goto out;</span><br><span class="line">	&#125;</span><br><span class="line">    init_object(s, object, SLUB_RED_INACTIVE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>check_slab()</code> 主要用来检查<code>slab</code>合法性<br><code>init_object()</code> 主要用来填充<code>magic num</code><br><code>alloc_debug_processing()</code> 和 <code>free_debug_processing()</code> 会hook在slab分配与释放的路径上，达到对所有 slab 对象分配和释放过程中<code>检查是否越界</code> 和 <code>填充magic num</code>的目的。</p>
<p>但是有时候有些slab申请之后，很久之后才会释放，甚至在整个内核生命周期内都不会释放，那通过 <code>free_debug_processing</code> 这个代码路径就无法执行，就没法检查是否越界了吗？<br>显然不是，这就是<code>slabinfo -v</code>的作用，他最后会调用到内核函数<code>validate_slab()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#ifdef CONFIG_SLUB_DEBUG</span><br><span class="line">static void validate_slab(struct kmem_cache *s, struct page *page)</span><br><span class="line">&#123;</span><br><span class="line">	void *p;</span><br><span class="line">	void *addr &#x3D; page_address(page);</span><br><span class="line">	unsigned long *map;</span><br><span class="line"></span><br><span class="line">	slab_lock(page);</span><br><span class="line"></span><br><span class="line">	if (!check_slab(s, page) || !on_freelist(s, page, NULL))</span><br><span class="line">		goto unlock;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="left-redzone-oob-out-of-bounds"><a href="#left-redzone-oob-out-of-bounds" class="headerlink" title="left redzone oob(out of bounds)"></a>left redzone oob(out of bounds)</h3><p>使用 kslub_debug_left()<br>同样编译安装之后，可以 使用<code>slabinfo -v</code>触发检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;slub_debug# sudo slabinfo -v</span><br><span class="line">[   88.049885] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   88.050661] BUG kmalloc-32 (Tainted: G           O     ): Redzone overwritten</span><br><span class="line">[   88.050661] -----------------------------------------------------------------------------</span><br><span class="line">[   88.050661]</span><br><span class="line">[   88.050661] INFO: 0x00000000f7a64828-0x00000000f7a64828 @offset&#x3D;30. First byte 0x61 instead of 0xcc</span><br><span class="line">[   88.050661] INFO: Allocated in kslub_debug_left+0x1c&#x2F;0x50 [slub_debug] age&#x3D;8012 cpu&#x3D;2 pid&#x3D;3207</span><br><span class="line">......</span><br><span class="line">[   88.050661] INFO: Slab 0x00000000736d0bf0 objects&#x3D;19 used&#x3D;13 fp&#x3D;0x0000000001a78134 flags&#x3D;0x100000000010201</span><br><span class="line">[   88.050661] INFO: Object 0x00000000a9f17fea @offset&#x3D;32 fp&#x3D;0x00000000ec20872a</span><br><span class="line">[   88.050661]</span><br><span class="line">[   88.050661] Redzone 000000003a38622f: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   88.050661] Redzone 000000006a2f8e0a: cc cc cc cc cc cc cc cc cc cc cc cc cc cc 61 cc  ..............a.</span><br><span class="line">[   88.050661] Object 00000000a9f17fea: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   88.050661] Object 00000000cc601ad9: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   88.050661] Redzone 0000000050c2e0d4: cc cc cc cc cc cc cc cc                          ........</span><br><span class="line">[   88.050661] Padding 000000009487d314: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   88.050661] Padding 000000008d823823: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   88.050661] CPU: 3 PID: 3212 Comm: slabinfo Kdump: loaded Tainted: G    B      O      5.11.0-rc4+ #5</span><br></pre></td></tr></table></figure>

<p>可以从输出看到原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[   88.050661] BUG kmalloc-32 (Tainted: G           O     ): Redzone overwritten</span><br><span class="line">[   88.050661] INFO: 0x00000000f7a64828-0x00000000f7a64828 @offset&#x3D;30. First byte 0x61 instead of 0xcc</span><br></pre></td></tr></table></figure>


<h3 id="use-after-free"><a href="#use-after-free" class="headerlink" title="use after free"></a>use after free</h3><p>使用 kslub_debug_use_after_free()<br>同样编译安装之后，可以 使用<code>slabinfo -v</code>触发检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[   43.801344] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   43.802065] BUG kmalloc-32 (Tainted: G           O     ): Poison overwritten</span><br><span class="line">[   43.802065] -----------------------------------------------------------------------------</span><br><span class="line">[   43.802065]</span><br><span class="line">[   43.802065] INFO: 0x0000000065d12e59-0x0000000065d12e59 @offset&#x3D;3806. First byte 0x61 instead of 0x6b</span><br><span class="line">[   43.802065] INFO: Allocated in kslub_debug_use_after_free+0x4e&#x2F;0xc0 [slub_debug] age&#x3D;8 cpu&#x3D;1 pid&#x3D;3163</span><br><span class="line">[   43.802065] 	__slab_alloc+0x50&#x2F;0x60</span><br><span class="line">[   43.802065] 	kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line">[   43.802065] 	kslub_debug_use_after_free+0x4e&#x2F;0xc0 [slub_debug]</span><br><span class="line">[   43.802065] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   43.802065] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   43.802065] INFO: Freed in kslub_debug_use_after_free+0x6a&#x2F;0xc0 [slub_debug] age&#x3D;8 cpu&#x3D;1 pid&#x3D;3163</span><br><span class="line">[   43.802065] 	kslub_debug_use_after_free+0x6a&#x2F;0xc0 [slub_debug]</span><br><span class="line">[   43.802065] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   43.802065] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   43.802065] INFO: Slab 0x0000000091c90915 objects&#x3D;19 used&#x3D;19 fp&#x3D;0x0000000000000000 flags&#x3D;0x100000000010200</span><br><span class="line">[   43.802065] INFO: Object 0x000000002c0fb46b @offset&#x3D;3776 fp&#x3D;0x00000000d32afce7</span><br><span class="line">[   43.802065]</span><br><span class="line">[   43.802065] Redzone 000000007de0fb38: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   43.802065] Redzone 0000000010d06595: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   43.802065] Object 000000002c0fb46b: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   43.802065] Object 000000008ffb8d24: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 61 a5  kkkkkkkkkkkkkka.</span><br><span class="line">[   43.802065] Redzone 00000000f5b8c2fa: bb bb bb bb bb bb bb bb                          ........</span><br><span class="line">[   43.802065] Padding 000000007af7da7c: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   43.802065] Padding 000000002d26610c: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   43.802065] FIX kmalloc-32: Restoring 0x0000000065d12e59-0x0000000065d12e59&#x3D;0x6b</span><br><span class="line">[   43.802065]</span><br><span class="line">[   43.802065] FIX kmalloc-32: Marking all objects used</span><br></pre></td></tr></table></figure>

<p>可以从输出看到原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[   43.802065] BUG kmalloc-32 (Tainted: G           O     ): Poison overwritten</span><br><span class="line">[   43.802065] INFO: 0x0000000065d12e59-0x0000000065d12e59 @offset&#x3D;3806. First byte 0x61 instead of 0x6b</span><br></pre></td></tr></table></figure>
<p>可以发现 free 状态的 <code>slab object</code> 的 <code>redzone</code> 填充的是 <code>bb</code> 与使用中的<code>cc</code>不一样，其次 padding还是<code>5a</code>。</p>
<h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><p>使用 kslub_debug_double_free()<br>同样编译安装之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[   99.126747] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   99.128946] BUG kmalloc-32 (Tainted: G    B      O     ): Object already free</span><br><span class="line">[   99.128946] -----------------------------------------------------------------------------</span><br><span class="line">[   99.128946]</span><br><span class="line">[   99.128946] INFO: Allocated in kslub_debug_double_free+0x4e&#x2F;0xd0 [slub_debug] age&#x3D;1517 cpu&#x3D;1 pid&#x3D;3402</span><br><span class="line">[   99.128946] 	__slab_alloc+0x50&#x2F;0x60</span><br><span class="line">[   99.128946] 	kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line">[   99.128946] 	kslub_debug_double_free+0x4e&#x2F;0xd0 [slub_debug]</span><br><span class="line">[   99.128946] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   99.128946] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   99.128946] INFO: Freed in kslub_debug_double_free+0x6b&#x2F;0xd0 [slub_debug] age&#x3D;1207 cpu&#x3D;1 pid&#x3D;3402</span><br><span class="line">[   99.128946] 	kslub_debug_double_free+0x6b&#x2F;0xd0 [slub_debug]</span><br><span class="line">[   99.128946] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   99.128946] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   99.128946] INFO: Slab 0x000000004358aee6 objects&#x3D;19 used&#x3D;16 fp&#x3D;0x000000007cc439c4 flags&#x3D;0x100000000010201</span><br><span class="line">[   99.128946] INFO: Object 0x000000007cc439c4 @offset&#x3D;5856 fp&#x3D;0x0000000000000000</span><br><span class="line">[   99.128946]</span><br><span class="line">[   99.128946] Redzone 000000008f8c9766: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   99.128946] Redzone 00000000ad0c3fcc: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   99.128946] Object 000000007cc439c4: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   99.128946] Object 00000000b15b51a4: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   99.128946] Redzone 000000009f473013: bb bb bb bb bb bb bb bb                          ........</span><br><span class="line">[   99.128946] Padding 00000000cb92dccb: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   99.128946] Padding 000000006bc8c5e0: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   99.128946] CPU: 1 PID: 3402 Comm: kslub_debug Kdump: loaded Tainted: G    B      O      5.11.0-rc4+ #5</span><br><span class="line">[   99.128946] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   99.128946] Call Trace:</span><br><span class="line">[   99.128946]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[   99.128946]  free_debug_processing.cold+0x10c&#x2F;0x14f</span><br><span class="line">[   99.128946]  __slab_free+0x286&#x2F;0x490</span><br><span class="line">[   99.128946]  ? schedule_timeout+0x1bf&#x2F;0x370</span><br><span class="line">[   99.128946]  ? trace_hardirqs_on+0x1b&#x2F;0xd0</span><br><span class="line">[   99.128946]  kslub_debug_double_free+0x86&#x2F;0xd0 [slub_debug]</span><br><span class="line">[   99.128946]  ? kslub_debug_double_free.part.0+0x20&#x2F;0x20 [slub_debug]</span><br><span class="line">[   99.128946]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[   99.128946]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[   99.128946]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   99.160092] FIX kmalloc-32: Object at 0x000000007cc439c4 not freed</span><br></pre></td></tr></table></figure>

<p>可以从输出看到原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[   99.128946] BUG kmalloc-32 (Tainted: G    B      O     ): Object already free</span><br></pre></td></tr></table></figure>
<p><code>double free</code>的问题会直接在 第二次 free的时候打印出日志，不需要<code>slabinfo -v</code>去触发</p>
<h2 id="slubinfo-其他用处"><a href="#slubinfo-其他用处" class="headerlink" title="slubinfo 其他用处"></a>slubinfo 其他用处</h2><p><code>slabinfo -t</code> 可以跟踪 <code>slab</code> 内存分配释放<br><code>slabinfo -A</code> 显示 alias 信息<br><code>slabinfo -T</code> 显示 total 信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo slabinfo -T</span><br><span class="line">Slabcache Totals</span><br><span class="line">----------------</span><br><span class="line">Slabcaches :             220   Aliases  :           0-&gt;0    Active:    117</span><br><span class="line">Memory used:          211.2M   # Loss   :          112.7M   MRatio:   114%</span><br><span class="line"># Objects  :          265.6K   # PartObj:           17.7K   ORatio:     6%</span><br><span class="line"></span><br><span class="line">Per Cache         Average              Min              Max            Total</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">#Objects             2.2K                1            39.8K           265.6K</span><br><span class="line">#Slabs                185                1             3.3K            21.7K</span><br><span class="line">#PartSlab              16                1              347             1.9K</span><br><span class="line">%PartSlab             56%               0%             100%               9%</span><br><span class="line">PartObjs                6                0             3.8K            17.7K</span><br><span class="line">% PartObj             53%               0%             100%               6%</span><br><span class="line">Memory               1.8M             4.0K            27.1M           211.2M</span><br><span class="line">Used               841.8K               32            22.7M            98.4M</span><br><span class="line">Loss               964.0K             4.0K            14.7M           112.7M</span><br><span class="line"></span><br><span class="line">Per Object        Average              Min              Max</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Memory                742              344            24.5K</span><br><span class="line">User                  370                8             8.1K</span><br><span class="line">Loss                  372              336            16.3K</span><br></pre></td></tr></table></figure>


<h2 id="slub-debug-overhead"><a href="#slub-debug-overhead" class="headerlink" title="slub_debug overhead"></a>slub_debug overhead</h2><p>从 <code>slub debug</code> 原理上看，主要有以下几点 overhead:</p>
<ol>
<li>需要额外空间去放 <code>redzone</code>等为了debug而额外添加的一些字段</li>
<li>需要在 <code>kmalloc</code> <code>kfree</code> 等关键路径上hook 设置、检查 magic num的代码<br>其他倒没有很大的overhead</li>
</ol>
<p>使用公司开发板做一下对比（单核 cortex-A7芯片）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">memory  on      	off</span><br><span class="line">free	105224K		57992K</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cpu     on      off</span><br><span class="line">usr	4.1	5.5</span><br><span class="line">sys	19.8	11.1</span><br><span class="line">idle	75.3	82.2</span><br><span class="line"></span><br><span class="line">loadavg on      off</span><br><span class="line">1	2.91	1.14</span><br><span class="line">5	1.13	0.29</span><br><span class="line">15	0.41	0.10</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>slub_debug</code> 特性大概占用了7% CPU。<br>free内存少了一半，当然，这是个小内存系统，内存只有211Mb。<br>loadavg 也上升了许多，没有去看 <code>sar -B 1</code> 相关指标，应该也出现了不少直接内存回收。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从overall的角度来说，<code>slub debug</code> 通过在 <code>kmalloc</code> <code>kfree</code>的路径上hook了设置和检查 magic num的方式，可以很有效的排查：</p>
<ol>
<li>内存使用越界</li>
<li>内存use after free</li>
<li>double free<br>这三类问题</li>
</ol>
<p>参考 <a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/427.html">wowo 文章1</a><br>参考 <a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/426.html">wowo 文章2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-23T11:00:00.000Z" title="1/23/2021, 7:00:00 PM">2021-01-23</time>发表</span><span class="level-item"><time dateTime="2021-01-21T16:58:39.853Z" title="1/22/2021, 12:58:39 AM">2021-01-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">几秒读完 (大约6个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/23/crash%E4%B8%93%E9%A2%98/x86%20%E5%B9%B3%E5%8F%B0%E5%B8%B8%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8%E5%92%8C%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/">x86 平台常用寄存器和函数调用分析</a></h1><div class="content"><p>后续填坑。。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-23T11:00:00.000Z" title="1/23/2021, 7:00:00 PM">2021-01-23</time>发表</span><span class="level-item"><time dateTime="2021-01-22T08:51:22.401Z" title="1/22/2021, 4:51:22 PM">2021-01-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">14 分钟读完 (大约2161个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/23/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/%E4%BD%BF%E8%83%BDlock_dep%E8%A7%A3%E5%86%B3%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/">使能lock_dep解决死锁问题</a></h1><div class="content"><p>lockdep 就是 <code>lock dependencies</code> 缩写，翻译是 <code>锁依赖</code>。</p>
<h2 id="如何使能-lockdep"><a href="#如何使能-lockdep" class="headerlink" title="如何使能 lockdep"></a>如何使能 lockdep</h2><p>在 <code>make menuconfig</code> 使能 <code>lockdep</code> 之后，会自动增加如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;CONFIG_LOCKUP_DETECTOR&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_SOFTLOCKUP_DETECTOR&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC_VALUE&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_HARDLOCKUP_DETECTOR_PERF&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_HARDLOCKUP_DETECTOR&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_HARDLOCKUP_PANIC&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_HARDLOCKUP_PANIC_VALUE&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br></pre></td></tr></table></figure>
<p>配置之后重新编译运行，会发现在 <code>/proc/lockdep</code> 目录下多出几个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;lock_stat--------置位则可以查看&#x2F;proc&#x2F;lock_stat统计信息，清楚则关闭lockdep统计信息。</span><br><span class="line">&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;max_lock_depth---</span><br><span class="line">&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;prove_locking</span><br><span class="line">&#x2F;proc&#x2F;locks</span><br><span class="line">&#x2F;proc&#x2F;lock_stat-------------------关于锁的使用统计信息</span><br><span class="line">&#x2F;proc&#x2F;lockdep---------------------存在依赖关系的锁</span><br><span class="line">&#x2F;proc&#x2F;lockdep_stats---------------存在依赖关系锁的统计信息</span><br><span class="line">&#x2F;proc&#x2F;lockdep_chains--------------依赖关系锁链表</span><br></pre></td></tr></table></figure>

<h2 id="lockdep-原理"><a href="#lockdep-原理" class="headerlink" title="lockdep 原理"></a>lockdep 原理</h2><p>常见的死锁有如下两种：</p>
<ol>
<li>递归死锁：中断等延迟操作中使用了锁，和外面的锁构成了递归死锁。</li>
<li>AB-BA死锁：多个锁因处理不当而引发死锁，多个内核路径上的所处理顺序不一致也会导致死锁。</li>
</ol>
<p>Linux内核提供死锁调试模块Lockdep，跟踪每个锁的自身状态和各个锁之间的依赖关系，经过一系列的验<br>证规则来确保锁之间依赖关系是正确的。</p>
<p>先看代码注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * this code maps all the lock dependencies as they occur in a live kernel</span><br><span class="line"> * and will warn about the following classes of locking bugs:</span><br><span class="line"> *</span><br><span class="line"> * - lock inversion scenarios</span><br><span class="line"> * - circular lock dependencies</span><br><span class="line"> * - hardirq&#x2F;softirq safe&#x2F;unsafe locking bugs</span><br><span class="line"> *</span><br><span class="line"> * Bugs are reported even if the current locking scenario does not cause</span><br><span class="line"> * any deadlock at this point.</span><br><span class="line"> *</span><br><span class="line"> * I.e. if anytime in the past two locks were taken in a different order,</span><br><span class="line"> * even if it happened for another task, even if those were different</span><br><span class="line"> * locks (but of the same class as this lock), this code will detect it.</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<p>翻译就是可以解决如下的问题</p>
<ol>
<li>锁定反转方案 – ABBA</li>
<li>循环锁依赖性 – 递归锁</li>
<li>hardirq / softirq安全/不安全的锁定错误</li>
</ol>
<h2 id="lockdep-案例"><a href="#lockdep-案例" class="headerlink" title="lockdep 案例"></a>lockdep 案例</h2><p>写了一个<code>ABBA型</code> 基于 spinlock的 deadlock demo。参考 <a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/lock_race/lockdep_test/lockdep_test.c">代码</a><br>其实这个demo 会触发多个问题</p>
<ol>
<li>deadlock 被检测出来。</li>
<li>由于是基于 <code>spinlock</code> 的，所以在等待lock的时候一直处于<code>spin</code>，导致 <code>rcu stall</code></li>
<li>等待 <code>20s</code> 之后，由于基于 <code>spinlock</code>的，所以两个cpu一直未调度，发生 <code>soft lockup</code>，然后 panic.</li>
</ol>
<p>编译安装之后，kmsg 显示如下问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[  147.475517] lockdep_test: loading out-of-tree module taints kernel.</span><br><span class="line">[  157.769995]</span><br><span class="line">[  157.770640] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[  157.770683] WARNING: possible circular locking dependency detected</span><br><span class="line">[  157.770683] 5.11.0-rc4+ #5 Tainted: G           O</span><br><span class="line">[  157.770683] ------------------------------------------------------</span><br><span class="line">[  157.770683] krace_0&#x2F;3755 is trying to acquire lock:</span><br><span class="line">[  157.770683] ffffffffc0527468 (&amp;g_lockdep_test.lock_A)&#123;+.+.&#125;-&#123;2:2&#125;, at: klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]</span><br><span class="line">               but task is already holding lock:</span><br><span class="line">[  157.770683] ffffffffc05274a8 (&amp;g_lockdep_test.lock_B)&#123;+.+.&#125;-&#123;2:2&#125;, at: klockdep_test_BA+0x18&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]</span><br><span class="line">               which lock already depends on the new lock.</span><br><span class="line"></span><br><span class="line">[  157.770683]</span><br><span class="line">               the existing dependency chain (in reverse order) is:</span><br><span class="line">[  157.770683]</span><br><span class="line">               -&gt; #1 (&amp;g_lockdep_test.lock_B)&#123;+.+.&#125;-&#123;2:2&#125;:</span><br><span class="line">[  157.770683]        _raw_spin_lock+0x27&#x2F;0x40</span><br><span class="line">[  157.770683]        klockdep_test_AB+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[  157.770683]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[  157.770683]</span><br><span class="line">               -&gt; #0 (&amp;g_lockdep_test.lock_A)&#123;+.+.&#125;-&#123;2:2&#125;:</span><br><span class="line">[  157.770683]        __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[  157.770683]        lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[  157.770683]        _raw_spin_lock+0x27&#x2F;0x40</span><br><span class="line">[  157.770683]        klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[  157.770683]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[  157.770683]</span><br><span class="line">               other info that might help us debug this:</span><br><span class="line"></span><br><span class="line">[  157.770683]  Possible unsafe locking scenario:</span><br><span class="line"></span><br><span class="line">[  157.770683]        CPU0                    CPU1</span><br><span class="line">[  157.770683]        ----                    ----</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_A);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_A);</span><br><span class="line">[  157.770683]</span><br><span class="line">                *** DEADLOCK ***</span><br><span class="line">[  157.770683] 1 lock held by krace_0&#x2F;3755:</span><br><span class="line">[  157.770683]  #0: ffffffffc05274a8 (&amp;g_lockdep_test.lock_B)&#123;+.+.&#125;-&#123;2:2&#125;, at: klockdep_test_BA+0x18&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]</span><br><span class="line">               stack backtrace:</span><br><span class="line">[  157.770683] CPU: 1 PID: 3755 Comm: krace_0 Kdump: loaded Tainted: G           O      5.11.0-rc4+ #5</span><br><span class="line">[  157.770683] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1 04&#x2F;01&#x2F;2014</span><br><span class="line">[  157.770683] Call Trace:</span><br><span class="line">[  157.770683]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[  157.770683]  check_noncircular+0xfe&#x2F;0x110</span><br><span class="line">[  157.770683]  ? find_held_lock+0x2b&#x2F;0x80</span><br><span class="line">[  157.770683]  __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[  157.770683]  lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[  157.770683]  ? klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  ? klockdep_test_AB+0x80&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  _raw_spin_lock+0x27&#x2F;0x40</span><br><span class="line">[  157.770683]  ? klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[  157.770683]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[  157.770683]  ret_from_fork+0x22&#x2F;0x30</span><br></pre></td></tr></table></figure>

<p>其中可以很明显看到如下提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[  157.770683]        CPU0                    CPU1</span><br><span class="line">[  157.770683]        ----                    ----</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_A);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_A);</span><br></pre></td></tr></table></figure>

<p>这个提示简直无敌，完美显示了 <code>deadlock</code> 的原因</p>
<p>写了一个<code>ABBA型</code> 基于 mutex 的 deadlock demo。参考 <a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/lock_race/lockdep_test_mutex/lockdep_test_mutex.c">代码</a><br>其实这个demo 会触发多个问题</p>
<ol>
<li>deadlock 被检测出来。</li>
<li>等待 <code>120s</code> 之后，由于基于 <code>mutex</code>的，所以发生死锁的俩线程都是 <code>D状态</code>，所以检测到发生 <code>hung_task</code>，然后 panic.</li>
</ol>
<p>为啥 <code>mutex</code> 的waiter会 处于 <code>D状态</code> ？看看代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static noinline void __sched</span><br><span class="line">__mutex_lock_slowpath(struct mutex *lock)</span><br><span class="line">&#123;</span><br><span class="line">	__mutex_lock(lock, TASK_UNINTERRUPTIBLE, 0, NULL, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __sched mutex_lock(struct mutex *lock)</span><br><span class="line">&#123;</span><br><span class="line">	if (!__mutex_trylock_fast(lock))</span><br><span class="line">		__mutex_lock_slowpath(lock);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(mutex_lock);</span><br></pre></td></tr></table></figure>
<p>发现等待 mutex的线程都会被设置成 <code>TASK_UNINTERRUPTIBLE</code>，也就是 <code>D状态</code>。</p>
<p>也可以通过 hung_task 之后panic 的现场看出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; ps | grep UN</span><br><span class="line">   3193      2   2  ffff9127bb82b240  UN   0.0       0      0  [krace_0]</span><br><span class="line">   3194      2   0  ffff9127c3458040  UN   0.0       0      0  [krace_1]</span><br><span class="line">crash&gt; bt 3193</span><br><span class="line">PID: 3193   TASK: ffff9127bb82b240  CPU: 2   COMMAND: &quot;krace_0&quot;</span><br><span class="line"> #0 [ffffb557007efd78] __schedule at ffffffff8c319af2</span><br><span class="line"> #1 [ffffb557007efe08] schedule at ffffffff8c31a1e6</span><br><span class="line"> #2 [ffffb557007efe20] schedule_preempt_disabled at ffffffff8c31a53c</span><br><span class="line"> #3 [ffffb557007efe28] __mutex_lock at ffffffff8c31bcd5</span><br><span class="line"> #4 [ffffb557007eff08] klockdep_test_mutex_BA at ffffffffc02990b2 [lockdep_test_mutex]</span><br><span class="line"> #5 [ffffb557007eff10] kthread at ffffffff8b6930da</span><br><span class="line"> #6 [ffffb557007eff50] ret_from_fork at ffffffff8b601ae2</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; bt 3194</span><br><span class="line">PID: 3194   TASK: ffff9127c3458040  CPU: 0   COMMAND: &quot;krace_1&quot;</span><br><span class="line"> #0 [ffffb557004c3d78] __schedule at ffffffff8c319af2</span><br><span class="line"> #1 [ffffb557004c3e08] schedule at ffffffff8c31a1e6</span><br><span class="line"> #2 [ffffb557004c3e20] schedule_preempt_disabled at ffffffff8c31a53c</span><br><span class="line"> #3 [ffffb557004c3e28] __mutex_lock at ffffffff8c31bcd5</span><br><span class="line"> #4 [ffffb557004c3f08] klockdep_test_mutex_AB at ffffffffc0299032 [lockdep_test_mutex]</span><br><span class="line"> #5 [ffffb557004c3f10] kthread at ffffffff8b6930da</span><br><span class="line"> #6 [ffffb557004c3f50] ret_from_fork at ffffffff8b601ae2</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>krace_0</code> <code>krace_1</code> 线程都是处于 <code>UN</code> 状态，这也导致此时系统负载有<code>2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; sys</span><br><span class="line">      KERNEL: vmlinux</span><br><span class="line">    DUMPFILE: dump.202101221553  [PARTIAL DUMP]</span><br><span class="line">        CPUS: 4</span><br><span class="line">        DATE: Fri Jan 22 15:53:16 CST 2021</span><br><span class="line">      UPTIME: 00:04:06</span><br><span class="line">LOAD AVERAGE: 1.96, 1.10, 0.46</span><br></pre></td></tr></table></figure>

<p>再看一下 检测到的死锁日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[   60.151205] lockdep_test_mutex: loading out-of-tree module taints kernel.</span><br><span class="line">[   70.216063]</span><br><span class="line">[   70.216623] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   70.216866] WARNING: possible circular locking dependency detected</span><br><span class="line">[   70.216866] 5.11.0-rc4+ #5 Tainted: G           O</span><br><span class="line">[   70.216866] ------------------------------------------------------</span><br><span class="line">[   70.216866] krace_0&#x2F;3193 is trying to acquire lock:</span><br><span class="line">[   70.216866] ffffffffc029b4b8 (&amp;g_lockdep_test_mutex.lock_A)&#123;+.+.&#125;-&#123;3:3&#125;, at: klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]</span><br><span class="line">               but task is already holding lock:</span><br><span class="line">[   70.216866] ffffffffc029b548 (&amp;g_lockdep_test_mutex.lock_B)&#123;+.+.&#125;-&#123;3:3&#125;, at: klockdep_test_mutex_BA+0x1a&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]</span><br><span class="line">               which lock already depends on the new lock.</span><br><span class="line"></span><br><span class="line">[   70.216866]</span><br><span class="line">               the existing dependency chain (in reverse order) is:</span><br><span class="line">[   70.216866]</span><br><span class="line">               -&gt; #1 (&amp;g_lockdep_test_mutex.lock_B)&#123;+.+.&#125;-&#123;3:3&#125;:</span><br><span class="line">[   70.216866]        __mutex_lock+0x8d&#x2F;0x920</span><br><span class="line">[   70.216866]        klockdep_test_mutex_AB+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[   70.216866]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   70.216866]</span><br><span class="line">               -&gt; #0 (&amp;g_lockdep_test_mutex.lock_A)&#123;+.+.&#125;-&#123;3:3&#125;:</span><br><span class="line">[   70.216866]        __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[   70.216866]        lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[   70.216866]        __mutex_lock+0x8d&#x2F;0x920</span><br><span class="line">[   70.216866]        klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[   70.216866]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   70.216866]</span><br><span class="line">               other info that might help us debug this:</span><br><span class="line"></span><br><span class="line">[   70.216866]  Possible unsafe locking scenario:</span><br><span class="line"></span><br><span class="line">[   70.216866]        CPU0                    CPU1</span><br><span class="line">[   70.216866]        ----                    ----</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_A);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_A);</span><br><span class="line">[   70.216866]</span><br><span class="line">                *** DEADLOCK ***</span><br><span class="line"></span><br><span class="line">[   70.216866] 1 lock held by krace_0&#x2F;3193:</span><br><span class="line">[   70.216866]  #0: ffffffffc029b548 (&amp;g_lockdep_test_mutex.lock_B)&#123;+.+.&#125;-&#123;3:3&#125;, at: klockdep_test_mutex_BA+0x1a&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]</span><br><span class="line">               stack backtrace:</span><br><span class="line">[   70.216866] CPU: 2 PID: 3193 Comm: krace_0 Kdump: loaded Tainted: G           O      5.11.0-rc4+ #5</span><br><span class="line">[   70.216866] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   70.216866] Call Trace:</span><br><span class="line">[   70.216866]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[   70.216866]  check_noncircular+0xfe&#x2F;0x110</span><br><span class="line">[   70.216866]  __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[   70.216866]  lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? lockdep_hardirqs_on_prepare+0xd4&#x2F;0x170</span><br><span class="line">[   70.216866]  ? _raw_spin_unlock_irqrestore+0x34&#x2F;0x40</span><br><span class="line">[   70.216866]  __mutex_lock+0x8d&#x2F;0x920</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? find_held_lock+0x2b&#x2F;0x80</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? __next_timer_interrupt+0x100&#x2F;0x100</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_AB+0x80&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_AB+0x80&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[   70.216866]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[   70.216866]  ret_from_fork+0x22&#x2F;0x30</span><br></pre></td></tr></table></figure>

<p>同样也是 给出了很详细出错位置，对于找出问题代码一如反掌。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[   70.216866]        CPU0                    CPU1</span><br><span class="line">[   70.216866]        ----                    ----</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_A);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_A);</span><br></pre></td></tr></table></figure>

<h2 id="lockdep-代码"><a href="#lockdep-代码" class="headerlink" title="lockdep 代码"></a>lockdep 代码</h2><p>之后填坑</p>
<h2 id="死锁带来的影响"><a href="#死锁带来的影响" class="headerlink" title="死锁带来的影响"></a>死锁带来的影响</h2><p>对于线程自身</p>
<ol>
<li><code>spinlock</code> 的死锁可以带来 线程一直在<code>spin</code>，占用cpu且无法恢复.</li>
<li><code>mutex</code> <code>semaphore</code> <code>rwsem</code> 的死锁会在<code>slowpath</code> 中让线程进入了<br><code>TASK_UNINTERRUPTIBLE</code> 状态，导致不响应外部信号，也无法使用 <code>kill</code> 去杀死</li>
</ol>
<p>对于系统</p>
<ol>
<li><code>spinlock</code> 的死锁可以带来 <code>rcu stall</code> <code>soft lockup</code> <code>hard lockup</code>问题，如果对应项<br>设置了 panic 选项，就会导致 kernel panic.</li>
<li><code>mutex</code> <code>semaphore</code> <code>rwsem</code> 的死锁会带来系统的 load升高，因为都在 <code>slowpath</code> 中让线<br>程进入了<code>TASK_UNINTERRUPTIBLE</code> 状态，会被统计为系统负载，最后会导致 hung_task 发生，如果对应项设置了 panic 选项，就会导致 kernel panic.</li>
</ol>
<p>不同锁进入slowpath的行为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mutex:</span><br><span class="line">static noinline void __sched</span><br><span class="line">__mutex_lock_slowpath(struct mutex *lock)</span><br><span class="line">&#123;</span><br><span class="line">	__mutex_lock(lock, TASK_UNINTERRUPTIBLE, 0, NULL, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">semaphore:</span><br><span class="line">static noinline void __sched __down(struct semaphore *sem)</span><br><span class="line">&#123;</span><br><span class="line">	__down_common(sem, TASK_UNINTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">semaphore:</span><br><span class="line">static noinline void __sched __down(struct semaphore *sem)</span><br><span class="line">&#123;</span><br><span class="line">	__down_common(sem, TASK_UNINTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rwsem:</span><br><span class="line">static inline void __down_write(struct rw_semaphore *sem)</span><br><span class="line">&#123;</span><br><span class="line">	__down_write_common(sem, TASK_UNINTERRUPTIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以参考：<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20892822/how-to-use-lockdep-feature-in-linux-kernel-for-deadlock-detection">stack overflow提问</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/arnoldlu/p/8580387.html">博客园文章</a><br><a target="_blank" rel="noopener" href="http://kernel.meizu.com/linux-dead-lock-detect-lockdep.html">魅族内核团队文章</a><br><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/locking/">内核文档</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-21T07:00:00.000Z" title="1/21/2021, 3:00:00 PM">2021-01-21</time>发表</span><span class="level-item"><time dateTime="2021-01-21T11:15:12.397Z" title="1/21/2021, 7:15:12 PM">2021-01-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">8 分钟读完 (大约1209个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/21/crash%E4%B8%93%E9%A2%98/%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E7%A9%BA%E6%8C%87%E9%92%88oops/">最简单的空指针oops</a></h1><div class="content"><p>只是做一个记录，为了演示最简单的空指针case, 写了一个demo, 可以参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/null_pointer/01_null_pointer/01_null_pointer.c">github 代码</a></p>
<h2 id="用-crash-分析"><a href="#用-crash-分析" class="headerlink" title="用 crash 分析"></a>用 <code>crash</code> 分析</h2><p><code>insmod</code> 出错之后已经生成了相关 <code>dump</code>文件。<br>下面直接使用 <code>crash</code> 工具分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash&#x2F;202101211201# sudo crash vmlinux dump</span><br><span class="line">crash 7.2.9++</span><br><span class="line">GNU gdb (GDB) 7.6</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;...</span><br><span class="line">WARNING: kernel relocated [704MB]: patching 137170 gdb minimal_symbol values</span><br><span class="line"></span><br><span class="line">      KERNEL: vmlinux</span><br><span class="line">    DUMPFILE: dump.202101211201  [PARTIAL DUMP]</span><br><span class="line">        CPUS: 4</span><br><span class="line">        DATE: Thu Jan 21 12:00:56 CST 2021</span><br><span class="line">      UPTIME: 00:12:53</span><br><span class="line">LOAD AVERAGE: 0.16, 0.11, 0.10</span><br><span class="line">       TASKS: 454</span><br><span class="line">    NODENAME: rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">     RELEASE: 5.11.0-rc4+</span><br><span class="line">     VERSION: #5 SMP Wed Jan 20 20:41:47 CST 2021</span><br><span class="line">     MACHINE: x86_64  (3692 Mhz)</span><br><span class="line">      MEMORY: 2 GB</span><br><span class="line">       PANIC: &quot;Oops: 0002 [#1] SMP NOPTI&quot; (check log for details)</span><br><span class="line">         PID: 3605</span><br><span class="line">     COMMAND: &quot;krace_thread&quot;</span><br><span class="line">        TASK: ffffa1b006754b40  [THREAD_INFO: ffffa1b006754b40]</span><br><span class="line">         CPU: 2</span><br><span class="line">       STATE: TASK_RUNNING (PANIC)</span><br><span class="line"></span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到 发生问题的 kernel 版本是 <code>5.11.0-rc4+</code>，编译时间是 <code>#5 SMP Wed Jan 20 20:41:47 CST 2021</code>，内存大小是 <code>2G</code>，出问题时刻的负载是<code>0.16, 0.11, 0.10</code></p>
<p>PANIC 原因是<code>&quot;Oops: 0002 [#1] SMP NOPTI&quot; (check log for details)</code>，CPU:2 上的TASK（krace_thread-3605）: <code>ffffa1b006754b40</code>发生了 oops，具体原因需要看 日志来得到。</p>
<h2 id="bt-查看出问题的task"><a href="#bt-查看出问题的task" class="headerlink" title="bt 查看出问题的task"></a><code>bt</code> 查看出问题的task</h2><p>crash 运行之后默认的task是出问题的task，可以通过 <code>set</code> 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; set</span><br><span class="line">    PID: 3605</span><br><span class="line">COMMAND: &quot;krace_thread&quot;</span><br><span class="line">   TASK: ffffa1b006754b40  [THREAD_INFO: ffffa1b006754b40]</span><br><span class="line">    CPU: 2</span><br><span class="line">  STATE: TASK_RUNNING (PANIC)</span><br></pre></td></tr></table></figure>

<p>bt 可以查看当前追踪的task的 <code>backtrace</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; bt</span><br><span class="line">PID: 3605   TASK: ffffa1b006754b40  CPU: 2   COMMAND: &quot;krace_thread&quot;</span><br><span class="line"> #0 [ffffbbbf004ebc40] machine_kexec at ffffffffad04d87c</span><br><span class="line"> #1 [ffffbbbf004ebc88] __crash_kexec at ffffffffad1283b8</span><br><span class="line"> #2 [ffffbbbf004ebd50] crash_kexec at ffffffffad1290d0</span><br><span class="line"> #3 [ffffbbbf004ebd60] oops_end at ffffffffad021d75</span><br><span class="line"> #4 [ffffbbbf004ebd80] no_context at ffffffffad0570e0</span><br><span class="line"> #5 [ffffbbbf004ebdf0] __bad_area_nosemaphore at ffffffffad0572c7</span><br><span class="line"> #6 [ffffbbbf004ebe38] exc_page_fault at ffffffffadd16b67</span><br><span class="line"> #7 [ffffbbbf004ebe60] asm_exc_page_fault at ffffffffade00ace</span><br><span class="line"> #8 [ffffbbbf004ebee8] create_oops at ffffffffc0371027 [01_null_pointer]</span><br><span class="line"> #9 [ffffbbbf004ebf10] kthread at ffffffffad0930da</span><br><span class="line">#10 [ffffbbbf004ebf50] ret_from_fork at ffffffffad001ae2</span><br></pre></td></tr></table></figure>
<p><code>bt -c 1</code>： 可以查看 cpu:1 上当前运行的线程的backtrace<br><code>bt -a</code>  ： 可以查看 当前所有 cpu上运行的线程的backtrace</p>
<p>这个case 十分显然，是 <code>create_oops</code> 这里出现了问题。</p>
<h2 id="dis-查看bug地址"><a href="#dis-查看bug地址" class="headerlink" title="dis 查看bug地址"></a>dis 查看bug地址</h2><p><code>dis</code> 是 disassemble 反汇编的缩写，可以</p>
<ol>
<li>查看出问题 <code>text</code> 地址内容</li>
<li>某个函数 <code>symbol</code> 符号内容</li>
<li>某个函数 <code>symbol</code> 符号 + 偏移的内容</li>
<li>某个符号 或者 <code>text</code> 与 代码行显示在一起（如果是<code>module</code> 中crash需要加载 module.ko）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; dis ffffffffc0371027</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; dis create_oops</span><br><span class="line">0xffffffffc0371000 &lt;create_oops&gt;:       mov    $0x1388,%edi</span><br><span class="line">0xffffffffc0371005 &lt;create_oops+5&gt;:     callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">0xffffffffc037100a &lt;create_oops+10&gt;:    mov    $0xffffffffc037203c,%rdi</span><br><span class="line">0xffffffffc0371011 &lt;create_oops+17&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">0xffffffffc0371016 &lt;create_oops+22&gt;:    mov    $0x1388,%edi</span><br><span class="line">0xffffffffc037101b &lt;create_oops+27&gt;:    callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">0xffffffffc0371020 &lt;create_oops+32&gt;:    mov    $0xffffffffc037204f,%rdi</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">0xffffffffc0371032 &lt;create_oops+50&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">0xffffffffc0371037 &lt;create_oops+55&gt;:    xor    %eax,%eax</span><br><span class="line">0xffffffffc0371039 &lt;create_oops+57&gt;:    retq</span><br><span class="line">crash&gt; dis create_oops+39</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

<p>直接可以看出问题是，将立即数<code>$0x0</code> 赋值到 地址<code>0x0</code>中，所以直接 oops了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br></pre></td></tr></table></figure>


<p>但是在哪一行呢，这就需要加载 ko文件了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; lsmod</span><br><span class="line">     MODULE       NAME              SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0373000  01_null_pointer  16384  (not loaded)  [CONFIG_KALLSYMS]</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; mod -s 01_null_pointer &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.ko</span><br><span class="line">     MODULE       NAME              SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0373000  01_null_pointer  16384  &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.ko</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; lsmod</span><br><span class="line">     MODULE       NAME              SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0373000  01_null_pointer  16384  &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.ko</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

<p>加载 ko文件之后，直接 <code>dis -l</code> 反汇编 出问题的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; dis -l create_oops</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 12</span><br><span class="line">0xffffffffc0371000 &lt;create_oops&gt;:       mov    $0x1388,%edi</span><br><span class="line">0xffffffffc0371005 &lt;create_oops+5&gt;:     callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 13</span><br><span class="line">0xffffffffc037100a &lt;create_oops+10&gt;:    mov    $0xffffffffc037203c,%rdi</span><br><span class="line">0xffffffffc0371011 &lt;create_oops+17&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 14</span><br><span class="line">0xffffffffc0371016 &lt;create_oops+22&gt;:    mov    $0x1388,%edi</span><br><span class="line">0xffffffffc037101b &lt;create_oops+27&gt;:    callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 16</span><br><span class="line">0xffffffffc0371020 &lt;create_oops+32&gt;:    mov    $0xffffffffc037204f,%rdi</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 17</span><br><span class="line">0xffffffffc0371032 &lt;create_oops+50&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 18</span><br><span class="line">0xffffffffc0371037 &lt;create_oops+55&gt;:    xor    %eax,%eax</span><br><span class="line">0xffffffffc0371039 &lt;create_oops+57&gt;:    retq</span><br></pre></td></tr></table></figure>

<p>直接定位到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">01_null_pointer.c: 16</span><br><span class="line">0xffffffffc0371020 &lt;create_oops+32&gt;:    mov    $0xffffffffc037204f,%rdi</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br></pre></td></tr></table></figure>

<p>代码中看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(int *)0 &#x3D; 0;</span><br></pre></td></tr></table></figure>

<p>问题很快解决了。</p>
<h2 id="试着查看x86-如何调用函数传参的"><a href="#试着查看x86-如何调用函数传参的" class="headerlink" title="试着查看x86 如何调用函数传参的"></a>试着查看x86 如何调用函数传参的</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 12</span><br><span class="line">0xffffffffc0371000 &lt;create_oops&gt;:       mov    $0x1388,%edi</span><br><span class="line">0xffffffffc0371005 &lt;create_oops+5&gt;:     callq  0xffffffffad104b80 &lt;msleep&gt;</span><br></pre></td></tr></table></figure>

<p>对应代码是，<code>0x1388</code> 就是十六进制的 <code>5000</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msleep(5000);</span><br></pre></td></tr></table></figure>
<p>是不是第一个整形参数是存在 <code>edi</code> 寄存器中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 13</span><br><span class="line">0xffffffffc037100a &lt;create_oops+10&gt;:    mov    $0xffffffffc037203c,%rdi</span><br><span class="line">0xffffffffc0371011 &lt;create_oops+17&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br></pre></td></tr></table></figure>

<p>对应的代码是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(&quot;create_oops start\n&quot;);</span><br></pre></td></tr></table></figure>

<p><code>0xffffffffc037203c</code> 是啥呢？可以使用 <code>rd</code> 命令读取一下，原来是字符串的起始的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; rd 0xffffffffc037203c 4</span><br><span class="line">ffffffffc037203c:  6f5f657461657263 726174732073706f   create_oops star</span><br><span class="line">ffffffffc037204c:  7461657263000a74 652073706f6f5f65   t..create_oops e</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>
<p>是不是 第一个地址型参数是存放在 <code>rdi</code> 中的呢？</p>
<p>后面会用不同个数参数，不同类型参数的函数 crash，来实验一下这个是不是对～</p>
<p>找到<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27339191">一篇讲解x86-64寄存器和函数调用的文章</a>，上面说的猜想就是扯淡。。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-17T11:00:00.000Z" title="1/17/2021, 7:00:00 PM">2021-01-17</time>发表</span><span class="level-item"><time dateTime="2021-01-21T09:06:22.284Z" title="1/21/2021, 5:06:22 PM">2021-01-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">12 分钟读完 (大约1859个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/17/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/valgrind%20%E5%AE%9A%E4%BD%8D%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">valgrind 定位用户空间内存泄漏</a></h1><div class="content"><h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY"></a>WHY</h2><p>在实际开发中，某个应用程序如果存在内存泄露，且是长时间运行的程序，就会导致比较严重的后果。<br>在一些业务场景的长跑测试中，这些问题往往会充分暴露出来。</p>
<p>一般情况下这种内存泄漏都是以 OOM Kill 而结尾的。 kmsg log 往往只有 这个进程确实消耗了大量进<br>程的证据，但是无法确切知道是哪里的内存泄漏，这里就需要一个工具来帮助检测，如果是发生内存泄漏之后<br>仅仅通过人肉去分析代码，往往很困难。</p>
<p>valgrind 就是这样一款 强大的工具：</p>
<ol>
<li>检查用户空间内存泄漏</li>
<li>检查</li>
</ol>
<h2 id="valdrind-原理"><a href="#valdrind-原理" class="headerlink" title="valdrind 原理"></a>valdrind 原理</h2><h2 id="valdrind-安装，使用"><a href="#valdrind-安装，使用" class="headerlink" title="valdrind 安装，使用"></a>valdrind 安装，使用</h2><p>直接安装， ubuntu 官方软件源已经包含了，其他平台可以通过源码编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@100ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# sudo apt install valgrind</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following packages were automatically installed and are no longer required:</span><br><span class="line">  openbsd-inetd openjdk-11-jdk-headless tcpd update-inetd</span><br><span class="line">Use &#39;sudo apt autoremove&#39; to remove them.</span><br><span class="line">Suggested packages:</span><br><span class="line">  valgrind-dbg valgrind-mpi kcachegrind alleyoop valkyrie</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  valgrind</span><br><span class="line">0 upgraded, 1 newly installed, 0 to remove and 231 not upgraded.</span><br><span class="line">Need to get 20.3 MB of archives.</span><br><span class="line">After this operation, 90.0 MB of additional disk space will be used.</span><br><span class="line">Get:1 https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu focal-updates&#x2F;main amd64 valgrind amd64 1:3.15.0-1ubuntu9.1 [20.3 MB]</span><br><span class="line">48% [1 valgrind 12.2 MB&#x2F;20.3 MB 60%]</span><br><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# ls</span><br></pre></td></tr></table></figure>

<p>使用如下代码检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 3;</span><br><span class="line">        char *p &#x3D; NULL;</span><br><span class="line">        p &#x3D; malloc(1024 * 1024);</span><br><span class="line">        if (!p)</span><br><span class="line">                printf(&quot;malloc failed,just wait!!\n&quot;);</span><br><span class="line"></span><br><span class="line">        printf(&quot;malloc sucess,just wait!!\n&quot;);</span><br><span class="line"></span><br><span class="line">        while(i--) &#123;</span><br><span class="line">                usleep(1000 * 1000);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>对于 valgrind 不好的地方在于：</p>
<ol>
<li><p>对于想使用 valgrind来检查内存泄漏的业务来说，必须从开始 用valgrind 启动，意味着对于业务<br>需要重启。还有比如很难复现的内存泄漏，等你重启业务用 valgrind来启动，说不定又不复现了。。</p>
</li>
<li><p>对于 valgrind 启动的业务来说，会比直接启动有一些性能损失。</p>
</li>
</ol>
<h3 id="userspace-memleak-demo"><a href="#userspace-memleak-demo" class="headerlink" title="userspace memleak demo"></a>userspace memleak demo</h3><p>使用上面代码 直接用 <code>valgrind</code> 启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# valgrind .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Memcheck, a memory error detector</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Command: .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">malloc sucess,just wait!!</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; HEAP SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;     in use at exit: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;   total heap usage: 2 allocs, 1 frees, 1,049,600 bytes allocated</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; LEAK SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;    definitely lost: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;    still reachable: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;         suppressed: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Rerun with --leak-check&#x3D;full to see details of leaked memory</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>HEAP SUMMARY:</code> 中写了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;     in use at exit: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;   total heap usage: 2 allocs, 1 frees, 1,049,600 bytes allocated</span><br></pre></td></tr></table></figure>
<p>在进程退出时，仍然有 <code>1048576 bytes</code> 内存在使用中，这部分就是泄漏的内存。但是我们仍然不能确<br>定到底是哪里泄漏的内存，按照他的建议 加上 <code>-leak-check=full</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# valgrind  --leak-check&#x3D;full  .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Memcheck, a memory error detector</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Command: .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">malloc sucess,just wait!!</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; HEAP SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;     in use at exit: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;   total heap usage: 2 allocs, 1 frees, 1,049,600 bytes allocated</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D; 1,048,576 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    by 0x1091AD: main (in &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak&#x2F;a.out)</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; LEAK SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    definitely lost: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    still reachable: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;         suppressed: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span><br><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak#</span><br></pre></td></tr></table></figure>

<p>可以看到这次， <code>valgrind</code> 已经将泄漏的具体位置打印了出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2813434&#x3D; 1,048,576 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    by 0x1091AD: main (in &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak&#x2F;a.out)</span><br></pre></td></tr></table></figure>

<p>可以用 <code>gcc -g</code> 重新编译一下带上符号表信息，再次用 valgrind 定位，可以得到更详细信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2822695&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2822695&#x3D;&#x3D;    by 0x1091AD: main (user_space_memleak.c:9)</span><br></pre></td></tr></table></figure>
<p>这次直接将 在 哪个文件 哪一行都直接打印出来了。</p>
<h3 id="out-of-bounds-access-demo"><a href="#out-of-bounds-access-demo" class="headerlink" title="out of bounds access demo"></a>out of bounds access demo</h3><p>代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 3;</span><br><span class="line">        char *p &#x3D; NULL;</span><br><span class="line">        p &#x3D; malloc(1024);</span><br><span class="line">        if (!p)</span><br><span class="line">                printf(&quot;malloc failed,just wait!!\n&quot;);</span><br><span class="line"></span><br><span class="line">        printf(&quot;malloc sucess,just wait!!*(p + 10) &#x3D; %d\n&quot;, *(p + 10));</span><br><span class="line">        *(p + 1023) &#x3D; *(p + 1024);</span><br><span class="line">        *(p + 1024) &#x3D; 1;</span><br><span class="line">        while(i--) &#123;</span><br><span class="line">                usleep(1000 * 1000);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free(p);</span><br><span class="line">        free(p + 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>gcc -g</code> 编译之偶 用 <code>valgrind ./a.out</code> 跑一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;valgrind# valgrind .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Memcheck, a memory error detector</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Command: .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D; Use of uninitialised value of size 8</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    at 0x48B681B: _itoa_word (_itoa.c:179)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48D26F4: __vfprintf_internal (vfprintf-internal.c:1687)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48BCEBE: printf (printf.c:33)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x109225: main (out_of_bounds_access.c:13)</span><br><span class="line">malloc sucess,just wait!!</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid read of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109200: main (out_of_bounds_access.c:14)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid write of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109213: main (out_of_bounds_access.c:15)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D; Invalid free() &#x2F; delete &#x2F; delete[] &#x2F; realloc()</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10927F: main (out_of_bounds_access.c:21)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Address 0x4a4d041 is 1 bytes inside a block of size 1,024 free&#39;d</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10926F: main (out_of_bounds_access.c:20)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Block was alloc&#39;d at</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x1091ED: main (out_of_bounds_access.c:9)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; HEAP SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;     in use at exit: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;   total heap usage: 2 allocs, 3 frees, 2,048 bytes allocated</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; All heap blocks were freed -- no leaks are possible</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure>

<p>也是直接指出了 一次引用未初始化的内存, 两次越界访问, 一次非法 free：</p>
<ol>
<li><p>一次引用为初始化的内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D; Use of uninitialised value of size 8</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    at 0x48B681B: _itoa_word (_itoa.c:179)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48D26F4: __vfprintf_internal (vfprintf-internal.c:1687)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48BCEBE: printf (printf.c:33)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x109225: main (out_of_bounds_access.c:13)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一次越界读访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid read of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109200: main (out_of_bounds_access.c:14)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一次越界写访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid write of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109213: main (out_of_bounds_access.c:15)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一次 invaild free</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D; Invalid free() &#x2F; delete &#x2F; delete[] &#x2F; realloc()</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10927F: main (out_of_bounds_access.c:21)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Address 0x4a4d041 is 1 bytes inside a block of size 1,024 free&#39;d</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10926F: main (out_of_bounds_access.c:20)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Block was alloc&#39;d at</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x1091ED: main (out_of_bounds_access.c:9)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实际项目中应用的内存泄漏往往比这要复杂很多，可能代码考虑了正常情况下的 free，异常情况下没有<br>free等， <code>valgrind</code> 是很强大，有很多参数，但也只能帮助我们在出现问题之后定位，还是需要养成良<br>好的编码习惯，减少杜绝这类问题</p>
<p>参考<a target="_blank" rel="noopener" href="http://senlinzhan.github.io/2017/12/31/valgrind/">文章1</a><br>参考<a target="_blank" rel="noopener" href="https://www.cprogramming.com/debugging/valgrind.html">文章2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-16T11:00:00.000Z" title="1/16/2021, 7:00:00 PM">2021-01-16</time>发表</span><span class="level-item"><time dateTime="2022-01-10T03:42:41.835Z" title="1/10/2022, 11:42:41 AM">2022-01-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">4 分钟读完 (大约671个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/16/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/lock_stat/">lock_stat</a></h1><div class="content"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>lock_stat 是一款测试查看内核锁状态的工具，可以看出刚刚锁的争用繁忙情况和到底哪个路径上争用最多，从而找到性能优化的思路。<br>但是它会使内核的大小变大很多</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>使用之前需要使能<code>CONFIG_LOCK_STATS</code>，然后重新编译内核</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_LOCK_STAT:</span><br><span class="line">This feature enables tracking lock contention points</span><br><span class="line">For more details, see Documentation&#x2F;locking&#x2F;lockstat.rst</span><br><span class="line">This also enables lock events required by &quot;perf lock&quot;,</span><br><span class="line">subcommand of perf.</span><br><span class="line">If you want to use &quot;perf lock&quot;, you also need to turn on</span><br><span class="line">CONFIG_EVENT_TRACING.</span><br><span class="line"></span><br><span class="line">CONFIG_LOCK_STAT defines &quot;contended&quot; and &quot;acquired&quot; lock events.</span><br><span class="line">(CONFIG_LOCKDEP defines &quot;acquire&quot; and &quot;release&quot; events.)</span><br></pre></td></tr></table></figure>


<p>enable/disable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># echo 1 &gt;&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;lock_stat</span><br><span class="line"># echo 0 &gt;&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;lock_stat</span><br></pre></td></tr></table></figure>

<p>enable之后，数据在 <code>/proc/lock_stat</code>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;proc# head lock_stat</span><br><span class="line">lock_stat version 0.4</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">                              class name    con-bounces    contentions   waittime-min   waittime-max waittime-total   waittime-avg    acq-bounces   acquisitions   holdtime-min   holdtime-max holdtime-total   holdtime-avg</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                         &amp;dentry-&gt;d_lock:          6614           6650           0.06       23656.56      133605.67          20.09         282765        2391624           0.00       36452.61      529319.05           0.22</span><br><span class="line">                         ---------------</span><br><span class="line">                         &amp;dentry-&gt;d_lock           1703          [&lt;0000000060216fb7&gt;] lockref_get_not_dead+0xe&#x2F;0x30</span><br><span class="line">                         &amp;dentry-&gt;d_lock            747          [&lt;00000000bcf55138&gt;] __d_lookup+0x76&#x2F;0x160</span><br><span class="line">                         &amp;dentry-&gt;d_lock           3256          [&lt;000000009f49056e&gt;] dput+0x146&#x2F;0x380</span><br></pre></td></tr></table></figure>



<h2 id="格式解析"><a href="#格式解析" class="headerlink" title="格式解析"></a>格式解析</h2><p>看一份完整的log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">lock_stat version 0.4</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">                              class name    con-bounces    contentions   waittime-min   waittime-max waittime-total   waittime-avg    acq-bounces   acquisitions   holdtime-min   holdtime-max holdtime-total   holdtime-avg</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                         &amp;dentry-&gt;d_lock:          6606           6642           0.06       23656.56      133603.59          20.11         242023        1893479           0.00       36452.61      427674.18           0.23</span><br><span class="line">                         ---------------</span><br><span class="line">                         &amp;dentry-&gt;d_lock           1699          [&lt;0000000060216fb7&gt;] lockref_get_not_dead+0xe&#x2F;0x30</span><br><span class="line">                         &amp;dentry-&gt;d_lock            747          [&lt;00000000bcf55138&gt;] __d_lookup+0x76&#x2F;0x160</span><br><span class="line">                         &amp;dentry-&gt;d_lock           3254          [&lt;000000009f49056e&gt;] dput+0x146&#x2F;0x380</span><br><span class="line">                         &amp;dentry-&gt;d_lock            536          [&lt;000000003b543617&gt;] lockref_get+0x9&#x2F;0x20</span><br><span class="line">                         ---------------</span><br><span class="line">                         &amp;dentry-&gt;d_lock           1792          [&lt;0000000060216fb7&gt;] lockref_get_not_dead+0xe&#x2F;0x30</span><br><span class="line">                         &amp;dentry-&gt;d_lock            764          [&lt;00000000bcf55138&gt;] __d_lookup+0x76&#x2F;0x160</span><br><span class="line">                         &amp;dentry-&gt;d_lock           3082          [&lt;000000009f49056e&gt;] dput+0x146&#x2F;0x380</span><br><span class="line">                         &amp;dentry-&gt;d_lock            537          [&lt;000000003b543617&gt;] lockref_get+0x9&#x2F;0x20</span><br><span class="line"></span><br><span class="line">.............................................................................................................................................................................................................................</span><br><span class="line"></span><br><span class="line">                      &amp;mm-&gt;mmap_lock#2-W:           729           1328           0.12       56312.54      243027.65         183.00           3411         138648           0.10       34454.21     1951568.44          14.08</span><br><span class="line">                      &amp;mm-&gt;mmap_lock#2-R:           883           3858           0.13       11168.49      224472.15          58.18           4642         736764           0.08       79362.93     8514224.22          11.56</span><br><span class="line">                      ------------------</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2           3840          [&lt;00000000346dbc30&gt;] do_user_addr_fault+0x403&#x2F;0x690</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2             73          [&lt;000000007f3a53b5&gt;] mpol_rebind_mm+0x27&#x2F;0xf0</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2             13          [&lt;0000000004a222ed&gt;] __access_remote_vm+0x4d&#x2F;0x350</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2            378          [&lt;00000000e3ffe1c7&gt;] vm_mmap_pgoff+0xa9&#x2F;0x180</span><br><span class="line">                      ------------------</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2             94          [&lt;000000007f3a53b5&gt;] mpol_rebind_mm+0x27&#x2F;0xf0</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2             73          [&lt;00000000542c73e5&gt;] dup_mm+0xd5&#x2F;0x640</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2             18          [&lt;0000000015e7bc9a&gt;] dup_mm+0x9c&#x2F;0x640</span><br><span class="line">                        &amp;mm-&gt;mmap_lock#2              1          [&lt;00000000d9e9fd4c&gt;] prctl_set_mm+0xfa&#x2F;0x540</span><br><span class="line"></span><br><span class="line">.............................................................................................................................................................................................................................</span><br></pre></td></tr></table></figure>

<p>可以看出争用的路径，尝试获取锁次数，获取但是需要等待的次数，等待的最大、最小、平均时间等，持有锁的最大、最小、平均时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">                              class name    con-bounces    contentions   waittime-min   waittime-max waittime-total   waittime-avg    acq-bounces   acquisitions   holdtime-min   holdtime-max holdtime-total   holdtime-avg</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                           &amp;sem-&gt;waiters:             0              0           0.00           0.00           0.00           0.00             36            618           0.09           1.69         140.32           0.23</span><br><span class="line">                           callback_lock:             0              0           0.00           0.00           0.00           0.00             28            121           0.10           1.83          67.38           0.56</span><br><span class="line">                               pmus_lock:             0              0           0.00           0.00           0.00           0.00             20             30           0.00         200.86         231.73           7.72</span><br><span class="line">                           &amp;rsp-&gt;gp_wait:             0              0           0.00           0.00           0.00           0.00             79           1430           0.07           5.83         265.57           0.19</span><br><span class="line">                         &amp;cpuset_rwsem-W:             0              0           0.00           0.00           0.00           0.00              0            618           0.64       76605.59     1370704.10        2217.97</span><br><span class="line">                         &amp;cpuset_rwsem-R:             0              0           0.00           0.00           0.00           0.00              0            413           0.00          21.72         473.62           1.15</span><br><span class="line">         &quot;warn_unseeded_randomness&quot;.lock:             0              0           0.00           0.00           0.00           0.00              0              1           0.08           0.08           0.08           0.08</span><br><span class="line">                                &amp;c-&gt;lock:             0              0           0.00           0.00           0.00           0.00              0         201310           0.00         457.69       38407.85           0.19</span><br><span class="line">                         cgroup_idr_lock:             0              0           0.00           0.00           0.00           0.00             88           2148           0.09          11.15         939.40           0.44</span><br><span class="line">                             pin_fs_lock:             0              0           0.00           0.00           0.00           0.00             35          11335           0.00          15.48        1171.10           0.10</span><br><span class="line">                  tk_core.seq.seqcount-W:             0              0           0.00           0.00           0.00           0.00              0          10049           0.00         894.17       10020.79           1.00</span><br><span class="line">                  tk_core.seq.seqcount-R:             0              0           0.00           0.00           0.00           0.00              0        1126135           0.00        4915.37      105326.06           0.09</span><br><span class="line">                     cgroup_file_kn_lock:             0              0           0.00           0.00           0.00           0.00            197           1734           0.06          28.30        1893.58           1.09</span><br><span class="line">                  cpufreq_governor_mutex:             0              0           0.00           0.00           0.00           0.00              0              6           0.00           0.32           0.95           0.16</span><br><span class="line">               &amp;sb-&gt;s_type-&gt;i_lock_key#4:             0              0           0.00           0.00           0.00           0.00              2             69           0.05           0.80          16.10           0.23</span><br><span class="line">                         timekeeper_lock:             0              0           0.00           0.00           0.00           0.00           4065          10349           0.00        6268.82       26333.01           2.54</span><br><span class="line">                         resource_lock-W:             0              0           0.00           0.00           0.00           0.00              1            357           0.08           3.13          77.04           0.22</span><br><span class="line">                         resource_lock-R:             0              0           0.00           0.00           0.00           0.00             24           1601           0.08          29.63         682.58           0.43</span><br><span class="line">                 &amp;type-&gt;s_umount_key#4&#x2F;1:             0              0           0.00           0.00           0.00           0.00              0              1           6.78           6.78           6.78           6.78</span><br><span class="line">                            drivers_lock:             0              0           0.00           0.00           0.00           0.00              2              4           0.09           0.44           0.99           0.25</span><br><span class="line">                      pernet_ops_rwsem-W:             0              0           0.00           0.00           0.00           0.00              2            115           0.00         367.87        2408.12          20.94</span><br><span class="line">                      pernet_ops_rwsem-R:             0              0           0.00           0.00           0.00           0.00              5              5        1129.92       83930.70       94433.84       18886.77</span><br><span class="line">                      proc_subdir_lock-W:             0              0           0.00           0.00           0.00           0.00              4            586           0.00          29.05         195.94           0.33</span><br><span class="line">                      proc_subdir_lock-R:             0              0           0.00           0.00           0.00           0.00            129            963           0.00          13.59         394.16           0.41</span><br><span class="line">                          subsys mutex#2:             0              0           0.00           0.00           0.00           0.00              0              1           0.12           0.12           0.12           0.12</span><br></pre></td></tr></table></figure>
<p>这里可以看出系统中最繁忙的锁的数据统计信息</p>
<p>参考<a target="_blank" rel="noopener" href="https://source.android.google.cn/devices/tech/debug/ftrace?hl=zh-cn">使用 ftrace</a><br>参考<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/locking/lockstat.html">Lock Statistics</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-16T11:00:00.000Z" title="1/16/2021, 7:00:00 PM">2021-01-16</time>发表</span><span class="level-item"><time dateTime="2021-01-31T11:03:31.205Z" title="1/31/2021, 7:03:31 PM">2021-01-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">4 分钟读完 (大约585个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/16/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/page_owner%20%E5%AE%9A%E4%BD%8D%20buddy%20%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">page_owner 定位 buddy 内存泄漏</a></h1><div class="content"><h2 id="page-owner-原理"><a href="#page-owner-原理" class="headerlink" title="page_owner 原理"></a>page_owner 原理</h2><p>主要是通过给 每个分配出去的page 记录调用栈</p>
<h2 id="page-owner-使用"><a href="#page-owner-使用" class="headerlink" title="page_owner 使用"></a>page_owner 使用</h2><p>从mm/makefile 看，需要如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if [ $debug_page_owner &#x3D;&#x3D; 1 ]</span><br><span class="line">then</span><br><span class="line">## page_owner detect and panic start</span><br><span class="line">	echo &quot;CONFIG_STACKDEPOT&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_PAGE_EXTENSION&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_PAGE_OWNER&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">## page_owner detect and panic end</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>重新编译之后，启动qemu, 需要加上 <code>page_owner=on</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">	-kernel &#x2F;tmp&#x2F;bzImage \</span><br><span class="line">	-hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;stable_ubuntu.img \</span><br><span class="line">	-append &quot;root&#x3D;&#x2F;dev&#x2F;sda5 console&#x3D;ttyS0 crashkernel&#x3D;256M page_owner&#x3D;on&quot; \</span><br><span class="line">	-smp 4 \</span><br><span class="line">	-m 2048 \</span><br><span class="line">	--enable-kvm \</span><br><span class="line">	-net nic \</span><br><span class="line">	-net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">	--nographic \</span><br><span class="line">	-fsdev local,id&#x3D;fs1,path&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share,security_model&#x3D;none \</span><br><span class="line">	-device virtio-9p-pci,fsdev&#x3D;fs1,mount_tag&#x3D;host_share</span><br></pre></td></tr></table></figure>

<p>查看 <code>/sys/kernel/debug/page_owner</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cat page_owner | wc -l</span><br><span class="line">4363829</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>
<p>记录的信息非常多，然后需要一些工具来帮助检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cat page_owner &gt; &#x2F;home&#x2F;rlk&#x2F;page_owner.txt</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cp &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;resource_leak&#x2F;page_alloc_leak&#x2F;page_owner_sort &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">stable_kernel@kernel: ~# page_owner_sort .&#x2F;page_owner.txt sorted_page_owner.txt</span><br><span class="line">loaded 398724</span><br><span class="line">sorting ....</span><br><span class="line">culling</span><br><span class="line">stable_kernel@kernel: ~# cat sorted_page_owner.txt| wc -l</span><br><span class="line">5470295</span><br><span class="line">stable_kernel@kernel: ~# cat page_owner.txt| wc -l</span><br><span class="line">5472954</span><br><span class="line">stable_kernel@kernel: ~#</span><br></pre></td></tr></table></figure>

<p>看一下详细信息，<code>order</code> <code>mask</code>详细信息都有，对于debug 页面内存泄露用处很大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: ~# cat page_owner.txt | head -n 80</span><br><span class="line">Page allocated via order 2, mask 0xd20c1(GFP_DMA|__GFP_IO|__GFP_FS|__GFP_NOWARN|__GFP_NORETRY|__GFP_COMP|__GFP_NOMEMALLOC), pid 62, ts 121463164s</span><br><span class="line">PFN 1024 type Unmovable Block 2 type Unmovable Flags 0x10200(slab|head)</span><br><span class="line"> prep_new_page+0xcf&#x2F;0xf0</span><br><span class="line"> get_page_from_freelist+0xd8a&#x2F;0x1230</span><br><span class="line"> __alloc_pages_nodemask+0x170&#x2F;0x330</span><br><span class="line"> allocate_slab+0x24f&#x2F;0x2f0</span><br><span class="line"> ___slab_alloc+0x480&#x2F;0x6b0</span><br><span class="line"> __slab_alloc+0x50&#x2F;0x60</span><br><span class="line"> kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line"> sr_probe+0x213&#x2F;0x5e0</span><br><span class="line"> really_probe+0xd6&#x2F;0x2e0</span><br><span class="line"> driver_probe_device+0x4a&#x2F;0xa0</span><br><span class="line"> bus_for_each_drv+0x7c&#x2F;0xc0</span><br><span class="line"> __device_attach+0xe8&#x2F;0x150</span><br><span class="line"> bus_probe_device+0x9a&#x2F;0xb0</span><br><span class="line"> device_add+0x39b&#x2F;0x850</span><br><span class="line"> scsi_sysfs_add_sdev+0x89&#x2F;0x280</span><br><span class="line"> scsi_probe_and_add_lun+0x81e&#x2F;0xb90</span><br><span class="line"></span><br><span class="line">Page allocated via order 0, mask 0x0(), pid 1, ts 285099088 ns</span><br><span class="line">PFN 4096 type Unmovable Block 8 type Unmovable Flags 0x100000000000000()</span><br><span class="line"> register_early_stack+0x23&#x2F;0x60</span><br><span class="line"> init_page_owner+0x27&#x2F;0x290</span><br><span class="line"> kernel_init_freeable+0x158&#x2F;0x273</span><br><span class="line"> kernel_init+0x5&#x2F;0x101</span><br><span class="line"></span><br><span class="line">Page allocated via order 0, mask 0x0(), pid 1, ts 285099128 ns</span><br><span class="line">PFN 4097 type Unmovable Block 8 type Unmovable Flags 0x100000000000000()</span><br><span class="line"> register_early_stack+0x23&#x2F;0x60</span><br><span class="line"> init_page_owner+0x27&#x2F;0x290</span><br><span class="line"> kernel_init_freeable+0x158&#x2F;0x273</span><br><span class="line"> kernel_init+0x5&#x2F;0x101</span><br></pre></td></tr></table></figure>


<h2 id="page-owner-代码"><a href="#page-owner-代码" class="headerlink" title="page_owner 代码"></a>page_owner 代码</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个工具 运行 overhead较大，在线上可能不能开启，只能在debug时开启。</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/vm/page_owner.html">内核文档</a><br>参考<a target="_blank" rel="noopener" href="https://lwn.net/Articles/121656/">LWN 文章</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-16T11:00:00.000Z" title="1/16/2021, 7:00:00 PM">2021-01-16</time>发表</span><span class="level-item"><time dateTime="2021-01-31T09:47:29.081Z" title="1/31/2021, 5:47:29 PM">2021-01-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约1122个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/16/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/kmemleak%20%E5%AE%9A%E4%BD%8D%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">kmemleak 定位内存泄露</a></h1><div class="content"><h2 id="kmemleak-原理"><a href="#kmemleak-原理" class="headerlink" title="kmemleak 原理"></a>kmemleak 原理</h2><p>Basic Algorithm<br>The memory allocations via kmalloc(), vmalloc(), kmem_cache_alloc() and friends are traced and the pointers, together with additional information like size and stack trace, are stored in a rbtree. The corresponding freeing function calls are tracked and the pointers removed from the kmemleak data structures.</p>
<p>An allocated block of memory is considered orphan if no pointer to its start address or to any location inside the block can be found by scanning the memory (including saved registers). This means that there might be no way for the kernel to pass the address of the allocated block to a freeing function and therefore the block is considered a memory leak.</p>
<p>The scanning algorithm steps:</p>
<p>mark all objects as white (remaining white objects will later be considered orphan)<br>scan the memory starting with the data section and stacks, checking the values against the addresses stored in the rbtree. If a pointer to a white object is found, the object is added to the gray list<br>scan the gray objects for matching addresses (some white objects can become gray and added at the end of the gray list) until the gray set is finished<br>the remaining white objects are considered orphan and reported via /sys/kernel/debug/kmemleak<br>Some allocated memory blocks have pointers stored in the kernel’s internal data structures and they cannot be detected as orphans. To avoid this, kmemleak can also store the number of values pointing to an address inside the block address range that need to be found so that the block is not considered a leak. One example is __vmalloc().</p>
<h2 id="kmemleak-使用"><a href="#kmemleak-使用" class="headerlink" title="kmemleak 使用"></a>kmemleak 使用</h2><p>kmemleak 功能一开始默认是不开启的，需要配置如下选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if [ $debug_kmemleak &#x3D;&#x3D; 1 ]</span><br><span class="line">then</span><br><span class="line">## kmemleak detect and panic start</span><br><span class="line">	echo &quot;CONFIG_DEBUG_KMEMLEAK&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_DEBUG_KMEMLEAK_MEM_POOL_SIZE&#x3D;16000&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_DEBUG_KMEMLEAK_AUTO_SCAN&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_BOOTPARAM_HUNG_TASK_PANIC_VALUE&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">## kmemleak detect and panic end</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/resource_leak/kmemleak/kmemleak.c">test code</a></p>
<p>一开始遇到了无法安装的问题，后来发现是因为模块名 一样导致的问题。。<br>参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/16360689/invalid-parameters-error-when-trying-to-insert-module-that-accesses-exported-s">bug</a></p>
<p>触发开始扫描，这是个同步过程，内存比较大的话可能比较耗时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# echo scan &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;kmemleak</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>

<p>查看扫描结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cat kmemleak</span><br><span class="line">unreferenced object 0xffff8da0cac1c500 (size 32):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.798s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;00000000ae5c9724&gt;] 0xffffffffc030702d</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">unreferenced object 0xffff8da0d2371000 (size 1024):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.798s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;0000000079fd2c9c&gt;] 0xffffffffc030709c</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">unreferenced object 0xffff8da0ca534000 (size 4096):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.862s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;000000000526120c&gt;] 0xffffffffc0307130</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">unreferenced object 0xffffaa50801fb000 (size 4096):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.862s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    27 94 40 81 50 aa ff ff 27 04 00 00 00 00 00 00  &#39;.@.P...&#39;.......</span><br><span class="line">    7c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |...............</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;00000000854ee6a4&gt;] __vmalloc_node_range+0x236&#x2F;0x270</span><br><span class="line">    [&lt;00000000a355227b&gt;] __vmalloc_node+0x3f&#x2F;0x60</span><br><span class="line">    [&lt;0000000039b16a7e&gt;] 0xffffffffc0307149</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>
<p>可以比较清楚的看到 可能leak的 object点，且有详细调用栈，排查起来十分方便</p>
<p>清除之前扫描结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# echo clear  &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;kmemleak</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cat kmemleak</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>

<h2 id="kmemleak-代码"><a href="#kmemleak-代码" class="headerlink" title="kmemleak 代码"></a>kmemleak 代码</h2><p>后续填坑</p>
<h2 id="kmemleak-overhead"><a href="#kmemleak-overhead" class="headerlink" title="kmemleak overhead"></a>kmemleak overhead</h2><p>当然假设我们场景允许 使能kmemleak之后，重新编译 kernel，也要关心 kmemleak 所带来的<br>overhead是否允许，如果你的场景本来就是一个高负载的已经80%多的CPU使用率了，然后开启<br>kmemleak,是很可能出问题的。</p>
<p>在 公司 一款三核心的 Cortex-A7 的产品中测试结果：<br>        disabled        enabled     Per Core增加%       换算成单核CPU%<br>User:     3.54%          7.63%          4.09%            12.27%<br>Sys:      10.68%         23.76%         13.08%           38.7%<br>Idle:     84.6%          67.68%         17.02%           -50.76%</p>
<p>在我自己 qemu 虚拟机中测试结果是：</p>
<pre><code>    disabled        enabled     Per Core增加%       换算成单核CPU%</code></pre>
<p>User:     3.54%          7.63%                           12.27%<br>Sys:      10.68%         23.76%                          38.7%<br>Idle:     84.6%          67.68%                          -50.76%</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/dev-tools/kmemleak.html">内核文档</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-15T11:00:00.000Z" title="1/15/2021, 7:00:00 PM">2021-01-15</time>发表</span><span class="level-item"><time dateTime="2021-01-21T16:39:25.597Z" title="1/22/2021, 12:39:25 AM">2021-01-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">14 分钟读完 (大约2084个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/15/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/%E8%BF%9B%E7%A8%8B%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/">进程虚拟地址空间泄漏问题</a></h1><div class="content"><h2 id="虚拟内存泄漏"><a href="#虚拟内存泄漏" class="headerlink" title="虚拟内存泄漏"></a>虚拟内存泄漏</h2><p>一般情况我们说 内存泄漏，都是指的是物理内存泄漏，毕竟物理内存是实实在在的，一个进程泄漏了，那么整个系统中的可用内存就会变少。</p>
<p>但是linux的虚拟内存空间是各个进程之间相互隔离的，在arm64系统中 有 T,在 arm32系统中也有3G<br>多。但是否意味着这种 虚拟内存我们就不需要关心呢？</p>
<h2 id="尝试复现"><a href="#尝试复现" class="headerlink" title="尝试复现"></a>尝试复现</h2><p>代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 0;</span><br><span class="line">        char *p &#x3D; NULL;</span><br><span class="line">        for (i &#x3D; 0; i &lt; 1024 * 1024 * 64; i++) &#123;</span><br><span class="line">                p &#x3D; malloc(1024 * 1024);</span><br><span class="line">                if (!p) &#123;printf(&quot;malloc failed,p &#x3D; %p, i &#x3D; %d\n&quot;, p, i); break;&#125;</span><br><span class="line">                else    &#123;printf(&quot;malloc sucess.p &#x3D; %p, i &#x3D; %d\n&quot;, p, i);&#125;</span><br><span class="line">                usleep(1000 * 10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        printf(&quot;malloc failed,just wait!!\n&quot;);</span><br><span class="line">        while(1) &#123;</span><br><span class="line">                usleep(1000 * 10);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次尝试需分配 1G的虚拟内存，但是不会去使用，也就是不会去申请物理内存</p>
<h2 id="x86-64-平台"><a href="#x86-64-平台" class="headerlink" title="x86_64 平台"></a>x86_64 平台</h2><p>我一开始尝试在腾讯云 服务器上复现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@130ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;process_virtual_address_memleak# .&#x2F;a.out</span><br><span class="line">malloc sucess. p &#x3D; 0x7f8e3f5c6010, i &#x3D; 0</span><br><span class="line">malloc sucess. p &#x3D; 0x7f8e3f4c5010, i &#x3D; 1</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0x56771e4ba6e0, i &#x3D; 461827</span><br><span class="line">malloc sucess. p &#x3D; 0x56771e5ba6f0, i &#x3D; 461828</span><br><span class="line">[1]    2721866 killed     .&#x2F;a.out</span><br></pre></td></tr></table></figure>

<p>直到最后分配到 <code>461828 MB</code> 内存的时候，<code>a.out</code> 被OOM kill了。</p>
<p>到底是为啥呢？？？毕竟我也没有去往 <code>malloc</code> 的虚拟地址中写数据，也不应该会分配物理页面。<br>从 <code>top</code> 命令看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">top - 15:47:46 up 3 days, 15:06,  2 users,  load average: 0.24, 0.16, 0.10</span><br><span class="line">Tasks: 157 total,   1 running, 156 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  3.3 us,  3.6 sy,  0.0 ni, 92.7 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem :   1987.9 total,     70.5 free,   1660.6 used,    256.8 buff&#x2F;cache</span><br><span class="line">MiB Swap:   2048.0 total,   1499.9 free,    548.1 used.    162.0 avail Mem</span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">2783846 ubuntu    20   0  173.4g 683692   1380 S   0.3  33.6   0:06.86 a.out</span><br><span class="line">   1378 jenkins   20   0 2510448 176168   2924 S   0.7   8.7   7:05.12 java</span><br><span class="line">2779920 ubuntu    20   0  925684 107776  15196 S   1.0   5.3   0:21.10 node</span><br><span class="line">2703822 ubuntu    20   0 1611828  41268  11624 S   0.3   2.0   0:24.40 node</span><br><span class="line">2773158 ubuntu    20   0  702408  39436  12496 S   0.7   1.9   0:15.87</span><br></pre></td></tr></table></figure>

<p>已经分配了 <code>173G</code> 虚拟内存，但是同时可以发现 驻留在物理内存中的页面也达到了 <code>683692kb</code>.<br>这到底是什么？</p>
<p>通过对比 运行 <code>mytest</code> 前后的 <code>/proc/meminfo</code> 文件，发现差异主要在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">系统正常</span><br><span class="line">Active(anon):     243372 kB</span><br><span class="line">Inactive(anon):   267836 kB</span><br><span class="line"></span><br><span class="line">mytest运行之后</span><br><span class="line">Active(anon):     550888 kB</span><br><span class="line">Inactive(anon):   576840 kB</span><br></pre></td></tr></table></figure>
<p>说明确实是 mytest 消耗了大量的内存 用作匿名页面<br>接下来就需要查看具体是哪种页面消耗了物理内存了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;2798128# cat smaps | grep heap -A 40</span><br><span class="line">7fbca3ff9000-7fc69e600000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">Size:           41850908 kB</span><br><span class="line">KernelPageSize:        4 kB</span><br><span class="line">MMUPageSize:           4 kB</span><br><span class="line">Rss:              162844 kB</span><br><span class="line">Pss:              162844 kB</span><br><span class="line">Shared_Clean:          0 kB</span><br><span class="line">Shared_Dirty:          0 kB</span><br><span class="line">Private_Clean:         0 kB</span><br><span class="line">Private_Dirty:    162844 kB</span><br><span class="line">Referenced:       162844 kB</span><br><span class="line">Anonymous:        162844 kB</span><br><span class="line">LazyFree:              0 kB</span><br><span class="line"></span><br><span class="line">此时top 输出</span><br><span class="line">top - 16:05:47 up 3 days, 15:24,  4 users,  load average: 0.14, 0.09, 0.10</span><br><span class="line">Tasks: 157 total,   1 running, 156 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  3.0 us,  2.7 sy,  0.0 ni, 94.0 id,  0.0 wa,  0.0 hi,  0.3 si,  0.0 st</span><br><span class="line">MiB Mem :   1987.9 total,    786.6 free,    917.0 used,    284.2 buff&#x2F;cache</span><br><span class="line">MiB Swap:   2048.0 total,   1512.2 free,    535.8 used.    912.0 avail Mem</span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">2798128 ubuntu    20   0   45.1g 185412   1408 S   0.7   9.1   0:01.66 a.out</span><br><span class="line">......</span><br><span class="line">等待3min</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;2798128# cat smaps | grep heap -A 40</span><br><span class="line">7fb68e600000-7fc69e600000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">Size:           67371008 kB</span><br><span class="line">KernelPageSize:        4 kB</span><br><span class="line">MMUPageSize:           4 kB</span><br><span class="line">Rss:              262144 kB</span><br><span class="line">Pss:              262144 kB</span><br><span class="line">Shared_Clean:          0 kB</span><br><span class="line">Shared_Dirty:          0 kB</span><br><span class="line">Private_Clean:         0 kB</span><br><span class="line">Private_Dirty:    262144 kB</span><br><span class="line">Referenced:       262144 kB</span><br><span class="line">Anonymous:        262144 kB</span><br><span class="line">LazyFree:              0 kB</span><br><span class="line">AnonHugePages:         0 kB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">此时top 输出</span><br><span class="line">top - 16:09:43 up 3 days, 15:27,  4 users,  load average: 0.24, 0.12, 0.10</span><br><span class="line">Tasks: 159 total,   1 running, 158 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  2.7 us,  3.4 sy,  0.0 ni, 90.3 id,  3.7 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem :   1987.9 total,    585.4 free,   1072.9 used,    329.5 buff&#x2F;cache</span><br><span class="line">MiB Swap:   2048.0 total,   1523.9 free,    524.1 used.    754.9 avail Mem</span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">2798128 ubuntu    20   0   67.9g 278604   1408 S   0.3  13.7   0:02.55 a.out</span><br></pre></td></tr></table></figure>

<p>可以看到虽然 没有往堆内存中写入数据，但是还是消耗了较多的物理内存？这是怎么回事？</p>
<ol>
<li><p>猜想一， 可能是一直连续分配虚拟内存，导致 <code>vma</code> 使用很多？<br>通过查看 /proc/slabinfo 和 /proc/pid/maps 看堆内存就一块，基本没有分块的，kernel中也有<br><code>vma_merge</code> 的操作，所以应该不是vma 占用的内存</p>
</li>
<li><p>??？<br>我还没有其他头绪，为什么会占用物理内存</p>
</li>
</ol>
<h2 id="arm32-平台"><a href="#arm32-平台" class="headerlink" title="arm32 平台"></a>arm32 平台</h2><p>然后想了想，x86_64平台可能是虚拟内存太大，复现时间成本有点高<br>就使用了公司的板子，重新编译了一遍，在一个 <code>arm32</code> 板子上运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@device_gls:&#x2F; # mytest</span><br><span class="line">malloc sucess. p &#x3D; 0xb6b00000, i &#x3D; 0</span><br><span class="line">malloc sucess. p &#x3D; 0xb6a00000, i &#x3D; 1</span><br><span class="line">malloc sucess. p &#x3D; 0xb6900000, i &#x3D; 2</span><br><span class="line">malloc sucess. p &#x3D; 0xb6800000, i &#x3D; 3</span><br><span class="line">malloc sucess. p &#x3D; 0xb6700000, i &#x3D; 4</span><br><span class="line">malloc sucess. p &#x3D; 0xb6600000, i &#x3D; 5</span><br><span class="line">malloc sucess. p &#x3D; 0xb6500000, i &#x3D; 6</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0x10380000, i &#x3D; 2663</span><br><span class="line">malloc sucess. p &#x3D; 0x10280000, i &#x3D; 2664</span><br><span class="line">malloc sucess. p &#x3D; 0x10180000, i &#x3D; 2665</span><br><span class="line">malloc sucess. p &#x3D; 0x10080000, i &#x3D; 2666</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0xff80000, i &#x3D; 2667</span><br><span class="line">malloc sucess. p &#x3D; 0xfe80000, i &#x3D; 2668</span><br><span class="line">malloc sucess. p &#x3D; 0xfd80000, i &#x3D; 2669</span><br><span class="line">malloc sucess. p &#x3D; 0xfc80000, i &#x3D; 2670</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0x4180000, i &#x3D; 2857</span><br><span class="line">malloc sucess. p &#x3D; 0x4080000, i &#x3D; 2858</span><br><span class="line">malloc sucess. p &#x3D; 0x3f80000, i &#x3D; 2859</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0x1080000, i &#x3D; 2906</span><br><span class="line">malloc sucess. p &#x3D; 0xf80000, i &#x3D; 2907</span><br><span class="line">malloc sucess. p &#x3D; 0xe80000, i &#x3D; 2908</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0x80000, i &#x3D; 2922</span><br><span class="line">malloc sucess. p &#x3D; 0xb6f80000, i &#x3D; 2923</span><br><span class="line">malloc sucess. p &#x3D; 0xb7080000, i &#x3D; 2924</span><br><span class="line">......</span><br><span class="line">malloc sucess. p &#x3D; 0xbe880000, i &#x3D; 3044</span><br><span class="line">malloc sucess. p &#x3D; 0xbe980000, i &#x3D; 3045</span><br><span class="line">malloc sucess. p &#x3D; 0xbea80000, i &#x3D; 3046</span><br><span class="line">malloc sucess. p &#x3D; 0xbed80000, i &#x3D; 3047</span><br><span class="line">malloc failed, p &#x3D; 0x0, i &#x3D; 3048</span><br><span class="line">malloc failed,just wait!!</span><br></pre></td></tr></table></figure>


<p>可以看到，<code>arm32</code> 平台在分配了 <code>3038MB</code> 虚拟内存之后，在分配第3039块1MB的内存时，由于虚拟地<br>址空间用完了，不能再继续分配虚拟内存？</p>
<p>可以看到此时 <code>mytest</code> 进程的地址空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">root@device_gls:&#x2F;proc&#x2F;1293 # cat maps</span><br><span class="line">00080000-7f580000 rw-p 00000000 00:00 0          [anon:libc_malloc]</span><br><span class="line">7f5cd000-7f5d0000 r-xp 00000000 103:0f 1523      &#x2F;system&#x2F;bin&#x2F;mytest</span><br><span class="line">7f5d0000-7f5d1000 r--p 00002000 103:0f 1523      &#x2F;system&#x2F;bin&#x2F;mytest</span><br><span class="line">7f5d1000-7f5d2000 rw-p 00000000 00:00 0          [heap]</span><br><span class="line">7f600000-b6d00000 rw-p 00000000 00:00 0          [anon:libc_malloc]</span><br><span class="line">b6d64000-b6d68000 r-xp 00000000 103:0f 1428      &#x2F;system&#x2F;lib&#x2F;libnetd_client.so</span><br><span class="line">b6d68000-b6d69000 r--p 00003000 103:0f 1428      &#x2F;system&#x2F;lib&#x2F;libnetd_client.so</span><br><span class="line">b6d69000-b6d6a000 rw-p 00004000 103:0f 1428      &#x2F;system&#x2F;lib&#x2F;libnetd_client.so</span><br><span class="line">b6d6a000-b6d8a000 r--s 00000000 00:0f 11859      &#x2F;dev&#x2F;__properties__</span><br><span class="line">b6d8a000-b6d8b000 rw-p 00000000 00:00 0          [anon:linker_alloc_vector]</span><br><span class="line">b6d8c000-b6d8d000 rw-p 00000000 00:00 0          [anon:linker_alloc_vector]</span><br><span class="line">b6d8d000-b6dac000 r-xp 00000000 103:0f 1421      &#x2F;system&#x2F;lib&#x2F;libm.so</span><br><span class="line">b6dac000-b6dad000 ---p 00000000 00:00 0</span><br><span class="line">b6dad000-b6dae000 r--p 0001f000 103:0f 1421      &#x2F;system&#x2F;lib&#x2F;libm.so</span><br><span class="line">b6dae000-b6daf000 rw-p 00020000 103:0f 1421      &#x2F;system&#x2F;lib&#x2F;libm.so</span><br><span class="line">b6daf000-b6e23000 r-xp 00000000 103:0f 1355      &#x2F;system&#x2F;lib&#x2F;libc.so</span><br><span class="line">b6e23000-b6e27000 r--p 00073000 103:0f 1355      &#x2F;system&#x2F;lib&#x2F;libc.so</span><br><span class="line">b6e27000-b6e2a000 rw-p 00077000 103:0f 1355      &#x2F;system&#x2F;lib&#x2F;libc.so</span><br><span class="line">b6e2a000-b6e34000 rw-p 00000000 00:00 0</span><br><span class="line">b6e34000-b6ebc000 r-xp 00000000 103:0f 1354      &#x2F;system&#x2F;lib&#x2F;libc++.so</span><br><span class="line">b6ebc000-b6ebd000 ---p 00000000 00:00 0</span><br><span class="line">b6ebd000-b6ec1000 r--p 00088000 103:0f 1354      &#x2F;system&#x2F;lib&#x2F;libc++.so</span><br><span class="line">b6ec1000-b6ec2000 rw-p 0008c000 103:0f 1354      &#x2F;system&#x2F;lib&#x2F;libc++.so</span><br><span class="line">b6ec2000-b6ec3000 rw-p 00000000 00:00 0</span><br><span class="line">b6ec3000-b6ec4000 r--p 00000000 00:00 0</span><br><span class="line">b6ec4000-b6ec5000 r--p 00000000 00:00 0          [anon:linker_alloc]</span><br><span class="line">b6ec5000-b6ec6000 rw-p 00000000 00:00 0          [anon:linker_alloc]</span><br><span class="line">b6ec6000-b6ec7000 rw-p 00000000 00:00 0          [anon:linker_alloc_vector]</span><br><span class="line">b6ec7000-b6ec8000 rw-p 00000000 00:00 0          [anon:linker_alloc_32]</span><br><span class="line">b6ec8000-b6ec9000 r--p 00000000 00:00 0          [anon:linker_alloc]</span><br><span class="line">b6ec9000-b6ee9000 r--s 00000000 00:0f 11859      &#x2F;dev&#x2F;__properties__</span><br><span class="line">b6ee9000-b6eea000 r--p 00000000 00:00 0</span><br><span class="line">b6eea000-b6eeb000 ---p 00000000 00:00 0</span><br><span class="line">b6eeb000-b6eed000 rw-p 00000000 00:00 0          [anon:thread signal stack]</span><br><span class="line">b6eed000-b6f0a000 r-xp 00000000 103:0f 170       &#x2F;system&#x2F;bin&#x2F;linker</span><br><span class="line">b6f0a000-b6f0b000 r--p 0001c000 103:0f 170       &#x2F;system&#x2F;bin&#x2F;linker</span><br><span class="line">b6f0b000-b6f0d000 rw-p 0001d000 103:0f 170       &#x2F;system&#x2F;bin&#x2F;linker</span><br><span class="line">b6f0d000-b6f0f000 rw-p 00000000 00:00 0</span><br><span class="line">b6f80000-beb80000 rw-p 00000000 00:00 0          [anon:libc_malloc]</span><br><span class="line">bed01000-bed22000 rw-p 00000000 00:00 0          [stack]</span><br><span class="line">bed80000-bee80000 rw-p 00000000 00:00 0          [anon:libc_malloc]</span><br><span class="line">bef66000-bef67000 r-xp 00000000 00:00 0          [sigpage]</span><br><span class="line">bef67000-bef68000 r--p 00000000 00:00 0          [vvar]</span><br><span class="line">bef68000-bef69000 r-xp 00000000 00:00 0          [vdso]</span><br><span class="line">ffff0000-ffff1000 r-xp 00000000 00:00 0          [vectors]</span><br><span class="line">root@device_gls:&#x2F;proc&#x2F;1293 #</span><br></pre></td></tr></table></figure>


<p>我们看 <code>libc_malloc</code> 区域的 的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00080000-7f580000 rw-p 00000000 00:00 0          [anon:libc_malloc]  &#x3D;&#x3D; 2037MB</span><br><span class="line">7f600000-b6d00000 rw-p 00000000 00:00 0          [anon:libc_malloc]  &#x3D;&#x3D; 887MB</span><br><span class="line">b6f80000-beb80000 rw-p 00000000 00:00 0          [anon:libc_malloc]  &#x3D;&#x3D; 124MB</span><br><span class="line">bed80000-bee80000 rw-p 00000000 00:00 0          [anon:libc_malloc]  &#x3D;&#x3D; 1MB</span><br></pre></td></tr></table></figure>
<p>总和是 <code>2037 + 887 + 124 + 1 = 3049MB</code></p>
<p>这是项目中一个实际的bug，场景是 直播盒子 做长跑测试的时候，每到7天左右，直播业务就会因<br>为malloc失败而导致失败，但是由于业务代码写的问题，没有检查 malloc返回值的原因，导致业<br>务应用会crash, 现象是空指针错误。。很难联想到是因为进程虚拟地址空间全部泄漏导致的问题。<br>业务的小伙伴差了一个多月都没有头绪。。</p>
<p>在 <code>arm32</code> 设备上，<br>User 14 + Nice 0 + Sys 49 + Idle 246 + IOW 1 + IRQ 0 + SIRQ 0 = 310</p>
<p>  PID PR CPU% S  #THR     VSS     RSS PCY UID      Name<br> 3592  0   0% S     1 3124044K   1688K  fg root     mytest</p>
<p>RSS 也占用了一些，但是远没 X86设备上夸张</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Inspiron-5548@ubuntu: ~&#x2F;workspace# cat &#x2F;tmp&#x2F;123 | grep Rss</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                  12 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                 256 kB</span><br><span class="line">Rss:                  16 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                  28 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                  64 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                 460 kB</span><br><span class="line">Rss:                  16 kB</span><br><span class="line">Rss:                  12 kB</span><br><span class="line">Rss:                  28 kB</span><br><span class="line">Rss:                 536 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                  16 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                  28 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                 116 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   8 kB</span><br><span class="line">Rss:                   8 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                   8 kB</span><br><span class="line">Rss:                   0 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   4 kB</span><br><span class="line">Rss:                   0 kB</span><br></pre></td></tr></table></figure>
<p>其中 malloc 的 rss 只占用 <code>256Kb</code>,大部分是 libc, libc++ libm的代码段占用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">7f680000-b6d80000 rw-p 00000000 00:00 0          [anon:libc_malloc]</span><br><span class="line">Name:           [anon:libc_malloc]</span><br><span class="line">Size:             908288 kB</span><br><span class="line">Rss:                 256 kB</span><br><span class="line">Pss:                 256 kB</span><br><span class="line">Shared_Clean:          0 kB</span><br><span class="line">Shared_Dirty:          0 kB</span><br><span class="line">Private_Clean:         0 kB</span><br><span class="line">Private_Dirty:       256 kB</span><br><span class="line">Referenced:          256 kB</span><br><span class="line">Anonymous:           256 kB</span><br></pre></td></tr></table></figure>

<p>由此可见</p>
<ol>
<li><p>进程虚拟地址空间泄漏还是有可能会存在的，尽管可能概率非常低，对系统危害也比物理内存泄漏小很<br>多。但是一旦发生，他的危害对于业务本身也是致命的，必须重启业务或者系统来恢复。</p>
</li>
<li><p>编程习惯养好，一定需要检查函数返回值。</p>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-15T11:00:00.000Z" title="1/15/2021, 7:00:00 PM">2021-01-15</time>发表</span><span class="level-item"><time dateTime="2021-01-18T06:07:42.051Z" title="1/18/2021, 2:07:42 PM">2021-01-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约992个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/15/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98/">文件资源泄漏问题</a></h1><div class="content"><h2 id="资源泄漏"><a href="#资源泄漏" class="headerlink" title="资源泄漏"></a>资源泄漏</h2><p>资源泄漏在实际编程中是一不小心就会遇到的一个问题，最常见的就是 <code>内存泄漏</code>。<br>内存泄漏：对于短时间存在的进程，线程即使存在内存泄漏，往往也不会变现出来，开发人员也很难感知到。<br>但是一旦是长时间运行的进程，线程存在内存泄漏的问题，那将是一个灾难，要么过一会被OOM KILL，要么<br>自己重启，更严重的就是重启机器。</p>
<p>内存泄漏是指内存被分配出来，但是后续一直未使用，且失去了这个内存的引用，一直无法释放的问题。</p>
<p>但是除了最常见内存泄漏之外，还有其他各种资源泄漏的问题，比如这次的 <code>进程文件资源泄漏</code>。</p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>虽然是嵌入式平台，也有一些业务需要做压力测试连续几天到一个月不关机长时间跑测试。</p>
<p>某个业务在运行两天之后就会出现进程挂掉的问题。</p>
<h2 id="代码复现"><a href="#代码复现" class="headerlink" title="代码复现"></a>代码复现</h2><p>如果能用简单代码复现的问题，都不大</p>
<p><a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/tree/main">代码</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line">#include &lt;dirent.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;stat.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#define DIR_NAME        &quot;&#x2F;tmp&#x2F;asdf&quot;</span><br><span class="line"></span><br><span class="line">int sync_dir(char *dir)</span><br><span class="line">&#123;</span><br><span class="line">        if(!dir) return -1;</span><br><span class="line">        int fd &#x3D; open(dir, O_ASYNC);</span><br><span class="line">        if (-1 &#x3D;&#x3D; fd) return -1;</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 0;</span><br><span class="line">        int ret &#x3D; -1;</span><br><span class="line">        for (i &#x3D; 0; i &lt; 1024 * 1024 * 64; i++) &#123;</span><br><span class="line">                ret &#x3D; sync_dir(DIR_NAME);</span><br><span class="line">                if (ret)        printf(&quot;sync_dir failed. i &#x3D; %d, ret &#x3D; %d\n&quot;, i, ret);</span><br><span class="line">                else            printf(&quot;sync_dir sucess. i &#x3D; %d\n&quot;, i);</span><br><span class="line">                usleep(1000 * 10);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>嵌入式设备上的资源限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@device_gls:&#x2F;proc&#x2F;sys&#x2F;fs # cat file-nr</span><br><span class="line">800     0       21378</span><br><span class="line">root@device_gls:&#x2F;proc&#x2F;sys&#x2F;fs #</span><br></pre></td></tr></table></figure>
<p>意思是当前系统允许打开 <code>21378</code> 个文件，已经打开了 <code>800</code>个文件了</p>
<p>我选择用 <code>ubuntu</code> 系统去复现，先将 系统 fd上限制调制与设备一样的水平</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-max</span><br><span class="line">9223372036854775807</span><br><span class="line">tencent_clould@1ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# sudo su</span><br><span class="line">VM-0-11-ubuntu# echo 21378 &gt; file-max</span><br><span class="line">VM-0-11-ubuntu# exit</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-max</span><br><span class="line">21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>

<p>尝试复现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@130ubuntu: ~&#x2F;workspace&#x2F;hexo_blog&#x2F;source&#x2F;_posts&#x2F;资源管理# .&#x2F;a.out</span><br><span class="line">sync_dir sucess. i &#x3D; 0</span><br><span class="line">sync_dir sucess. i &#x3D; 1</span><br><span class="line">....</span><br><span class="line">sync_dir sucess. i &#x3D; 5</span><br><span class="line">sync_dir sucess. i &#x3D; 18194</span><br><span class="line">sync_dir sucess. i &#x3D; 18195</span><br><span class="line">...</span><br><span class="line">sync_dir failed. i &#x3D; 18196, ret &#x3D; -1</span><br></pre></td></tr></table></figure>


<p>同时观察 <code> /proc/sys/fs/file-nr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">4704    0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">9824    0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">17760   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">20224   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">21024   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">21216   0       21378</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">zsh: pipe failed: too many open files in system</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">zsh: pipe failed: too many open files in system</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>a.out</code> 最后无法 通过 <code>open</code> 打开文件了，且同时 <code>zsh</code> shell 都无法打开<br><code>file-nr</code>了。</p>
<p>与此同时，看到 <code>dmesg</code> 的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[57615.006011] VFS: file-max limit 21378 reached</span><br><span class="line">[57616.671617] VFS: file-max limit 21378 reached</span><br></pre></td></tr></table></figure>
<p>也可以比较容易定位出来。</p>
<p>这个问题困扰了当时开发同事很久，最后发现原来是 系统 <code>fd</code> 资源全部泄漏殆尽导致的。</p>
<h2 id="其他限制资源使用的方式"><a href="#其他限制资源使用的方式" class="headerlink" title="其他限制资源使用的方式"></a>其他限制资源使用的方式</h2><ol>
<li>其实还有其他方式限制资源 如 <code>ulimit</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# ulimit -a</span><br><span class="line">-t: cpu time (seconds)              unlimited</span><br><span class="line">-f: file size (blocks)              unlimited</span><br><span class="line">-d: data seg size (kbytes)          unlimited</span><br><span class="line">-s: stack size (kbytes)             8192</span><br><span class="line">-c: core file size (blocks)         0</span><br><span class="line">-m: resident set size (kbytes)      unlimited</span><br><span class="line">-u: processes                       7582</span><br><span class="line">-n: file descriptors                1024</span><br><span class="line">-l: locked-in-memory size (kbytes)  65536</span><br><span class="line">-v: address space (kbytes)          unlimited</span><br><span class="line">-x: file locks                      unlimited</span><br><span class="line">-i: pending signals                 7582</span><br><span class="line">-q: bytes in POSIX msg queues       819200</span><br><span class="line">-e: max nice                        0</span><br><span class="line">-r: max rt priority                 0</span><br><span class="line">-N 15:                              unlimited</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>/proc/pid/limits<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat &#x2F;proc&#x2F;4833&#x2F;limits</span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        0                    unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             7582                 7582                 processes</span><br><span class="line">Max open files            1024                 1048576              files</span><br><span class="line">Max locked memory         67108864             67108864             bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       7582                 7582                 signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         0                    0</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><code>/etc/security/limits.conf</code></li>
</ol>
<p>这里可以预先配置。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/linux%E5%86%85%E6%A0%B8/page/4/">上一页</a></div><div class="pagination-next"><a href="/categories/linux%E5%86%85%E6%A0%B8/page/6/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/4/">4</a></li><li><a class="pagination-link is-current" href="/categories/linux%E5%86%85%E6%A0%B8/page/5/">5</a></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/6/">6</a></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/7/">7</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">119</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">24</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">146</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/explore" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BRK/"><span class="tag">BRK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HW/"><span class="tag">HW</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QCOM/"><span class="tag">QCOM</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aarch64/"><span class="tag">aarch64</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/acl/"><span class="tag">acl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android-framework/"><span class="tag">android framework</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android12-gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/"><span class="tag">android12 gdb64调试进程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v1/"><span class="tag">cgroup v1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v2/"><span class="tag">cgroup v2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu%E8%B0%83%E9%A2%91/"><span class="tag">cpu调频</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dd/"><span class="tag">dd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debugfs/"><span class="tag">debugfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/double-free/"><span class="tag">double free</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drop-caches/"><span class="tag">drop_caches</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dumpe2fs/"><span class="tag">dumpe2fs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eas/"><span class="tag">eas</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ext2/"><span class="tag">ext2</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-attr/"><span class="tag">file attr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-hole/"><span class="tag">file hole</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filesystem/"><span class="tag">filesystem</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fsck/"><span class="tag">fsck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/futex/"><span class="tag">futex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hrtimer/"><span class="tag">hrtimer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hugepage/"><span class="tag">hugepage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interrupt/"><span class="tag">interrupt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt/"><span class="tag">intrrrupt</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt-storm/"><span class="tag">intrrrupt storm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kallsyms/"><span class="tag">kallsyms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kfence/"><span class="tag">kfence</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kprobes/"><span class="tag">kprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kretprobes/"><span class="tag">kretprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvmtool/"><span class="tag">kvmtool</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/launch-json/"><span class="tag">launch.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-kernel/"><span class="tag">linux kernel</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-native-aio/"><span class="tag">linux native aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lock-stat/"><span class="tag">lock_stat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory/"><span class="tag">memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory-direct-reclaim/"><span class="tag">memory direct reclaim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mount/"><span class="tag">mount</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/node/"><span class="tag">node</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oom/"><span class="tag">oom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagemap/"><span class="tag">pagemap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf/"><span class="tag">perf</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf-c2c/"><span class="tag">perf c2c</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pid-namespace/"><span class="tag">pid namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/power-management/"><span class="tag">power management</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preemption/"><span class="tag">preemption</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pressure/"><span class="tag">pressure</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/process-madvise/"><span class="tag">process_madvise</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psi/"><span class="tag">psi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psoix-aio/"><span class="tag">psoix aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/randomize-va-space/"><span class="tag">randomize_va_space</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rcu/"><span class="tag">rcu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sched-latency/"><span class="tag">sched latency</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/schedule/"><span class="tag">schedule</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slab/"><span class="tag">slab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-overflow/"><span class="tag">stack_overflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-key/"><span class="tag">static_key</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sync/"><span class="tag">sync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systrace/"><span class="tag">systrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-json/"><span class="tag">task.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-struct/"><span class="tag">task_struct</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread-info/"><span class="tag">thread_info</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tracepoint/"><span class="tag">tracepoint</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/use-after-free/"><span class="tag">use after free</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uts-namespace/"><span class="tag">uts namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vdso/"><span class="tag">vdso</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmstat/"><span class="tag">vmstat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xattr/"><span class="tag">xattr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zone/"><span class="tag">zone</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%B6%8A%E7%95%8C/"><span class="tag">内存泄漏越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88%E6%BA%A2%E5%87%BA/"><span class="tag">内核栈溢出</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8A%9F%E8%80%97/"><span class="tag">功耗</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80%E9%9A%8F%E6%9C%BA%E5%8C%96/"><span class="tag">地址空间布局随机化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/QCOM/"><span class="level-start"><span class="level-item">QCOM</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/cgroup-v1/"><span class="level-start"><span class="level-item">cgroup v1</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/cgroup-v1/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/kernel-debug/cache-false-sharing/"><span class="level-start"><span class="level-item">cache false sharing</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/"><span class="level-start"><span class="level-item">linux kernel</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/deadline-schedule/"><span class="level-start"><span class="level-item">deadline schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/"><span class="level-start"><span class="level-item">frequency governer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/schedule-util/"><span class="level-start"><span class="level-item">schedule util</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/idle/"><span class="level-start"><span class="level-item">idle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">70</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/"><span class="level-start"><span class="level-item">namespace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/namespace/pid-namespace/"><span class="level-start"><span class="level-item">pid namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/uts-namespace/"><span class="level-start"><span class="level-item">uts namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/power-management/"><span class="level-start"><span class="level-item">power management</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/schedule/"><span class="level-start"><span class="level-item">schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-28T11:00:00.000Z">2022-03-28</time></p><p class="title"><a href="/2022/03/28/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/gdb%20%E4%BD%BF%E7%94%A8/">gdb 使用</a></p><p class="categories"><a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-24T11:00:00.000Z">2022-01-24</time></p><p class="title"><a href="/2022/01/24/schedule/cpu%E8%B0%83%E9%A2%91/">cpu调频</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-20T08:42:37.115Z">2022-01-20</time></p><p class="title"><a href="/2022/01/20/schedule/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0%E8%B0%83%E5%BA%A6/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-05T11:00:00.000Z">2022-01-05</time></p><p class="title"><a href="/2022/01/05/schedule/eas/">eas</a></p><p class="categories"><a href="/categories/linux-kernel/">linux kernel</a> / <a href="/categories/linux-kernel/linux-schedule/">linux schedule</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-03T11:00:00.000Z">2021-11-03</time></p><p class="title"><a href="/2021/11/03/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/perf%E7%9B%B8%E5%85%B3/perf%20c2c/">perf c2c</a></p><p class="categories"><a href="/categories/kernel-debug/">kernel debug</a> / <a href="/categories/kernel-debug/cache-false-sharing/">cache false sharing</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>