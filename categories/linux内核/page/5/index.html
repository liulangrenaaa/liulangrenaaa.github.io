<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>分类: linux内核 - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">linux内核</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-27T11:00:00.000Z" title="1/27/2021, 7:00:00 PM">2021-01-27</time>发表</span><span class="level-item"><time dateTime="2022-03-08T06:42:13.744Z" title="3/8/2022, 2:42:13 PM">2022-03-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">13 分钟读完 (大约1878个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/27/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/KASAN%20%E4%BD%BF%E7%94%A8/">KASAN 定位越界访问</a></h1><div class="content"><h2 id="KASAN-配置"><a href="#KASAN-配置" class="headerlink" title="KASAN 配置"></a>KASAN 配置</h2><p>首先想使用这类根据肯定是需要重新编译内核的。<br>看下<code>.config</code>的改变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if [ $debug_KASAN &#x3D;&#x3D; 1 ]</span><br><span class="line">then</span><br><span class="line">## KASAN detect and panic start</span><br><span class="line">	#---- add</span><br><span class="line">	echo &quot;CONFIG_CONSTRUCTORS&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_KASAN_SHADOW_OFFSET&#x3D;0xdffffc0000000000&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_STACKDEPOT&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_KASAN&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_KASAN_GENERIC&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_KASAN_OUTLINE&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_KASAN_STACK&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	#---- delect</span><br><span class="line">	sed -i &#39;&#x2F;CONFIG_VMAP_STACK&#x3D;y&#x2F;d&#39; &#x2F;tmp&#x2F;.config</span><br><span class="line">## KASAN detect and panic end</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>当然，我在别的地方将$debug_slub_debug也已经打开了.</p>
<h2 id="KASAN-使用"><a href="#KASAN-使用" class="headerlink" title="KASAN 使用"></a>KASAN 使用</h2><p>写了一个test case，参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/memory/kasan_debug/kasan_debug.c">代码</a></p>
<h3 id="oob检测"><a href="#oob检测" class="headerlink" title="oob检测"></a>oob检测</h3><p>编译安装模块之后，直接panic了(我设置了<code>panic_on_warn</code>。。)，只能通过 <code>crash</code> 根据查看 现场的 dmesg log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; log | tail -n 70</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[  114.816452] BUG: KASAN: slab-out-of-bounds in kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452] Write of size 1 at addr ffff8880076053c0 by task kasan_debug&#x2F;3229</span><br><span class="line">[  114.816452]</span><br><span class="line">[  114.816452] CPU: 1 PID: 3229 Comm: kasan_debug Kdump: loaded Tainted: G           O      5.11.0-rc5+ #6</span><br><span class="line">[  114.816452] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[  114.816452] Call Trace:</span><br><span class="line">[  114.816452]  dump_stack+0x9a&#x2F;0xcc</span><br><span class="line">[  114.816452]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452]  print_address_description.constprop.0+0x1a&#x2F;0x140</span><br><span class="line">[  114.816452]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452]  kasan_report.cold+0x7f&#x2F;0x10e</span><br><span class="line">[  114.816452]  ? ____kasan_kmalloc.constprop.0+0x1&#x2F;0xa0</span><br><span class="line">[  114.816452]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452]  ? 0xffffffffc0880000</span><br><span class="line">[  114.816452]  kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452]  kthread+0x1aa&#x2F;0x200</span><br><span class="line">[  114.816452]  ? kthread_create_on_node+0xd0&#x2F;0xd0</span><br><span class="line">[  114.816452]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[  114.816452]</span><br><span class="line">[  114.816452] Allocated by task 3229:</span><br><span class="line">[  114.816452]  kasan_save_stack+0x1b&#x2F;0x40</span><br><span class="line">[  114.816452]  ____kasan_kmalloc.constprop.0+0x84&#x2F;0xa0</span><br><span class="line">[  114.816452]  kasan_debug_oob+0x29&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452]  kthread+0x1aa&#x2F;0x200</span><br><span class="line">[  114.816452]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[  114.816452]</span><br><span class="line">[  114.816452] The buggy address belongs to the object at ffff8880076053a0</span><br><span class="line">                which belongs to the cache kmalloc-32 of size 32</span><br><span class="line">[  114.816452] The buggy address is located 0 bytes to the right of</span><br><span class="line">                32-byte region [ffff8880076053a0, ffff8880076053c0)</span><br><span class="line">[  114.816452] The buggy address belongs to the page:</span><br><span class="line">[  114.816452] page:00000000352cff66 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x7604</span><br><span class="line">[  114.816452] head:00000000352cff66 order:1 compound_mapcount:0</span><br><span class="line">[  114.816452] flags: 0x100000000010200(slab|head)</span><br><span class="line">[  114.816452] raw: 0100000000010200 ffffea0000441688 ffffea0000466d88 ffff888001042540</span><br><span class="line">[  114.816452] raw: 0000000000000000 0000000000130013 00000001ffffffff 0000000000000000</span><br><span class="line">[  114.816452] page dumped because: kasan: bad access detected</span><br><span class="line">[  114.816452]</span><br><span class="line">[  114.816452] Memory state around the buggy address:</span><br><span class="line">[  114.816452]  ffff888007605280: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[  114.816452]  ffff888007605300: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[  114.816452] &gt;ffff888007605380: fc fc fc fc 00 00 00 00 fc fc fc fc fc fc fc fc</span><br><span class="line">[  114.816452]                                            ^</span><br><span class="line">[  114.816452]  ffff888007605400: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[  114.816452]  ffff888007605480: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[  114.816452] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[  114.816452] Disabling lock debugging due to kernel taint</span><br><span class="line">[  114.833983] Kernel panic - not syncing: panic_on_warn set ...</span><br><span class="line">[  114.834833] CPU: 1 PID: 3229 Comm: kasan_debug Kdump: loaded Tainted: G    B      O      5.11.0-rc5+ #6</span><br><span class="line">[  114.835925] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[  114.836979] Call Trace:</span><br><span class="line">[  114.836979]  dump_stack+0x9a&#x2F;0xcc</span><br><span class="line">[  114.836979]  ? 0xffffffffc0880000</span><br><span class="line">[  114.836979]  panic+0x1ae&#x2F;0x3c3</span><br><span class="line">[  114.836979]  ? print_oops_end_marker.cold+0x10&#x2F;0x10</span><br><span class="line">[  114.839656]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.840336]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.841598]  end_report+0x58&#x2F;0x5e</span><br><span class="line">[  114.841598]  kasan_report.cold+0x9d&#x2F;0x10e</span><br><span class="line">[  114.841598]  ? ____kasan_kmalloc.constprop.0+0x1&#x2F;0xa0</span><br><span class="line">[  114.841598]  ? kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.841598]  ? 0xffffffffc0880000</span><br><span class="line">[  114.841598]  kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.841598]  kthread+0x1aa&#x2F;0x200</span><br><span class="line">[  114.841598]  ? kthread_create_on_node+0xd0&#x2F;0xd0</span><br><span class="line">[  114.841598]  ret_from_fork+0x22&#x2F;0x30</span><br></pre></td></tr></table></figure>

<p>可以看到报错信息很明显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[  114.816452] BUG: KASAN: slab-out-of-bounds in kasan_debug_oob+0x35&#x2F;0x70 [kasan_debug]</span><br><span class="line">[  114.816452] Write of size 1 at addr ffff8880076053c0 by task kasan_debug&#x2F;3229</span><br><span class="line">[  114.816452] The buggy address belongs to the object at ffff8880076053a0</span><br><span class="line">                which belongs to the cache kmalloc-32 of size 32</span><br><span class="line">[  114.816452] The buggy address is located 0 bytes to the right of</span><br><span class="line">                32-byte region [ffff8880076053a0, ffff8880076053c0)</span><br></pre></td></tr></table></figure>
<p>基本<code>dis</code>反汇编一下就能看到出错逻辑</p>
<h3 id="use-after-free检测"><a href="#use-after-free检测" class="headerlink" title="use after free检测"></a>use after free检测</h3><p>使用<code>kasan_debug_use_after_free（）</code><br>重新编译安装（这次我关掉了<code>panic_on_warn</code>）,报错信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[   98.719080] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   98.719793] BUG: KASAN: use-after-free in kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793] Write of size 1 at addr ffff8880432ce85e by task kasan_debug&#x2F;3203</span><br><span class="line"></span><br><span class="line">[   98.719793] CPU: 0 PID: 3203 Comm: kasan_debug Kdump: loaded Tainted: G           O      5.11.0-rc5+ #6</span><br><span class="line">[   98.719793] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   98.719793] Call Trace:</span><br><span class="line">[   98.719793]  dump_stack+0x9a&#x2F;0xcc</span><br><span class="line">[   98.719793]  ? kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  print_address_description.constprop.0+0x1a&#x2F;0x140</span><br><span class="line">[   98.719793]  ? kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  ? kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  kasan_report.cold+0x7f&#x2F;0x10e</span><br><span class="line">[   98.719793]  ? kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  ? 0xffffffffc07b8000</span><br><span class="line">[   98.719793]  ? mark_held_locks+0x24&#x2F;0x90</span><br><span class="line">[   98.719793]  ? lockdep_hardirqs_on_prepare+0x12e&#x2F;0x1f0</span><br><span class="line">[   98.719793]  ? _raw_spin_unlock_irqrestore+0x34&#x2F;0x40</span><br><span class="line">[   98.719793]  ? trace_hardirqs_on+0x1c&#x2F;0x100</span><br><span class="line">[   98.719793]  ? 0xffffffffc07b8000</span><br><span class="line">[   98.719793]  kthread+0x1aa&#x2F;0x200</span><br><span class="line">[   98.719793]  ? kthread_create_on_node+0xd0&#x2F;0xd0</span><br><span class="line">[   98.719793]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[   98.719793] Allocated by task 3203:</span><br><span class="line">[   98.719793]  kasan_save_stack+0x1b&#x2F;0x40</span><br><span class="line">[   98.719793]  ____kasan_kmalloc.constprop.0+0x84&#x2F;0xa0</span><br><span class="line">[   98.719793]  kasan_debug_use_after_free+0xb8&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  kthread+0x1aa&#x2F;0x200</span><br><span class="line">[   98.719793]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[   98.719793] Freed by task 3203:</span><br><span class="line">[   98.719793]  kasan_save_stack+0x1b&#x2F;0x40</span><br><span class="line">[   98.719793]  kasan_set_track+0x1c&#x2F;0x30</span><br><span class="line">[   98.719793]  kasan_set_free_info+0x20&#x2F;0x30</span><br><span class="line">[   98.719793]  ____kasan_slab_free+0xec&#x2F;0x120</span><br><span class="line">[   98.719793]  kfree+0xcc&#x2F;0x2e0</span><br><span class="line">[   98.719793]  kasan_debug_use_after_free+0xf6&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793]  kthread+0x1aa&#x2F;0x200</span><br><span class="line">[   98.719793]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line"></span><br><span class="line">[   98.719793] The buggy address belongs to the object at ffff8880432ce840</span><br><span class="line">                which belongs to the cache kmalloc-32 of size 32</span><br><span class="line">[   98.719793] The buggy address is located 30 bytes inside of</span><br><span class="line">                32-byte region [ffff8880432ce840, ffff8880432ce860)</span><br><span class="line">[   98.719793] The buggy address belongs to the page:</span><br><span class="line">[   98.719793] page:00000000d04b265b refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff8880432ce1c0 pfn:0x432ce</span><br><span class="line">[   98.719793] head:00000000d04b265b order:1 compound_mapcount:0</span><br><span class="line">[   98.719793] flags: 0x100000000010200(slab|head)</span><br><span class="line">[   98.719793] raw: 0100000000010200 ffffea0000720f08 ffff888001041b88 ffff888001042540</span><br><span class="line">[   98.719793] raw: ffff8880432ce1c0 0000000000130011 00000001ffffffff 0000000000000000</span><br><span class="line">[   98.719793] page dumped because: kasan: bad access detected</span><br><span class="line"></span><br><span class="line">[   98.719793] Memory state around the buggy address:</span><br><span class="line">[   98.719793]  ffff8880432ce700: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   98.719793]  ffff8880432ce780: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   98.719793] &gt;ffff8880432ce800: fc fc fc fc fc fc fc fc fa fb fb fb fc fc fc fc</span><br><span class="line">[   98.719793]                                                     ^</span><br><span class="line">[   98.719793]  ffff8880432ce880: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   98.719793]  ffff8880432ce900: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   98.719793] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   98.719793] Disabling lock debugging due to kernel taint</span><br></pre></td></tr></table></figure>

<p>可以看到报错信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[   98.719793] BUG: KASAN: use-after-free in kasan_debug_use_after_free+0x109&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   98.719793] Allocated by task 3203:</span><br><span class="line">[   98.719793] Freed by task 3203:</span><br><span class="line">[   98.719793] The buggy address belongs to the object at ffff8880432ce840</span><br><span class="line">                which belongs to the cache kmalloc-32 of size 32</span><br><span class="line">[   98.719793] The buggy address is located 30 bytes inside of</span><br><span class="line">                32-byte region [ffff8880432ce840, ffff8880432ce860)</span><br></pre></td></tr></table></figure>
<p>直接反汇编，基本直接可以找到问题</p>
<h3 id="double-free检测"><a href="#double-free检测" class="headerlink" title="double free检测"></a>double free检测</h3><p>使用<code>kasan_debug_double_free</code><br>重新编译安装（这次我关掉了<code>panic_on_warn</code>）,报错信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[   80.381499] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   80.508872] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   80.509767] BUG: KASAN: double-free or invalid-free in kasan_debug_double_free+0x119&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   80.509767] CPU: 3 PID: 3407 Comm: kasan_debug Kdump: loaded Tainted: G    B      O      5.11.0-rc5+ #6</span><br><span class="line">[   80.509767] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   80.509767] Call Trace:</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[   80.509767] The buggy address belongs to the object at ffff888010e3b540</span><br><span class="line">                which belongs to the cache kmalloc-32 of size 32</span><br><span class="line">[   80.509767] The buggy address is located 0 bytes inside of</span><br><span class="line">                32-byte region [ffff888010e3b540, ffff888010e3b560)</span><br><span class="line">[   80.509767] The buggy address belongs to the page:</span><br><span class="line">[   80.509767] page:000000001edff74e refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10e3a</span><br><span class="line">[   80.509767] head:000000001edff74e order:1 compound_mapcount:0</span><br><span class="line">[   80.509767] flags: 0x100000000010200(slab|head)</span><br><span class="line">[   80.509767] raw: 0100000000010200 ffffea0000955888 ffff888001041ba8 ffff888001042540</span><br><span class="line">[   80.509767] raw: 0000000000000000 0000000000130013 00000001ffffffff 0000000000000000</span><br><span class="line">[   80.509767] page dumped because: kasan: bad access detected</span><br><span class="line"></span><br><span class="line">[   80.509767] Memory state around the buggy address:</span><br><span class="line">[   80.509767]  ffff888010e3b400: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   80.509767]  ffff888010e3b480: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   80.509767] &gt;ffff888010e3b500: fc fc fc fc fc fc fc fc fa fb fb fb fc fc fc fc</span><br><span class="line">[   80.509767]                                            ^</span><br><span class="line">[   80.509767]  ffff888010e3b580: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br><span class="line">[   80.509767]  ffff888010e3b600: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span><br></pre></td></tr></table></figure>

<p>可以看到报错信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[   80.509767] BUG: KASAN: double-free or invalid-free in kasan_debug_double_free+0x119&#x2F;0x180 [kasan_debug]</span><br><span class="line">[   80.509767] The buggy address belongs to the object at ffff888010e3b540</span><br><span class="line">                which belongs to the cache kmalloc-32 of size 32</span><br><span class="line">[   80.509767] The buggy address is located 0 bytes inside of</span><br><span class="line">                32-byte region [ffff888010e3b540, ffff888010e3b560)</span><br></pre></td></tr></table></figure>
<p>根据这提示信息和 backtrace，反汇编一下基本就可以找到问题所在</p>
<h3 id="vmalloc-内存检测"><a href="#vmalloc-内存检测" class="headerlink" title="vmalloc 内存检测"></a>vmalloc 内存检测</h3><p>由于 <code>vmalloc</code>存在的 <code>guard page</code>的原因，基本上只要 <code>vmalloc</code>内存存在越界的问题，就会立即报出来<br>后面加上 <code>guard page</code>分析。</p>
<h2 id="KASAN-overhead"><a href="#KASAN-overhead" class="headerlink" title="KASAN overhead"></a>KASAN overhead</h2><p>当然假设我们场景允许 使能KASAN之后，重新编译 kernel，也要关系 KASAN 所带来的<br>overhead是否允许。</p>
<p>关于使能 KASAN的 overhead:</p>
<ol>
<li>image 变大<br>on<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;share&#x2F;debug# ls -alh</span><br><span class="line">total 1.1G</span><br><span class="line">-rw-r--r-- 1 root   root    17M 1月  26 21:56 bzImage</span><br><span class="line">-rwxr-xr-x 1 root   root   1.1G 1月  26 21:56 vmlinux</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>off</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;share&#x2F;stable# ls -alh</span><br><span class="line">total 970M</span><br><span class="line">-rw-r--r-- 1 root   root   9.6M 1月  26 11:05 bzImage</span><br><span class="line">-rwxr-xr-x 1 root   root   967M 1月  26 11:05 vmlinux</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>运行速度<br>原来我自己qemu虚拟机开机12s，开启 kasan 之后开机时间是 20s.</p>
</li>
<li><p>cpu使用率</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">on          off</span><br></pre></td></tr></table></figure>
<p>我的qemu虚拟机看起来好像区别不大，后面需要用公司机器看一下</p>
</li>
<li><p>内存使用<br>我的qemu上（2G）<br>on</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;kasan_debug# free -m</span><br><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:           1419         783          44           6         591         592</span><br><span class="line">Swap:          1497           0        1496</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>KASAN 和 slub_debug一样也可以使由于内存越界的检查。<br>但是原理上截然不同，后续等搞明白原理再分析一波。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-27T11:00:00.000Z" title="1/27/2021, 7:00:00 PM">2021-01-27</time>发表</span><span class="level-item"><time dateTime="2021-01-27T16:55:05.505Z" title="1/28/2021, 12:55:05 AM">2021-01-28</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">14 分钟读完 (大约2059个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/27/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/stack_overflow/">stack_overflow</a></h1><div class="content"><h2 id="stack-overflow-概述"><a href="#stack-overflow-概述" class="headerlink" title="stack_overflow 概述"></a>stack_overflow 概述</h2><p>一般linux内核栈大小都是<code>8kb</code>，当内核中调用层次太多，或者局部变量太大的时候，就会使得栈实际使用的大小超过8Kb，但是8kb之外就是别的内存了，不属于当前task的 <code>stack</code>了。一般会破坏其他task的<code>stack</code>或者其他的重要数据结构(slub等)，轻则导致运行的程序的异常，重则导致系统直接<code>panic</code>，而且由于破坏数据结构不确定，panic的位置也是不确定的，所以往往很难定位这种问题。</p>
<h2 id="stack-overflow-如何检测"><a href="#stack-overflow-如何检测" class="headerlink" title="stack_overflow 如何检测"></a>stack_overflow 如何检测</h2><h3 id="传统RTOS上如何做的？"><a href="#传统RTOS上如何做的？" class="headerlink" title="传统RTOS上如何做的？"></a>传统RTOS上如何做的？</h3><p>这是我大四总结的RTOS栈溢出如何检测的节选</p>
<ol>
<li>检查指针：每次任务切换时检查栈指针是在合法范围内（是否越界），但是仍然存在检测不到情况，比如在任务执行过程中栈指针越界了，但是在任务切换前，栈指针pop到了合法位置。</li>
<li>检查数据：将栈空间顶部16字节数据初始化一定值如0XA5，然后在每次任务切换的时候检查栈顶部16字节有没有改变，如果改变了就说明肯定栈溢出了，想较于检查指针方法费时费事。但是仍然可能检测不到栈溢出，比如虽然溢出但是栈顶部数据没有被修改，溢出后的数据被修改了。</li>
</ol>
<h3 id="linux上如何做的？"><a href="#linux上如何做的？" class="headerlink" title="linux上如何做的？"></a>linux上如何做的？</h3><p>其实在<code>linux</code> 系统上也无外乎这几种方法。（其实多了一种方法）</p>
<ol>
<li>首先linux会在<code>kernel stack</code>的结尾处放置一个<code>magic num</code>，就是方法2<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void set_task_stack_end_magic(struct task_struct *tsk) &#123;</span><br><span class="line">	*end_of_stack(tsk) &#x3D; STACK_END_MAGIC;	&#x2F;* for overflow detection *&#x2F;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asmlinkage __visible void __init __no_sanitize_address start_kernel(void) &#123;</span><br><span class="line">	set_task_stack_end_magic(&amp;init_task);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct task_struct *dup_task_struct(struct task_struct *orig, int node) &#123;</span><br><span class="line">        setup_thread_stack(tsk, orig);</span><br><span class="line">	clear_user_return_notifier(tsk);</span><br><span class="line">	clear_tsk_need_resched(tsk);</span><br><span class="line">	set_task_stack_end_magic(tsk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static __latent_entropy struct task_struct *copy_process(...) &#123;</span><br><span class="line">        p &#x3D; dup_task_struct(current, node);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>那么何时来检测呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#define STACK_END_MAGIC		0x57AC6E9D</span><br><span class="line">#define task_stack_end_corrupted(task) \</span><br><span class="line">		(*(end_of_stack(task)) !&#x3D; STACK_END_MAGIC)</span><br><span class="line"></span><br><span class="line">static inline void schedule_debug(struct task_struct *prev, bool preempt)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef CONFIG_SCHED_STACK_END_CHECK</span><br><span class="line">	if (task_stack_end_corrupted(prev))</span><br><span class="line">		panic(&quot;corrupted stack end detected inside scheduler\n&quot;);</span><br><span class="line"></span><br><span class="line">	if (task_scs_end_corrupted(prev))</span><br><span class="line">		panic(&quot;corrupted shadow stack detected inside scheduler\n&quot;);</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个功能还需要 开启 <code>CONFIG_SCHED_STACK_END_CHECK</code> 配置。</p>
<ol start="2">
<li><p>使用虚拟内存的特性来保证。<br>以前内核栈都是通过连续物理内存页面来分配的，且是线性映射的内存，这样做的好处是减少了部分开销。<br>但是这样也导致如果发生栈溢出，就是真切的踩到别的物理内存了。<br>所以内核提供了一个新的方式，配置<code>CONFIG_VMAP_STACK</code>之后，可以使用 vmalloc的方式来提供栈空间，由于 <code>vmalloc</code> 还提供了 <code>guard page</code>机制，所以一旦检测到栈溢出，就可以立即报告出来。<br>由这个commit：(ba14a194a434ccc8f733e263ad2ce941e35e5787)加入,<br>后面又优化了一把(ac496bf48d97f2503eaa353996a4dd5e4383eaf0)，主要是用<code>cached_stacks</code> 这个 percpu 变量缓存了 一些vmalloc页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static unsigned long *alloc_thread_stack_node(struct task_struct *tsk, int node)&#123;</span><br><span class="line">#ifdef CONFIG_VMAP_STACK</span><br><span class="line">	void *stack;</span><br><span class="line">	stack &#x3D; __vmalloc_node_range(THREAD_SIZE, THREAD_ALIGN,</span><br><span class="line">				     VMALLOC_START, VMALLOC_END,</span><br><span class="line">				     THREADINFO_GFP &amp; ~__GFP_ACCOUNT,</span><br><span class="line">				     PAGE_KERNEL,</span><br><span class="line">				     0, node, __builtin_return_address(0));</span><br><span class="line">	return stack;</span><br><span class="line">#else</span><br><span class="line">	struct page *page &#x3D; alloc_pages_node(node, THREADINFO_GFP,THREAD_SIZE_ORDER);</span><br><span class="line"></span><br><span class="line">	if (likely(page)) &#123;</span><br><span class="line">		tsk-&gt;stack &#x3D; kasan_reset_tag(page_address(page));</span><br><span class="line">		return tsk-&gt;stack;</span><br><span class="line">	&#125;</span><br><span class="line">	return NULL;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct task_struct *dup_task_struct(struct task_struct *orig, int node) &#123;</span><br><span class="line">	stack &#x3D; alloc_thread_stack_node(tsk, node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>gcc特性保证<br>可以在函数<br>在gcc编译的时候，加入”-fstack-protector”选项即可。每个函数会对应一个stack frame，<br>这样每个stack frame都需要一个canary，这会消耗掉一部分的栈空间。<br>此外，由于每次函数返回时都需要检测canary，代码的整执行时间也势必会增加。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp$ cat .&#x2F;debug_out&#x2F;.config | grep STACKPROTECTOR</span><br><span class="line">CONFIG_CC_HAS_SANE_STACKPROTECTOR&#x3D;y</span><br><span class="line">CONFIG_HAVE_STACKPROTECTOR&#x3D;y</span><br><span class="line">CONFIG_STACKPROTECTOR&#x3D;y</span><br><span class="line">CONFIG_STACKPROTECTOR_STRONG&#x3D;y</span><br></pre></td></tr></table></figure>

<p>看<code>makefile</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stackp-flags-y                                    :&#x3D; -fno-stack-protector</span><br><span class="line">stackp-flags-$(CONFIG_STACKPROTECTOR)             :&#x3D; -fstack-protector</span><br><span class="line">stackp-flags-$(CONFIG_STACKPROTECTOR_STRONG)      :&#x3D; -fstack-protector-strong</span><br><span class="line">KBUILD_CFLAGS +&#x3D; $(stackp-flags-y)</span><br></pre></td></tr></table></figure>
<p>可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/arnoldlu/p/11630979.html">文章1</a><br>可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gm-201705/p/9863958.html">文章2</a></p>
<h2 id="stack-overflow-配置"><a href="#stack-overflow-配置" class="headerlink" title="stack_overflow 配置"></a>stack_overflow 配置</h2><ol>
<li>开启<code>CONFIG_SCHED_STACK_END_CHECK</code>，关闭<code>CONFIG_VMAP_STACK</code>查看效果<br>参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/memory/stack_overflow/stack_overflow.c">代码</a></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; log | tail -n 18</span><br><span class="line">[   16.480669] systemd-journald[122]: File &#x2F;var&#x2F;log&#x2F;journal&#x2F;99626a991f7d4bfa8cb2df0e3b8ce643&#x2F;user-1000.journal corrupted or uncleanly shut .</span><br><span class="line">[   28.311464] rfkill: input handler disabled</span><br><span class="line">[   32.585818] loop0: detected capacity change from 63672 to 0</span><br><span class="line">[   33.713469] loop0: detected capacity change from 113424 to 0</span><br><span class="line">[   36.372258] stack_overflow: loading out-of-tree module taints kernel.</span><br><span class="line">[   37.396337] k_stackoverflow_thread have alloc 4096 bytes in stack, times &#x3D; 9</span><br><span class="line">[   38.420098] k_stackoverflow_thread have alloc 4096 bytes in stack, times &#x3D; 8</span><br><span class="line">[   39.444356] k_stackoverflow_thread have alloc 4096 bytes in stack, times &#x3D; 7</span><br><span class="line">[   39.444369] Kernel panic - not syncing: corrupted stack end detected inside scheduler</span><br><span class="line">[   39.445278] CPU: 3 PID: 3378 Comm: k_stackoverflow Kdump: loaded Tainted: G           O      5.11.0-rc5+ #10</span><br><span class="line">[   39.445278] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   39.445278] Call Trace:</span><br><span class="line">[   39.445278]  ? k_stackoverflow_thread.cold+0x16&#x2F;0x20 [stack_overflow]</span><br><span class="line">[   39.445278]  ? k_stackoverflow_thread.cold+0x16&#x2F;0x20 [stack_overflow]</span><br><span class="line">[   39.445278]  ? k_stackoverflow_thread.cold+0x16&#x2F;0x20 [stack_overflow]</span><br><span class="line">[   39.445278]  ? kthread+0x10a&#x2F;0x140</span><br><span class="line">[   39.445278]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[   39.445278]  ? ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; bt</span><br><span class="line">PID: 3378   TASK: ffff8fce4d6d4b40  CPU: 3   COMMAND: &quot;k_stackoverflow&quot;</span><br><span class="line">bt: invalid size request: 0  type: &quot;stack contents&quot;</span><br><span class="line">bt: read of stack at fffffe00000b1000 failed</span><br></pre></td></tr></table></figure>

<p>可以看到报错信息，显示很明显，打印出了backtrace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[   39.444369] Kernel panic - not syncing: corrupted stack end detected inside scheduler</span><br></pre></td></tr></table></figure>
<p>但是看到<code>bt</code> 命令已经不能正常显示了。</p>
<ol start="2">
<li>开启<code>CONFIG_VMAP_STACK</code>，使用虚拟内存机制保证<br>参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/memory/stack_overflow/stack_overflow.c">代码</a><br>重新编译内核启动，编译安装test 驱动，得到如下报错信息，由于检测到栈溢出，直接panic了，需要 crash查看现场信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[ 1188.110899] k_stackoverflow_thread have alloc 4096 bytes in stack, times &#x3D; 9</span><br><span class="line">[ 1189.134809] k_stackoverflow_thread have alloc 4096 bytes in stack, times &#x3D; 8</span><br><span class="line">[ 1190.158790] k_stackoverflow_thread have alloc 4096 bytes in stack, times &#x3D; 7</span><br><span class="line">[ 1190.159424] BUG: stack guard page was hit at 000000009af4b1c0 (stack is 0000000013046cba..00000000bab11d7d)</span><br><span class="line">[ 1190.159427] kernel stack overflow (double-fault): 0000 [#1] SMP NOPTI</span><br><span class="line">[ 1190.159428] CPU: 1 PID: 3607 Comm: k_stackoverflow Kdump: loaded Tainted: G           O      5.11.0-rc5+ #8</span><br><span class="line">[ 1190.159430] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[ 1190.159431] RIP: 0010:k_stackoverflow_thread+0x8&#x2F;0x80 [stack_overflow]</span><br><span class="line">[ 1190.159433] Code: Unable to access opcode bytes at RIP 0xffffffffc0238fde.</span><br><span class="line">[ 1190.159434] RSP: 0018:ffff9cc38089bec0 EFLAGS: 00010286</span><br><span class="line">[ 1190.159436] RAX: 0000000000000040 RBX: ffffffffc0239000 RCX: 0000000000000000</span><br><span class="line">[ 1190.159438] RDX: 0000000000000000 RSI: ffff8bc8bfc97fd0 RDI: 0000000000000000</span><br><span class="line">[ 1190.159439] RBP: 0000000000000000 R08: ffff8bc8bfc97fd0 R09: 0000000000000001</span><br><span class="line">[ 1190.159440] R10: 0000000000000001 R11: 0000000000000001 R12: ffff8bc857788040</span><br><span class="line">[ 1190.159441] R13: ffff9cc380907ba8 R14: 0000000000000000 R15: ffff8bc8843a0040</span><br><span class="line">[ 1190.159443] FS:  0000000000000000(0000) GS:ffff8bc8bfc80000(0000) knlGS:0000000000000000</span><br><span class="line">[ 1190.159444] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[ 1190.159445] CR2: ffffffffc0238fde CR3: 000000001627c000 CR4: 00000000000006e0</span><br><span class="line">[ 1190.159446] Call Trace:</span><br><span class="line">[ 1190.159447]  ? __lock_acquire+0x3be&#x2F;0x28a0</span><br><span class="line">[ 1190.159448]  ? __lock_acquire+0x3be&#x2F;0x28a0</span><br><span class="line">[ 1190.159486]  ? rcu_read_lock_sched_held+0x4d&#x2F;0x80</span><br><span class="line">[ 1190.159487]  ? __lock_acquire+0x3be&#x2F;0x28a0</span><br><span class="line">[ 1190.159488]  ? __lock_acquire+0x3be&#x2F;0x28a0</span><br><span class="line">[ 1190.159489]  ? desc_read_finalized_seq+0x26&#x2F;0x80</span><br><span class="line">[ 1190.159490]  ? find_held_lock+0x2b&#x2F;0x80</span><br><span class="line">[ 1190.159491]  ? console_unlock+0x35f&#x2F;0x570</span><br><span class="line">[ 1190.159492]  ? lockdep_hardirqs_on_prepare+0xd4&#x2F;0x170</span><br><span class="line">[ 1190.159493]  ? console_unlock+0x487&#x2F;0x570</span><br><span class="line">[ 1190.159494]  ? __irq_work_queue_local+0x48&#x2F;0x50</span><br><span class="line">[ 1190.159495]  ? irq_work_queue+0x20&#x2F;0x30</span><br><span class="line">[ 1190.159495]  ? wake_up_klogd.part.0+0x32&#x2F;0x40</span><br><span class="line">[ 1190.159496]  ? vprintk_emit+0x98&#x2F;0x2a0</span><br><span class="line">[ 1190.159497]  ? 0xffffffffc0239000</span><br><span class="line">[ 1190.159498]  ? printk+0x53&#x2F;0x6a</span><br><span class="line">[ 1190.159499]  k_stackoverflow_thread.cold+0x16&#x2F;0x20 [stack_overflow]</span><br><span class="line">[ 1190.159500]  k_stackoverflow_thread.cold+0x16&#x2F;0x20 [stack_overflow]</span><br><span class="line">[ 1190.159501]  k_stackoverflow_thread.cold+0x16&#x2F;0x20 [stack_overflow]</span><br><span class="line">[ 1190.159502]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[ 1190.159503]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[ 1190.159504]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[ 1190.159505] Modules linked in: stack_overflow(O)</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>可以很明显看到报错信息指出是 <code>stack overflow</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ 1190.159424] BUG: stack guard page was hit at 000000009af4b1c0 (stack is 0000000013046cba..00000000bab11d7d)</span><br><span class="line">[ 1190.159427] kernel stack overflow (double-fault): 0000 [#1] SMP NOPTI</span><br></pre></td></tr></table></figure>
<p>反汇编一下就可以知道函数地址，结合 backtrace 就看可以知道具体原因</p>
<ol start="3">
<li>gcc 相关参数<code>  </code>默认开启的？<br>我试了一下，有栈溢出，但是没有触发报错，后面有空再看…<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp$ cat debug_out&#x2F;.config |grep STACKPROTECTOR</span><br><span class="line">CONFIG_CC_HAS_SANE_STACKPROTECTOR&#x3D;y</span><br><span class="line">CONFIG_HAVE_STACKPROTECTOR&#x3D;y</span><br><span class="line">CONFIG_STACKPROTECTOR&#x3D;y</span><br><span class="line">CONFIG_STACKPROTECTOR_STRONG&#x3D;y</span><br><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp$</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>开启 <code>CONFIG_SCHED_STACK_END_CHECK</code> 是有一定 overhead的，每次sched的时候都会去检<br>查栈顶的 <code>magic num</code>有无被修改过，且这个也不一定准确，也可能是虽然栈溢了，但是恰好没有<br>改写到 <code>magic num</code>的数据，这种就比较难办。</p>
</li>
<li><p>开启 <code>CONFIG_VMAP_STACK</code>，相对来说 overhead 就少很多了，现在 64bit kernel都是默<br>认打开这个宏定义的，32bit 猜测主要可能是 vmalloc区域太小。</p>
</li>
</ol>
<p>參考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/84591715">知乎文章</a></p>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/hardenedlinux/grsecurity-101-tutorials/blob/master/grsec-code-analysis/kstack.md">文章1</a></p>
<p>參考<a target="_blank" rel="noopener" href="https://github.com/hardenedlinux/grsecurity-101-tutorials/blob/master/grsec-code-analysis/KSTACKOVERFLOW.md">文章2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-27T11:00:00.000Z" title="1/27/2021, 7:00:00 PM">2021-01-27</time>发表</span><span class="level-item"><time dateTime="2022-03-08T08:55:42.335Z" title="3/8/2022, 4:55:42 PM">2022-03-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">2 分钟读完 (大约313个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/27/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/KASAN%20%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">KASAN 原理分析</a></h1><div class="content"><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>granule size == 8<br>tags num == 2^8 == 256</p>
<h2 id="代码实现分析"><a href="#代码实现分析" class="headerlink" title="代码实现分析"></a>代码实现分析</h2><h3 id="tag-有哪些，怎么产生的"><a href="#tag-有哪些，怎么产生的" class="headerlink" title="tag 有哪些，怎么产生的"></a>tag 有哪些，怎么产生的</h3><p>kernel 认为 <code>0xFF</code> 的tag 都是有效的，将不可访问的内存都标记为 <code>0xFE</code>，认为是无效的。<br>在不使能 <code>CONFIG_KASAN_HW_TAGS</code> 特性下，最小的 TAG是 <code>0x00</code>；使能情况下（只有aarch64支持），最小的 TAG是 <code>0xF0</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#define KASAN_TAG_KERNEL	0xFF &#x2F;* native kernel pointers tag *&#x2F;</span><br><span class="line">#define KASAN_TAG_INVALID	0xFE &#x2F;* inaccessible memory tag *&#x2F;</span><br><span class="line">#define KASAN_TAG_MAX		0xFD &#x2F;* maximum value for random tags *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_KASAN_HW_TAGS</span><br><span class="line">#define KASAN_TAG_MIN		0xF0 &#x2F;* minimum value for random tags *&#x2F;</span><br><span class="line">#else</span><br><span class="line">#define KASAN_TAG_MIN		0x00 &#x2F;* minimum value for random tags *&#x2F;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>


<p>通过 <code>kasan_random_tag</code> 可以随机产生一个tag val</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">u8 kasan_random_tag(void)</span><br><span class="line">&#123;</span><br><span class="line">	u32 state &#x3D; this_cpu_read(prng_state);</span><br><span class="line"></span><br><span class="line">	state &#x3D; 1664525 * state + 1013904223;</span><br><span class="line">	this_cpu_write(prng_state, state);</span><br><span class="line"></span><br><span class="line">	return (u8)(state % (KASAN_TAG_MAX + 1));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="kasan-hook点做了啥"><a href="#kasan-hook点做了啥" class="headerlink" title="kasan hook点做了啥"></a>kasan hook点做了啥</h3><p>kasan_kmalloc</p>
<p>kasan_kfree</p>
<h2 id="MTE"><a href="#MTE" class="headerlink" title="MTE"></a>MTE</h2><p>MTE 是一种内存错误检测工具，或者至少是硬件加速工具。<br>第一个实现类似功能的硬件架构 是 <code>SPARCE</code>，</p>
<h2 id="HWKASAN"><a href="#HWKASAN" class="headerlink" title="HWKASAN"></a>HWKASAN</h2><p>参考<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=9wRT2hNwbkA&list=PL7naqTyjyDvBj7dcaTcNp5QSPArZAImv2&index=3&ab_channel=AndreyKonovalov">KASAN 原理解释</a></p>
<p>参考<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=UwMt0e_dC_Q&list=PL7naqTyjyDvBj7dcaTcNp5QSPArZAImv2&index=6&ab_channel=AndreyKonovalov">MTE HWKASAN 原理解释</a></p>
<p>参考<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=qzQNoYwcH2g&ab_channel=Arm%C2%AE">MTE 是什么</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-27T11:00:00.000Z" title="1/27/2021, 7:00:00 PM">2021-01-27</time>发表</span><span class="level-item"><time dateTime="2022-03-11T07:39:23.756Z" title="3/11/2022, 3:39:23 PM">2022-03-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">6 分钟读完 (大约863个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/27/%E9%94%81%E6%9C%BA%E5%88%B6/futex/">futex</a></h1><div class="content"><h2 id="futex-简介"><a href="#futex-简介" class="headerlink" title="futex 简介"></a>futex 简介</h2><p>futex (fast userspace mutex) 是Linux的一个基础组件，可以用来构建各种更高级别的同步机制，比如锁或者信号量等等，POSIX信号量就是基于futex构建的。大多数时候编写应用程序并不需要直接使用futex，一般用基于它所实现的系统库就够了。</p>
<p>传统的SystemV IPC(inter process communication)进程间同步机制都是通过内核对象来实现的，以 semaphore 为例，当进程间要同步的时候，必须通过系统调用semop(2)进入内核进行PV操作。系统调用的缺点是开销很大，需要从user mode切换到kernel mode、保存寄存器状态、从user stack切换到kernel stack、等等，通常要消耗上百条指令。事实上，有一部分系统调用是可以避免的，因为现实中很多同步操作进行的时候根本不存在竞争，即某个进程从持有semaphore直至释放semaphore的这段时间内，常常没有其它进程对同一semaphore有需求，在这种情况下，内核的参与本来是不必要的，可是在传统机制下，持有semaphore必须先调用semop(2)进入内核去看看有没有人和它竞争，释放semaphore也必须调用semop(2)进入内核去看看有没有人在等待同一semaphore，这些不必要的系统调用造成了大量的性能损耗。</p>
<p>futex的解决思路是：在无竞争的情况下操作完全在user space进行，不需要系统调用，仅在发生竞争的时候进入内核去完成相应的处理(wait 或者 wake up)。所以说，futex是一种user mode和kernel mode混合的同步机制，需要两种模式合作才能完成，futex本质就是一个位于user space的变量，而不是内核对象，futex的代码也分为user mode和kernel mode两部分，无竞争的情况下在user mode，发生竞争时则通过sys_futex系统调用进入kernel mode进行处理。<br>但是内核也为了 futex更加健壮，给futex机制增加了好几个syscall:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(set_robust_list, struct robust_list_head __user *, head,</span><br><span class="line">		size_t, len);</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE3(get_robust_list, int, pid,</span><br><span class="line">		struct robust_list_head __user * __user *, head_ptr,</span><br><span class="line">		size_t __user *, len_ptr);</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE6(futex, u32 __user *, uaddr, int, op, u32, val,</span><br><span class="line">		const struct __kernel_timespec __user *, utime,</span><br><span class="line">		u32 __user *, uaddr2, u32, val3);</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE5(futex_waitv, struct futex_waitv __user *, waiters,</span><br><span class="line">		unsigned int, nr_futexes, unsigned int, flags,</span><br><span class="line">		struct __kernel_timespec __user *, timeout, clockid_t, clockid);</span><br></pre></td></tr></table></figure>

<p>主要优点是：</p>
<ul>
<li>futex 自身只是userspace的一个变量。</li>
<li>减少了系统调用，只有竞争的情况下回发生系统调用，无竞争的情况下都是用户空间的操作</li>
<li>避免了不必要的上下文切换（导致的TLB失效等）。</li>
</ul>
<h2 id="futex-userspace-使用案列"><a href="#futex-userspace-使用案列" class="headerlink" title="futex userspace 使用案列"></a>futex userspace 使用案列</h2><p>在 <code>test_modules</code> 中的 <code>futex_demo</code> 案列。</p>
<h3 id="POSIX-sema-mutex-实现"><a href="#POSIX-sema-mutex-实现" class="headerlink" title="POSIX sema mutex 实现"></a>POSIX sema mutex 实现</h3><h2 id="内核部分实现"><a href="#内核部分实现" class="headerlink" title="内核部分实现"></a>内核部分实现</h2><p>参考<a target="_blank" rel="noopener" href="https://pzh2386034.github.io/Black-Jack/pthread/2020/02/08/linux%E9%94%81%E5%AE%9E%E7%8E%B0/">posix mutex userspace 锁实现</a><br>参考<a target="_blank" rel="noopener" href="https://pzh2386034.github.io/Black-Jack/pthread/2020/02/15/linux%E9%94%81%E5%AE%9E%E7%8E%B0-futex%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0/">posix mutex kernelspace 锁实现</a><br>参考<a target="_blank" rel="noopener" href="https://docs.kernel.org/locking/pi-futex.html">轻量级的 PI-futex</a><br>参考<a target="_blank" rel="noopener" href="https://docs.kernel.org/locking/robust-futexes.html">健壮的 robust futex</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-26T11:00:00.000Z" title="1/26/2021, 7:00:00 PM">2021-01-26</time>发表</span><span class="level-item"><time dateTime="2021-01-26T14:25:52.700Z" title="1/26/2021, 10:25:52 PM">2021-01-26</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">22 分钟读完 (大约3228个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/26/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/slub%20debug%20%E5%AE%9A%E4%BD%8D%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/">slub_debug 定位内存越界</a></h1><div class="content"><h2 id="slub-debug-概述"><a href="#slub-debug-概述" class="headerlink" title="slub_debug 概述"></a>slub_debug 概述</h2><p>首先需要使能，一般情况下我们系统都是使用 <code>slub</code>的。所以只需要打开debug选项即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if [ $debug_slubdebug &#x3D;&#x3D; 1 ]</span><br><span class="line">then</span><br><span class="line">## slubdebug detect start</span><br><span class="line">	echo &quot;CONFIG_SLUB_DEBUG_ON&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">## slubdebug detect end</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>写了一个test case,参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/memory/slub_debug/slub_debug.c">代码</a></p>
<p>与 <code>KASAN</code> 可以自动检测出 内存越界，然后报错不同， <code>slub_debug</code> 需要主动触发检测，这里需要使用到<code>slabinfo</code> 这个工具（如果是很快释放的slab,其实不需要 slabinfo），源码在 <code>./tools/vm/</code> 目录下，可以直接编译得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;vm$ make</span><br><span class="line">make -C ..&#x2F;lib&#x2F;api</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;lib&#x2F;api&#39;</span><br><span class="line">make -C &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;build CFLAGS&#x3D; LDFLAGS&#x3D; fixdep</span><br><span class="line">  HOSTCC   fixdep.o</span><br><span class="line">  HOSTLD   fixdep-in.o</span><br><span class="line">  LINK     fixdep</span><br><span class="line">  CC       fd&#x2F;array.o</span><br><span class="line">  LD       fd&#x2F;libapi-in.o</span><br><span class="line">  CC       fs&#x2F;fs.o</span><br><span class="line">  CC       fs&#x2F;tracing_path.o</span><br><span class="line">  CC       fs&#x2F;cgroup.o</span><br><span class="line">  LD       fs&#x2F;libapi-in.o</span><br><span class="line">  CC       cpu.o</span><br><span class="line">  CC       debug.o</span><br><span class="line">  CC       str_error_r.o</span><br><span class="line">  LD       libapi-in.o</span><br><span class="line">  AR       libapi.a</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;lib&#x2F;api&#39;</span><br><span class="line">gcc -Wall -Wextra -I..&#x2F;lib&#x2F; -o page-types page-types.c ..&#x2F;lib&#x2F;api&#x2F;libapi.a</span><br><span class="line">gcc -Wall -Wextra -I..&#x2F;lib&#x2F; -o slabinfo slabinfo.c ..&#x2F;lib&#x2F;api&#x2F;libapi.a</span><br><span class="line">gcc -Wall -Wextra -I..&#x2F;lib&#x2F; -o page_owner_sort page_owner_sort.c ..&#x2F;lib&#x2F;api&#x2F;libapi.a</span><br><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;vm$ ls -al | grep slab</span><br><span class="line">-rwxrwxr-x  1 jenkins jenkins  50416 1月  26 13:12 slabinfo</span><br><span class="line">-rw-rw-r--  1 jenkins jenkins  37868 12月 20 22:58 slabinfo.c</span><br><span class="line">-rw-rw-r--  1 jenkins jenkins   4817 12月 20 22:58 slabinfo-gnuplot.sh</span><br><span class="line">jenkins@server:~&#x2F;workspace&#x2F;linux_kernel_ltp&#x2F;tools&#x2F;vm$</span><br></pre></td></tr></table></figure>

<p><code>slabinfo</code> 也有多个功能，主动触发 合法性检查<code>slabinfo -v</code> 只是一项，还有比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;slub_debug# .&#x2F;slabinfo --help</span><br><span class="line">slabinfo 4&#x2F;15&#x2F;2011. (c) 2007 sgi&#x2F;(c) 2011 Linux Foundation.</span><br><span class="line"></span><br><span class="line">slabinfo [-aABDefhilLnoPrsStTUvXz1] [N&#x3D;K] [-dafzput] [slab-regexp]</span><br><span class="line">-a|--aliases           Show aliases</span><br><span class="line">-A|--activity          Most active slabs first</span><br><span class="line">-B|--Bytes             Show size in bytes</span><br><span class="line">-D|--display-active    Switch line format to activity</span><br><span class="line">-e|--empty             Show empty slabs</span><br><span class="line">-f|--first-alias       Show first alias</span><br><span class="line">-h|--help              Show usage information</span><br><span class="line">-i|--inverted          Inverted list</span><br><span class="line">-l|--slabs             Show slabs</span><br><span class="line">-L|--Loss              Sort by loss</span><br><span class="line">-n|--numa              Show NUMA information</span><br><span class="line">-N|--lines&#x3D;K           Show the first K slabs</span><br><span class="line">-o|--ops               Show kmem_cache_ops</span><br><span class="line">-P|--partial		Sort by number of partial slabs</span><br><span class="line">-r|--report            Detailed report on single slabs</span><br><span class="line">-s|--shrink            Shrink slabs</span><br><span class="line">-S|--Size              Sort by size</span><br><span class="line">-t|--tracking          Show alloc&#x2F;free information</span><br><span class="line">-T|--Totals            Show summary information</span><br><span class="line">-U|--Unreclaim         Show unreclaimable slabs only</span><br><span class="line">-v|--validate          Validate slabs</span><br><span class="line">-X|--Xtotals           Show extended summary information</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="slab-debug使用"><a href="#slab-debug使用" class="headerlink" title="slab debug使用"></a>slab debug使用</h2><h3 id="right-redzone-oob-out-of-bounds"><a href="#right-redzone-oob-out-of-bounds" class="headerlink" title="right redzone oob(out of bounds)"></a>right redzone oob(out of bounds)</h3><p>使用这个函数 kslub_debug_right()<br>编译安装 上面test case之后，主动 <code>sudo ./slabinfo -v</code> 触发合法性检查。<br>可以看到如下输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@130kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;slub_debug# sudo .&#x2F;slabinfo -v</span><br><span class="line">[   53.423227] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   53.424083] BUG kmalloc-32 (Tainted: G           O     ): Redzone overwritten</span><br><span class="line">[   53.424083] -----------------------------------------------------------------------------</span><br><span class="line">[   53.424083]</span><br><span class="line">[   53.424083] INFO: 0x00000000de38e5d6-0x00000000de38e5d6 @offset&#x3D;64. First byte 0x61 instead of 0xcc</span><br><span class="line">[   53.424083] INFO: Allocated in kslub_debug_right+0x1c&#x2F;0x50 [slub_debug] age&#x3D;18928 cpu&#x3D;2 pid&#x3D;3159</span><br><span class="line">[   53.424083] 	__slab_alloc+0x50&#x2F;0x60</span><br><span class="line">[   53.424083] 	kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line">[   53.424083] 	kslub_debug_right+0x1c&#x2F;0x50 [slub_debug]</span><br><span class="line">[   53.424083] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   53.424083] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   53.424083] INFO: Freed in security_cred_free+0x37&#x2F;0x50 age&#x3D;18938 cpu&#x3D;1 pid&#x3D;0</span><br><span class="line">[   53.424083] 	security_cred_free+0x37&#x2F;0x50</span><br><span class="line">[   53.424083] 	put_cred_rcu+0x22&#x2F;0x80</span><br><span class="line">[   53.424083] 	rcu_core+0x25a&#x2F;0xaa0</span><br><span class="line">[   53.424083] 	__do_softirq+0xc7&#x2F;0x419</span><br><span class="line">[   53.424083] 	asm_call_irq_on_stack+0x12&#x2F;0x20</span><br><span class="line">[   53.424083] 	do_softirq_own_stack+0x56&#x2F;0x60</span><br><span class="line">[   53.424083] 	irq_exit_rcu+0xa9&#x2F;0xb0</span><br><span class="line">[   53.424083] 	sysvec_apic_timer_interrupt+0x43&#x2F;0xa0</span><br><span class="line">[   53.424083] 	asm_sysvec_apic_timer_interrupt+0x12&#x2F;0x20</span><br><span class="line">[   53.424083] 	default_idle+0xe&#x2F;0x10</span><br><span class="line">[   53.424083] 	default_idle_call+0x63&#x2F;0x1e0</span><br><span class="line">[   53.424083] 	do_idle+0x1e5&#x2F;0x240</span><br><span class="line">[   53.424083] 	cpu_startup_entry+0x14&#x2F;0x20</span><br><span class="line">[   53.424083] 	secondary_startup_64_no_verify+0xc2&#x2F;0xcb</span><br><span class="line">[   53.424083] INFO: Slab 0x00000000831bf412 objects&#x3D;19 used&#x3D;18 fp&#x3D;0x0000000083bc545d flags&#x3D;0x100000000010201</span><br><span class="line">[   53.424083] INFO: Object 0x00000000f71a6b67 @offset&#x3D;32 fp&#x3D;0x000000000629ace8</span><br><span class="line">[   53.424083]</span><br><span class="line">[   53.424083] Redzone 0000000033d4cff0: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Redzone 00000000bf62d009: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Object 00000000f71a6b67: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   53.424083] Object 00000000e9b4a4ba: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   53.424083] Redzone 00000000de38e5d6: 61 cc cc cc cc cc cc cc                          a.......</span><br><span class="line">[   53.424083] Padding 000000002dddb492: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   53.424083] Padding 0000000010d75c56: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   53.424083] CPU: 1 PID: 3198 Comm: slabinfo Kdump: loaded Tainted: G    B      O      5.11.0-rc4+ #5</span><br><span class="line">[   53.424083] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   53.424083] Call Trace:</span><br><span class="line">[   53.424083]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[   53.424083]  check_bytes_and_report.cold+0x77&#x2F;0xb4</span><br><span class="line">[   53.424083]  check_object+0x193&#x2F;0x250</span><br><span class="line">[   53.424083]  validate_slab+0x127&#x2F;0x170</span><br><span class="line">[   53.424083]  validate_store+0xac&#x2F;0x160</span><br><span class="line">[   53.424083]  slab_attr_store+0x1b&#x2F;0x30</span><br><span class="line">[   53.424083]  kernfs_fop_write+0xca&#x2F;0x1b0</span><br><span class="line">[   53.424083]  vfs_write+0xc6&#x2F;0x360</span><br><span class="line">[   53.424083]  ksys_write+0x63&#x2F;0xe0</span><br><span class="line">[   53.424083]  do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">[   53.424083]  entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">[   53.424083] RIP: 0033:0x7facb81181e7</span><br><span class="line">[   53.424083] Code: 64 89 02 48 c7 c0 ff ff ff ff eb bb 0f 1f 80 00 00 00 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 01 00 00 04</span><br><span class="line">[   53.424083] RSP: 002b:00007ffe1b3ef6c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001</span><br><span class="line">[   53.424083] RAX: ffffffffffffffda RBX: 0000000000000002 RCX: 00007facb81181e7</span><br><span class="line">[   53.424083] RDX: 0000000000000002 RSI: 00005641aa82cb40 RDI: 0000000000000003</span><br><span class="line">[   53.424083] RBP: 00005641aa82cb40 R08: 0000000000000000 R09: 0000000000000002</span><br><span class="line">[   53.424083] R10: 00005641a899065b R11: 0000000000000246 R12: 0000000000000002</span><br><span class="line">[   53.424083] R13: 00005641aa834b80 R14: 00007facb81f44a0 R15: 00007facb81f38a0</span><br><span class="line">[   53.424083] FIX kmalloc-32: Restoring 0x00000000de38e5d6-0x00000000de38e5d6&#x3D;0xcc</span><br><span class="line">[   53.424083]</span><br><span class="line">[   53.424083] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   53.424083] BUG kmalloc-32 (Tainted: G    B      O     ): Redzone overwritten</span><br><span class="line">[   53.424083] -----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>可以看到开启 slub_debug 之后内存布局是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[   53.424083] Redzone 0000000033d4cff0: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Redzone 00000000bf62d009: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   53.424083] Object 00000000f71a6b67: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   53.424083] Object 00000000e9b4a4ba: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   53.424083] Redzone 00000000de38e5d6: 61 cc cc cc cc cc cc cc                          a.......</span><br><span class="line">[   53.424083] Padding 000000002dddb492: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   53.424083] Padding 0000000010d75c56: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br></pre></td></tr></table></figure>

<p>在分配之后（未使用GFP_ZREO mask），object的内容都是 <code>6b</code>, 最后一个字节是<code>a5</code>，其余 redzone 的地方都是填充了<code>cc</code>，最后padding的位置填充了 <code>5a</code>，这些<code>magic num</code> 其实都是在分配的时候assign的。<br>先看各个<code>magic num</code>定义，在 <code>include/linux/poison.h</code> 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;********** mm&#x2F;slab.c **********&#x2F;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Magic nums for obj red zoning.</span><br><span class="line"> * Placed in the first word before and the first word after an obj.</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define	RED_INACTIVE	0x09F911029D74E35BULL	&#x2F;* when obj is inactive *&#x2F;</span><br><span class="line">#define	RED_ACTIVE	0xD84156C5635688C0ULL	&#x2F;* when obj is active *&#x2F;</span><br><span class="line"></span><br><span class="line">#define SLUB_RED_INACTIVE	0xbb</span><br><span class="line">#define SLUB_RED_ACTIVE		0xcc</span><br><span class="line"></span><br><span class="line">&#x2F;* ...and for poisoning *&#x2F;</span><br><span class="line">#define	POISON_INUSE	0x5a	&#x2F;* for use-uninitialised poisoning *&#x2F;</span><br><span class="line">#define POISON_FREE	0x6b	&#x2F;* for use-after-free poisoning *&#x2F;</span><br><span class="line">#define	POISON_END	0xa5	&#x2F;* end-byte of poisoning *&#x2F;</span><br></pre></td></tr></table></figure>

<p>实现主要参考 <code>mm/slub.c</code> 中代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">static int check_slab(struct kmem_cache *s, struct page *page)</span><br><span class="line">&#123;</span><br><span class="line">	int maxobj;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(!irqs_disabled());</span><br><span class="line"></span><br><span class="line">	if (!PageSlab(page)) &#123;</span><br><span class="line">		slab_err(s, page, &quot;Not a valid slab page&quot;);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	maxobj &#x3D; order_objects(compound_order(page), s-&gt;size);</span><br><span class="line">	if (page-&gt;objects &gt; maxobj) &#123;</span><br><span class="line">		slab_err(s, page, &quot;objects %u &gt; max %u&quot;,</span><br><span class="line">			page-&gt;objects, maxobj);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	if (page-&gt;inuse &gt; page-&gt;objects) &#123;</span><br><span class="line">		slab_err(s, page, &quot;inuse %u &gt; max %u&quot;,</span><br><span class="line">			page-&gt;inuse, page-&gt;objects);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;* Slab_pad_check fixes things up after itself *&#x2F;</span><br><span class="line">	slab_pad_check(s, page);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void init_object(struct kmem_cache *s, void *object, u8 val)</span><br><span class="line">&#123;</span><br><span class="line">	u8 *p &#x3D; kasan_reset_tag(object);</span><br><span class="line"></span><br><span class="line">	if (s-&gt;flags &amp; SLAB_RED_ZONE)</span><br><span class="line">		memset(p - s-&gt;red_left_pad, val, s-&gt;red_left_pad);</span><br><span class="line"></span><br><span class="line">	if (s-&gt;flags &amp; __OBJECT_POISON) &#123;</span><br><span class="line">		memset(p, POISON_FREE, s-&gt;object_size - 1);</span><br><span class="line">		p[s-&gt;object_size - 1] &#x3D; POISON_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (s-&gt;flags &amp; SLAB_RED_ZONE)</span><br><span class="line">		memset(p + s-&gt;object_size, val, s-&gt;inuse - s-&gt;object_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static noinline int alloc_debug_processing(struct kmem_cache *s,</span><br><span class="line">					struct page *page,</span><br><span class="line">					void *object, unsigned long addr)</span><br><span class="line">&#123;</span><br><span class="line">	init_object(s, object, SLUB_RED_ACTIVE);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static noinline int free_debug_processing(</span><br><span class="line">	struct kmem_cache *s, struct page *page,</span><br><span class="line">	void *head, void *tail, int bulk_cnt,</span><br><span class="line">	unsigned long addr)</span><br><span class="line">&#123;</span><br><span class="line">    if (s-&gt;flags &amp; SLAB_CONSISTENCY_CHECKS) &#123;</span><br><span class="line">		if (!check_slab(s, page))</span><br><span class="line">			goto out;</span><br><span class="line">	&#125;</span><br><span class="line">    init_object(s, object, SLUB_RED_INACTIVE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>check_slab()</code> 主要用来检查<code>slab</code>合法性<br><code>init_object()</code> 主要用来填充<code>magic num</code><br><code>alloc_debug_processing()</code> 和 <code>free_debug_processing()</code> 会hook在slab分配与释放的路径上，达到对所有 slab 对象分配和释放过程中<code>检查是否越界</code> 和 <code>填充magic num</code>的目的。</p>
<p>但是有时候有些slab申请之后，很久之后才会释放，甚至在整个内核生命周期内都不会释放，那通过 <code>free_debug_processing</code> 这个代码路径就无法执行，就没法检查是否越界了吗？<br>显然不是，这就是<code>slabinfo -v</code>的作用，他最后会调用到内核函数<code>validate_slab()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#ifdef CONFIG_SLUB_DEBUG</span><br><span class="line">static void validate_slab(struct kmem_cache *s, struct page *page)</span><br><span class="line">&#123;</span><br><span class="line">	void *p;</span><br><span class="line">	void *addr &#x3D; page_address(page);</span><br><span class="line">	unsigned long *map;</span><br><span class="line"></span><br><span class="line">	slab_lock(page);</span><br><span class="line"></span><br><span class="line">	if (!check_slab(s, page) || !on_freelist(s, page, NULL))</span><br><span class="line">		goto unlock;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="left-redzone-oob-out-of-bounds"><a href="#left-redzone-oob-out-of-bounds" class="headerlink" title="left redzone oob(out of bounds)"></a>left redzone oob(out of bounds)</h3><p>使用 kslub_debug_left()<br>同样编译安装之后，可以 使用<code>slabinfo -v</code>触发检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;memory&#x2F;slub_debug# sudo slabinfo -v</span><br><span class="line">[   88.049885] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   88.050661] BUG kmalloc-32 (Tainted: G           O     ): Redzone overwritten</span><br><span class="line">[   88.050661] -----------------------------------------------------------------------------</span><br><span class="line">[   88.050661]</span><br><span class="line">[   88.050661] INFO: 0x00000000f7a64828-0x00000000f7a64828 @offset&#x3D;30. First byte 0x61 instead of 0xcc</span><br><span class="line">[   88.050661] INFO: Allocated in kslub_debug_left+0x1c&#x2F;0x50 [slub_debug] age&#x3D;8012 cpu&#x3D;2 pid&#x3D;3207</span><br><span class="line">......</span><br><span class="line">[   88.050661] INFO: Slab 0x00000000736d0bf0 objects&#x3D;19 used&#x3D;13 fp&#x3D;0x0000000001a78134 flags&#x3D;0x100000000010201</span><br><span class="line">[   88.050661] INFO: Object 0x00000000a9f17fea @offset&#x3D;32 fp&#x3D;0x00000000ec20872a</span><br><span class="line">[   88.050661]</span><br><span class="line">[   88.050661] Redzone 000000003a38622f: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc  ................</span><br><span class="line">[   88.050661] Redzone 000000006a2f8e0a: cc cc cc cc cc cc cc cc cc cc cc cc cc cc 61 cc  ..............a.</span><br><span class="line">[   88.050661] Object 00000000a9f17fea: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   88.050661] Object 00000000cc601ad9: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   88.050661] Redzone 0000000050c2e0d4: cc cc cc cc cc cc cc cc                          ........</span><br><span class="line">[   88.050661] Padding 000000009487d314: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   88.050661] Padding 000000008d823823: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   88.050661] CPU: 3 PID: 3212 Comm: slabinfo Kdump: loaded Tainted: G    B      O      5.11.0-rc4+ #5</span><br></pre></td></tr></table></figure>

<p>可以从输出看到原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[   88.050661] BUG kmalloc-32 (Tainted: G           O     ): Redzone overwritten</span><br><span class="line">[   88.050661] INFO: 0x00000000f7a64828-0x00000000f7a64828 @offset&#x3D;30. First byte 0x61 instead of 0xcc</span><br></pre></td></tr></table></figure>


<h3 id="use-after-free"><a href="#use-after-free" class="headerlink" title="use after free"></a>use after free</h3><p>使用 kslub_debug_use_after_free()<br>同样编译安装之后，可以 使用<code>slabinfo -v</code>触发检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[   43.801344] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   43.802065] BUG kmalloc-32 (Tainted: G           O     ): Poison overwritten</span><br><span class="line">[   43.802065] -----------------------------------------------------------------------------</span><br><span class="line">[   43.802065]</span><br><span class="line">[   43.802065] INFO: 0x0000000065d12e59-0x0000000065d12e59 @offset&#x3D;3806. First byte 0x61 instead of 0x6b</span><br><span class="line">[   43.802065] INFO: Allocated in kslub_debug_use_after_free+0x4e&#x2F;0xc0 [slub_debug] age&#x3D;8 cpu&#x3D;1 pid&#x3D;3163</span><br><span class="line">[   43.802065] 	__slab_alloc+0x50&#x2F;0x60</span><br><span class="line">[   43.802065] 	kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line">[   43.802065] 	kslub_debug_use_after_free+0x4e&#x2F;0xc0 [slub_debug]</span><br><span class="line">[   43.802065] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   43.802065] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   43.802065] INFO: Freed in kslub_debug_use_after_free+0x6a&#x2F;0xc0 [slub_debug] age&#x3D;8 cpu&#x3D;1 pid&#x3D;3163</span><br><span class="line">[   43.802065] 	kslub_debug_use_after_free+0x6a&#x2F;0xc0 [slub_debug]</span><br><span class="line">[   43.802065] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   43.802065] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   43.802065] INFO: Slab 0x0000000091c90915 objects&#x3D;19 used&#x3D;19 fp&#x3D;0x0000000000000000 flags&#x3D;0x100000000010200</span><br><span class="line">[   43.802065] INFO: Object 0x000000002c0fb46b @offset&#x3D;3776 fp&#x3D;0x00000000d32afce7</span><br><span class="line">[   43.802065]</span><br><span class="line">[   43.802065] Redzone 000000007de0fb38: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   43.802065] Redzone 0000000010d06595: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   43.802065] Object 000000002c0fb46b: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   43.802065] Object 000000008ffb8d24: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 61 a5  kkkkkkkkkkkkkka.</span><br><span class="line">[   43.802065] Redzone 00000000f5b8c2fa: bb bb bb bb bb bb bb bb                          ........</span><br><span class="line">[   43.802065] Padding 000000007af7da7c: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   43.802065] Padding 000000002d26610c: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   43.802065] FIX kmalloc-32: Restoring 0x0000000065d12e59-0x0000000065d12e59&#x3D;0x6b</span><br><span class="line">[   43.802065]</span><br><span class="line">[   43.802065] FIX kmalloc-32: Marking all objects used</span><br></pre></td></tr></table></figure>

<p>可以从输出看到原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[   43.802065] BUG kmalloc-32 (Tainted: G           O     ): Poison overwritten</span><br><span class="line">[   43.802065] INFO: 0x0000000065d12e59-0x0000000065d12e59 @offset&#x3D;3806. First byte 0x61 instead of 0x6b</span><br></pre></td></tr></table></figure>
<p>可以发现 free 状态的 <code>slab object</code> 的 <code>redzone</code> 填充的是 <code>bb</code> 与使用中的<code>cc</code>不一样，其次 padding还是<code>5a</code>。</p>
<h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><p>使用 kslub_debug_double_free()<br>同样编译安装之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[   99.126747] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   99.128946] BUG kmalloc-32 (Tainted: G    B      O     ): Object already free</span><br><span class="line">[   99.128946] -----------------------------------------------------------------------------</span><br><span class="line">[   99.128946]</span><br><span class="line">[   99.128946] INFO: Allocated in kslub_debug_double_free+0x4e&#x2F;0xd0 [slub_debug] age&#x3D;1517 cpu&#x3D;1 pid&#x3D;3402</span><br><span class="line">[   99.128946] 	__slab_alloc+0x50&#x2F;0x60</span><br><span class="line">[   99.128946] 	kmem_cache_alloc_trace+0x1fb&#x2F;0x230</span><br><span class="line">[   99.128946] 	kslub_debug_double_free+0x4e&#x2F;0xd0 [slub_debug]</span><br><span class="line">[   99.128946] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   99.128946] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   99.128946] INFO: Freed in kslub_debug_double_free+0x6b&#x2F;0xd0 [slub_debug] age&#x3D;1207 cpu&#x3D;1 pid&#x3D;3402</span><br><span class="line">[   99.128946] 	kslub_debug_double_free+0x6b&#x2F;0xd0 [slub_debug]</span><br><span class="line">[   99.128946] 	kthread+0x10a&#x2F;0x140</span><br><span class="line">[   99.128946] 	ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   99.128946] INFO: Slab 0x000000004358aee6 objects&#x3D;19 used&#x3D;16 fp&#x3D;0x000000007cc439c4 flags&#x3D;0x100000000010201</span><br><span class="line">[   99.128946] INFO: Object 0x000000007cc439c4 @offset&#x3D;5856 fp&#x3D;0x0000000000000000</span><br><span class="line">[   99.128946]</span><br><span class="line">[   99.128946] Redzone 000000008f8c9766: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   99.128946] Redzone 00000000ad0c3fcc: bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb bb  ................</span><br><span class="line">[   99.128946] Object 000000007cc439c4: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">[   99.128946] Object 00000000b15b51a4: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">[   99.128946] Redzone 000000009f473013: bb bb bb bb bb bb bb bb                          ........</span><br><span class="line">[   99.128946] Padding 00000000cb92dccb: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   99.128946] Padding 000000006bc8c5e0: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ</span><br><span class="line">[   99.128946] CPU: 1 PID: 3402 Comm: kslub_debug Kdump: loaded Tainted: G    B      O      5.11.0-rc4+ #5</span><br><span class="line">[   99.128946] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   99.128946] Call Trace:</span><br><span class="line">[   99.128946]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[   99.128946]  free_debug_processing.cold+0x10c&#x2F;0x14f</span><br><span class="line">[   99.128946]  __slab_free+0x286&#x2F;0x490</span><br><span class="line">[   99.128946]  ? schedule_timeout+0x1bf&#x2F;0x370</span><br><span class="line">[   99.128946]  ? trace_hardirqs_on+0x1b&#x2F;0xd0</span><br><span class="line">[   99.128946]  kslub_debug_double_free+0x86&#x2F;0xd0 [slub_debug]</span><br><span class="line">[   99.128946]  ? kslub_debug_double_free.part.0+0x20&#x2F;0x20 [slub_debug]</span><br><span class="line">[   99.128946]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[   99.128946]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[   99.128946]  ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   99.160092] FIX kmalloc-32: Object at 0x000000007cc439c4 not freed</span><br></pre></td></tr></table></figure>

<p>可以从输出看到原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[   99.128946] BUG kmalloc-32 (Tainted: G    B      O     ): Object already free</span><br></pre></td></tr></table></figure>
<p><code>double free</code>的问题会直接在 第二次 free的时候打印出日志，不需要<code>slabinfo -v</code>去触发</p>
<h2 id="slubinfo-其他用处"><a href="#slubinfo-其他用处" class="headerlink" title="slubinfo 其他用处"></a>slubinfo 其他用处</h2><p><code>slabinfo -t</code> 可以跟踪 <code>slab</code> 内存分配释放<br><code>slabinfo -A</code> 显示 alias 信息<br><code>slabinfo -T</code> 显示 total 信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash# sudo slabinfo -T</span><br><span class="line">Slabcache Totals</span><br><span class="line">----------------</span><br><span class="line">Slabcaches :             220   Aliases  :           0-&gt;0    Active:    117</span><br><span class="line">Memory used:          211.2M   # Loss   :          112.7M   MRatio:   114%</span><br><span class="line"># Objects  :          265.6K   # PartObj:           17.7K   ORatio:     6%</span><br><span class="line"></span><br><span class="line">Per Cache         Average              Min              Max            Total</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">#Objects             2.2K                1            39.8K           265.6K</span><br><span class="line">#Slabs                185                1             3.3K            21.7K</span><br><span class="line">#PartSlab              16                1              347             1.9K</span><br><span class="line">%PartSlab             56%               0%             100%               9%</span><br><span class="line">PartObjs                6                0             3.8K            17.7K</span><br><span class="line">% PartObj             53%               0%             100%               6%</span><br><span class="line">Memory               1.8M             4.0K            27.1M           211.2M</span><br><span class="line">Used               841.8K               32            22.7M            98.4M</span><br><span class="line">Loss               964.0K             4.0K            14.7M           112.7M</span><br><span class="line"></span><br><span class="line">Per Object        Average              Min              Max</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Memory                742              344            24.5K</span><br><span class="line">User                  370                8             8.1K</span><br><span class="line">Loss                  372              336            16.3K</span><br></pre></td></tr></table></figure>


<h2 id="slub-debug-overhead"><a href="#slub-debug-overhead" class="headerlink" title="slub_debug overhead"></a>slub_debug overhead</h2><p>从 <code>slub debug</code> 原理上看，主要有以下几点 overhead:</p>
<ol>
<li>需要额外空间去放 <code>redzone</code>等为了debug而额外添加的一些字段</li>
<li>需要在 <code>kmalloc</code> <code>kfree</code> 等关键路径上hook 设置、检查 magic num的代码<br>其他倒没有很大的overhead</li>
</ol>
<p>使用公司开发板做一下对比（单核 cortex-A7芯片）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">memory  on      	off</span><br><span class="line">free	105224K		57992K</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cpu     on      off</span><br><span class="line">usr	4.1	5.5</span><br><span class="line">sys	19.8	11.1</span><br><span class="line">idle	75.3	82.2</span><br><span class="line"></span><br><span class="line">loadavg on      off</span><br><span class="line">1	2.91	1.14</span><br><span class="line">5	1.13	0.29</span><br><span class="line">15	0.41	0.10</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>slub_debug</code> 特性大概占用了7% CPU。<br>free内存少了一半，当然，这是个小内存系统，内存只有211Mb。<br>loadavg 也上升了许多，没有去看 <code>sar -B 1</code> 相关指标，应该也出现了不少直接内存回收。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从overall的角度来说，<code>slub debug</code> 通过在 <code>kmalloc</code> <code>kfree</code>的路径上hook了设置和检查 magic num的方式，可以很有效的排查：</p>
<ol>
<li>内存使用越界</li>
<li>内存use after free</li>
<li>double free<br>这三类问题</li>
</ol>
<p>参考 <a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/427.html">wowo 文章1</a><br>参考 <a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/426.html">wowo 文章2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-23T11:00:00.000Z" title="1/23/2021, 7:00:00 PM">2021-01-23</time>发表</span><span class="level-item"><time dateTime="2021-01-21T16:58:39.853Z" title="1/22/2021, 12:58:39 AM">2021-01-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">几秒读完 (大约6个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/23/crash%E4%B8%93%E9%A2%98/x86%20%E5%B9%B3%E5%8F%B0%E5%B8%B8%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8%E5%92%8C%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/">x86 平台常用寄存器和函数调用分析</a></h1><div class="content"><p>后续填坑。。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-23T11:00:00.000Z" title="1/23/2021, 7:00:00 PM">2021-01-23</time>发表</span><span class="level-item"><time dateTime="2021-01-22T08:51:22.401Z" title="1/22/2021, 4:51:22 PM">2021-01-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">14 分钟读完 (大约2161个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/23/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/%E4%BD%BF%E8%83%BDlock_dep%E8%A7%A3%E5%86%B3%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/">使能lock_dep解决死锁问题</a></h1><div class="content"><p>lockdep 就是 <code>lock dependencies</code> 缩写，翻译是 <code>锁依赖</code>。</p>
<h2 id="如何使能-lockdep"><a href="#如何使能-lockdep" class="headerlink" title="如何使能 lockdep"></a>如何使能 lockdep</h2><p>在 <code>make menuconfig</code> 使能 <code>lockdep</code> 之后，会自动增加如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;CONFIG_LOCKUP_DETECTOR&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_SOFTLOCKUP_DETECTOR&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC_VALUE&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_HARDLOCKUP_DETECTOR_PERF&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_HARDLOCKUP_DETECTOR&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_HARDLOCKUP_PANIC&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">echo &quot;CONFIG_BOOTPARAM_HARDLOCKUP_PANIC_VALUE&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br></pre></td></tr></table></figure>
<p>配置之后重新编译运行，会发现在 <code>/proc/lockdep</code> 目录下多出几个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;lock_stat--------置位则可以查看&#x2F;proc&#x2F;lock_stat统计信息，清楚则关闭lockdep统计信息。</span><br><span class="line">&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;max_lock_depth---</span><br><span class="line">&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;prove_locking</span><br><span class="line">&#x2F;proc&#x2F;locks</span><br><span class="line">&#x2F;proc&#x2F;lock_stat-------------------关于锁的使用统计信息</span><br><span class="line">&#x2F;proc&#x2F;lockdep---------------------存在依赖关系的锁</span><br><span class="line">&#x2F;proc&#x2F;lockdep_stats---------------存在依赖关系锁的统计信息</span><br><span class="line">&#x2F;proc&#x2F;lockdep_chains--------------依赖关系锁链表</span><br></pre></td></tr></table></figure>

<h2 id="lockdep-原理"><a href="#lockdep-原理" class="headerlink" title="lockdep 原理"></a>lockdep 原理</h2><p>常见的死锁有如下两种：</p>
<ol>
<li>递归死锁：中断等延迟操作中使用了锁，和外面的锁构成了递归死锁。</li>
<li>AB-BA死锁：多个锁因处理不当而引发死锁，多个内核路径上的所处理顺序不一致也会导致死锁。</li>
</ol>
<p>Linux内核提供死锁调试模块Lockdep，跟踪每个锁的自身状态和各个锁之间的依赖关系，经过一系列的验<br>证规则来确保锁之间依赖关系是正确的。</p>
<p>先看代码注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * this code maps all the lock dependencies as they occur in a live kernel</span><br><span class="line"> * and will warn about the following classes of locking bugs:</span><br><span class="line"> *</span><br><span class="line"> * - lock inversion scenarios</span><br><span class="line"> * - circular lock dependencies</span><br><span class="line"> * - hardirq&#x2F;softirq safe&#x2F;unsafe locking bugs</span><br><span class="line"> *</span><br><span class="line"> * Bugs are reported even if the current locking scenario does not cause</span><br><span class="line"> * any deadlock at this point.</span><br><span class="line"> *</span><br><span class="line"> * I.e. if anytime in the past two locks were taken in a different order,</span><br><span class="line"> * even if it happened for another task, even if those were different</span><br><span class="line"> * locks (but of the same class as this lock), this code will detect it.</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<p>翻译就是可以解决如下的问题</p>
<ol>
<li>锁定反转方案 – ABBA</li>
<li>循环锁依赖性 – 递归锁</li>
<li>hardirq / softirq安全/不安全的锁定错误</li>
</ol>
<h2 id="lockdep-案例"><a href="#lockdep-案例" class="headerlink" title="lockdep 案例"></a>lockdep 案例</h2><p>写了一个<code>ABBA型</code> 基于 spinlock的 deadlock demo。参考 <a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/lock_race/lockdep_test/lockdep_test.c">代码</a><br>其实这个demo 会触发多个问题</p>
<ol>
<li>deadlock 被检测出来。</li>
<li>由于是基于 <code>spinlock</code> 的，所以在等待lock的时候一直处于<code>spin</code>，导致 <code>rcu stall</code></li>
<li>等待 <code>20s</code> 之后，由于基于 <code>spinlock</code>的，所以两个cpu一直未调度，发生 <code>soft lockup</code>，然后 panic.</li>
</ol>
<p>编译安装之后，kmsg 显示如下问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[  147.475517] lockdep_test: loading out-of-tree module taints kernel.</span><br><span class="line">[  157.769995]</span><br><span class="line">[  157.770640] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[  157.770683] WARNING: possible circular locking dependency detected</span><br><span class="line">[  157.770683] 5.11.0-rc4+ #5 Tainted: G           O</span><br><span class="line">[  157.770683] ------------------------------------------------------</span><br><span class="line">[  157.770683] krace_0&#x2F;3755 is trying to acquire lock:</span><br><span class="line">[  157.770683] ffffffffc0527468 (&amp;g_lockdep_test.lock_A)&#123;+.+.&#125;-&#123;2:2&#125;, at: klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]</span><br><span class="line">               but task is already holding lock:</span><br><span class="line">[  157.770683] ffffffffc05274a8 (&amp;g_lockdep_test.lock_B)&#123;+.+.&#125;-&#123;2:2&#125;, at: klockdep_test_BA+0x18&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]</span><br><span class="line">               which lock already depends on the new lock.</span><br><span class="line"></span><br><span class="line">[  157.770683]</span><br><span class="line">               the existing dependency chain (in reverse order) is:</span><br><span class="line">[  157.770683]</span><br><span class="line">               -&gt; #1 (&amp;g_lockdep_test.lock_B)&#123;+.+.&#125;-&#123;2:2&#125;:</span><br><span class="line">[  157.770683]        _raw_spin_lock+0x27&#x2F;0x40</span><br><span class="line">[  157.770683]        klockdep_test_AB+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[  157.770683]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[  157.770683]</span><br><span class="line">               -&gt; #0 (&amp;g_lockdep_test.lock_A)&#123;+.+.&#125;-&#123;2:2&#125;:</span><br><span class="line">[  157.770683]        __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[  157.770683]        lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[  157.770683]        _raw_spin_lock+0x27&#x2F;0x40</span><br><span class="line">[  157.770683]        klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[  157.770683]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[  157.770683]</span><br><span class="line">               other info that might help us debug this:</span><br><span class="line"></span><br><span class="line">[  157.770683]  Possible unsafe locking scenario:</span><br><span class="line"></span><br><span class="line">[  157.770683]        CPU0                    CPU1</span><br><span class="line">[  157.770683]        ----                    ----</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_A);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_A);</span><br><span class="line">[  157.770683]</span><br><span class="line">                *** DEADLOCK ***</span><br><span class="line">[  157.770683] 1 lock held by krace_0&#x2F;3755:</span><br><span class="line">[  157.770683]  #0: ffffffffc05274a8 (&amp;g_lockdep_test.lock_B)&#123;+.+.&#125;-&#123;2:2&#125;, at: klockdep_test_BA+0x18&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]</span><br><span class="line">               stack backtrace:</span><br><span class="line">[  157.770683] CPU: 1 PID: 3755 Comm: krace_0 Kdump: loaded Tainted: G           O      5.11.0-rc4+ #5</span><br><span class="line">[  157.770683] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1 04&#x2F;01&#x2F;2014</span><br><span class="line">[  157.770683] Call Trace:</span><br><span class="line">[  157.770683]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[  157.770683]  check_noncircular+0xfe&#x2F;0x110</span><br><span class="line">[  157.770683]  ? find_held_lock+0x2b&#x2F;0x80</span><br><span class="line">[  157.770683]  __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[  157.770683]  lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[  157.770683]  ? klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  ? klockdep_test_AB+0x80&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  _raw_spin_lock+0x27&#x2F;0x40</span><br><span class="line">[  157.770683]  ? klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  klockdep_test_BA+0x2e&#x2F;0x80 [lockdep_test]</span><br><span class="line">[  157.770683]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[  157.770683]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[  157.770683]  ret_from_fork+0x22&#x2F;0x30</span><br></pre></td></tr></table></figure>

<p>其中可以很明显看到如下提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[  157.770683]        CPU0                    CPU1</span><br><span class="line">[  157.770683]        ----                    ----</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_A);</span><br><span class="line">[  157.770683]                                lock(&amp;g_lockdep_test.lock_B);</span><br><span class="line">[  157.770683]   lock(&amp;g_lockdep_test.lock_A);</span><br></pre></td></tr></table></figure>

<p>这个提示简直无敌，完美显示了 <code>deadlock</code> 的原因</p>
<p>写了一个<code>ABBA型</code> 基于 mutex 的 deadlock demo。参考 <a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/lock_race/lockdep_test_mutex/lockdep_test_mutex.c">代码</a><br>其实这个demo 会触发多个问题</p>
<ol>
<li>deadlock 被检测出来。</li>
<li>等待 <code>120s</code> 之后，由于基于 <code>mutex</code>的，所以发生死锁的俩线程都是 <code>D状态</code>，所以检测到发生 <code>hung_task</code>，然后 panic.</li>
</ol>
<p>为啥 <code>mutex</code> 的waiter会 处于 <code>D状态</code> ？看看代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static noinline void __sched</span><br><span class="line">__mutex_lock_slowpath(struct mutex *lock)</span><br><span class="line">&#123;</span><br><span class="line">	__mutex_lock(lock, TASK_UNINTERRUPTIBLE, 0, NULL, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __sched mutex_lock(struct mutex *lock)</span><br><span class="line">&#123;</span><br><span class="line">	if (!__mutex_trylock_fast(lock))</span><br><span class="line">		__mutex_lock_slowpath(lock);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(mutex_lock);</span><br></pre></td></tr></table></figure>
<p>发现等待 mutex的线程都会被设置成 <code>TASK_UNINTERRUPTIBLE</code>，也就是 <code>D状态</code>。</p>
<p>也可以通过 hung_task 之后panic 的现场看出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; ps | grep UN</span><br><span class="line">   3193      2   2  ffff9127bb82b240  UN   0.0       0      0  [krace_0]</span><br><span class="line">   3194      2   0  ffff9127c3458040  UN   0.0       0      0  [krace_1]</span><br><span class="line">crash&gt; bt 3193</span><br><span class="line">PID: 3193   TASK: ffff9127bb82b240  CPU: 2   COMMAND: &quot;krace_0&quot;</span><br><span class="line"> #0 [ffffb557007efd78] __schedule at ffffffff8c319af2</span><br><span class="line"> #1 [ffffb557007efe08] schedule at ffffffff8c31a1e6</span><br><span class="line"> #2 [ffffb557007efe20] schedule_preempt_disabled at ffffffff8c31a53c</span><br><span class="line"> #3 [ffffb557007efe28] __mutex_lock at ffffffff8c31bcd5</span><br><span class="line"> #4 [ffffb557007eff08] klockdep_test_mutex_BA at ffffffffc02990b2 [lockdep_test_mutex]</span><br><span class="line"> #5 [ffffb557007eff10] kthread at ffffffff8b6930da</span><br><span class="line"> #6 [ffffb557007eff50] ret_from_fork at ffffffff8b601ae2</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; bt 3194</span><br><span class="line">PID: 3194   TASK: ffff9127c3458040  CPU: 0   COMMAND: &quot;krace_1&quot;</span><br><span class="line"> #0 [ffffb557004c3d78] __schedule at ffffffff8c319af2</span><br><span class="line"> #1 [ffffb557004c3e08] schedule at ffffffff8c31a1e6</span><br><span class="line"> #2 [ffffb557004c3e20] schedule_preempt_disabled at ffffffff8c31a53c</span><br><span class="line"> #3 [ffffb557004c3e28] __mutex_lock at ffffffff8c31bcd5</span><br><span class="line"> #4 [ffffb557004c3f08] klockdep_test_mutex_AB at ffffffffc0299032 [lockdep_test_mutex]</span><br><span class="line"> #5 [ffffb557004c3f10] kthread at ffffffff8b6930da</span><br><span class="line"> #6 [ffffb557004c3f50] ret_from_fork at ffffffff8b601ae2</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>krace_0</code> <code>krace_1</code> 线程都是处于 <code>UN</code> 状态，这也导致此时系统负载有<code>2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; sys</span><br><span class="line">      KERNEL: vmlinux</span><br><span class="line">    DUMPFILE: dump.202101221553  [PARTIAL DUMP]</span><br><span class="line">        CPUS: 4</span><br><span class="line">        DATE: Fri Jan 22 15:53:16 CST 2021</span><br><span class="line">      UPTIME: 00:04:06</span><br><span class="line">LOAD AVERAGE: 1.96, 1.10, 0.46</span><br></pre></td></tr></table></figure>

<p>再看一下 检测到的死锁日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[   60.151205] lockdep_test_mutex: loading out-of-tree module taints kernel.</span><br><span class="line">[   70.216063]</span><br><span class="line">[   70.216623] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[   70.216866] WARNING: possible circular locking dependency detected</span><br><span class="line">[   70.216866] 5.11.0-rc4+ #5 Tainted: G           O</span><br><span class="line">[   70.216866] ------------------------------------------------------</span><br><span class="line">[   70.216866] krace_0&#x2F;3193 is trying to acquire lock:</span><br><span class="line">[   70.216866] ffffffffc029b4b8 (&amp;g_lockdep_test_mutex.lock_A)&#123;+.+.&#125;-&#123;3:3&#125;, at: klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]</span><br><span class="line">               but task is already holding lock:</span><br><span class="line">[   70.216866] ffffffffc029b548 (&amp;g_lockdep_test_mutex.lock_B)&#123;+.+.&#125;-&#123;3:3&#125;, at: klockdep_test_mutex_BA+0x1a&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]</span><br><span class="line">               which lock already depends on the new lock.</span><br><span class="line"></span><br><span class="line">[   70.216866]</span><br><span class="line">               the existing dependency chain (in reverse order) is:</span><br><span class="line">[   70.216866]</span><br><span class="line">               -&gt; #1 (&amp;g_lockdep_test_mutex.lock_B)&#123;+.+.&#125;-&#123;3:3&#125;:</span><br><span class="line">[   70.216866]        __mutex_lock+0x8d&#x2F;0x920</span><br><span class="line">[   70.216866]        klockdep_test_mutex_AB+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[   70.216866]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   70.216866]</span><br><span class="line">               -&gt; #0 (&amp;g_lockdep_test_mutex.lock_A)&#123;+.+.&#125;-&#123;3:3&#125;:</span><br><span class="line">[   70.216866]        __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[   70.216866]        lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[   70.216866]        __mutex_lock+0x8d&#x2F;0x920</span><br><span class="line">[   70.216866]        klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]        kthread+0x10a&#x2F;0x140</span><br><span class="line">[   70.216866]        ret_from_fork+0x22&#x2F;0x30</span><br><span class="line">[   70.216866]</span><br><span class="line">               other info that might help us debug this:</span><br><span class="line"></span><br><span class="line">[   70.216866]  Possible unsafe locking scenario:</span><br><span class="line"></span><br><span class="line">[   70.216866]        CPU0                    CPU1</span><br><span class="line">[   70.216866]        ----                    ----</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_A);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_A);</span><br><span class="line">[   70.216866]</span><br><span class="line">                *** DEADLOCK ***</span><br><span class="line"></span><br><span class="line">[   70.216866] 1 lock held by krace_0&#x2F;3193:</span><br><span class="line">[   70.216866]  #0: ffffffffc029b548 (&amp;g_lockdep_test_mutex.lock_B)&#123;+.+.&#125;-&#123;3:3&#125;, at: klockdep_test_mutex_BA+0x1a&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]</span><br><span class="line">               stack backtrace:</span><br><span class="line">[   70.216866] CPU: 2 PID: 3193 Comm: krace_0 Kdump: loaded Tainted: G           O      5.11.0-rc4+ #5</span><br><span class="line">[   70.216866] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1 04&#x2F;01&#x2F;2014</span><br><span class="line">[   70.216866] Call Trace:</span><br><span class="line">[   70.216866]  dump_stack+0x77&#x2F;0x97</span><br><span class="line">[   70.216866]  check_noncircular+0xfe&#x2F;0x110</span><br><span class="line">[   70.216866]  __lock_acquire+0x139e&#x2F;0x28a0</span><br><span class="line">[   70.216866]  lock_acquire+0xbd&#x2F;0x360</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? lockdep_hardirqs_on_prepare+0xd4&#x2F;0x170</span><br><span class="line">[   70.216866]  ? _raw_spin_unlock_irqrestore+0x34&#x2F;0x40</span><br><span class="line">[   70.216866]  __mutex_lock+0x8d&#x2F;0x920</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? find_held_lock+0x2b&#x2F;0x80</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? __next_timer_interrupt+0x100&#x2F;0x100</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_AB+0x80&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  ? klockdep_test_mutex_AB+0x80&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  klockdep_test_mutex_BA+0x32&#x2F;0x80 [lockdep_test_mutex]</span><br><span class="line">[   70.216866]  kthread+0x10a&#x2F;0x140</span><br><span class="line">[   70.216866]  ? kthread_park+0x80&#x2F;0x80</span><br><span class="line">[   70.216866]  ret_from_fork+0x22&#x2F;0x30</span><br></pre></td></tr></table></figure>

<p>同样也是 给出了很详细出错位置，对于找出问题代码一如反掌。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[   70.216866]        CPU0                    CPU1</span><br><span class="line">[   70.216866]        ----                    ----</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_A);</span><br><span class="line">[   70.216866]                                lock(&amp;g_lockdep_test_mutex.lock_B);</span><br><span class="line">[   70.216866]   lock(&amp;g_lockdep_test_mutex.lock_A);</span><br></pre></td></tr></table></figure>

<h2 id="lockdep-代码"><a href="#lockdep-代码" class="headerlink" title="lockdep 代码"></a>lockdep 代码</h2><p>之后填坑</p>
<h2 id="死锁带来的影响"><a href="#死锁带来的影响" class="headerlink" title="死锁带来的影响"></a>死锁带来的影响</h2><p>对于线程自身</p>
<ol>
<li><code>spinlock</code> 的死锁可以带来 线程一直在<code>spin</code>，占用cpu且无法恢复.</li>
<li><code>mutex</code> <code>semaphore</code> <code>rwsem</code> 的死锁会在<code>slowpath</code> 中让线程进入了<br><code>TASK_UNINTERRUPTIBLE</code> 状态，导致不响应外部信号，也无法使用 <code>kill</code> 去杀死</li>
</ol>
<p>对于系统</p>
<ol>
<li><code>spinlock</code> 的死锁可以带来 <code>rcu stall</code> <code>soft lockup</code> <code>hard lockup</code>问题，如果对应项<br>设置了 panic 选项，就会导致 kernel panic.</li>
<li><code>mutex</code> <code>semaphore</code> <code>rwsem</code> 的死锁会带来系统的 load升高，因为都在 <code>slowpath</code> 中让线<br>程进入了<code>TASK_UNINTERRUPTIBLE</code> 状态，会被统计为系统负载，最后会导致 hung_task 发生，如果对应项设置了 panic 选项，就会导致 kernel panic.</li>
</ol>
<p>不同锁进入slowpath的行为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mutex:</span><br><span class="line">static noinline void __sched</span><br><span class="line">__mutex_lock_slowpath(struct mutex *lock)</span><br><span class="line">&#123;</span><br><span class="line">	__mutex_lock(lock, TASK_UNINTERRUPTIBLE, 0, NULL, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">semaphore:</span><br><span class="line">static noinline void __sched __down(struct semaphore *sem)</span><br><span class="line">&#123;</span><br><span class="line">	__down_common(sem, TASK_UNINTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">semaphore:</span><br><span class="line">static noinline void __sched __down(struct semaphore *sem)</span><br><span class="line">&#123;</span><br><span class="line">	__down_common(sem, TASK_UNINTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rwsem:</span><br><span class="line">static inline void __down_write(struct rw_semaphore *sem)</span><br><span class="line">&#123;</span><br><span class="line">	__down_write_common(sem, TASK_UNINTERRUPTIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以参考：<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20892822/how-to-use-lockdep-feature-in-linux-kernel-for-deadlock-detection">stack overflow提问</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/arnoldlu/p/8580387.html">博客园文章</a><br><a target="_blank" rel="noopener" href="http://kernel.meizu.com/linux-dead-lock-detect-lockdep.html">魅族内核团队文章</a><br><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/locking/">内核文档</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-21T07:00:00.000Z" title="1/21/2021, 3:00:00 PM">2021-01-21</time>发表</span><span class="level-item"><time dateTime="2021-01-21T11:15:12.397Z" title="1/21/2021, 7:15:12 PM">2021-01-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">8 分钟读完 (大约1209个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/21/crash%E4%B8%93%E9%A2%98/%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E7%A9%BA%E6%8C%87%E9%92%88oops/">最简单的空指针oops</a></h1><div class="content"><p>只是做一个记录，为了演示最简单的空指针case, 写了一个demo, 可以参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/null_pointer/01_null_pointer/01_null_pointer.c">github 代码</a></p>
<h2 id="用-crash-分析"><a href="#用-crash-分析" class="headerlink" title="用 crash 分析"></a>用 <code>crash</code> 分析</h2><p><code>insmod</code> 出错之后已经生成了相关 <code>dump</code>文件。<br>下面直接使用 <code>crash</code> 工具分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">stable_kernel@kernel: &#x2F;var&#x2F;crash&#x2F;202101211201# sudo crash vmlinux dump</span><br><span class="line">crash 7.2.9++</span><br><span class="line">GNU gdb (GDB) 7.6</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;...</span><br><span class="line">WARNING: kernel relocated [704MB]: patching 137170 gdb minimal_symbol values</span><br><span class="line"></span><br><span class="line">      KERNEL: vmlinux</span><br><span class="line">    DUMPFILE: dump.202101211201  [PARTIAL DUMP]</span><br><span class="line">        CPUS: 4</span><br><span class="line">        DATE: Thu Jan 21 12:00:56 CST 2021</span><br><span class="line">      UPTIME: 00:12:53</span><br><span class="line">LOAD AVERAGE: 0.16, 0.11, 0.10</span><br><span class="line">       TASKS: 454</span><br><span class="line">    NODENAME: rlk-Standard-PC-i440FX-PIIX-1996</span><br><span class="line">     RELEASE: 5.11.0-rc4+</span><br><span class="line">     VERSION: #5 SMP Wed Jan 20 20:41:47 CST 2021</span><br><span class="line">     MACHINE: x86_64  (3692 Mhz)</span><br><span class="line">      MEMORY: 2 GB</span><br><span class="line">       PANIC: &quot;Oops: 0002 [#1] SMP NOPTI&quot; (check log for details)</span><br><span class="line">         PID: 3605</span><br><span class="line">     COMMAND: &quot;krace_thread&quot;</span><br><span class="line">        TASK: ffffa1b006754b40  [THREAD_INFO: ffffa1b006754b40]</span><br><span class="line">         CPU: 2</span><br><span class="line">       STATE: TASK_RUNNING (PANIC)</span><br><span class="line"></span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到 发生问题的 kernel 版本是 <code>5.11.0-rc4+</code>，编译时间是 <code>#5 SMP Wed Jan 20 20:41:47 CST 2021</code>，内存大小是 <code>2G</code>，出问题时刻的负载是<code>0.16, 0.11, 0.10</code></p>
<p>PANIC 原因是<code>&quot;Oops: 0002 [#1] SMP NOPTI&quot; (check log for details)</code>，CPU:2 上的TASK（krace_thread-3605）: <code>ffffa1b006754b40</code>发生了 oops，具体原因需要看 日志来得到。</p>
<h2 id="bt-查看出问题的task"><a href="#bt-查看出问题的task" class="headerlink" title="bt 查看出问题的task"></a><code>bt</code> 查看出问题的task</h2><p>crash 运行之后默认的task是出问题的task，可以通过 <code>set</code> 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; set</span><br><span class="line">    PID: 3605</span><br><span class="line">COMMAND: &quot;krace_thread&quot;</span><br><span class="line">   TASK: ffffa1b006754b40  [THREAD_INFO: ffffa1b006754b40]</span><br><span class="line">    CPU: 2</span><br><span class="line">  STATE: TASK_RUNNING (PANIC)</span><br></pre></td></tr></table></figure>

<p>bt 可以查看当前追踪的task的 <code>backtrace</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; bt</span><br><span class="line">PID: 3605   TASK: ffffa1b006754b40  CPU: 2   COMMAND: &quot;krace_thread&quot;</span><br><span class="line"> #0 [ffffbbbf004ebc40] machine_kexec at ffffffffad04d87c</span><br><span class="line"> #1 [ffffbbbf004ebc88] __crash_kexec at ffffffffad1283b8</span><br><span class="line"> #2 [ffffbbbf004ebd50] crash_kexec at ffffffffad1290d0</span><br><span class="line"> #3 [ffffbbbf004ebd60] oops_end at ffffffffad021d75</span><br><span class="line"> #4 [ffffbbbf004ebd80] no_context at ffffffffad0570e0</span><br><span class="line"> #5 [ffffbbbf004ebdf0] __bad_area_nosemaphore at ffffffffad0572c7</span><br><span class="line"> #6 [ffffbbbf004ebe38] exc_page_fault at ffffffffadd16b67</span><br><span class="line"> #7 [ffffbbbf004ebe60] asm_exc_page_fault at ffffffffade00ace</span><br><span class="line"> #8 [ffffbbbf004ebee8] create_oops at ffffffffc0371027 [01_null_pointer]</span><br><span class="line"> #9 [ffffbbbf004ebf10] kthread at ffffffffad0930da</span><br><span class="line">#10 [ffffbbbf004ebf50] ret_from_fork at ffffffffad001ae2</span><br></pre></td></tr></table></figure>
<p><code>bt -c 1</code>： 可以查看 cpu:1 上当前运行的线程的backtrace<br><code>bt -a</code>  ： 可以查看 当前所有 cpu上运行的线程的backtrace</p>
<p>这个case 十分显然，是 <code>create_oops</code> 这里出现了问题。</p>
<h2 id="dis-查看bug地址"><a href="#dis-查看bug地址" class="headerlink" title="dis 查看bug地址"></a>dis 查看bug地址</h2><p><code>dis</code> 是 disassemble 反汇编的缩写，可以</p>
<ol>
<li>查看出问题 <code>text</code> 地址内容</li>
<li>某个函数 <code>symbol</code> 符号内容</li>
<li>某个函数 <code>symbol</code> 符号 + 偏移的内容</li>
<li>某个符号 或者 <code>text</code> 与 代码行显示在一起（如果是<code>module</code> 中crash需要加载 module.ko）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; dis ffffffffc0371027</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; dis create_oops</span><br><span class="line">0xffffffffc0371000 &lt;create_oops&gt;:       mov    $0x1388,%edi</span><br><span class="line">0xffffffffc0371005 &lt;create_oops+5&gt;:     callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">0xffffffffc037100a &lt;create_oops+10&gt;:    mov    $0xffffffffc037203c,%rdi</span><br><span class="line">0xffffffffc0371011 &lt;create_oops+17&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">0xffffffffc0371016 &lt;create_oops+22&gt;:    mov    $0x1388,%edi</span><br><span class="line">0xffffffffc037101b &lt;create_oops+27&gt;:    callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">0xffffffffc0371020 &lt;create_oops+32&gt;:    mov    $0xffffffffc037204f,%rdi</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">0xffffffffc0371032 &lt;create_oops+50&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">0xffffffffc0371037 &lt;create_oops+55&gt;:    xor    %eax,%eax</span><br><span class="line">0xffffffffc0371039 &lt;create_oops+57&gt;:    retq</span><br><span class="line">crash&gt; dis create_oops+39</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

<p>直接可以看出问题是，将立即数<code>$0x0</code> 赋值到 地址<code>0x0</code>中，所以直接 oops了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br></pre></td></tr></table></figure>


<p>但是在哪一行呢，这就需要加载 ko文件了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; lsmod</span><br><span class="line">     MODULE       NAME              SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0373000  01_null_pointer  16384  (not loaded)  [CONFIG_KALLSYMS]</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; mod -s 01_null_pointer &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.ko</span><br><span class="line">     MODULE       NAME              SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0373000  01_null_pointer  16384  &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.ko</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; lsmod</span><br><span class="line">     MODULE       NAME              SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0373000  01_null_pointer  16384  &#x2F;tmp&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.ko</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>

<p>加载 ko文件之后，直接 <code>dis -l</code> 反汇编 出问题的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; dis -l create_oops</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 12</span><br><span class="line">0xffffffffc0371000 &lt;create_oops&gt;:       mov    $0x1388,%edi</span><br><span class="line">0xffffffffc0371005 &lt;create_oops+5&gt;:     callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 13</span><br><span class="line">0xffffffffc037100a &lt;create_oops+10&gt;:    mov    $0xffffffffc037203c,%rdi</span><br><span class="line">0xffffffffc0371011 &lt;create_oops+17&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 14</span><br><span class="line">0xffffffffc0371016 &lt;create_oops+22&gt;:    mov    $0x1388,%edi</span><br><span class="line">0xffffffffc037101b &lt;create_oops+27&gt;:    callq  0xffffffffad104b80 &lt;msleep&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 16</span><br><span class="line">0xffffffffc0371020 &lt;create_oops+32&gt;:    mov    $0xffffffffc037204f,%rdi</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 17</span><br><span class="line">0xffffffffc0371032 &lt;create_oops+50&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 18</span><br><span class="line">0xffffffffc0371037 &lt;create_oops+55&gt;:    xor    %eax,%eax</span><br><span class="line">0xffffffffc0371039 &lt;create_oops+57&gt;:    retq</span><br></pre></td></tr></table></figure>

<p>直接定位到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">01_null_pointer.c: 16</span><br><span class="line">0xffffffffc0371020 &lt;create_oops+32&gt;:    mov    $0xffffffffc037204f,%rdi</span><br><span class="line">0xffffffffc0371027 &lt;create_oops+39&gt;:    movl   $0x0,0x0</span><br></pre></td></tr></table></figure>

<p>代码中看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(int *)0 &#x3D; 0;</span><br></pre></td></tr></table></figure>

<p>问题很快解决了。</p>
<h2 id="试着查看x86-如何调用函数传参的"><a href="#试着查看x86-如何调用函数传参的" class="headerlink" title="试着查看x86 如何调用函数传参的"></a>试着查看x86 如何调用函数传参的</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 12</span><br><span class="line">0xffffffffc0371000 &lt;create_oops&gt;:       mov    $0x1388,%edi</span><br><span class="line">0xffffffffc0371005 &lt;create_oops+5&gt;:     callq  0xffffffffad104b80 &lt;msleep&gt;</span><br></pre></td></tr></table></figure>

<p>对应代码是，<code>0x1388</code> 就是十六进制的 <code>5000</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msleep(5000);</span><br></pre></td></tr></table></figure>
<p>是不是第一个整形参数是存在 <code>edi</code> 寄存器中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;test_modules&#x2F;null_pointer&#x2F;01_null_pointer&#x2F;01_null_pointer.c: 13</span><br><span class="line">0xffffffffc037100a &lt;create_oops+10&gt;:    mov    $0xffffffffc037203c,%rdi</span><br><span class="line">0xffffffffc0371011 &lt;create_oops+17&gt;:    callq  0xffffffffadcc96da &lt;printk&gt;</span><br></pre></td></tr></table></figure>

<p>对应的代码是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(&quot;create_oops start\n&quot;);</span><br></pre></td></tr></table></figure>

<p><code>0xffffffffc037203c</code> 是啥呢？可以使用 <code>rd</code> 命令读取一下，原来是字符串的起始的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; rd 0xffffffffc037203c 4</span><br><span class="line">ffffffffc037203c:  6f5f657461657263 726174732073706f   create_oops star</span><br><span class="line">ffffffffc037204c:  7461657263000a74 652073706f6f5f65   t..create_oops e</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure>
<p>是不是 第一个地址型参数是存放在 <code>rdi</code> 中的呢？</p>
<p>后面会用不同个数参数，不同类型参数的函数 crash，来实验一下这个是不是对～</p>
<p>找到<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27339191">一篇讲解x86-64寄存器和函数调用的文章</a>，上面说的猜想就是扯淡。。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-17T11:00:00.000Z" title="1/17/2021, 7:00:00 PM">2021-01-17</time>发表</span><span class="level-item"><time dateTime="2021-01-21T09:06:22.284Z" title="1/21/2021, 5:06:22 PM">2021-01-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">12 分钟读完 (大约1859个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/17/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/valgrind%20%E5%AE%9A%E4%BD%8D%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">valgrind 定位用户空间内存泄漏</a></h1><div class="content"><h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY"></a>WHY</h2><p>在实际开发中，某个应用程序如果存在内存泄露，且是长时间运行的程序，就会导致比较严重的后果。<br>在一些业务场景的长跑测试中，这些问题往往会充分暴露出来。</p>
<p>一般情况下这种内存泄漏都是以 OOM Kill 而结尾的。 kmsg log 往往只有 这个进程确实消耗了大量进<br>程的证据，但是无法确切知道是哪里的内存泄漏，这里就需要一个工具来帮助检测，如果是发生内存泄漏之后<br>仅仅通过人肉去分析代码，往往很困难。</p>
<p>valgrind 就是这样一款 强大的工具：</p>
<ol>
<li>检查用户空间内存泄漏</li>
<li>检查</li>
</ol>
<h2 id="valdrind-原理"><a href="#valdrind-原理" class="headerlink" title="valdrind 原理"></a>valdrind 原理</h2><h2 id="valdrind-安装，使用"><a href="#valdrind-安装，使用" class="headerlink" title="valdrind 安装，使用"></a>valdrind 安装，使用</h2><p>直接安装， ubuntu 官方软件源已经包含了，其他平台可以通过源码编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@100ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# sudo apt install valgrind</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following packages were automatically installed and are no longer required:</span><br><span class="line">  openbsd-inetd openjdk-11-jdk-headless tcpd update-inetd</span><br><span class="line">Use &#39;sudo apt autoremove&#39; to remove them.</span><br><span class="line">Suggested packages:</span><br><span class="line">  valgrind-dbg valgrind-mpi kcachegrind alleyoop valkyrie</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  valgrind</span><br><span class="line">0 upgraded, 1 newly installed, 0 to remove and 231 not upgraded.</span><br><span class="line">Need to get 20.3 MB of archives.</span><br><span class="line">After this operation, 90.0 MB of additional disk space will be used.</span><br><span class="line">Get:1 https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu focal-updates&#x2F;main amd64 valgrind amd64 1:3.15.0-1ubuntu9.1 [20.3 MB]</span><br><span class="line">48% [1 valgrind 12.2 MB&#x2F;20.3 MB 60%]</span><br><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# ls</span><br></pre></td></tr></table></figure>

<p>使用如下代码检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 3;</span><br><span class="line">        char *p &#x3D; NULL;</span><br><span class="line">        p &#x3D; malloc(1024 * 1024);</span><br><span class="line">        if (!p)</span><br><span class="line">                printf(&quot;malloc failed,just wait!!\n&quot;);</span><br><span class="line"></span><br><span class="line">        printf(&quot;malloc sucess,just wait!!\n&quot;);</span><br><span class="line"></span><br><span class="line">        while(i--) &#123;</span><br><span class="line">                usleep(1000 * 1000);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>对于 valgrind 不好的地方在于：</p>
<ol>
<li><p>对于想使用 valgrind来检查内存泄漏的业务来说，必须从开始 用valgrind 启动，意味着对于业务<br>需要重启。还有比如很难复现的内存泄漏，等你重启业务用 valgrind来启动，说不定又不复现了。。</p>
</li>
<li><p>对于 valgrind 启动的业务来说，会比直接启动有一些性能损失。</p>
</li>
</ol>
<h3 id="userspace-memleak-demo"><a href="#userspace-memleak-demo" class="headerlink" title="userspace memleak demo"></a>userspace memleak demo</h3><p>使用上面代码 直接用 <code>valgrind</code> 启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# valgrind .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Memcheck, a memory error detector</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Command: .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">malloc sucess,just wait!!</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; HEAP SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;     in use at exit: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;   total heap usage: 2 allocs, 1 frees, 1,049,600 bytes allocated</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; LEAK SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;    definitely lost: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;    still reachable: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;         suppressed: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; Rerun with --leak-check&#x3D;full to see details of leaked memory</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D; ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>HEAP SUMMARY:</code> 中写了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;     in use at exit: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813281&#x3D;&#x3D;   total heap usage: 2 allocs, 1 frees, 1,049,600 bytes allocated</span><br></pre></td></tr></table></figure>
<p>在进程退出时，仍然有 <code>1048576 bytes</code> 内存在使用中，这部分就是泄漏的内存。但是我们仍然不能确<br>定到底是哪里泄漏的内存，按照他的建议 加上 <code>-leak-check=full</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak# valgrind  --leak-check&#x3D;full  .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Memcheck, a memory error detector</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; Command: .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">malloc sucess,just wait!!</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; HEAP SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;     in use at exit: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;   total heap usage: 2 allocs, 1 frees, 1,049,600 bytes allocated</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D; 1,048,576 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    by 0x1091AD: main (in &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak&#x2F;a.out)</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; LEAK SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    definitely lost: 1,048,576 bytes in 1 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    still reachable: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;         suppressed: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D; ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span><br><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak#</span><br></pre></td></tr></table></figure>

<p>可以看到这次， <code>valgrind</code> 已经将泄漏的具体位置打印了出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2813434&#x3D; 1,048,576 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2813434&#x3D;&#x3D;    by 0x1091AD: main (in &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;user_space_memleak&#x2F;a.out)</span><br></pre></td></tr></table></figure>

<p>可以用 <code>gcc -g</code> 重新编译一下带上符号表信息，再次用 valgrind 定位，可以得到更详细信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2822695&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2822695&#x3D;&#x3D;    by 0x1091AD: main (user_space_memleak.c:9)</span><br></pre></td></tr></table></figure>
<p>这次直接将 在 哪个文件 哪一行都直接打印出来了。</p>
<h3 id="out-of-bounds-access-demo"><a href="#out-of-bounds-access-demo" class="headerlink" title="out of bounds access demo"></a>out of bounds access demo</h3><p>代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">        int i &#x3D; 3;</span><br><span class="line">        char *p &#x3D; NULL;</span><br><span class="line">        p &#x3D; malloc(1024);</span><br><span class="line">        if (!p)</span><br><span class="line">                printf(&quot;malloc failed,just wait!!\n&quot;);</span><br><span class="line"></span><br><span class="line">        printf(&quot;malloc sucess,just wait!!*(p + 10) &#x3D; %d\n&quot;, *(p + 10));</span><br><span class="line">        *(p + 1023) &#x3D; *(p + 1024);</span><br><span class="line">        *(p + 1024) &#x3D; 1;</span><br><span class="line">        while(i--) &#123;</span><br><span class="line">                usleep(1000 * 1000);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free(p);</span><br><span class="line">        free(p + 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>gcc -g</code> 编译之偶 用 <code>valgrind ./a.out</code> 跑一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace&#x2F;test_modules&#x2F;resource_leak&#x2F;valgrind# valgrind .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Memcheck, a memory error detector</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Command: .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D; Use of uninitialised value of size 8</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    at 0x48B681B: _itoa_word (_itoa.c:179)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48D26F4: __vfprintf_internal (vfprintf-internal.c:1687)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48BCEBE: printf (printf.c:33)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x109225: main (out_of_bounds_access.c:13)</span><br><span class="line">malloc sucess,just wait!!</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid read of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109200: main (out_of_bounds_access.c:14)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid write of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109213: main (out_of_bounds_access.c:15)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D; Invalid free() &#x2F; delete &#x2F; delete[] &#x2F; realloc()</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10927F: main (out_of_bounds_access.c:21)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Address 0x4a4d041 is 1 bytes inside a block of size 1,024 free&#39;d</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10926F: main (out_of_bounds_access.c:20)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Block was alloc&#39;d at</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x1091ED: main (out_of_bounds_access.c:9)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; HEAP SUMMARY:</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;     in use at exit: 0 bytes in 0 blocks</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;   total heap usage: 2 allocs, 3 frees, 2,048 bytes allocated</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; All heap blocks were freed -- no leaks are possible</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure>

<p>也是直接指出了 一次引用未初始化的内存, 两次越界访问, 一次非法 free：</p>
<ol>
<li><p>一次引用为初始化的内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D; Use of uninitialised value of size 8</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    at 0x48B681B: _itoa_word (_itoa.c:179)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48D26F4: __vfprintf_internal (vfprintf-internal.c:1687)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x48BCEBE: printf (printf.c:33)</span><br><span class="line">&#x3D;&#x3D;2833797&#x3D;&#x3D;    by 0x109225: main (out_of_bounds_access.c:13)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一次越界读访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid read of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109200: main (out_of_bounds_access.c:14)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一次越界写访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D; Invalid write of size 1</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x109213: main (out_of_bounds_access.c:15)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;  Address 0x4a4d440 is 0 bytes after a block of size 1,024 alloc&#39;d</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2826928&#x3D;&#x3D;    by 0x1091CD: main (out_of_bounds_access.c:9)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一次 invaild free</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D; Invalid free() &#x2F; delete &#x2F; delete[] &#x2F; realloc()</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10927F: main (out_of_bounds_access.c:21)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Address 0x4a4d041 is 1 bytes inside a block of size 1,024 free&#39;d</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483CA3F: free (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x10926F: main (out_of_bounds_access.c:20)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;  Block was alloc&#39;d at</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    at 0x483B7F3: malloc (in &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;valgrind&#x2F;vgpreload_memcheck-amd64-linux.so)</span><br><span class="line">&#x3D;&#x3D;2845980&#x3D;&#x3D;    by 0x1091ED: main (out_of_bounds_access.c:9)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实际项目中应用的内存泄漏往往比这要复杂很多，可能代码考虑了正常情况下的 free，异常情况下没有<br>free等， <code>valgrind</code> 是很强大，有很多参数，但也只能帮助我们在出现问题之后定位，还是需要养成良<br>好的编码习惯，减少杜绝这类问题</p>
<p>参考<a target="_blank" rel="noopener" href="http://senlinzhan.github.io/2017/12/31/valgrind/">文章1</a><br>参考<a target="_blank" rel="noopener" href="https://www.cprogramming.com/debugging/valgrind.html">文章2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-16T11:00:00.000Z" title="1/16/2021, 7:00:00 PM">2021-01-16</time>发表</span><span class="level-item"><time dateTime="2021-01-31T09:47:29.081Z" title="1/31/2021, 5:47:29 PM">2021-01-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约1122个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/16/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/kmemleak%20%E5%AE%9A%E4%BD%8D%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">kmemleak 定位内存泄露</a></h1><div class="content"><h2 id="kmemleak-原理"><a href="#kmemleak-原理" class="headerlink" title="kmemleak 原理"></a>kmemleak 原理</h2><p>Basic Algorithm<br>The memory allocations via kmalloc(), vmalloc(), kmem_cache_alloc() and friends are traced and the pointers, together with additional information like size and stack trace, are stored in a rbtree. The corresponding freeing function calls are tracked and the pointers removed from the kmemleak data structures.</p>
<p>An allocated block of memory is considered orphan if no pointer to its start address or to any location inside the block can be found by scanning the memory (including saved registers). This means that there might be no way for the kernel to pass the address of the allocated block to a freeing function and therefore the block is considered a memory leak.</p>
<p>The scanning algorithm steps:</p>
<p>mark all objects as white (remaining white objects will later be considered orphan)<br>scan the memory starting with the data section and stacks, checking the values against the addresses stored in the rbtree. If a pointer to a white object is found, the object is added to the gray list<br>scan the gray objects for matching addresses (some white objects can become gray and added at the end of the gray list) until the gray set is finished<br>the remaining white objects are considered orphan and reported via /sys/kernel/debug/kmemleak<br>Some allocated memory blocks have pointers stored in the kernel’s internal data structures and they cannot be detected as orphans. To avoid this, kmemleak can also store the number of values pointing to an address inside the block address range that need to be found so that the block is not considered a leak. One example is __vmalloc().</p>
<h2 id="kmemleak-使用"><a href="#kmemleak-使用" class="headerlink" title="kmemleak 使用"></a>kmemleak 使用</h2><p>kmemleak 功能一开始默认是不开启的，需要配置如下选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if [ $debug_kmemleak &#x3D;&#x3D; 1 ]</span><br><span class="line">then</span><br><span class="line">## kmemleak detect and panic start</span><br><span class="line">	echo &quot;CONFIG_DEBUG_KMEMLEAK&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_DEBUG_KMEMLEAK_MEM_POOL_SIZE&#x3D;16000&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_DEBUG_KMEMLEAK_AUTO_SCAN&#x3D;y&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">	echo &quot;CONFIG_BOOTPARAM_HUNG_TASK_PANIC_VALUE&#x3D;1&quot; &gt;&gt; &#x2F;tmp&#x2F;.config</span><br><span class="line">## kmemleak detect and panic end</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/resource_leak/kmemleak/kmemleak.c">test code</a></p>
<p>一开始遇到了无法安装的问题，后来发现是因为模块名 一样导致的问题。。<br>参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/16360689/invalid-parameters-error-when-trying-to-insert-module-that-accesses-exported-s">bug</a></p>
<p>触发开始扫描，这是个同步过程，内存比较大的话可能比较耗时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# echo scan &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;kmemleak</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>

<p>查看扫描结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cat kmemleak</span><br><span class="line">unreferenced object 0xffff8da0cac1c500 (size 32):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.798s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5  kkkkkkkkkkkkkkk.</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;00000000ae5c9724&gt;] 0xffffffffc030702d</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">unreferenced object 0xffff8da0d2371000 (size 1024):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.798s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;0000000079fd2c9c&gt;] 0xffffffffc030709c</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">unreferenced object 0xffff8da0ca534000 (size 4096):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.862s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;000000000526120c&gt;] 0xffffffffc0307130</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">unreferenced object 0xffffaa50801fb000 (size 4096):</span><br><span class="line">  comm &quot;insmod&quot;, pid 3529, jiffies 4294873584 (age 562.862s)</span><br><span class="line">  hex dump (first 32 bytes):</span><br><span class="line">    27 94 40 81 50 aa ff ff 27 04 00 00 00 00 00 00  &#39;.@.P...&#39;.......</span><br><span class="line">    7c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |...............</span><br><span class="line">  backtrace:</span><br><span class="line">    [&lt;00000000854ee6a4&gt;] __vmalloc_node_range+0x236&#x2F;0x270</span><br><span class="line">    [&lt;00000000a355227b&gt;] __vmalloc_node+0x3f&#x2F;0x60</span><br><span class="line">    [&lt;0000000039b16a7e&gt;] 0xffffffffc0307149</span><br><span class="line">    [&lt;00000000afc3b54e&gt;] do_one_initcall+0x56&#x2F;0x2b0</span><br><span class="line">    [&lt;000000000724192e&gt;] do_init_module+0x56&#x2F;0x200</span><br><span class="line">    [&lt;00000000996ecfff&gt;] load_module+0x2348&#x2F;0x26e0</span><br><span class="line">    [&lt;000000004fa63e1a&gt;] __do_sys_finit_module+0xa0&#x2F;0xe0</span><br><span class="line">    [&lt;00000000cddcb6e5&gt;] do_syscall_64+0x33&#x2F;0x40</span><br><span class="line">    [&lt;00000000a0266b85&gt;] entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>
<p>可以比较清楚的看到 可能leak的 object点，且有详细调用栈，排查起来十分方便</p>
<p>清除之前扫描结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# echo clear  &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;kmemleak</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug# cat kmemleak</span><br><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug#</span><br></pre></td></tr></table></figure>

<h2 id="kmemleak-代码"><a href="#kmemleak-代码" class="headerlink" title="kmemleak 代码"></a>kmemleak 代码</h2><p>后续填坑</p>
<h2 id="kmemleak-overhead"><a href="#kmemleak-overhead" class="headerlink" title="kmemleak overhead"></a>kmemleak overhead</h2><p>当然假设我们场景允许 使能kmemleak之后，重新编译 kernel，也要关心 kmemleak 所带来的<br>overhead是否允许，如果你的场景本来就是一个高负载的已经80%多的CPU使用率了，然后开启<br>kmemleak,是很可能出问题的。</p>
<p>在 公司 一款三核心的 Cortex-A7 的产品中测试结果：<br>        disabled        enabled     Per Core增加%       换算成单核CPU%<br>User:     3.54%          7.63%          4.09%            12.27%<br>Sys:      10.68%         23.76%         13.08%           38.7%<br>Idle:     84.6%          67.68%         17.02%           -50.76%</p>
<p>在我自己 qemu 虚拟机中测试结果是：</p>
<pre><code>    disabled        enabled     Per Core增加%       换算成单核CPU%</code></pre>
<p>User:     3.54%          7.63%                           12.27%<br>Sys:      10.68%         23.76%                          38.7%<br>Idle:     84.6%          67.68%                          -50.76%</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/dev-tools/kmemleak.html">内核文档</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/linux%E5%86%85%E6%A0%B8/page/4/">上一页</a></div><div class="pagination-next"><a href="/categories/linux%E5%86%85%E6%A0%B8/page/6/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/4/">4</a></li><li><a class="pagination-link is-current" href="/categories/linux%E5%86%85%E6%A0%B8/page/5/">5</a></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/6/">6</a></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/7/">7</a></li><li><a class="pagination-link" href="/categories/linux%E5%86%85%E6%A0%B8/page/8/">8</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Hui Su"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hui Su</p><p class="is-size-6 is-block">liulangren bolg</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">130</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">28</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">164</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/liulangrenaaa" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/liulangrenaaa"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com.hk/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">www.google.com.hk</span></span></a></li><li><a class="level is-mobile" href="https://lkml.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LKML</span></span><span class="level-right"><span class="level-item tag">lkml.org</span></span></a></li><li><a class="level is-mobile" href="https://mail.google.com/mail" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gmail</span></span><span class="level-right"><span class="level-item tag">mail.google.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/explore" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/contest/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 剑指offer</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://leetcode-cn.com/problemset/lcof/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode 周赛</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://tongji.baidu.com/web/32051076/overview/index?siteId=16230094" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度分析</span></span><span class="level-right"><span class="level-item tag">tongji.baidu.com</span></span></a></li><li><a class="level is-mobile" href="https://analytics.google.com/analytics/web/#/a187909645p259761261/admin/streams/table/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">google分析</span></span><span class="level-right"><span class="level-item tag">analytics.google.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BRK/"><span class="tag">BRK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HW/"><span class="tag">HW</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/KASAN/"><span class="tag">KASAN</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QCOM/"><span class="tag">QCOM</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aarch64/"><span class="tag">aarch64</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/acl/"><span class="tag">acl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android-framework/"><span class="tag">android framework</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android12-gdb64%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B/"><span class="tag">android12 gdb64调试进程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/asid/"><span class="tag">asid</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/benchmark/"><span class="tag">benchmark</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpf/"><span class="tag">bpf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup/"><span class="tag">cgroup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v1/"><span class="tag">cgroup v1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroup-v2/"><span class="tag">cgroup v2</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/config/"><span class="tag">config</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/coroutinue/"><span class="tag">coroutinue</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu%E8%B0%83%E9%A2%91/"><span class="tag">cpu调频</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crash/"><span class="tag">crash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dd/"><span class="tag">dd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deadlock/"><span class="tag">deadlock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debugfs/"><span class="tag">debugfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/double-free/"><span class="tag">double free</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drop-caches/"><span class="tag">drop_caches</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dumpe2fs/"><span class="tag">dumpe2fs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eas/"><span class="tag">eas</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/epoll/"><span class="tag">epoll</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event-trace/"><span class="tag">event trace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ext2/"><span class="tag">ext2</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-attr/"><span class="tag">file attr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/file-hole/"><span class="tag">file hole</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filesystem/"><span class="tag">filesystem</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fsck/"><span class="tag">fsck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace/"><span class="tag">ftrace</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ftrace-%E7%94%A8%E6%B3%95/"><span class="tag">ftrace 用法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/futex/"><span class="tag">futex</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hardlockup/"><span class="tag">hardlockup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hrtimer/"><span class="tag">hrtimer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hugepage/"><span class="tag">hugepage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hungtask/"><span class="tag">hungtask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/initramfs/"><span class="tag">initramfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interrupt/"><span class="tag">interrupt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt/"><span class="tag">intrrrupt</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intrrrupt-storm/"><span class="tag">intrrrupt storm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/irq/"><span class="tag">irq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kallsyms/"><span class="tag">kallsyms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kdump/"><span class="tag">kdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-patch/"><span class="tag">kernel patch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kfence/"><span class="tag">kfence</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kmemleak/"><span class="tag">kmemleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kprobes/"><span class="tag">kprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kretprobes/"><span class="tag">kretprobes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ksoftirqd/"><span class="tag">ksoftirqd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kthread/"><span class="tag">kthread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvm/"><span class="tag">kvm</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kvmtool/"><span class="tag">kvmtool</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/last-kmsg/"><span class="tag">last_kmsg</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/launch-json/"><span class="tag">launch.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-kernel/"><span class="tag">linux kernel</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-native-aio/"><span class="tag">linux native aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lock-stat/"><span class="tag">lock_stat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lockdep/"><span class="tag">lockdep</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makedumpfile/"><span class="tag">makedumpfile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memleak/"><span class="tag">memleak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory/"><span class="tag">memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/memory-direct-reclaim/"><span class="tag">memory direct reclaim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/menuconfig/"><span class="tag">menuconfig</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mm/"><span class="tag">mm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mount/"><span class="tag">mount</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/node/"><span class="tag">node</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oom/"><span class="tag">oom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oops/"><span class="tag">oops</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-cache/"><span class="tag">page_cache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/page-owner/"><span class="tag">page_owner</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagecache/"><span class="tag">pagecache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pagemap/"><span class="tag">pagemap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/panic/"><span class="tag">panic</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/per-cpu/"><span class="tag">per-cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf/"><span class="tag">perf</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/perf-c2c/"><span class="tag">perf c2c</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pid-namespace/"><span class="tag">pid namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/poll/"><span class="tag">poll</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/posix/"><span class="tag">posix</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/power-management/"><span class="tag">power management</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preempt-count/"><span class="tag">preempt_count</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/preemption/"><span class="tag">preemption</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pressure/"><span class="tag">pressure</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/process-madvise/"><span class="tag">process_madvise</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psi/"><span class="tag">psi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/psoix-aio/"><span class="tag">psoix aio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pstore/"><span class="tag">pstore</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pyqt5/"><span class="tag">pyqt5</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/randomize-va-space/"><span class="tag">randomize_va_space</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rcu/"><span class="tag">rcu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/read-code/"><span class="tag">read code</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sched-latency/"><span class="tag">sched latency</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/schedule/"><span class="tag">schedule</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/select/"><span class="tag">select</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slab/"><span class="tag">slab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub/"><span class="tag">slub</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slub-debug/"><span class="tag">slub_debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/softlockup/"><span class="tag">softlockup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-backtrace/"><span class="tag">stack_backtrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stack-overflow/"><span class="tag">stack_overflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-key/"><span class="tag">static_key</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sync/"><span class="tag">sync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemTap/"><span class="tag">systemTap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systrace/"><span class="tag">systrace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-json/"><span class="tag">task.json</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/task-struct/"><span class="tag">task_struct</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tasklet/"><span class="tag">tasklet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread-info/"><span class="tag">thread_info</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tracepoint/"><span class="tag">tracepoint</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/use-after-free/"><span class="tag">use after free</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uts-namespace/"><span class="tag">uts namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/valgrind/"><span class="tag">valgrind</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vdso/"><span class="tag">vdso</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmstat/"><span class="tag">vmstat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmtouch/"><span class="tag">vmtouch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/x86/"><span class="tag">x86</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xattr/"><span class="tag">xattr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zone/"><span class="tag">zone</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内存泄漏</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%B6%8A%E7%95%8C/"><span class="tag">内存泄漏越界</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"><span class="tag">内存泄露</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">内核内存泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C/"><span class="tag">内核内存越界</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"><span class="tag">内核同步</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%8A%A2%E5%8D%A0/"><span class="tag">内核抢占</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88%E6%BA%A2%E5%87%BA/"><span class="tag">内核栈溢出</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%AE%A1%E7%AE%A1%E7%90%86/"><span class="tag">内管管理</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/"><span class="tag">函数调用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8A%9F%E8%80%97/"><span class="tag">功耗</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8E%9F%E7%90%86/"><span class="tag">原理</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80%E9%9A%8F%E6%9C%BA%E5%8C%96/"><span class="tag">地址空间布局随机化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="tag">开发工具</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/"><span class="tag">性能稳定性</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E6%BC%8F/"><span class="tag">文件描述符泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E9%A1%B9/"><span class="tag">杂项</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%88/"><span class="tag">栈</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/"><span class="tag">死锁检测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="tag">生活感悟</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E6%88%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span class="tag">用户内存泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A9%BA%E6%8C%87%E9%92%88/"><span class="tag">空指针</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%B3%84%E6%BC%8F/"><span class="tag">虚拟地址空间泄漏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F/"><span class="tag">资源泄漏</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%AF%E4%B8%AD%E6%96%AD/"><span class="tag">软中断</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/"><span class="tag">进程调度</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/"><span class="tag">通用寄存器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81%E7%B2%92%E5%BA%A6/"><span class="tag">锁粒度</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E7%B3%BB%E7%BB%9F/"><span class="tag">问题系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/QCOM/"><span class="level-start"><span class="level-item">QCOM</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/cgroup-v1/"><span class="level-start"><span class="level-item">cgroup v1</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/cgroup-v1/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/cgroup-v2/"><span class="level-start"><span class="level-item">cgroup v2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/kernel-debug/"><span class="level-start"><span class="level-item">kernel debug</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/kernel-debug/cache-false-sharing/"><span class="level-start"><span class="level-item">cache false sharing</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/"><span class="level-start"><span class="level-item">linux kernel</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/deadline-schedule/"><span class="level-start"><span class="level-item">deadline schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/"><span class="level-start"><span class="level-item">frequency governer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/frequency-governer/schedule-util/"><span class="level-start"><span class="level-item">schedule util</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/linux-kernel/linux-schedule/idle/"><span class="level-start"><span class="level-item">idle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/linux%E5%86%85%E6%A0%B8/"><span class="level-start"><span class="level-item">linux内核</span></span><span class="level-end"><span class="level-item tag">74</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/"><span class="level-start"><span class="level-item">namespace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/namespace/pid-namespace/"><span class="level-start"><span class="level-item">pid namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/namespace/uts-namespace/"><span class="level-start"><span class="level-item">uts namespace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/power-management/"><span class="level-start"><span class="level-item">power management</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/schedule/"><span class="level-start"><span class="level-item">schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/server/"><span class="level-start"><span class="level-item">server</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">shell脚本</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/userspace/"><span class="level-start"><span class="level-item">userspace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/userspace/coroutinue/"><span class="level-start"><span class="level-item">coroutinue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/userspace/coroutinue/linux-schedule/"><span class="level-start"><span class="level-item">linux schedule</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">开发工具</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">生活感悟</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">网络</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-01T11:00:40.000Z">2022-07-01</time></p><p class="title"><a href="/2022/07/01/memory/asid/">asid</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-06-18T11:00:00.000Z">2022-06-18</time></p><p class="title"><a href="/2022/06/18/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/last_kmsg/">last_kmsg</a></p><p class="categories"><a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-04-29T11:00:00.000Z">2022-04-29</time></p><p class="title"><a href="/2022/04/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/ftrace%20%E5%8E%9F%E7%90%86/">ftrace 原理</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-04-29T11:00:00.000Z">2022-04-29</time></p><p class="title"><a href="/2022/04/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/%E5%B8%B8%E8%A7%81ftrace%E7%94%A8%E6%B3%95/">常见ftrace用法</a></p><p class="categories"><a href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-28T11:00:00.000Z">2022-03-28</time></p><p class="title"><a href="/2022/03/28/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/gdb%20%E4%BD%BF%E7%94%A8/">gdb 使用</a></p><p class="categories"><a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Su Hui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>